<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ãƒ©ã‚¤ãƒ•ãƒ­ã‚°ã‚¢ãƒ—ãƒª v16.3</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
            background: #ffffff;
            color: #333;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        
        button {
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            touch-action: manipulation;
            user-select: none;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8em;
            color: #000;
        }
        
        .tab-nav {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab-nav::-webkit-scrollbar {
            display: none;
        }
        
        .tab-button {
            flex: 1;
            min-width: 80px;
            padding: 15px 10px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 0.95em;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            color: #000;
            border-bottom-color: #000;
            font-weight: 600;
        }
        
        .tab-button:active {
            opacity: 0.7;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .voice-button {
            width: 100%;
            padding: 18px;
            background: #fff;
            border: 2px solid #000;
            border-radius: 12px;
            font-size: 1.1em;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .voice-button:hover {
            background: #000;
            color: #fff;
        }
        
        .voice-button:active {
            transform: scale(0.98);
        }
        
        .voice-button.listening {
            background: #000;
            color: #fff;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .quick-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .quick-button {
            padding: 12px 8px;
            background: #fff;
            border: 1px solid #333;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .quick-button:hover {
            background: #f5f5f5;
            border-color: #000;
        }
        
        .quick-button.selected {
            background: #000;
            color: #fff;
            border-color: #000;
            font-weight: bold;
        }
        
        .quick-button:active {
            background: #000;
            color: #fff;
            transform: scale(0.95);
        }
        
        .text-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
        }
        
        .text-input:focus {
            outline: none;
            border-color: #000;
            border-width: 2px;
        }
        
        textarea.text-input {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }
        
        .add-button {
            width: 100%;
            padding: 14px;
            background: #000;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .add-button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            color: #666;
            font-size: 0.9em;
        }
        
        .logs-section {
            margin-top: 30px;
        }
        
        .section-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-item {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .log-item:hover {
            border-color: #000;
        }
        
        /* ã‚«ãƒ†ã‚´ãƒªç®¡ç†ãƒœã‚¿ãƒ³ */
        .manage-button {
            padding: 8px 15px;
            background: #fff;
            color: #000;
            border: 1px solid #000;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .manage-button:hover {
            background: #000;
            color: #fff;
        }
        
        /* æ°—åˆ†é¸æŠ */
        .mood-selector {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }
        
        .mood-selector-title {
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            color: #000;
        }
        
        .mood-buttons {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }
        
        .mood-button {
            flex: 1;
            padding: 15px 5px;
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .mood-button:hover {
            border-color: #666;
            transform: translateY(-2px);
        }
        
        .mood-button.selected {
            border-color: #000;
            background: #f0f8ff;
            border-width: 3px;
        }
        
        .mood-emoji {
            font-size: 2em;
        }
        
        .mood-label {
            font-size: 0.8em;
            color: #666;
            font-weight: 500;
        }
        
        .mood-button.selected .mood-label {
            color: #000;
            font-weight: 600;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: #fff;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #000;
        }
        
        .modal-close {
            float: right;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }
        
        .modal-close:hover {
            color: #000;
        }
        
        /* ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«è¦ç´„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .summary-section {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }
        
        .summary-section.active {
            display: block;
        }
        
        .summary-item {
            margin-bottom: 20px;
        }
        
        .summary-label {
            font-weight: 600;
            font-size: 1em;
            margin-bottom: 8px;
            color: #000;
        }
        
        .summary-content {
            padding: 12px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            min-height: 60px;
            white-space: pre-wrap;
        }
        
        .ai-comment {
            margin-top: 10px;
            padding: 12px;
            background: #f0f8ff;
            border-left: 4px solid #000;
            border-radius: 4px;
            font-size: 0.9em;
            color: #333;
        }
        
        .ai-comment::before {
            content: 'ğŸ’¬ AIã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ: ';
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }
        
        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar {
            margin-top: 20px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .calendar-nav {
            padding: 8px 15px;
            background: #fff;
            border: 1px solid #000;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .calendar-nav:active {
            background: #000;
            color: #fff;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            padding: 10px 5px;
            font-size: 0.9em;
            color: #666;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            background: #fff;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            border-color: #000;
        }
        
        .calendar-day.today {
            background: #000;
            color: #fff;
            font-weight: 600;
        }
        
        .calendar-day.has-journal {
            background: #f0f8ff;
            border-color: #666;
        }
        
        .calendar-day.today.has-journal {
            background: #000;
            color: #fff;
        }
        
        .calendar-day.empty {
            background: transparent;
            border: none;
            cursor: default;
        }
        
        .calendar-day-mood {
            font-size: 1.2em;
            margin-top: 2px;
        }
        
        /* ãƒ¬ãƒãƒ¼ãƒˆ */
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            padding: 15px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 600;
            color: #000;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        /* AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
        .ai-feedback-container {
            margin: 20px 0;
            padding: 25px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            border: 2px solid #000;
        }
        
        .ai-feedback-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .feedback-section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        
        .feedback-section h4 {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 12px;
            color: #000;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .feedback-item {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }
        
        .feedback-icon {
            font-size: 1.2em;
        }
        
        .ai-advice-box {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #000;
            margin: 15px 0;
            line-height: 1.8;
        }
        
        .ai-advice-box::before {
            content: 'ğŸ’¬ AIã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹';
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #000;
        }
        
        .goals-list {
            list-style: none;
            padding: 0;
        }
        
        .goals-list li {
            padding: 10px;
            margin: 8px 0;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 3px solid #000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .goals-list li::before {
            content: 'â€¢';
            font-size: 1.5em;
            color: #000;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5em;
                margin-bottom: 20px;
            }
            
            .tab-button {
                min-width: 70px;
                padding: 12px 8px;
                font-size: 0.85em;
            }
            
            .voice-button {
                padding: 16px;
                font-size: 1em;
            }
            
            .quick-buttons {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 8px;
            }
            
            .quick-button {
                padding: 10px 5px;
                font-size: 0.85em;
                min-height: 48px;
            }
            
            .modal-content {
                padding: 20px;
            }
        }

        /* ç¶™ç¶šä¸­è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .ongoing-badge {
            display: inline-block;
            padding: 3px 8px;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            color: white;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .log-item.ongoing {
            border-left: 4px solid #22c55e;
            background: linear-gradient(to right, #f0fdf4, #ffffff);
        }

        .log-item {
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
        }

        .log-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .log-info {
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #666;
        }

        .time-display {
            color: #333;
            font-weight: 500;
        }

        .category-badge {
            padding: 2px 8px;
            background: #f0f0f0;
            border-radius: 12px;
            font-size: 0.9em;
        }

        .log-actions {
            display: flex;
            gap: 8px;
        }

        .log-actions button {
            padding: 5px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 0.9em;
        }

        .log-actions button:hover {
            background: #f5f5f5;
        }

        .end-btn {
            background: #22c55e !important;
            color: white !important;
            border: none !important;
            font-weight: bold;
        }

        .end-btn:hover {
            background: #16a34a !important;
        }
.report-section {
    margin: 20px 0;
    padding: 15px;
    background: #f9f9f9;
    border-radius: 8px;
}

.report-controls {
    margin-bottom: 15px;
    display: flex;
    gap: 10px;
    align-items: center;
}

.report-controls label {
    display: flex;
    gap: 5px;
    align-items: center;
}

.report-controls input[type="month"] {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.report-controls button {
    padding: 8px 16px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.report-controls button:hover {
    background: #45a049;
}

.category-summary {
    margin: 10px 0;
    padding: 15px;
    background: white;
    border-radius: 8px;
    border: 1px solid #ddd;
    cursor: pointer;
    transition: all 0.2s;
}

.category-summary:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}

.category-stats {
    display: flex;
    gap: 20px;
    margin-top: 5px;
    font-size: 0.9em;
    color: #666;
}

.category-details {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
    display: none;
}

.category-details.show {
    display: block;
}

.detail-item {
    padding: 10px;
    margin: 5px 0;
    background: #f5f5f5;
    border-radius: 4px;
    font-size: 0.9em;
}

.detail-item strong {
    display: block;
    margin-bottom: 5px;
}

.total-summary {
    margin: 20px 0;
    padding: 15px;
    background: #e3f2fd;
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
}

.btn-icon {
    background: none;
    border: none;
    font-size: 1.2em;
    cursor: pointer;
    padding: 5px;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.btn-icon:hover {
    opacity: 1;
}

.category-badge {
    display: inline-block;
    padding: 2px 8px;
    background: #f0f0f0;
    border-radius: 4px;
    font-size: 0.85em;
    color: #666;
}
/* ç›®æ¨™æ©Ÿèƒ½ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.goals-section {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.goals-list-section {
    margin: 20px 0;
}

.goal-item {
    background: white;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    border: 2px solid #e0e0e0;
    transition: all 0.2s;
}

.goal-item:hover {
    border-color: #4CAF50;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.goal-item.completed {
    opacity: 0.7;
    background: #f0f8f0;
}

.goal-item.completed .goal-text {
    text-decoration: line-through;
    color: #999;
}

.goal-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.goal-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.goal-text {
    flex: 1;
    font-size: 1.05em;
    font-weight: 500;
}

.goal-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.goal-category {
    padding: 4px 10px;
    background: #f0f0f0;
    border-radius: 4px;
    font-size: 0.9em;
}

.goals-progress-section {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
}

.progress-summary {
    margin-bottom: 20px;
}

.progress-bar-container {
    width: 100%;
    height: 30px;
    background: #e0e0e0;
    border-radius: 15px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

.progress-text {
    text-align: center;
    font-size: 1.2em;
    font-weight: bold;
    color: #4CAF50;
}

.category-progress h4 {
    margin-bottom: 15px;
    color: #333;
}

.category-stat {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    margin: 5px 0;
    background: white;
    border-radius: 4px;
    border-left: 4px solid #4CAF50;
}

.goals-feedback-section {
    margin: 20px 0;
}

.goals-feedback-section h3 {
    margin-bottom: 15px;
}

.feedback-content {
    line-height: 1.8;
}

.feedback-content p {
    margin: 15px 0;
}

.feedback-content ul {
    padding-left: 20px;
}

.feedback-content li {
    margin: 8px 0;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #999;
    font-size: 1.1em;
}
/* ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ­ã‚°ã®æ”¹å–„ã‚¹ã‚¿ã‚¤ãƒ« */
.journal-log-item {
    background: white;
    border-radius: 12px;
    margin: 15px 0;
    padding: 15px;
    border: 2px solid #e0e0e0;
    transition: all 0.2s;
}

.journal-log-item:hover {
    border-color: #4CAF50;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.journal-log-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    padding: 5px 0;
}

.journal-date {
    font-weight: 600;
    font-size: 1.05em;
    color: #333;
}

.toggle-icon {
    color: #999;
    font-size: 0.9em;
    transition: transform 0.2s;
}

.journal-summary-preview {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #f0f0f0;
}

.summary-preview-item {
    margin: 10px 0;
}

.summary-label-mini {
    display: inline-block;
    font-weight: 600;
    font-size: 0.9em;
    margin-bottom: 5px;
    color: #555;
}

.summary-items {
    margin-left: 10px;
}

.summary-bullet {
    font-size: 0.95em;
    color: #666;
    line-height: 1.6;
    margin: 3px 0;
}

.summary-more {
    font-size: 0.85em;
    color: #999;
    font-style: italic;
    margin-top: 3px;
}

.journal-detail {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.journal-detail.show {
    max-height: 2000px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 2px solid #e0e0e0;
}

.journal-full-text {
    background: #f9f9f9;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.journal-full-text strong {
    display: block;
    margin-bottom: 10px;
    color: #333;
}

.journal-full-summary {
    background: #f0f8ff;
    padding: 15px;
    border-radius: 8px;
}

.journal-full-summary > strong {
    display: block;
    margin-bottom: 15px;
    color: #333;
}

.summary-detail-section {
    margin: 15px 0;
}

.summary-detail-label {
    font-weight: 600;
    color: #555;
    margin-bottom: 8px;
}

.summary-detail-item {
    margin: 5px 0;
    padding-left: 10px;
    color: #666;
    line-height: 1.6;
}
/* æ‰‹å‹•ã‚«ãƒ†ã‚´ãƒªé¸æŠUI */
.category-selector {
    margin: 15px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px solid #e9ecef;
}

.category-selector-title {
    font-size: 14px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.category-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 10px;
}

.category-btn {
    padding: 12px;
    border: 2px solid #dee2e6;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.category-btn:hover {
    background: #f8f9fa;
    transform: translateY(-1px);
}

.category-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.category-btn.good { border-color: #28a745; }
.category-btn.good.active { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-color: #28a745; }

.category-btn.more { border-color: #17a2b8; }
.category-btn.more.active { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); border-color: #17a2b8; }

.category-btn.worry { border-color: #ffc107; }
.category-btn.worry.active { background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); border-color: #ffc107; color: white; }

.category-btn.task { border-color: #007bff; }
.category-btn.task.active { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); border-color: #007bff; }

.selected-category-display {
    padding: 8px 12px;
    background: white;
    border-radius: 6px;
    font-size: 13px;
    text-align: center;
    color: #6c757d;
    border: 1px solid #dee2e6;
}

.selected-category-display.has-selection {
    font-weight: 600;
    color: #495057;
}

/* éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
.voice-input-section {
    position: relative;
}

.category-required-hint {
    font-size: 12px;
    color: #dc3545;
    margin-top: 5px;
    display: none;
}

.category-required-hint.show {
    display: block;
}
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ãƒ©ã‚¤ãƒ•ãƒ­ã‚° v9.6</h1>
        
        <div class="tab-nav">
            <button class="tab-button active" onclick="switchTab('activity')">â±ï¸ è¡Œå‹•</button>
            <button class="tab-button" onclick="switchTab('money')">ğŸ’° ãŠé‡‘</button>
            <button class="tab-button" onclick="switchTab('weight')">âš–ï¸ ä½“é‡</button>
            <button class="tab-button" onclick="switchTab('journal')">ğŸ“” ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</button>
            <button class="tab-button" onclick="switchTab('report')">ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆ</button>
            <button class="tab-button" onclick="switchTab('goals')">ğŸ¯ ç›®æ¨™</button>
        </div>
        
        <!-- è¡Œå‹•ã‚¿ãƒ– -->
        <div id="activity" class="tab-content active">
            <button id="activityVoiceButton" class="voice-button">ğŸ¤ éŸ³å£°å…¥åŠ›ã§è¨˜éŒ²</button>
            
            <div id="activityQuickButtons" class="quick-buttons"></div>
            
            <input type="text" id="activityInput" class="text-input" placeholder="æ´»å‹•å†…å®¹ã‚’å…¥åŠ›...">
            
            <!-- æ™‚é–“è¨˜éŒ²æ©Ÿèƒ½ -->
            <div class="time-input-section" style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 12px;">
                <div style="font-weight: 600; margin-bottom: 10px; color: #000;">â±ï¸ æ™‚é–“ã‚’è¨˜éŒ²</div>
                
                <!-- ã‚·ãƒ³ãƒ—ãƒ«: è¨˜éŒ²ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã ã‘ -->
                <div style="text-align: center; color: #666; font-size: 0.9em; margin-bottom: 10px;">
                    â€» è¨˜éŒ²ãƒœã‚¿ãƒ³ã§é–‹å§‹ã€ãƒ­ã‚°ã®çµ‚äº†ãƒœã‚¿ãƒ³ã§çµ‚äº†
                </div>
            </div>
            
            <button class="add-button" onclick="addActivity()">â• è¨˜éŒ²</button>
            <div id="activityStatus" class="status"></div>
            
            <div class="logs-section">
                <div class="section-title">
                    <span>ä»Šæ—¥ã®è¡Œå‹•</span>
                    <button class="manage-button" onclick="openCategoryManager()">âš™ï¸ ã‚«ãƒ†ã‚´ãƒªç®¡ç†</button>
                </div>
                <div id="activityLogs"></div>
            </div>
        </div>
        
        <!-- ãŠé‡‘ã‚¿ãƒ– -->
        <div id="money" class="tab-content">
            <button id="moneyVoiceButton" class="voice-button">ğŸ¤ éŸ³å£°å…¥åŠ›ã§è¨˜éŒ²</button>
            
            <div class="quick-buttons">
                <button class="quick-button" onclick="quickAddMoney('åå…¥', 10000)">ğŸ’° åå…¥</button>
                <button class="quick-button" onclick="quickAddMoney('æ”¯å‡º', -500)">ğŸ’¸ æ”¯å‡º</button>
                <button class="quick-button" onclick="quickAddMoney('é£Ÿè²»', -800)">ğŸ½ï¸ é£Ÿè²»</button>
                <button class="quick-button" onclick="quickAddMoney('äº¤é€šè²»', -300)">ğŸšƒ äº¤é€š</button>
                <button class="quick-button" onclick="quickAddMoney('å¨¯æ¥½', -1000)">ğŸ® å¨¯æ¥½</button>
                <button class="quick-button" onclick="quickAddMoney('å…‰ç†±è²»', -5000)">ğŸ’¡ å…‰ç†±è²»</button>
                <button class="quick-button" onclick="quickAddMoney('é€šä¿¡è²»', -3000)">ğŸ“± é€šä¿¡</button>
                <button class="quick-button" onclick="quickAddMoney('ãã®ä»–', -500)">ğŸ“Œ ãã®ä»–</button>
            </div>
            
            <input type="text" id="moneyInput" class="text-input" placeholder="å†…å®¹ã‚’å…¥åŠ›...">
            <input type="number" id="moneyAmount" class="text-input" placeholder="é‡‘é¡ï¼ˆå††ï¼‰">
            <button class="add-button" onclick="addMoney()">â• è¨˜éŒ²</button>
            <div id="moneyStatus" class="status"></div>
            
            <div class="logs-section">
                <h2 class="section-title">ä»Šæ—¥ã®ãŠé‡‘</h2>
                <div id="moneyLogs"></div>
            </div>
        </div>
        
        <!-- ä½“é‡ã‚¿ãƒ– -->
        <div id="weight" class="tab-content">
            <button id="weightVoiceButton" class="voice-button">ğŸ¤ éŸ³å£°å…¥åŠ›ã§è¨˜éŒ²</button>
            
            <input type="number" step="0.1" id="weightInput" class="text-input" placeholder="ä½“é‡ï¼ˆkgï¼‰">
            <button class="add-button" onclick="addWeight()">â• è¨˜éŒ²</button>
            <div id="weightStatus" class="status"></div>
            
            <div class="logs-section">
                <h2 class="section-title">ä½“é‡å±¥æ­´</h2>
                <div id="weightLogs"></div>
            </div>
        </div>
        
        <!-- ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚¿ãƒ– -->
        <div id="journal" class="tab-content">
<!-- ã‚«ãƒ†ã‚´ãƒªé¸æŠUIï¼ˆã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã®éŸ³å£°å…¥åŠ›å‰ã«é…ç½®ï¼‰ -->
<div class="category-selector">
    <div class="category-selector-title">
        ğŸ¯ éŸ³å£°å…¥åŠ›ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ:
    </div>
    <div class="category-buttons">
        <button class="category-btn good" onclick="selectJournalCategory('good')" data-category="good">
            ğŸ˜Š è‰¯ã‹ã£ãŸã“ã¨
        </button>
        <button class="category-btn more" onclick="selectJournalCategory('more')" data-category="more">
            ğŸ“ˆ ã‚‚ã£ã¨ã§ãã‚‹ã“ã¨
        </button>
        <button class="category-btn worry" onclick="selectJournalCategory('worry')" data-category="worry">
            ğŸ˜Ÿ æ‚©ã‚“ã§ã„ã‚‹ã“ã¨
        </button>
        <button class="category-btn task" onclick="selectJournalCategory('task')" data-category="task">
            âœ… æ˜æ—¥ã‚„ã‚‹ã“ã¨
        </button>
    </div>
    <div class="selected-category-display" id="selectedCategoryDisplay">
        ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ã‹ã‚‰éŸ³å£°å…¥åŠ›ã—ã¦ãã ã•ã„
    </div>
    <div class="category-required-hint" id="categoryRequiredHint">
        âš ï¸ ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„
    </div>
</div>
            <button id="journalVoiceButton" class="voice-button">ğŸ¤ éŸ³å£°å…¥åŠ›ã§æŒ¯ã‚Šè¿”ã‚Š</button>
            
            <!-- æ°—åˆ†é¸æŠ -->
            <div class="mood-selector">
                <div class="mood-selector-title">ä»Šæ—¥ã®æ°—åˆ†ã‚’é¸ã‚“ã§ãã ã•ã„</div>
                <div class="mood-buttons">
                    <button class="mood-button" onclick="selectMood('great')" data-mood="great">
                        <span class="mood-emoji">ğŸ˜Š</span>
                        <span class="mood-label">æœ€é«˜</span>
                    </button>
                    <button class="mood-button" onclick="selectMood('good')" data-mood="good">
                        <span class="mood-emoji">ğŸ™‚</span>
                        <span class="mood-label">è‰¯ã„</span>
                    </button>
                    <button class="mood-button" onclick="selectMood('normal')" data-mood="normal">
                        <span class="mood-emoji">ğŸ˜</span>
                        <span class="mood-label">æ™®é€š</span>
                    </button>
                    <button class="mood-button" onclick="selectMood('bad')" data-mood="bad">
                        <span class="mood-emoji">ğŸ˜”</span>
                        <span class="mood-label">æ‚ªã„</span>
                    </button>
                    <button class="mood-button" onclick="selectMood('terrible')" data-mood="terrible">
                        <span class="mood-emoji">ğŸ˜¢</span>
                        <span class="mood-label">æœ€æ‚ª</span>
                    </button>
                </div>
            </div>
            
            
            <!-- æ—¥ä»˜é¸æŠ -->
            <div style="margin: 15px 0; padding: 15px; background: #f9f9f9; border-radius: 12px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">ğŸ“… è¨˜éŒ²ã™ã‚‹æ—¥ä»˜ã‚’é¸æŠ</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="date" id="journalDate" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em;">
                    <button type="button" onclick="setJournalDateToToday()" style="padding: 10px 15px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap;">ä»Šæ—¥</button>
                </div>
                <div style="margin-top: 5px; font-size: 0.9em; color: #666;">
                    â€» éå»ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ã€é¡ã£ã¦è¨˜éŒ²ã§ãã¾ã™
                </div>
            </div>
            <textarea id="journalInput" class="text-input" placeholder="ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šã‚’æ›¸ãã¾ã—ã‚‡ã†...&#10;&#10;ä¾‹ï¼š&#10;æœã‹ã‚‰ã‚¸ãƒ ã«è¡Œã£ã¦æ°—æŒã¡ã‚ˆãæ±—ã‚’æµã—ãŸã€‚&#10;åˆå¾Œã¯é›†ä¸­ã—ã¦ä»•äº‹ãŒã§ããŸã€‚&#10;æ˜æ—¥ã¯æ—©èµ·ãã—ã¦æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å–ã‚Šçµ„ã‚‚ã†ã€‚"></textarea>
            
            <!-- è‡ªå‹•è¦ç´„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="summarySection" class="summary-section">
                <h3 style="margin-bottom: 15px;">ğŸ“ è‡ªå‹•è¦ç´„</h3>
                
                <div class="summary-item">
                    <div class="summary-label">ğŸ˜Š Goodï¼ˆè‰¯ã‹ã£ãŸã“ã¨ï¼‰</div>
                    <div id="summaryGood" class="summary-content"></div>
                    <div id="commentGood" class="ai-comment"></div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-label">ğŸ“ˆ Moreï¼ˆã‚‚ã£ã¨è‰¯ãã§ãã‚‹ã“ã¨ï¼‰</div>
                    <div id="summaryMore" class="summary-content"></div>
                    <div id="commentMore" class="ai-comment"></div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-label">ğŸ¤” æ‚©ã‚“ã§ã„ã‚‹ã“ã¨</div>
                    <div id="summaryWorry" class="summary-content"></div>
                    <div id="commentWorry" class="ai-comment"></div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-label">âœ… æ˜æ—¥ã®ã‚¿ã‚¹ã‚¯</div>
                    <div id="summaryTask" class="summary-content"></div>
                    <div id="commentTask" class="ai-comment"></div>
                </div>
            </div>
            
            <button class="add-button" onclick="addJournal()">ğŸ“ ä¿å­˜</button>
            <div id="journalStatus" class="status"></div>
            
            <div class="logs-section">
                <h2 class="section-title">ğŸ“… æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
                <div class="calendar">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)">â—€ å‰æœˆ</button>
                        <span id="calendarMonth" style="font-weight: 600;"></span>
                        <button class="calendar-nav" onclick="changeMonth(1)">æ¬¡æœˆ â–¶</button>
                    </div>
                    <div id="calendar" class="calendar-grid"></div>
                </div>
                
                <h2 class="section-title" style="margin-top: 30px;">ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«å±¥æ­´</h2>
                <div id="journalLogs"></div>
            </div>
        </div>
        
<!-- ä»Šæœˆã®ç›®æ¨™ã‚¿ãƒ– -->
<div id="goals" class="tab-content">
    <h2 class="section-title">ğŸ¯ ä»Šæœˆã®ç›®æ¨™</h2>
    
    <div class="goals-section">
        <div class="form-group">
            <label>æ–°ã—ã„ç›®æ¨™ã‚’è¿½åŠ </label>
            <input type="text" id="goalInput" class="input-field" placeholder="ä¾‹: æ¯æ—¥30åˆ†é‹å‹•ã™ã‚‹" />
        </div>
        
        <div class="form-group">
            <label>ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="goalCategory" class="input-field">
                <option value="å¥åº·">ğŸ’ª å¥åº·</option>
                <option value="ä»•äº‹">ğŸ’¼ ä»•äº‹</option>
                <option value="å‹‰å¼·">ğŸ“š å‹‰å¼·</option>
                <option value="è¶£å‘³">ğŸ¨ è¶£å‘³</option>
                <option value="äººé–“é–¢ä¿‚">ğŸ‘¥ äººé–“é–¢ä¿‚</option>
                <option value="ãŠé‡‘">ğŸ’° ãŠé‡‘</option>
                <option value="ãã®ä»–">ğŸ“Œ ãã®ä»–</option>
            </select>
        </div>
        
        <button class="btn-primary" onclick="addGoal()">â• ç›®æ¨™ã‚’è¿½åŠ </button>
        <div id="goalStatus" class="status-message"></div>
    </div>
    
    <div class="goals-list-section">
        <h3>ç›®æ¨™ãƒªã‚¹ãƒˆ</h3>
        <div id="goalsList"></div>
    </div>
    
    <div class="goals-progress-section">
        <h3>ğŸ“Š é”æˆçŠ¶æ³</h3>
        <div id="goalsProgress"></div>
    </div>
    
    <div class="goals-feedback-section">
        <h3>ğŸ¤– AI ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h3>
        <div id="goalsFeedback" class="ai-feedback-box">
            ç›®æ¨™ã‚’è¨­å®šã™ã‚‹ã¨ã€AIãŒã‚ãªãŸã®è¡Œå‹•è¨˜éŒ²ã¨ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’åˆ†æã—ã¦ã€é”æˆã«å‘ã‘ãŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã—ã¾ã™ã€‚
        </div>
        <button class="btn-secondary" onclick="generateGoalsFeedback()">ğŸ”„ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æ›´æ–°</button>
    </div>
</div>
        <!-- ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
        <div id="report" class="tab-content">
            <h2 class="section-title">ğŸ“Š çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalActivities">0</div>
                    <div class="stat-label">ç·è¡Œå‹•æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalMoney">Â¥0</div>
                    <div class="stat-label">åæ”¯åˆè¨ˆ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalJournals">0</div>
                    <div class="stat-label">ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgWeight">-</div>
                    <div class="stat-label">å¹³å‡ä½“é‡</div>
                </div>
            </div>
            
            <!-- AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
            <div class="ai-feedback-container">
                <div class="ai-feedback-title">
                    <span>ğŸ¤–</span>
                    <span>AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</span>
                </div>
                
                <div class="feedback-section">
                    <h4>ğŸ“Š ä»Šé€±ã®åˆ†æ</h4>
                    <div id="weeklyAnalysis"></div>
                </div>
                
                <div class="feedback-section">
                    <h4>ğŸ¯ è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³</h4>
                    <div id="activityPattern"></div>
                </div>
                
                <div class="feedback-section">
                    <h4>ğŸ˜Š æ°—åˆ†ã®å‚¾å‘</h4>
                    <div id="moodTrend"></div>
                </div>
                
                <div class="ai-advice-box" id="aiAdvice"></div>
                
                <div class="feedback-section">
                    <h4>ğŸŒŸ æ¥é€±ã®ç›®æ¨™ææ¡ˆ</h4>
                    <ul class="goals-list" id="weeklyGoals"></ul>
                </div>
            </div>
            
<!-- ãƒªãƒƒãƒãƒ¬ãƒãƒ¼ãƒˆ -->
<div class="report-section">
    <h3>ğŸ“Š è¡Œå‹•ãƒ¬ãƒãƒ¼ãƒˆ</h3>
    <div class="report-controls">
        <label>æœŸé–“:
            <input type="month" id="activityReportMonth" />
        </label>
        <button onclick="generateActivityReport()">ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
    </div>
    
    <div id="activityReportContent"></div>
    <canvas id="activityChartCanvas" width="400" height="400" style="display:none; margin: 20px auto; max-width: 100%;"></canvas>
</div>

<div class="report-section">
    <h3>ğŸ’° ãŠé‡‘ãƒ¬ãƒãƒ¼ãƒˆ</h3>
    <div class="report-controls">
        <label>æœŸé–“:
            <input type="month" id="moneyReportMonth" />
        </label>
        <button onclick="generateMoneyReport()">ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
    </div>
    
    <div id="moneyReportContent"></div>
    <canvas id="moneyChartCanvas" width="400" height="400" style="display:none; margin: 20px auto; max-width: 100%;"></canvas>
</div>
            <div class="chart-container">
                <h3 style="margin-bottom: 15px;">è¡Œå‹•ã‚«ãƒ†ã‚´ãƒªåˆ¥</h3>
                <canvas id="activityChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3 style="margin-bottom: 15px;">æ°—åˆ†ã®åˆ†å¸ƒ</h3>
                <canvas id="moodChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3 style="margin-bottom: 15px;">ãŠé‡‘ã®æ¨ç§»</h3>
                <canvas id="moneyChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3 style="margin-bottom: 15px;">ä½“é‡ã®æ¨ç§»</h3>
                <canvas id="weightChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- ã‚«ãƒ†ã‚´ãƒªç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeCategoryManager()">&times;</span>
            <h2 class="modal-title">âš™ï¸ ã‚«ãƒ†ã‚´ãƒªç®¡ç†</h2>
            
            <div style="margin-bottom: 20px;">
                <input type="text" id="newCategoryName" class="text-input" placeholder="æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªåï¼ˆä¾‹ï¼šèª­æ›¸ï¼‰">
                <input type="text" id="newCategoryEmoji" class="text-input" placeholder="çµµæ–‡å­—ï¼ˆä¾‹ï¼šğŸ“–ï¼‰">
                <button class="add-button" onclick="addCategory()">â• è¿½åŠ </button>
            </div>
            
            <h3 style="margin-bottom: 10px;">ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒª</h3>
            <div id="categoryList"></div>
        </div>
    </div>
    
    <script>
        // ãƒ‡ãƒ¼ã‚¿æ ¼ç´
        let activities = JSON.parse(localStorage.getItem('activities') || '[]');
        let moneyRecords = JSON.parse(localStorage.getItem('moneyRecords') || '[]');
        let weightRecords = JSON.parse(localStorage.getItem('weightRecords') || '[]');
        let journals = JSON.parse(localStorage.getItem('journals') || '[]');
        
        // ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ†ã‚´ãƒª
        let activityCategories = JSON.parse(localStorage.getItem('activityCategories') || JSON.stringify([
            { name: 'ä»•äº‹', emoji: 'ğŸ’¼' },
            { name: 'å‹‰å¼·', emoji: 'ğŸ“š' },
            { name: 'é‹å‹•', emoji: 'ğŸƒ' },
            { name: 'é£Ÿäº‹', emoji: 'ğŸ½ï¸' },
            { name: 'ç¡çœ ', emoji: 'ğŸ˜´' },
            { name: 'èª­æ›¸', emoji: 'ğŸ“–' },
            { name: 'å®¶äº‹', emoji: 'ğŸ§¹' },
            { name: 'è¶£å‘³', emoji: 'ğŸ¨' }
        ]));
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨
        let currentCalendarDate = new Date();
        
        // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹æ°—åˆ†
        let selectedMood = 'normal';
        
        // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ†ã‚´ãƒª
        let selectedCategory = null;
        let selectedCategoryEmoji = null;
        
        // ã‚¿ã‚¤ãƒãƒ¼é–¢é€£
        let timerStartTime = null;
        let timerInterval = null;
        let timerRunning = false;
        let timerElapsedSeconds = 0;
        
        // æ°—åˆ†ã®çµµæ–‡å­—ãƒãƒƒãƒ”ãƒ³ã‚°
        const moodEmojis = {
            great: 'ğŸ˜Š',
            good: 'ğŸ™‚',
            normal: 'ğŸ˜',
            bad: 'ğŸ˜”',
            terrible: 'ğŸ˜¢'
        };
        
        // æ°—åˆ†é¸æŠ
        function selectMood(mood) {
            selectedMood = mood;
            
            // ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.mood-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            const selectedButton = document.querySelector(`.mood-button[data-mood="${mood}"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
            }
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'journal') {
                renderCalendar();
            } else if (tabName === 'report') {
                renderReports();
            }
        }
        
        // ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’å‹•çš„ç”Ÿæˆ
        function renderActivityQuickButtons() {
            const container = document.getElementById('activityQuickButtons');
            container.innerHTML = activityCategories.map(cat => 
                `<button class="quick-button" data-category="${cat.name}" data-emoji="${cat.emoji}" onclick="selectCategory('${cat.name}', '${cat.emoji}')">${cat.emoji} ${cat.name}</button>`
            ).join('');
        }
        
        // ã‚«ãƒ†ã‚´ãƒªé¸æŠï¼ˆã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³ï¼‰
        function selectCategory(categoryName, categoryEmoji) {
            selectedCategory = categoryName;
            selectedCategoryEmoji = categoryEmoji;
            
            // ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.quick-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            const selectedButton = document.querySelector(`.quick-button[data-category="${categoryName}"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
            }
            
            // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            document.getElementById('activityInput').focus();
        }
        
        // ã‚¯ã‚¤ãƒƒã‚¯è¿½åŠ ï¼šãŠé‡‘
        function quickAddMoney(category, amount) {
            document.getElementById('moneyInput').value = category;
            document.getElementById('moneyAmount').value = Math.abs(amount);
            addMoney();
        }
        
        // è¡Œå‹•ã‚’è¨˜éŒ²
        function addActivity() {
            const text = document.getElementById('activityInput').value.trim();
            
            // ã‚«ãƒ†ã‚´ãƒªé¸æŠãƒã‚§ãƒƒã‚¯ï¼ˆã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³æ–¹å¼ï¼‰
            if (!selectedCategory) {
                alert('âŒ ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!text) {
                alert('âŒ å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // æ–°ã—ã„è¨˜éŒ²ã‚’ä½œæˆï¼ˆé–‹å§‹æ™‚åˆ»ã®ã¿ï¼‰
            const activity = {
                id: Date.now(),
                text: text,
                category: selectedCategory,
                categoryEmoji: selectedCategoryEmoji,
                startTime: new Date().toISOString(),
                endTime: null,  // ç¶™ç¶šä¸­
                timestamp: new Date().toISOString()
            };
            
            activities.unshift(activity);
            localStorage.setItem('activities', JSON.stringify(activities));
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('activityInput').value = '';
            
            // ã‚«ãƒ†ã‚´ãƒªé¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            selectedCategory = null;
            selectedCategoryEmoji = null;
            
            // ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
            document.querySelectorAll('.quick-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // ãƒ­ã‚°ã‚’æ›´æ–°
            renderActivityLogs();
            
            alert('âœ“ è¨˜éŒ²ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
        }

        // ç¶™ç¶šä¸­ã®è¨˜éŒ²ã‚’çµ‚äº†
        function endActivity(id) {
            const activity = activities.find(a => a.id === id);
            if (!activity) return;
            
            // çµ‚äº†æ™‚åˆ»ã‚’è¨˜éŒ²
            activity.endTime = new Date().toISOString();
            
            // æ‰€è¦æ™‚é–“ã‚’è¨ˆç®—
            const start = new Date(activity.startTime || activity.timestamp);
            const end = new Date(activity.endTime);
            const durationMinutes = Math.round((end - start) / 1000 / 60);
            activity.durationMinutes = durationMinutes;
            
            localStorage.setItem('activities', JSON.stringify(activities));
            renderActivityLogs();
            
            const hours = Math.floor(durationMinutes / 60);
            const minutes = durationMinutes % 60;
            const durationStr = hours > 0 ? `${hours}æ™‚é–“${minutes}åˆ†` : `${minutes}åˆ†`;
            
            alert(`âœ“ çµ‚äº†ã—ã¾ã—ãŸï¼ˆ${durationStr}ï¼‰`);
        }

        function addMoney() {
            const input = document.getElementById('moneyInput');
            const amountInput = document.getElementById('moneyAmount');
            const text = input.value.trim();
            const amount = parseFloat(amountInput.value);
            
            if (!text || isNaN(amount)) {
                showStatus('moneyStatus', 'âŒ å†…å®¹ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const record = {
                id: Date.now(),
                text: text,
                amount: amount,
                timestamp: new Date().toISOString()
            };
            
            moneyRecords.unshift(record);
            localStorage.setItem('moneyRecords', JSON.stringify(moneyRecords));
            
            input.value = '';
            amountInput.value = '';
            showStatus('moneyStatus', 'âœ“ è¨˜éŒ²ã—ã¾ã—ãŸ');
            renderMoneyLogs();
        }
        
        // ä½“é‡ã‚’è¨˜éŒ²
        function addWeight() {
            const input = document.getElementById('weightInput');
            const weight = parseFloat(input.value);
            
            if (isNaN(weight) || weight <= 0) {
                showStatus('weightStatus', 'âŒ æ­£ã—ã„ä½“é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const record = {
                id: Date.now(),
                weight: weight,
                timestamp: new Date().toISOString()
            };
            
            weightRecords.unshift(record);
            localStorage.setItem('weightRecords', JSON.stringify(weightRecords));
            
            input.value = '';
            showStatus('weightStatus', 'âœ“ è¨˜éŒ²ã—ã¾ã—ãŸ');
            renderWeightLogs();
        }
        
        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«è‡ªå‹•è¦ç´„
// æ”¹å–„ç‰ˆã‚¸ãƒ£ãƒ¼ãƒŠãƒ«åˆ†æé–¢æ•°
        // æ”¹å–„ç‰ˆã‚¸ãƒ£ãƒ¼ãƒŠãƒ«åˆ†æé–¢æ•°ï¼ˆãƒ‡ãƒãƒƒã‚°å¼·åŒ–ç‰ˆï¼‰
        // å®Œå…¨æ”¹å–„ç‰ˆã‚¸ãƒ£ãƒ¼ãƒŠãƒ«åˆ†æé–¢æ•°ï¼ˆè¤‡æ•°è¦ç´ å¯¾å¿œï¼‰
// éŸ³å£°å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã®å‰å‡¦ç†ã¨é«˜ç²¾åº¦åˆ†æ

function preprocessVoiceText(text) {
    console.log('=== å‰å‡¦ç†é–‹å§‹ ===');
    console.log('å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ:', text);
    
    // 1. æ˜ç¢ºãªåŒºåˆ‡ã‚Šãƒã‚¤ãƒ³ãƒˆã‚’æ¤œå‡º
    let processed = text;
    
    // æ¥ç¶šè©ã®å‰ã«å¥ç‚¹ã‚’è¿½åŠ ï¼ˆã‚«ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¾å¯¾å¿œï¼‰
    const conjunctions = [
        'ã¾ãŸ', 'ãã—ã¦', 'ãã‚Œã‹ã‚‰', 'ã‚ã¨', 'ã§ã‚‚', 'ã ã‘ã©', 'ã—ã‹ã—',
        'ãŸã ', 'ã‘ã©', 'ä¸€æ–¹', 'ã¡ãªã¿ã«', 'æ¬¡ã«', 'ã•ã‚‰ã«', 'ãã‚Œã§'
    ];
    
    conjunctions.forEach(conj => {
        // ã€Œã§ã™[æ¥ç¶šè©]ã€ã€Œã—ãŸ[æ¥ç¶šè©]ã€ã€Œã [æ¥ç¶šè©]ã€ãªã©ã‚’æ¤œå‡º
        const patterns = [
            new RegExp(`(ã§ã™|ã—ãŸ|ã ã£ãŸ|ã§ã—ãŸ|ã¾ã™|ã¾ã—ãŸ|ã |ãŸ)${conj}`, 'g'),
            new RegExp(`(ã“ã¨|ã®|ã‚‚ã®)${conj}`, 'g')
        ];
        
        patterns.forEach(pattern => {
            processed = processed.replace(pattern, (match, p1) => {
                console.log(`å¥ç‚¹æŒ¿å…¥: "${match}" â†’ "${p1}ã€‚${conj}"`);
                return `${p1}ã€‚${conj}`;
            });
        });
    });
    
    // 2. ã‚«ãƒ†ã‚´ãƒªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å‰ã«å¥ç‚¹ã‚’è¿½åŠ 
    const categoryMarkers = [
        'ã‚ˆã‹ã£ãŸã“ã¨', 'è‰¯ã‹ã£ãŸã“ã¨', 'ã„ã„ã“ã¨',
        'ã‚‚ã£ã¨ã§ãã‚‹ã“ã¨', 'ã‚‚ã£ã¨',
        'æ‚©ã‚“ã§ã‚‹ã“ã¨', 'å¿ƒé…ãªã“ã¨', 'ä¸å®‰ãªã“ã¨',
        'æ˜æ—¥', 'æ˜æ—¥ã¯', 'æ˜æ—¥ã®', 'æ˜æ—¥ã‚„ã‚‹ã“ã¨'
    ];
    
    categoryMarkers.forEach(marker => {
        const pattern = new RegExp(`(ã§ã™|ã—ãŸ|ã ã£ãŸ|ã§ã—ãŸ|ã¾ã™|ã¾ã—ãŸ|ã |ãŸ|ã“ã¨)([^ã€‚])*(${marker})`, 'g');
        processed = processed.replace(pattern, (match, p1, p2, p3) => {
            // æ—¢ã«å¥ç‚¹ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (match.includes('ã€‚')) return match;
            const insertion = `${p1}ã€‚${p2 || ''}${p3}`;
            console.log(`ã‚«ãƒ†ã‚´ãƒªå‰å¥ç‚¹æŒ¿å…¥: "${match}" â†’ "${insertion}"`);
            return insertion;
        });
    });
    
    // 3. éŸ³å£°èªè­˜ç‰¹æœ‰ã®èª¤å¤‰æ›ã‚’ä¿®æ­£
    const corrections = [
        ['å¦»æƒ³', 'æœ€é«˜'],
        ['è©•ä¾¡ã‚’é€²ã‚ã‚‰ã‚ŒãŸ', 'è©•ä¾¡ã‚’ã‚‚ã‚‰ãˆãŸ'],
        ['ã§ã™ã¾ãŸ', 'ã§ã™ã€‚ã¾ãŸ'],
        ['ã“ã¨å¦»æƒ³', 'ã“ã¨æœ€é«˜'],
        ['ã“ã¨ãŒ', 'ã“ã¨ã§']
    ];
    
    corrections.forEach(([wrong, correct]) => {
        if (processed.includes(wrong)) {
            console.log(`èª¤å¤‰æ›ä¿®æ­£: "${wrong}" â†’ "${correct}"`);
            processed = processed.replace(new RegExp(wrong, 'g'), correct);
        }
    });
    
    console.log('å‰å‡¦ç†å¾Œ:', processed);
    console.log('=== å‰å‡¦ç†å®Œäº† ===\n');
    
    return processed;
}

function analyzJournal(text) {
    console.log('\n=== ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«åˆ†æé–‹å§‹ ===');
    
    // å‰å‡¦ç†ã‚’é©ç”¨
    const preprocessed = preprocessVoiceText(text);
    
    const analysis = {
        good: [],
        more: [],
        worry: [],
        task: []
    };

    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ‹¡å¼µç‰ˆï¼‰
    const patterns = {
        good: {
            keywords: [
                'ã‚ˆã‹ã£ãŸ', 'è‰¯ã‹ã£ãŸ', 'ã„ã„', 'è‰¯ã„', 'ã†ã‚Œã—ã„', 'å¬‰ã—ã„',
                'æ¥½ã—ã‹ã£ãŸ', 'æ¥½ã—ã„', 'ãŸã®ã—ã„', 'å¹¸ã›', 'ã—ã‚ã‚ã›',
                'æˆåŠŸ', 'ã§ããŸ', 'é”æˆ', 'é€²ã‚“ã ', 'é †èª¿', 'ã‚„ã£ãŸ',
                'æº€è¶³', 'ã‚ã‚ŠãŒãŸã„', 'æ„Ÿè¬', 'æœ€é«˜', 'ç´ æ™´ã‚‰ã—ã„',
                'å……å®Ÿ', 'ãƒã‚¸ãƒ†ã‚£ãƒ–', 'å‰å‘ã', 'ãŒã‚“ã°ã£ãŸ', 'é ‘å¼µã£ãŸ',
                'è©•ä¾¡', 'ã‚‚ã‚‰ãˆãŸ', 'è¤’ã‚ã‚‰ã‚ŒãŸ', 'èªã‚ã‚‰ã‚ŒãŸ', 'é€€é™¢'
            ],
            verbs: ['ã§ããŸ', 'é€²ã‚“ã ', 'ã‚„ã£ãŸ', 'é”æˆã—ãŸ', 'æˆåŠŸã—ãŸ']
        },
        more: {
            keywords: [
                'ã‚‚ã£ã¨', 'ã•ã‚‰ã«', 'æ”¹å–„', 'ã‚‚ã†å°‘ã—', 'æ¬¡ã¯', 'æ¬¡å›',
                'å·¥å¤«', 'åŠ¹ç‡', 'ã‚ˆã‚Šã‚ˆã', 'å‘ä¸Š', 'ä¼¸ã°ã™', 'ç£¨ã',
                'å¼·åŒ–', 'ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—', 'æˆé•·', 'ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—', 'ç™ºå±•',
                'ã§ãã‚‹ã“ã¨', 'ã‚„ã‚Œã‚‹ã“ã¨', 'å¯èƒ½æ€§', 'ãƒãƒ£ãƒ³ã‚¹'
            ],
            verbs: ['æ”¹å–„ã™ã‚‹', 'å‘ä¸Šã™ã‚‹', 'æˆé•·ã™ã‚‹', 'ç£¨ã', 'ä¼¸ã°ã™']
        },
        worry: {
            keywords: [
                'å¿ƒé…', 'ä¸å®‰', 'æ‚©ã¿', 'å›°ã£ãŸ', 'é›£ã—ã„', 'å¤§å¤‰',
                'ã¤ã‚‰ã„', 'ãã¤ã„', 'ã—ã‚“ã©ã„', 'ã‚¹ãƒˆãƒ¬ã‚¹', 'ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼',
                'ç„¦ã‚Š', 'ã‚¤ãƒ©ã‚¤ãƒ©', 'ã‚‚ã‚„ã‚‚ã‚„', 'æ‚²ã—ã„', 'è½ã¡è¾¼ã‚€',
                'å¾Œæ‚”', 'å¤±æ•—', 'ãƒŸã‚¹', 'ãƒˆãƒ©ãƒ–ãƒ«', 'å•é¡Œ',
                'ã‚ã‹ã‚‰ãªã„', 'ã§ããªã„', 'ã†ã¾ãã„ã‹ãªã„', 'ã‚„ã°ã„'
            ],
            verbs: ['å›°ã‚‹', 'æ‚©ã‚€', 'å¿ƒé…ã™ã‚‹', 'ä¸å®‰ã«ãªã‚‹', 'è½ã¡è¾¼ã‚€']
        },
        task: {
            keywords: [
                'æ˜æ—¥', 'ä»Šå¾Œ', 'ã“ã‚Œã‹ã‚‰', 'æ¬¡', 'äºˆå®š', 'è¨ˆç”»',
                'ã‚„ã‚‹', 'ã™ã‚‹', 'ã—ã‚ˆã†', 'ã‚„ã‚ã†', 'å–ã‚Šçµ„ã‚€', 'é€²ã‚ã‚‹',
                'æº–å‚™', 'å¯¾å¿œ', 'å®Ÿæ–½', 'è¡Œã†', 'å§‹ã‚ã‚‹', 'ã‚¹ã‚¿ãƒ¼ãƒˆ',
                'é ‘å¼µã‚‹', 'ãŒã‚“ã°ã‚‹', 'ãƒˆãƒ©ã‚¤', 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸', 'æŒ‘æˆ¦'
            ],
            verbs: ['ã‚„ã‚‹', 'ã™ã‚‹', 'å–ã‚Šçµ„ã‚€', 'é€²ã‚ã‚‹', 'å§‹ã‚ã‚‹', 'é ‘å¼µã‚‹']
        }
    };

    // å‰å‡¦ç†æ¸ˆã¿ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«åˆ†å‰²
    const sentences = preprocessed
        .split(/[ã€‚ï¼ï¼Ÿ\n]/)
        .filter(s => s.trim().length > 0);
    
    console.log('ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«åˆ†å‰²:', sentences);

    sentences.forEach((sentence, idx) => {
        const trimmed = sentence.trim();
        if (trimmed.length === 0) return;

        console.log(`\n--- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ ${idx + 1}: "${trimmed}" ---`);

        let matched = false;
        let matchedCategories = [];

        // å„ã‚«ãƒ†ã‚´ãƒªã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆè¤‡æ•°ã‚«ãƒ†ã‚´ãƒªå¯¾å¿œï¼‰
        Object.keys(patterns).forEach(category => {
            const pattern = patterns[category];
            const hasKeyword = pattern.keywords.some(kw => trimmed.includes(kw));
            const hasVerb = pattern.verbs && pattern.verbs.some(v => trimmed.includes(v));

            if (hasKeyword || hasVerb) {
                console.log(`  âœ“ ${category}ã«åˆ†é¡ (ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${hasKeyword}, å‹•è©: ${hasVerb})`);
                
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                if (!analysis[category].includes(trimmed)) {
                    analysis[category].push(trimmed);
                    matchedCategories.push(category);
                    matched = true;
                }
            }
        });

        if (!matched) {
            console.log('  â†’ moreã«åˆ†é¡ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰');
            if (!analysis.more.includes(trimmed)) {
                analysis.more.push(trimmed);
            }
        } else {
            console.log(`  â†’ ${matchedCategories.join(', ')}ã«åˆ†é¡`);
        }
    });

    // å„ã‚«ãƒ†ã‚´ãƒªã‚’æœ€å¤§5ä»¶ã«åˆ¶é™
    Object.keys(analysis).forEach(key => {
        if (analysis[key].length > 5) {
            analysis[key] = analysis[key].slice(0, 5);
        }
    });

    console.log('\n=== åˆ†æçµæœ ===');
    console.log('Good:', analysis.good);
    console.log('More:', analysis.more);
    console.log('Worry:', analysis.worry);
    console.log('Task:', analysis.task);
    console.log('=== åˆ†æå®Œäº† ===\n');

    return analysis;
}
        
        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ä¿å­˜
        function addJournal() {
            const input = document.getElementById('journalInput');
            const text = input.value.trim();
            const journalDateInput = document.getElementById('journalDate');
            
            if (!text) {
                showStatus('journalStatus', 'âŒ å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã‚’å–å¾—ï¼ˆæœªé¸æŠã®å ´åˆã¯ä»Šæ—¥ï¼‰
            let selectedDate;
            if (journalDateInput.value) {
                // æ—¥ä»˜å…¥åŠ›ã‹ã‚‰æ—¥ä»˜ã‚’å–å¾—ã—ã€ç¾åœ¨æ™‚åˆ»ã‚’è¨­å®š
                selectedDate = new Date(journalDateInput.value + 'T' + new Date().toTimeString().split(' ')[0]);
            } else {
                selectedDate = new Date();
            }
            
            // è‡ªå‹•è¦ç´„
            const analysis = createManualCategoryAnalysis();
            
            const record = {
                id: Date.now(),
                text: text,
                mood: selectedMood,
                summary: analysis,
                timestamp: selectedDate.toISOString()
            };
            
            // é¸æŠã—ãŸæ—¥ä»˜ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ä¸Šæ›¸ãç¢ºèª
            const targetDateStr = selectedDate.toLocaleDateString('ja-JP');
            const existingIndex = journals.findIndex(j => 
                new Date(j.timestamp).toLocaleDateString('ja-JP') === targetDateStr
            );
            
            if (existingIndex >= 0) {
                if (confirm(`${targetDateStr}ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) {
                    journals[existingIndex] = record;
                } else {
                    return;
                }
            } else {
                journals.unshift(record);
            }
            
            localStorage.setItem('journals', JSON.stringify(journals));
            
            input.value = '';
            clearCategoryVoiceInputs(); // ã‚«ãƒ†ã‚´ãƒªå…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
            journalDateInput.value = ''; // æ—¥ä»˜ã‚’ãƒªã‚»ãƒƒãƒˆ
            // Keep summary visible after save
            
            // æ°—åˆ†é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            selectedMood = 'normal';
            document.querySelectorAll('.mood-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            showStatus('journalStatus', `âœ“ ${targetDateStr}ã®è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
            renderJournalLogs();
            renderCalendar();
        }
        
        // æ—¥ä»˜ã‚’ä»Šæ—¥ã«è¨­å®š
        function setJournalDateToToday() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            document.getElementById('journalDate').value = dateStr;
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
            setJournalDateToToday();
        });
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(elementId, message) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            setTimeout(() => {
                statusEl.textContent = '';
            }, 3000);
        }
        
        // ãƒ­ã‚°è¡¨ç¤ºï¼šè¡Œå‹•
// è¡Œå‹•ãƒ­ã‚°è¡¨ç¤ºï¼ˆç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ä»˜ãï¼‰
function renderActivityLogs() {
    const container = document.getElementById('activityLogs');
    const today = new Date().toLocaleDateString('ja-JP');
    const todayActivities = activities.filter(a => {
        const activityDate = new Date(a.startTime || a.timestamp).toLocaleDateString('ja-JP');
        return activityDate === today;
    });
    
    if (todayActivities.length === 0) {
        container.innerHTML = '<p style="color: #999;">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
    }
    
    container.innerHTML = todayActivities.map(record => {
        const startTime = new Date(record.startTime || record.timestamp);
        const startTimeStr = startTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        
        // ç¶™ç¶šä¸­ã‹ã©ã†ã‹åˆ¤å®š
        const isOngoing = !record.endTime;
        
        let timeDisplay = '';
        let statusBadge = '';
        
        if (isOngoing) {
            // ç¶™ç¶šä¸­ã®å ´åˆ
            const now = new Date();
            const elapsedMinutes = Math.round((now - startTime) / 1000 / 60);
            const hours = Math.floor(elapsedMinutes / 60);
            const minutes = elapsedMinutes % 60;
            const elapsedStr = hours > 0 ? `${hours}æ™‚é–“${minutes}åˆ†` : `${minutes}åˆ†`;
            
            timeDisplay = `${startTimeStr}ã€œ (${elapsedStr}çµŒé)`;
            statusBadge = '<span class="ongoing-badge">ğŸŸ¢ ç¶™ç¶šä¸­</span>';
        } else {
            // çµ‚äº†æ¸ˆã¿ã®å ´åˆ
            const endTime = new Date(record.endTime);
            const endTimeStr = endTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            const durationMinutes = record.durationMinutes || 0;
            const hours = Math.floor(durationMinutes / 60);
            const minutes = durationMinutes % 60;
            const durationStr = hours > 0 ? `${hours}æ™‚é–“${minutes}åˆ†` : `${minutes}åˆ†`;
            
            timeDisplay = `${startTimeStr}ã€œ${endTimeStr} (${durationStr})`;
        }
        
        const categoryBadge = record.category && record.categoryEmoji 
            ? `<span class="category-badge">${record.categoryEmoji} ${record.category}</span>`
            : '';
        
        const actionButtons = isOngoing
            ? `<button onclick="endActivity(${record.id})" class="end-btn">â¹ï¸ çµ‚äº†</button>
               <button onclick="editActivity(${record.id})">âœï¸ ç·¨é›†</button>
               <button onclick="deleteActivity(${record.id})">ğŸ—‘ï¸</button>`
            : `<button onclick="editActivity(${record.id})">âœï¸ ç·¨é›†</button>
               <button onclick="deleteActivity(${record.id})">ğŸ—‘ï¸</button>`;
        
        return `
            <div class="log-item ${isOngoing ? 'ongoing' : ''}">
                <div class="log-header">
                    <strong>${record.text}</strong>
                    ${statusBadge}
                </div>
                <div class="log-info">
                    <span class="time-display">${timeDisplay}</span>
                    ${categoryBadge}
                </div>
                <div class="log-actions">
                    ${actionButtons}
                </div>
            </div>
        `;
    }).join('');
}

// ç¶™ç¶šä¸­ã®è¨˜éŒ²ã‚’å®šæœŸçš„ã«æ›´æ–°ï¼ˆ1åˆ†ã”ã¨ï¼‰
setInterval(() => {
    const hasOngoing = activities.some(a => !a.endTime);
    if (hasOngoing) {
        renderActivityLogs();
    }
}, 60000);


// ç·¨é›†ä¸­ã®è¡Œå‹•ID
let editingActivityId = null;

// è¡Œå‹•ã‚’ç·¨é›†ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ç‰ˆï¼‰
// ãŠé‡‘ç·¨é›†æ©Ÿèƒ½
let editingMoneyId = null;

function editMoney(id) {
    const record = moneyRecords.find(r => r.id === id);
    if (!record) {
        alert('è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    
    editingMoneyId = id;
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ç¾åœ¨ã®å€¤ã‚’è¨­å®š
    document.getElementById('editMoneyText').value = record.text || '';
    document.getElementById('editMoneyAmount').value = record.amount || 0;
    
    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’datetime-localå½¢å¼ã«å¤‰æ›
    if (record.timestamp) {
        const date = new Date(record.timestamp);
        const formatted = formatDateTimeLocal(date);
        document.getElementById('editMoneyTimestamp').value = formatted;
    }
    
    // ã‚«ãƒ†ã‚´ãƒªã‚»ãƒ¬ã‚¯ãƒˆã‚’ç”Ÿæˆ
    const categorySelect = document.getElementById('editMoneyCategory');
    categorySelect.innerHTML = moneyCategories.map(cat => 
        `<option value="${cat.name}" ${record.category === cat.name ? 'selected' : ''}>
            ${cat.emoji} ${cat.name}
        </option>`
    ).join('');
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    document.getElementById('editMoneyModal').style.display = 'flex';
}

function closeEditMoneyModal() {
    document.getElementById('editMoneyModal').style.display = 'none';
    editingMoneyId = null;
}

function saveMoneyEdit() {
    const record = moneyRecords.find(r => r.id === editingMoneyId);
    if (!record) {
        alert('è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    
    const text = document.getElementById('editMoneyText').value.trim();
    const amount = parseFloat(document.getElementById('editMoneyAmount').value);
    const categoryName = document.getElementById('editMoneyCategory').value;
    const timestamp = document.getElementById('editMoneyTimestamp').value;
    
    if (!text) {
        alert('âŒ å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    if (isNaN(amount)) {
        alert('âŒ æœ‰åŠ¹ãªé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    // ã‚«ãƒ†ã‚´ãƒªã®çµµæ–‡å­—ã‚’å–å¾—
    const category = moneyCategories.find(c => c.name === categoryName);
    const categoryEmoji = category ? category.emoji : 'ğŸ’°';
    
    // æ›´æ–°
    record.text = text;
    record.amount = amount;
    record.category = categoryName;
    record.categoryEmoji = categoryEmoji;
    
    if (timestamp) {
        record.timestamp = new Date(timestamp).toISOString();
    }
    
    // ä¿å­˜
    localStorage.setItem('moneyRecords', JSON.stringify(moneyRecords));
    
    // å†æç”»
    renderMoneyLogs();
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    closeEditMoneyModal();
    
    showStatus('moneyStatus', 'âœ“ è¨˜éŒ²ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
}

function deleteMoney(id) {
    if (!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
    }
    
    moneyRecords = moneyRecords.filter(r => r.id !== id);
    localStorage.setItem('moneyRecords', JSON.stringify(moneyRecords));
    renderMoneyLogs();
    showStatus('moneyStatus', 'âœ“ è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}

function formatDateTimeLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}
function editActivity(id) {
    const activity = activities.find(a => a.id === id);
    if (!activity) return;
    
    editingActivityId = id;
    
    // ã‚«ãƒ†ã‚´ãƒªã‚»ãƒ¬ã‚¯ãƒˆã‚’ç”Ÿæˆ
    const categorySelect = document.getElementById('editActivityCategory');
    categorySelect.innerHTML = activityCategories.map((cat, idx) => 
        `<option value="${idx}" ${activity.category === cat.name ? 'selected' : ''}>
            ${cat.emoji} ${cat.name}
        </option>`
    ).join('');
    
    // å†…å®¹ã‚’ã‚»ãƒƒãƒˆ
    document.getElementById('editActivityText').value = activity.text;
    
    // é–‹å§‹æ™‚åˆ»ã‚’ã‚»ãƒƒãƒˆ
    const startTime = new Date(activity.startTime || activity.timestamp);
    document.getElementById('editActivityStartTime').value = formatDateTimeLocal(startTime);
    
    // çµ‚äº†æ™‚åˆ»ã‚’ã‚»ãƒƒãƒˆ
    if (activity.endTime) {
        const endTime = new Date(activity.endTime);
        document.getElementById('editActivityEndTime').value = formatDateTimeLocal(endTime);
    } else {
        document.getElementById('editActivityEndTime').value = '';
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    document.getElementById('editActivityModal').style.display = 'flex';
    
    // æ‰€è¦æ™‚é–“ã‚’æ›´æ–°
    updateDurationDisplay();
}

// æ—¥æ™‚ã‚’datetime-localå½¢å¼ã«å¤‰æ›
function formatDateTimeLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}

// ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeEditActivityModal() {
    document.getElementById('editActivityModal').style.display = 'none';
    editingActivityId = null;
}

// ç·¨é›†ã‚’ä¿å­˜
function saveEditActivity() {
    const activity = activities.find(a => a.id === editingActivityId);
    if (!activity) return;
    
    const text = document.getElementById('editActivityText').value.trim();
    const startTime = document.getElementById('editActivityStartTime').value;
    const endTime = document.getElementById('editActivityEndTime').value;
    const categoryIdx = parseInt(document.getElementById('editActivityCategory').value);
    
    if (!text) {
        alert('âŒ å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    if (!startTime) {
        alert('âŒ é–‹å§‹æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
    activity.text = text;
    activity.category = activityCategories[categoryIdx].name;
    activity.categoryEmoji = activityCategories[categoryIdx].emoji;
    activity.startTime = new Date(startTime).toISOString();
    activity.timestamp = new Date(startTime).toISOString();
    
    if (endTime) {
        activity.endTime = new Date(endTime).toISOString();
        const duration = (new Date(endTime) - new Date(startTime)) / 1000 / 60;
        activity.durationMinutes = Math.max(0, Math.round(duration));
    } else {
        activity.endTime = null;
        activity.durationMinutes = 0;
    }
    
    // ä¿å­˜
    localStorage.setItem('activities', JSON.stringify(activities));
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    closeEditActivityModal();
    
    // å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    renderActivityLogs();
    
    alert('âœ“ ä¿å­˜ã—ã¾ã—ãŸ');
}

// é–‹å§‹æ™‚åˆ»ã«ç¾åœ¨æ™‚åˆ»ã‚’ã‚»ãƒƒãƒˆ
function setCurrentTimeToStart() {
    const now = new Date();
    document.getElementById('editActivityStartTime').value = formatDateTimeLocal(now);
    updateDurationDisplay();
}

// çµ‚äº†æ™‚åˆ»ã«ç¾åœ¨æ™‚åˆ»ã‚’ã‚»ãƒƒãƒˆ
function setCurrentTimeToEnd() {
    const now = new Date();
    document.getElementById('editActivityEndTime').value = formatDateTimeLocal(now);
    updateDurationDisplay();
}

// çµ‚äº†æ™‚åˆ»ã‚’èª¿æ•´
function adjustEndTime(minutes) {
    const endTimeInput = document.getElementById('editActivityEndTime');
    let endTime;
    
    if (endTimeInput.value) {
        endTime = new Date(endTimeInput.value);
    } else {
        const startTime = new Date(document.getElementById('editActivityStartTime').value);
        endTime = new Date(startTime.getTime());
    }
    
    endTime.setMinutes(endTime.getMinutes() + minutes);
    endTimeInput.value = formatDateTimeLocal(endTime);
    
    updateDurationDisplay();
}

// æ‰€è¦æ™‚é–“ã‚’æ›´æ–°
function updateDurationDisplay() {
    const startTime = document.getElementById('editActivityStartTime').value;
    const endTime = document.getElementById('editActivityEndTime').value;
    const durationSpan = document.getElementById('calculatedDuration');
    
    if (!startTime) {
        durationSpan.textContent = '--';
        return;
    }
    
    if (!endTime) {
        durationSpan.textContent = 'ç¶™ç¶šä¸­';
        return;
    }
    
    const start = new Date(startTime);
    const end = new Date(endTime);
    const durationMinutes = Math.round((end - start) / 1000 / 60);
    
    if (durationMinutes < 0) {
        durationSpan.textContent = 'âš ï¸ çµ‚äº†æ™‚åˆ»ãŒé–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå‰ã§ã™';
        durationSpan.style.color = 'red';
    } else {
        const hours = Math.floor(durationMinutes / 60);
        const minutes = durationMinutes % 60;
        
        if (hours > 0) {
            durationSpan.textContent = `${hours}æ™‚é–“${minutes}åˆ†`;
        } else {
            durationSpan.textContent = `${minutes}åˆ†`;
        }
        durationSpan.style.color = '#000';
    }
}

// å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚’ç›£è¦–
document.addEventListener('DOMContentLoaded', () => {
    const startTimeInput = document.getElementById('editActivityStartTime');
    const endTimeInput = document.getElementById('editActivityEndTime');
    
    if (startTimeInput) startTimeInput.addEventListener('input', updateDurationDisplay);
    if (endTimeInput) endTimeInput.addEventListener('input', updateDurationDisplay);
});
        function deleteActivity(id) {
            if (confirm('ã“ã®è¡Œå‹•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                activities = activities.filter(a => a.id !== id);
                localStorage.setItem('activities', JSON.stringify(activities));
                renderActivityLogs();
            }
        }
        
        // ãƒ­ã‚°è¡¨ç¤ºï¼šãŠé‡‘
function renderMoneyLogs() {
    const container = document.getElementById('moneyLogs');
    const today = new Date().toLocaleDateString('ja-JP');
    const todayMoney = moneyRecords.filter(m => 
        new Date(m.timestamp).toLocaleDateString('ja-JP') === today
    );
    
    if (todayMoney.length === 0) {
        container.innerHTML = '<div class="log-item">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
    }
    
    const total = todayMoney.reduce((sum, r) => sum + r.amount, 0);
    
    container.innerHTML = `
        <div class="log-item" style="background: ${total >= 0 ? '#f0f8ff' : '#fff5f5'};">
            <strong>ä»Šæ—¥ã®åæ”¯: Â¥${total.toLocaleString()}</strong>
        </div>
    ` + todayMoney.map(record => {
        const categoryText = record.categoryEmoji ? 
            `${record.categoryEmoji} ${record.category}` : 
            (record.category || '');
        
        return `
            <div class="log-item">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <strong>${record.text}</strong> - Â¥${record.amount.toLocaleString()}
                        ${categoryText ? `<br><span class="category-badge">${categoryText}</span>` : ''}
                        <br>
                        <small>${new Date(record.timestamp).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</small>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn-icon" onclick="editMoney(${record.id})" title="ç·¨é›†">âœï¸</button>
                        <button class="btn-icon" onclick="deleteMoney(${record.id})" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}
        
        // ãƒ­ã‚°è¡¨ç¤ºï¼šä½“é‡
        function renderWeightLogs() {
            const container = document.getElementById('weightLogs');
            if (weightRecords.length === 0) {
                container.innerHTML = '<div class="log-item">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            const recent = weightRecords.slice(0, 10);
            container.innerHTML = recent.map(record => `
                <div class="log-item">
                    <strong>${record.weight} kg</strong>
                    <br>
                    <small>${new Date(record.timestamp).toLocaleString('ja-JP', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'})}</small>
                </div>
            `).join('');
        }
        
        // ãƒ­ã‚°è¡¨ç¤ºï¼šã‚¸ãƒ£ãƒ¼ãƒŠãƒ«
// æ”¹å–„ç‰ˆã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ­ã‚°è¡¨ç¤º
function renderJournalLogs() {
    const container = document.getElementById('journalLogs');
    if (journals.length === 0) {
        container.innerHTML = '<div class="log-item">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
    }
    
    const recent = journals.slice(0, 10);
    container.innerHTML = recent.map(record => {
        const date = new Date(record.timestamp);
        const dateStr = date.toLocaleDateString('ja-JP', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'short'
        });
        
        // æ°—åˆ†ã®çµµæ–‡å­—
        const moodEmojis = {
            'great': 'ğŸ˜Š',
            'good': 'ğŸ™‚',
            'normal': 'ğŸ˜',
            'bad': 'ğŸ˜”',
            'terrible': 'ğŸ˜¢'
        };
        const moodEmoji = moodEmojis[record.mood] || 'ğŸ˜';
        
        // è¦ç´„ã‚’ç”Ÿæˆï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿ç”¨ï¼‰
        const summary = record.summary || analyzJournal(record.text);
        
        // è¦ç´„ãŒç©ºã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        const hasGood = summary.good && summary.good.length > 0;
        const hasMore = summary.more && summary.more.length > 0;
        const hasWorry = summary.worry && summary.worry.length > 0;
        const hasTask = summary.task && summary.task.length > 0;
        
        const hasSummary = hasGood || hasMore || hasWorry || hasTask;
        
        return `
            <div class="journal-log-item">
                <div class="journal-log-header" onclick="toggleJournalDetail('journal-${record.id}')">
                    <div class="journal-date">
                        ${moodEmoji} ${dateStr}
                    </div>
                    <span class="toggle-icon">â–¼</span>
                </div>
                
                ${hasSummary ? `
                <div class="journal-summary-preview">
                    ${hasGood ? `
                        <div class="summary-preview-item">
                            <span class="summary-label-mini">ğŸ˜Š Good</span>
                            <div class="summary-items">
                                ${summary.good.slice(0, 2).map(item => 
                                    `<div class="summary-bullet">â€¢ ${item}</div>`
                                ).join('')}
                                ${summary.good.length > 2 ? 
                                    `<div class="summary-more">ä»–${summary.good.length - 2}ä»¶</div>` 
                                    : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${hasWorry ? `
                        <div class="summary-preview-item">
                            <span class="summary-label-mini">ğŸ¤” æ‚©ã¿</span>
                            <div class="summary-items">
                                ${summary.worry.slice(0, 2).map(item => 
                                    `<div class="summary-bullet">â€¢ ${item}</div>`
                                ).join('')}
                                ${summary.worry.length > 2 ? 
                                    `<div class="summary-more">ä»–${summary.worry.length - 2}ä»¶</div>` 
                                    : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${hasTask ? `
                        <div class="summary-preview-item">
                            <span class="summary-label-mini">âœ… ã‚¿ã‚¹ã‚¯</span>
                            <div class="summary-items">
                                ${summary.task.slice(0, 2).map(item => 
                                    `<div class="summary-bullet">â€¢ ${item}</div>`
                                ).join('')}
                                ${summary.task.length > 2 ? 
                                    `<div class="summary-more">ä»–${summary.task.length - 2}ä»¶</div>` 
                                    : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
                ` : ''}
                
                <div id="journal-${record.id}" class="journal-detail">
                    <div class="journal-full-text">
                        <strong>ğŸ“„ å…¨æ–‡:</strong>
                        <div style="white-space: pre-wrap; margin-top: 10px; line-height: 1.6;">
                            ${record.text}
                        </div>
                    </div>
                    
                    ${hasSummary ? `
                    <div class="journal-full-summary">
                        <strong>ğŸ“ è©³ç´°ãªè¦ç´„:</strong>
                        
                        ${hasGood ? `
                            <div class="summary-detail-section">
                                <div class="summary-detail-label">ğŸ˜Š Goodï¼ˆè‰¯ã‹ã£ãŸã“ã¨ï¼‰</div>
                                ${summary.good.map(item => 
                                    `<div class="summary-detail-item">â€¢ ${item}</div>`
                                ).join('')}
                            </div>
                        ` : ''}
                        
                        ${hasMore ? `
                            <div class="summary-detail-section">
                                <div class="summary-detail-label">ğŸ“ˆ Moreï¼ˆã‚‚ã£ã¨è‰¯ãã§ãã‚‹ã“ã¨ï¼‰</div>
                                ${summary.more.map(item => 
                                    `<div class="summary-detail-item">â€¢ ${item}</div>`
                                ).join('')}
                            </div>
                        ` : ''}
                        
                        ${hasWorry ? `
                            <div class="summary-detail-section">
                                <div class="summary-detail-label">ğŸ¤” æ‚©ã‚“ã§ã„ã‚‹ã“ã¨</div>
                                ${summary.worry.map(item => 
                                    `<div class="summary-detail-item">â€¢ ${item}</div>`
                                ).join('')}
                            </div>
                        ` : ''}
                        
                        ${hasTask ? `
                            <div class="summary-detail-section">
                                <div class="summary-detail-label">âœ… æ˜æ—¥ã®ã‚¿ã‚¹ã‚¯</div>
                                ${summary.task.map(item => 
                                    `<div class="summary-detail-item">â€¢ ${item}</div>`
                                ).join('')}
                            </div>
                        ` : ''}
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function toggleJournalDetail(id) {
    const element = document.getElementById(id);
    const parent = element.closest('.journal-log-item');
    const icon = parent.querySelector('.toggle-icon');
    
    if (element.classList.contains('show')) {
        element.classList.remove('show');
        icon.textContent = 'â–¼';
    } else {
        element.classList.add('show');
        icon.textContent = 'â–²';
    }
}
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º
// ãƒªãƒƒãƒãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½

// åˆæœŸåŒ–: ä»Šæœˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
function initializeReportMonths() {
    const now = new Date();
    const currentMonth = now.toISOString().substring(0, 7); // YYYY-MM
    document.getElementById('activityReportMonth').value = currentMonth;
    document.getElementById('moneyReportMonth').value = currentMonth;
}

// è¡Œå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
function generateActivityReport() {
    const month = document.getElementById('activityReportMonth').value;
    if (!month) {
        alert('æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    const [year, monthNum] = month.split('-');
    const startDate = new Date(year, monthNum - 1, 1);
    const endDate = new Date(year, monthNum, 0, 23, 59, 59);
    
    // æœŸé–“å†…ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    const filteredActivities = activities.filter(a => {
        const actDate = new Date(a.timestamp);
        return actDate >= startDate && actDate <= endDate;
    });
    
    if (filteredActivities.length === 0) {
        document.getElementById('activityReportContent').innerHTML = '<p style="text-align:center; color:#999;">ã“ã®æœŸé–“ã«è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        document.getElementById('activityChartCanvas').style.display = 'none';
        return;
    }
    
    // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«é›†è¨ˆ
    const categoryData = {};
    
    filteredActivities.forEach(activity => {
        const cat = activity.category || 'æœªåˆ†é¡';
        const emoji = activity.categoryEmoji || 'ğŸ“‹';
        
        if (!categoryData[cat]) {
            categoryData[cat] = {
                emoji: emoji,
                totalMinutes: 0,
                count: 0,
                details: []
            };
        }
        
        // æ‰€è¦æ™‚é–“è¨ˆç®—
        let minutes = 0;
        if (activity.endTime && activity.startTime) {
            const start = new Date(activity.startTime);
            const end = new Date(activity.endTime);
            minutes = Math.round((end - start) / 60000);
        }
        
        categoryData[cat].totalMinutes += minutes;
        categoryData[cat].count += 1;
        categoryData[cat].details.push({
            text: activity.text,
            startTime: activity.startTime,
            endTime: activity.endTime,
            minutes: minutes
        });
    });
    
    // HTMLç”Ÿæˆ
    let html = '';
    let totalMinutes = 0;
    let totalCount = 0;
    
    const sortedCategories = Object.keys(categoryData).sort((a, b) => 
        categoryData[b].totalMinutes - categoryData[a].totalMinutes
    );
    
    sortedCategories.forEach(cat => {
        const data = categoryData[cat];
        const hours = Math.floor(data.totalMinutes / 60);
        const mins = data.totalMinutes % 60;
        
        totalMinutes += data.totalMinutes;
        totalCount += data.count;
        
        html += `
            <div class="category-summary" onclick="toggleCategoryDetail('activity-${cat}')">
                <div class="category-header">
                    <span>${data.emoji} ${cat}</span>
                    <span>â–¼</span>
                </div>
                <div class="category-stats">
                    <span>â±ï¸ ${hours}æ™‚é–“${mins}åˆ†</span>
                    <span>ğŸ“ ${data.count}å›</span>
                </div>
                <div id="activity-${cat}" class="category-details">
                    ${data.details.sort((a, b) => new Date(b.startTime) - new Date(a.startTime)).map(detail => {
                        const start = detail.startTime ? new Date(detail.startTime).toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-';
                        const end = detail.endTime ? new Date(detail.endTime).toLocaleString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : 'ç¶™ç¶šä¸­';
                        const durationText = detail.endTime ? `${Math.floor(detail.minutes / 60)}æ™‚é–“${detail.minutes % 60}åˆ†` : 'ç¶™ç¶šä¸­';
                        
                        return `
                            <div class="detail-item">
                                <strong>${detail.text}</strong>
                                <div>${start} ã€œ ${end} (${durationText})</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    });
    
    const totalHours = Math.floor(totalMinutes / 60);
    const totalMins = totalMinutes % 60;
    
    html = `
        <div class="total-summary">
            ğŸ“Š åˆè¨ˆ: ${totalHours}æ™‚é–“${totalMins}åˆ† / ${totalCount}å›ã®è¨˜éŒ²
        </div>
    ` + html;
    
    document.getElementById('activityReportContent').innerHTML = html;
    
    // ã‚°ãƒ©ãƒ•æç”»
    drawActivityChart(categoryData);
}

// ãŠé‡‘ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
// ä»Šæœˆã®ç›®æ¨™æ©Ÿèƒ½
let monthlyGoals = JSON.parse(localStorage.getItem('monthlyGoals')) || [];

function addGoal() {
    const input = document.getElementById('goalInput');
    const categorySelect = document.getElementById('goalCategory');
    const text = input.value.trim();
    const category = categorySelect.value;
    
    if (!text) {
        showStatus('goalStatus', 'âŒ ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    const goal = {
        id: Date.now(),
        text: text,
        category: category,
        createdAt: new Date().toISOString(),
        month: new Date().toISOString().substring(0, 7), // YYYY-MM
        completed: false
    };
    
    monthlyGoals.unshift(goal);
    localStorage.setItem('monthlyGoals', JSON.stringify(monthlyGoals));
    
    input.value = '';
    renderGoals();
    showStatus('goalStatus', 'âœ“ ç›®æ¨™ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}

function toggleGoalComplete(id) {
    const goal = monthlyGoals.find(g => g.id === id);
    if (goal) {
        goal.completed = !goal.completed;
        localStorage.setItem('monthlyGoals', JSON.stringify(monthlyGoals));
        renderGoals();
        generateGoalsFeedback();
    }
}

function deleteGoal(id) {
    if (!confirm('ã“ã®ç›®æ¨™ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    monthlyGoals = monthlyGoals.filter(g => g.id !== id);
    localStorage.setItem('monthlyGoals', JSON.stringify(monthlyGoals));
    renderGoals();
    showStatus('goalStatus', 'âœ“ ç›®æ¨™ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}

function renderGoals() {
    const container = document.getElementById('goalsList');
    const currentMonth = new Date().toISOString().substring(0, 7);
    const currentGoals = monthlyGoals.filter(g => g.month === currentMonth);
    
    if (currentGoals.length === 0) {
        container.innerHTML = '<div class="empty-state">ä»Šæœˆã®ç›®æ¨™ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        renderGoalsProgress();
        return;
    }
    
    container.innerHTML = currentGoals.map(goal => {
        const categoryEmoji = {
            'å¥åº·': 'ğŸ’ª', 'ä»•äº‹': 'ğŸ’¼', 'å‹‰å¼·': 'ğŸ“š',
            'è¶£å‘³': 'ğŸ¨', 'äººé–“é–¢ä¿‚': 'ğŸ‘¥', 'ãŠé‡‘': 'ğŸ’°', 'ãã®ä»–': 'ğŸ“Œ'
        }[goal.category] || 'ğŸ“Œ';
        
        return `
            <div class="goal-item ${goal.completed ? 'completed' : ''}">
                <div class="goal-header">
                    <input type="checkbox" 
                           ${goal.completed ? 'checked' : ''} 
                           onchange="toggleGoalComplete(${goal.id})"
                           class="goal-checkbox" />
                    <span class="goal-text">${goal.text}</span>
                </div>
                <div class="goal-meta">
                    <span class="goal-category">${categoryEmoji} ${goal.category}</span>
                    <button class="btn-icon" onclick="deleteGoal(${goal.id})" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                </div>
            </div>
        `;
    }).join('');
    
    renderGoalsProgress();
}

function renderGoalsProgress() {
    const container = document.getElementById('goalsProgress');
    const currentMonth = new Date().toISOString().substring(0, 7);
    const currentGoals = monthlyGoals.filter(g => g.month === currentMonth);
    
    if (currentGoals.length === 0) {
        container.innerHTML = '<div class="empty-state">ç›®æ¨™ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>';
        return;
    }
    
    const completed = currentGoals.filter(g => g.completed).length;
    const total = currentGoals.length;
    const percentage = Math.round((completed / total) * 100);
    
    // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®é”æˆçŠ¶æ³
    const categoryStats = {};
    currentGoals.forEach(goal => {
        if (!categoryStats[goal.category]) {
            categoryStats[goal.category] = { total: 0, completed: 0 };
        }
        categoryStats[goal.category].total++;
        if (goal.completed) {
            categoryStats[goal.category].completed++;
        }
    });
    
    let html = `
        <div class="progress-summary">
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${percentage}%"></div>
            </div>
            <div class="progress-text">
                ${completed} / ${total} é”æˆ (${percentage}%)
            </div>
        </div>
        
        <div class="category-progress">
            <h4>ã‚«ãƒ†ã‚´ãƒªåˆ¥é”æˆçŠ¶æ³</h4>
            ${Object.entries(categoryStats).map(([category, stats]) => {
                const catEmoji = {
                    'å¥åº·': 'ğŸ’ª', 'ä»•äº‹': 'ğŸ’¼', 'å‹‰å¼·': 'ğŸ“š',
                    'è¶£å‘³': 'ğŸ¨', 'äººé–“é–¢ä¿‚': 'ğŸ‘¥', 'ãŠé‡‘': 'ğŸ’°', 'ãã®ä»–': 'ğŸ“Œ'
                }[category] || 'ğŸ“Œ';
                const catPercentage = Math.round((stats.completed / stats.total) * 100);
                
                return `
                    <div class="category-stat">
                        <span>${catEmoji} ${category}</span>
                        <span>${stats.completed}/${stats.total} (${catPercentage}%)</span>
                    </div>
                `;
            }).join('')}
        </div>
    `;
    
    container.innerHTML = html;
}

function generateGoalsFeedback() {
    const currentMonth = new Date().toISOString().substring(0, 7);
    const currentGoals = monthlyGoals.filter(g => g.month === currentMonth);
    
    if (currentGoals.length === 0) {
        document.getElementById('goalsFeedback').innerHTML = 
            '<p>ç›®æ¨™ã‚’è¨­å®šã™ã‚‹ã¨ã€AIãŒãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã—ã¾ã™ã€‚</p>';
        return;
    }
    
    // ä»Šæœˆã®è¡Œå‹•è¨˜éŒ²ã‚’å–å¾—
    const [year, month] = currentMonth.split('-');
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0, 23, 59, 59);
    
    const monthActivities = activities.filter(a => {
        const actDate = new Date(a.timestamp);
        return actDate >= startDate && actDate <= endDate;
    });
    
    // ä»Šæœˆã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’å–å¾—
    const monthJournals = journals.filter(j => {
        const jDate = new Date(j.timestamp);
        return jDate >= startDate && jDate <= endDate;
    });
    
    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”Ÿæˆ
    let feedback = '<div class="feedback-content">';
    
    // å…¨ä½“çš„ãªé”æˆåº¦
    const completed = currentGoals.filter(g => g.completed).length;
    const total = currentGoals.length;
    const percentage = Math.round((completed / total) * 100);
    
    if (percentage >= 80) {
        feedback += `<p>ğŸ‰ <strong>ç´ æ™´ã‚‰ã—ã„ï¼</strong> ${percentage}%ã®ç›®æ¨™ã‚’é”æˆã—ã¦ã„ã¾ã™ã€‚ã“ã®èª¿å­ã§é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼</p>`;
    } else if (percentage >= 50) {
        feedback += `<p>ğŸ‘ <strong>è‰¯ã„ãƒšãƒ¼ã‚¹ã§ã™ï¼</strong> ${percentage}%ã®ç›®æ¨™ã‚’é”æˆæ¸ˆã¿ã€‚æ®‹ã‚Šã®ç›®æ¨™ã‚‚é”æˆã§ãã‚‹ã‚ˆã†é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚</p>`;
    } else if (percentage >= 20) {
        feedback += `<p>ğŸ’ª <strong>ã¾ã æ™‚é–“ãŒã‚ã‚Šã¾ã™ï¼</strong> ${percentage}%ã®é”æˆç‡ã€‚æ®‹ã‚Šã®æ—¥æ•°ã§ç›®æ¨™é”æˆã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚</p>`;
    } else {
        feedback += `<p>âš ï¸ <strong>ãƒšãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ãŒå¿…è¦ã§ã™</strong> ç¾åœ¨ã®é”æˆç‡ã¯${percentage}%ã§ã™ã€‚ç›®æ¨™ã‚’è¦‹ç›´ã™ã‹ã€è¡Œå‹•ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ã€‚</p>`;
    }
    
    // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®åˆ†æ
    currentGoals.forEach(goal => {
        if (goal.completed) return;
        
        const relatedActivities = monthActivities.filter(a => 
            a.category === goal.category || 
            a.text.toLowerCase().includes(goal.text.toLowerCase().split(' ')[0])
        );
        
        const relatedJournals = monthJournals.filter(j =>
            j.text.toLowerCase().includes(goal.text.toLowerCase().split(' ')[0]) ||
            j.text.toLowerCase().includes(goal.category.toLowerCase())
        );
        
        if (relatedActivities.length > 0) {
            feedback += `<p>ğŸ“Š <strong>${goal.category}ã®ç›®æ¨™ã€Œ${goal.text}ã€</strong><br>`;
            feedback += `ä»Šæœˆ${relatedActivities.length}å›ã®é–¢é€£ã™ã‚‹è¡Œå‹•ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚ç¶™ç¶šã—ã¦å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã­ï¼</p>`;
        } else if (relatedJournals.length > 0) {
            feedback += `<p>ğŸ“ <strong>${goal.category}ã®ç›®æ¨™ã€Œ${goal.text}ã€</strong><br>`;
            feedback += `ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã«${relatedJournals.length}å›è¨€åŠã•ã‚Œã¦ã„ã¾ã™ã€‚å®Ÿéš›ã®è¡Œå‹•ã«ç§»ã›ã‚‹ã¨ã•ã‚‰ã«è‰¯ã„ã§ã—ã‚‡ã†ã€‚</p>`;
        } else {
            feedback += `<p>ğŸ’¡ <strong>${goal.category}ã®ç›®æ¨™ã€Œ${goal.text}ã€</strong><br>`;
            feedback += `ã¾ã é–¢é€£ã™ã‚‹è¡Œå‹•ã‚„ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä»Šæ—¥ã‹ã‚‰å§‹ã‚ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>`;
        }
    });
    
    // ãƒã‚¸ãƒ†ã‚£ãƒ–ãªã‚¸ãƒ£ãƒ¼ãƒŠãƒ«åˆ†æ
    const positiveJournals = monthJournals.filter(j => 
        j.mood && ['æœ€é«˜', 'è‰¯ã„'].includes(j.mood)
    );
    
    if (positiveJournals.length > 0) {
        feedback += `<p>ğŸ˜Š <strong>ãƒ¡ãƒ³ã‚¿ãƒ«é¢</strong><br>`;
        feedback += `ä»Šæœˆ${positiveJournals.length}æ—¥ã€è‰¯ã„æ°—åˆ†ã®æ—¥ãŒã‚ã‚Šã¾ã—ãŸã€‚ãƒã‚¸ãƒ†ã‚£ãƒ–ãªçŠ¶æ…‹ã‚’ä¿ã¦ã¦ã„ã¾ã™ã­ï¼</p>`;
    }
    
    // æ”¹å–„ææ¡ˆ
    const incompleteGoals = currentGoals.filter(g => !g.completed);
    if (incompleteGoals.length > 0) {
        feedback += `<p>ğŸ’ª <strong>ä»Šå¾Œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ææ¡ˆ</strong><br><ul style="margin-top: 10px;">`;
        incompleteGoals.slice(0, 3).forEach(goal => {
            feedback += `<li>ã€Œ${goal.text}ã€ã®ãŸã‚ã«ã€ä»Šæ—¥ã‹ã‚‰å…·ä½“çš„ãªè¡Œå‹•ã‚’1ã¤å§‹ã‚ã¾ã—ã‚‡ã†</li>`;
        });
        feedback += `</ul></p>`;
    }
    
    feedback += '</div>';
    
    document.getElementById('goalsFeedback').innerHTML = feedback;
}
function generateMoneyReport() {
    const month = document.getElementById('moneyReportMonth').value;
    if (!month) {
        alert('æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    const [year, monthNum] = month.split('-');
    const startDate = new Date(year, monthNum - 1, 1);
    const endDate = new Date(year, monthNum, 0, 23, 59, 59);
    
    // æœŸé–“å†…ã®è¨˜éŒ²ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    const filteredRecords = moneyRecords.filter(r => {
        const recDate = new Date(r.timestamp);
        return recDate >= startDate && recDate <= endDate;
    });
    
    if (filteredRecords.length === 0) {
        document.getElementById('moneyReportContent').innerHTML = '<p style="text-align:center; color:#999;">ã“ã®æœŸé–“ã«è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        document.getElementById('moneyChartCanvas').style.display = 'none';
        return;
    }
    
    // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«é›†è¨ˆ
    const categoryData = {};
    
    filteredRecords.forEach(record => {
        const cat = record.category || 'æœªåˆ†é¡';
        const emoji = record.categoryEmoji || 'ğŸ’°';
        
        if (!categoryData[cat]) {
            categoryData[cat] = {
                emoji: emoji,
                totalIncome: 0,
                totalExpense: 0,
                count: 0,
                details: []
            };
        }
        
        if (record.amount > 0) {
            categoryData[cat].totalIncome += record.amount;
        } else {
            categoryData[cat].totalExpense += Math.abs(record.amount);
        }
        
        categoryData[cat].count += 1;
        categoryData[cat].details.push({
            text: record.text,
            amount: record.amount,
            timestamp: record.timestamp
        });
    });
    
    // HTMLç”Ÿæˆ
    let html = '';
    let totalIncome = 0;
    let totalExpense = 0;
    let totalCount = 0;
    
    const sortedCategories = Object.keys(categoryData).sort((a, b) => 
        categoryData[b].totalExpense - categoryData[a].totalExpense
    );
    
    sortedCategories.forEach(cat => {
        const data = categoryData[cat];
        
        totalIncome += data.totalIncome;
        totalExpense += data.totalExpense;
        totalCount += data.count;
        
        html += `
            <div class="category-summary" onclick="toggleCategoryDetail('money-${cat}')">
                <div class="category-header">
                    <span>${data.emoji} ${cat}</span>
                    <span>â–¼</span>
                </div>
                <div class="category-stats">
                    ${data.totalIncome > 0 ? `<span style="color:green;">ğŸ’° åå…¥ Â¥${data.totalIncome.toLocaleString()}</span>` : ''}
                    ${data.totalExpense > 0 ? `<span style="color:red;">ğŸ’¸ æ”¯å‡º Â¥${data.totalExpense.toLocaleString()}</span>` : ''}
                    <span>ğŸ“ ${data.count}å›</span>
                </div>
                <div id="money-${cat}" class="category-details">
                    ${data.details.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(detail => {
                        const date = new Date(detail.timestamp).toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        const amountText = detail.amount > 0 ? 
                            `<span style="color:green;">+Â¥${detail.amount.toLocaleString()}</span>` : 
                            `<span style="color:red;">-Â¥${Math.abs(detail.amount).toLocaleString()}</span>`;
                        
                        return `
                            <div class="detail-item">
                                <strong>${detail.text}</strong>
                                <div>${date} / ${amountText}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    });
    
    html = `
        <div class="total-summary">
            ğŸ’° åå…¥: Â¥${totalIncome.toLocaleString()} | ğŸ’¸ æ”¯å‡º: Â¥${totalExpense.toLocaleString()} | ğŸ“Š ${totalCount}å›ã®è¨˜éŒ²
            <div style="margin-top:10px; font-size:1.2em;">
                ${totalIncome - totalExpense >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'} åæ”¯: Â¥${(totalIncome - totalExpense).toLocaleString()}
            </div>
        </div>
    ` + html;
    
    document.getElementById('moneyReportContent').innerHTML = html;
    
    // ã‚°ãƒ©ãƒ•æç”»
    drawMoneyChart(categoryData);
}

// è©³ç´°è¡¨ç¤ºãƒˆã‚°ãƒ«
function toggleCategoryDetail(id) {
    const element = document.getElementById(id);
    if (element) {
        element.classList.toggle('show');
    }
}

// è¡Œå‹•ã‚°ãƒ©ãƒ•æç”»
function drawActivityChart(categoryData) {
    const canvas = document.getElementById('activityChartCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.style.display = 'block';
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const categories = Object.keys(categoryData);
    if (categories.length === 0) return;
    
    const totalMinutes = categories.reduce((sum, cat) => sum + categoryData[cat].totalMinutes, 0);
    if (totalMinutes === 0) return;
    
    // å††ã‚°ãƒ©ãƒ•æç”»
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = Math.min(centerX, centerY) - 40;
    
    const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
    ];
    
    let currentAngle = -Math.PI / 2;
    
    categories.forEach((cat, index) => {
        const data = categoryData[cat];
        const sliceAngle = (data.totalMinutes / totalMinutes) * 2 * Math.PI;
        
        // æ‰‡å½¢æç”»
        ctx.fillStyle = colors[index % colors.length];
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fill();
        
        // ãƒ©ãƒ™ãƒ«
        const labelAngle = currentAngle + sliceAngle / 2;
        const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
        const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
        
        const hours = Math.floor(data.totalMinutes / 60);
        const mins = data.totalMinutes % 60;
        
        ctx.fillStyle = '#000';
        ctx.font = 'bold 12px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(`${data.emoji}`, labelX, labelY - 10);
        ctx.font = '11px sans-serif';
        ctx.fillText(`${hours}h${mins}m`, labelX, labelY + 10);
        
        currentAngle += sliceAngle;
    });
}

// ãŠé‡‘ã‚°ãƒ©ãƒ•æç”»
function drawMoneyChart(categoryData) {
    const canvas = document.getElementById('moneyChartCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.style.display = 'block';
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const categories = Object.keys(categoryData);
    if (categories.length === 0) return;
    
    const totalExpense = categories.reduce((sum, cat) => sum + categoryData[cat].totalExpense, 0);
    if (totalExpense === 0) return;
    
    // å††ã‚°ãƒ©ãƒ•æç”»
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = Math.min(centerX, centerY) - 40;
    
    const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
    ];
    
    let currentAngle = -Math.PI / 2;
    
    categories.forEach((cat, index) => {
        const data = categoryData[cat];
        if (data.totalExpense === 0) return;
        
        const sliceAngle = (data.totalExpense / totalExpense) * 2 * Math.PI;
        
        // æ‰‡å½¢æç”»
        ctx.fillStyle = colors[index % colors.length];
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fill();
        
        // ãƒ©ãƒ™ãƒ«
        const labelAngle = currentAngle + sliceAngle / 2;
        const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
        const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
        
        ctx.fillStyle = '#000';
        ctx.font = 'bold 12px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(`${data.emoji}`, labelX, labelY - 10);
        ctx.font = '11px sans-serif';
        ctx.fillText(`Â¥${Math.round(data.totalExpense / 1000)}k`, labelX, labelY + 10);
        
        currentAngle += sliceAngle;
    });
}
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            document.getElementById('calendarMonth').textContent = 
                `${year}å¹´ ${month + 1}æœˆ`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            let html = '';
            ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            for (let date = 1; date <= lastDate; date++) {
                const currentDate = new Date(year, month, date);
                const dateStr = currentDate.toLocaleDateString('ja-JP');
                
                // ãã®æ—¥ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’å–å¾—
                const journal = journals.find(j => 
                    new Date(j.timestamp).toLocaleDateString('ja-JP') === dateStr
                );
                const hasJournal = !!journal;
                
                const isToday = 
                    today.getFullYear() === year &&
                    today.getMonth() === month &&
                    today.getDate() === date;
                
                let className = 'calendar-day';
                if (isToday) className += ' today';
                if (hasJournal) className += ' has-journal';
                
                // æ°—åˆ†çµµæ–‡å­—ã‚’è¿½åŠ 
                let moodEmoji = '';
                if (journal && journal.mood) {
                    moodEmoji = `<div class="calendar-day-mood">${moodEmojis[journal.mood]}</div>`;
                }
                
                html += `<div class="${className}" onclick="viewJournalByDate('${dateStr}')">${date}${moodEmoji}</div>`;
            }
            
            document.getElementById('calendar').innerHTML = html;
        }
        
        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }
        
        function viewJournalByDate(dateStr) {
            const journal = journals.find(j => 
                new Date(j.timestamp).toLocaleDateString('ja-JP') === dateStr
            );
            
            if (journal) {
                const moodText = journal.mood ? `\n\næ°—åˆ†: ${moodEmojis[journal.mood]}` : '';
                alert(`${dateStr}ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«:${moodText}\n\n${journal.text}`);
            } else {
                alert(`${dateStr}ã«ã¯ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`);
            }
        }
        
        // ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
        function renderReports() {
            // çµ±è¨ˆ
            document.getElementById('totalActivities').textContent = activities.length;
            
            const totalMoney = moneyRecords.reduce((sum, r) => sum + r.amount, 0);
            document.getElementById('totalMoney').textContent = `Â¥${totalMoney.toLocaleString()}`;
            
            document.getElementById('totalJournals').textContent = journals.length;
            
            if (weightRecords.length > 0) {
                const avgWeight = weightRecords.reduce((sum, r) => sum + r.weight, 0) / weightRecords.length;
                document.getElementById('avgWeight').textContent = avgWeight.toFixed(1) + ' kg';
            }
            
            // è¡Œå‹•ãƒãƒ£ãƒ¼ãƒˆ
            renderActivityChart();
            
            // æ°—åˆ†ãƒãƒ£ãƒ¼ãƒˆ
            renderMoodChart();
            
            // ãŠé‡‘ãƒãƒ£ãƒ¼ãƒˆ
            renderMoneyChart();
            
            // ä½“é‡ãƒãƒ£ãƒ¼ãƒˆ
            renderWeightChart();
            
            // AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            renderAIFeedback();
        }
        
        function renderActivityChart() {
            const ctx = document.getElementById('activityChart');
            if (!ctx) return;
            
            const categoryCounts = {};
            activityCategories.forEach(cat => {
                categoryCounts[cat.name] = activities.filter(a => a.text.includes(cat.name)).length;
            });
            
            if (window.activityChartInstance) {
                window.activityChartInstance.destroy();
            }
            
            window.activityChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(categoryCounts),
                    datasets: [{
                        label: 'å›æ•°',
                        data: Object.values(categoryCounts),
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        borderColor: 'rgba(0, 0, 0, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        function renderMoodChart() {
            const ctx = document.getElementById('moodChart');
            if (!ctx) return;
            
            // æ°—åˆ†ã®ã‚«ã‚¦ãƒ³ãƒˆ
            const moodCounts = {
                great: 0,
                good: 0,
                normal: 0,
                bad: 0,
                terrible: 0
            };
            
            journals.forEach(j => {
                if (j.mood && moodCounts.hasOwnProperty(j.mood)) {
                    moodCounts[j.mood]++;
                }
            });
            
            const moodLabels = {
                great: 'ğŸ˜Š æœ€é«˜',
                good: 'ğŸ™‚ è‰¯ã„',
                normal: 'ğŸ˜ æ™®é€š',
                bad: 'ğŸ˜” æ‚ªã„',
                terrible: 'ğŸ˜¢ æœ€æ‚ª'
            };
            
            if (window.moodChartInstance) {
                window.moodChartInstance.destroy();
            }
            
            window.moodChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(moodCounts).map(k => moodLabels[k]),
                    datasets: [{
                        data: Object.values(moodCounts),
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.8)',   // great - green
                            'rgba(139, 195, 74, 0.8)',  // good - light green
                            'rgba(158, 158, 158, 0.8)', // normal - grey
                            'rgba(255, 152, 0, 0.8)',   // bad - orange
                            'rgba(244, 67, 54, 0.8)'    // terrible - red
                        ],
                        borderColor: [
                            'rgba(76, 175, 80, 1)',
                            'rgba(139, 195, 74, 1)',
                            'rgba(158, 158, 158, 1)',
                            'rgba(255, 152, 0, 1)',
                            'rgba(244, 67, 54, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function renderMoneyChart() {
            const ctx = document.getElementById('moneyChart');
            if (!ctx) return;
            
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last7Days.push(date.toLocaleDateString('ja-JP', {month: 'short', day: 'numeric'}));
            }
            
            const data = last7Days.map(dateStr => {
                const dayRecords = moneyRecords.filter(r => {
                    const recordDate = new Date(r.timestamp).toLocaleDateString('ja-JP', {month: 'short', day: 'numeric'});
                    return recordDate === dateStr;
                });
                return dayRecords.reduce((sum, r) => sum + r.amount, 0);
            });
            
            if (window.moneyChartInstance) {
                window.moneyChartInstance.destroy();
            }
            
            window.moneyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'åæ”¯ï¼ˆå††ï¼‰',
                        data: data,
                        borderColor: 'rgba(0, 0, 0, 1)',
                        backgroundColor: 'rgba(0, 0, 0, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }
        
        function renderWeightChart() {
            const ctx = document.getElementById('weightChart');
            if (!ctx) return;
            
            const recent = weightRecords.slice(0, 10).reverse();
            
            if (window.weightChartInstance) {
                window.weightChartInstance.destroy();
            }
            
            window.weightChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: recent.map(r => new Date(r.timestamp).toLocaleDateString('ja-JP', {month: 'short', day: 'numeric'})),
                    datasets: [{
                        label: 'ä½“é‡ï¼ˆkgï¼‰',
                        data: recent.map(r => r.weight),
                        borderColor: 'rgba(0, 0, 0, 1)',
                        backgroundColor: 'rgba(0, 0, 0, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }
        
        
        // AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”Ÿæˆ
        function renderAIFeedback() {
            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);
            
            const recentActivities = activities.filter(a => new Date(a.timestamp) >= sevenDaysAgo);
            const recentJournals = journals.filter(j => new Date(j.timestamp) >= sevenDaysAgo);
            const recentMoney = moneyRecords.filter(m => new Date(m.timestamp) >= sevenDaysAgo);
            
            const recordedDates = new Set();
            [...recentActivities, ...recentJournals, ...recentMoney].forEach(record => {
                const date = new Date(record.timestamp).toLocaleDateString('ja-JP');
                recordedDates.add(date);
            });
            
            const recordedDays = recordedDates.size;
            
            const categoryCounts = {};
            activityCategories.forEach(cat => {
                categoryCounts[cat.name] = recentActivities.filter(a => 
                    a.text.includes(cat.name)
                ).length;
            });
            
            const topCategories = Object.entries(categoryCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .filter(([, count]) => count > 0);
            
            // æ™‚é–“çµ±è¨ˆã‚’è¿½åŠ 
            const totalMinutes = recentActivities.reduce((sum, a) => sum + (a.durationMinutes || 0), 0);
            const totalHours = Math.floor(totalMinutes / 60);
            const remainingMinutes = totalMinutes % 60;
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®æ™‚é–“çµ±è¨ˆ
            const categoryTimes = {};
            activityCategories.forEach(cat => {
                const categoryActivities = recentActivities.filter(a => a.text.includes(cat.name));
                const categoryMinutes = categoryActivities.reduce((sum, a) => sum + (a.durationMinutes || 0), 0);
                if (categoryMinutes > 0) {
                    categoryTimes[cat.name] = {
                        emoji: cat.emoji,
                        hours: Math.floor(categoryMinutes / 60),
                        minutes: categoryMinutes % 60
                    };
                }
            });
            
            const moodCounts = {
                great: 0, good: 0, normal: 0, bad: 0, terrible: 0
            };
            
            recentJournals.forEach(j => {
                if (j.mood && moodCounts.hasOwnProperty(j.mood)) {
                    moodCounts[j.mood]++;
                }
            });
            
            const totalMoods = Object.values(moodCounts).reduce((sum, count) => sum + count, 0);
            const positiveMoods = moodCounts.great + moodCounts.good;
            const negativeMoods = moodCounts.bad + moodCounts.terrible;
            
            const totalIncome = recentMoney.filter(m => m.amount > 0).reduce((sum, m) => sum + m.amount, 0);
            const totalExpense = recentMoney.filter(m => m.amount < 0).reduce((sum, m) => sum + m.amount, 0);
            const balance = totalIncome + totalExpense;
            
            let advice = [];
            
            // æ™‚é–“çµ±è¨ˆã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¿½åŠ 
            if (totalMinutes > 0) {
                if (totalHours > 0) {
                    advice.push(`â±ï¸ ä»Šé€±ã¯åˆè¨ˆ ${totalHours}æ™‚é–“${remainingMinutes > 0 ? remainingMinutes + 'åˆ†' : ''}ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼`);
                } else {
                    advice.push(`â±ï¸ ä»Šé€±ã¯åˆè¨ˆ ${remainingMinutes}åˆ†ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼`);
                }
            }
            
            if (recordedDays >= 5) {
                advice.push('ğŸ“Š ç´ æ™´ã‚‰ã—ã„ï¼ä»Šé€±ã¯' + recordedDays + 'æ—¥é–“è¨˜éŒ²ã‚’ç¶šã‘ã¦ã„ã¾ã™ã€‚ç¶™ç¶šã¯åŠ›ãªã‚Šã§ã™ã­ï¼');
            } else if (recordedDays >= 3) {
                advice.push('ğŸ“Š ä»Šé€±ã¯' + recordedDays + 'æ—¥é–“è¨˜éŒ²ã—ã¾ã—ãŸã€‚ã‚ã¨å°‘ã—ã§æ¯æ—¥è¨˜éŒ²é”æˆã§ã™ï¼');
            } else {
                advice.push('ğŸ“Š ä»Šé€±ã®è¨˜éŒ²ã¯' + recordedDays + 'æ—¥é–“ã§ã™ã€‚æ¯æ—¥å°‘ã—ãšã¤è¨˜éŒ²ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼');
            }
            
            if (topCategories.length > 0) {
                const topActivity = topCategories[0];
                advice.push('ğŸ¯ ä»Šé€±ã¯ã€Œ' + topActivity[0] + 'ã€ã‚’' + topActivity[1] + 'å›è¨˜éŒ²ã—ã¾ã—ãŸã€‚ç´ æ™´ã‚‰ã—ã„ï¼');
            }
            
            if (totalMoods > 0) {
                const positiveRate = Math.round((positiveMoods / totalMoods) * 100);
                if (positiveRate >= 70) {
                    advice.push('ğŸ˜Š ä»Šé€±ã®æ°—åˆ†ã¯ç´ æ™´ã‚‰ã—ã„ï¼' + positiveRate + '%ãŒãƒã‚¸ãƒ†ã‚£ãƒ–ãªæ°—åˆ†ã§ã—ãŸã€‚');
                } else if (positiveRate >= 50) {
                    advice.push('ğŸ™‚ ä»Šé€±ã®æ°—åˆ†ã¯ã¾ãšã¾ãšã€‚' + positiveRate + '%ãŒãƒã‚¸ãƒ†ã‚£ãƒ–ãªæ°—åˆ†ã§ã—ãŸã€‚');
                } else if (negativeMoods > positiveMoods) {
                    advice.push('ğŸ˜” ä»Šé€±ã¯å°‘ã—å¤§å¤‰ã§ã—ãŸã­ã€‚ç„¡ç†ã›ãšã€è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§é€²ã¿ã¾ã—ã‚‡ã†ã€‚');
                }
            }
            
            if (recentMoney.length > 0) {
                if (balance >= 0) {
                    advice.push('ğŸ’° ä»Šé€±ã®åæ”¯ã¯+' + balance.toLocaleString() + 'å††ã€‚ç´ æ™´ã‚‰ã—ã„ç®¡ç†ã§ã™ã­ï¼');
                } else {
                    advice.push('ğŸ’¸ ä»Šé€±ã®æ”¯å‡ºã¯' + Math.abs(balance).toLocaleString() + 'å††ã€‚æ¥é€±ã¯ç¯€ç´„ã‚’å¿ƒãŒã‘ã¦ã¿ã¾ã—ã‚‡ã†ã€‚');
                }
            }
            
            let goals = [];
            
            if (recordedDays < 7) {
                goals.push('ğŸ“… æ¥é€±ã¯æ¯æ—¥è¨˜éŒ²ã‚’ç›®æŒ‡ã—ã¦ã¿ã¾ã—ã‚‡ã†');
            }
            
            if (topCategories.length > 0) {
                const topActivity = topCategories[0];
                goals.push('ğŸ¯ ã€Œ' + topActivity[0] + 'ã€ã‚’' + (topActivity[1] + 2) + 'å›ã‚„ã£ã¦ã¿ã‚‹');
            }
            
            if (recentActivities.filter(a => a.text.includes('é‹å‹•')).length < 3) {
                goals.push('ğŸƒ é€±3å›ä»¥ä¸Šã®é‹å‹•ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸');
            }
            
            if (recentJournals.length < 5) {
                goals.push('ğŸ“ é€±5å›ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«è¨˜éŒ²ã‚’ç›®æŒ‡ã™');
            }
            
            if (balance < 0) {
                goals.push('ğŸ’° æ”¯å‡ºã‚’æ„è­˜ã—ã¦è¨˜éŒ²ã‚’ç¶šã‘ã‚‹');
            }
            
            const weeklyAnalysisHTML = `
                <p><strong>ğŸ“Š è¨˜éŒ²æ—¥æ•°:</strong> ${recordedDays}æ—¥ / 7æ—¥</p>
                ${recordedDays >= 5 ? '<p style="color: #28a745;">âœ¨ ç´ æ™´ã‚‰ã—ã„ç¶™ç¶šåŠ›ã§ã™ï¼</p>' : ''}
                ${recentActivities.length > 0 ? `<p><strong>ğŸ“ è¡Œå‹•è¨˜éŒ²:</strong> ${recentActivities.length}å›</p>` : ''}
                ${recentJournals.length > 0 ? `<p><strong>âœï¸ ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«:</strong> ${recentJournals.length}å›</p>` : ''}
            `;
            
            const behaviorPatternsHTML = topCategories.length > 0 ? `
                <p><strong>ãƒˆãƒƒãƒ—3æ´»å‹•:</strong></p>
                <ul>
                    ${topCategories.map(([name, count]) => `<li>${name}: ${count}å›</li>`).join('')}
                </ul>
                
                ${Object.keys(categoryTimes).length > 0 ? `
                    <p style="margin-top: 15px;"><strong>â±ï¸ ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®æ™‚é–“:</strong></p>
                    <ul>
                        ${Object.entries(categoryTimes).map(([name, time]) => {
                            let timeStr = '';
                            if (time.hours > 0 && time.minutes > 0) {
                                timeStr = `${time.hours}æ™‚é–“${time.minutes}åˆ†`;
                            } else if (time.hours > 0) {
                                timeStr = `${time.hours}æ™‚é–“`;
                            } else {
                                timeStr = `${time.minutes}åˆ†`;
                            }
                            return `<li>${time.emoji} ${name}: ${timeStr}</li>`;
                        }).join('')}
                    </ul>
                ` : ''}
            ` : '<p>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„ãŸã‚ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†æã§ãã¾ã›ã‚“ã€‚</p>';
            
            const moodTrendsHTML = totalMoods > 0 ? `
                <p><strong>æ°—åˆ†ã®å†…è¨³:</strong></p>
                <ul>
                    ${moodCounts.great > 0 ? `<li>ğŸ˜Š æœ€é«˜: ${moodCounts.great}å›</li>` : ''}
                    ${moodCounts.good > 0 ? `<li>ğŸ™‚ è‰¯ã„: ${moodCounts.good}å›</li>` : ''}
                    ${moodCounts.normal > 0 ? `<li>ğŸ˜ æ™®é€š: ${moodCounts.normal}å›</li>` : ''}
                    ${moodCounts.bad > 0 ? `<li>ğŸ˜” æ‚ªã„: ${moodCounts.bad}å›</li>` : ''}
                    ${moodCounts.terrible > 0 ? `<li>ğŸ˜¢ æœ€æ‚ª: ${moodCounts.terrible}å›</li>` : ''}
                </ul>
            ` : '<p>ã¾ã ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ°—åˆ†ã‚’è¨˜éŒ²ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>';
            
            const aiAdviceHTML = advice.length > 0 ? 
                advice.map(a => `<p>ãƒ»${a}</p>`).join('') : 
                '<p>ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ã—ã¦ã€AIã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å—ã‘å–ã‚Šã¾ã—ã‚‡ã†ï¼</p>';
            
            const weeklyGoalsHTML = goals.length > 0 ? `
                <ul>
                    ${goals.map(g => `<li>${g}</li>`).join('')}
                </ul>
            ` : '<p>ç´ æ™´ã‚‰ã—ã„ï¼ã™ã¹ã¦ã®ç›®æ¨™ã‚’é”æˆã—ã¦ã„ã¾ã™ï¼</p>';
            
            document.getElementById('weeklyAnalysis').innerHTML = weeklyAnalysisHTML;
            document.getElementById('behaviorPatterns').innerHTML = behaviorPatternsHTML;
            document.getElementById('moodTrends').innerHTML = moodTrendsHTML;
            document.getElementById('aiAdvice').innerHTML = aiAdviceHTML;
            document.getElementById('weeklyGoals').innerHTML = weeklyGoalsHTML;
        }
        // ã‚«ãƒ†ã‚´ãƒªç®¡ç†
        // ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½
        function toggleTimer() {
            if (timerRunning) {
                // åœæ­¢
                clearInterval(timerInterval);
                timerRunning = false;
                document.getElementById('timerButton').innerHTML = 'â–¶ï¸ ã‚¿ã‚¤ãƒãƒ¼å†é–‹';
                document.getElementById('timerButton').style.background = '#4CAF50';
            } else {
                // é–‹å§‹
                if (timerStartTime === null) {
                    timerStartTime = Date.now() - (timerElapsedSeconds * 1000);
                } else {
                    timerStartTime = Date.now() - (timerElapsedSeconds * 1000);
                }
                
                timerRunning = true;
                document.getElementById('timerButton').innerHTML = 'â¸ï¸ ä¸€æ™‚åœæ­¢';
                document.getElementById('timerButton').style.background = '#FF9800';
                
                timerInterval = setInterval(() => {
                    timerElapsedSeconds = Math.floor((Date.now() - timerStartTime) / 1000);
                    updateTimerDisplay();
                }, 100);
            }
        }
        
        function updateTimerDisplay() {
            const hours = Math.floor(timerElapsedSeconds / 3600);
            const minutes = Math.floor((timerElapsedSeconds % 3600) / 60);
            const seconds = timerElapsedSeconds % 60;
            
            const display = 
                String(hours).padStart(2, '0') + ':' +
                String(minutes).padStart(2, '0') + ':' +
                String(seconds).padStart(2, '0');
            
            document.getElementById('timerDisplay').textContent = display;
        }
        
        function resetTimer() {
            clearInterval(timerInterval);
            timerStartTime = null;
            timerRunning = false;
            timerElapsedSeconds = 0;
            document.getElementById('timerDisplay').textContent = '00:00:00';
            document.getElementById('timerButton').innerHTML = 'â–¶ï¸ ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹';
            document.getElementById('timerButton').style.background = '#4CAF50';
        }
        
        // ã‚«ãƒ†ã‚´ãƒªç®¡ç†
        function openCategoryManager() {
            document.getElementById('categoryModal').classList.add('active');
            renderCategoryList();
        }
        
        function closeCategoryManager() {
            document.getElementById('categoryModal').classList.remove('active');
        }
        
        function renderCategoryList() {
            const container = document.getElementById('categoryList');
            container.innerHTML = activityCategories.map((cat, index) => `
                <div class="log-item" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${cat.emoji} ${cat.name}</span>
                    <button onclick="deleteCategory(${index})" style="padding: 5px 10px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">å‰Šé™¤</button>
                </div>
            `).join('');
        }
        
        function addCategory() {
            const nameInput = document.getElementById('newCategoryName');
            const emojiInput = document.getElementById('newCategoryEmoji');
            
            const name = nameInput.value.trim();
            const emoji = emojiInput.value.trim();
            
            if (!name || !emoji) {
                alert('åå‰ã¨çµµæ–‡å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            activityCategories.push({ name, emoji });
            localStorage.setItem('activityCategories', JSON.stringify(activityCategories));
            
            nameInput.value = '';
            emojiInput.value = '';
            
            renderCategoryList();
            renderActivityQuickButtons();
        }
        
        function deleteCategory(index) {
            if (confirm('ã“ã®ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                activityCategories.splice(index, 1);
                localStorage.setItem('activityCategories', JSON.stringify(activityCategories));
                renderCategoryList();
                renderActivityQuickButtons();
            }
        }
        
        // éŸ³å£°èªè­˜ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
// éŸ³å£°èªè­˜ã®äºŒé‡è¨˜å…¥ãƒã‚°ä¿®æ­£ç‰ˆ
// ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«å°‚ç”¨éŸ³å£°èªè­˜ï¼ˆå†…å®¹ä¿æŒç‰ˆï¼‰

// ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«å…¥åŠ›ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¿½åŠ 
function setupJournalInputListener() {
    const journalInput = document.getElementById('journalInput');
    if (!journalInput) {
        console.error('journalInputè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    
    let debounceTimer;
    
    journalInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        
        const text = journalInput.value.trim();
        
        // 50æ–‡å­—ä»¥ä¸Šå…¥åŠ›ã•ã‚ŒãŸã‚‰è¦ç´„ã‚’è¡¨ç¤º
        if (text.length >= 50) {
            debounceTimer = setTimeout(() => {
                // æ‰‹å‹•ã‚«ãƒ†ã‚´ãƒªãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                const hasManualCategories = 
                    categoryVoiceInputs.good.length > 0 ||
                    categoryVoiceInputs.more.length > 0 ||
                    categoryVoiceInputs.worry.length > 0 ||
                    categoryVoiceInputs.task.length > 0;
                
                let analysis;
                if (hasManualCategories) {
                    // æ‰‹å‹•ã‚«ãƒ†ã‚´ãƒªã‚’ä½¿ç”¨
                    analysis = createManualCategoryAnalysis();
                } else {
                    // è‡ªå‹•åˆ†æã‚’ä½¿ç”¨ï¼ˆæ‰‹å‹•å…¥åŠ›ã®å ´åˆï¼‰
                    analysis = analyzJournal(text);
                }
                
                displaySummary(analysis);
            }, 1000); // 1ç§’å¾…ã£ã¦ã‹ã‚‰è¦ç´„
        } else {
            // çŸ­ã„å ´åˆã¯è¦ç´„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
            const summarySection = document.getElementById('summarySection');
            if (summarySection) {
                summarySection.classList.remove('active');
            }
        }
    });
}
// ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«å°‚ç”¨éŸ³å£°èªè­˜ï¼ˆãƒã‚°ä¿®æ­£ç‰ˆï¼‰
// ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«å°‚ç”¨éŸ³å£°èªè­˜ï¼ˆå®Œå…¨ä¿®æ­£ç‰ˆï¼‰
// æ‰‹å‹•ã‚«ãƒ†ã‚´ãƒªé¸æŠæ©Ÿèƒ½
let selectedJournalCategory = null;
let categoryVoiceInputs = {
    good: [],
    more: [],
    worry: [],
    task: []
};

function selectJournalCategory(category) {
    console.log('ã‚«ãƒ†ã‚´ãƒªé¸æŠ:', category);
    
    // å‰ã®ã‚«ãƒ†ã‚´ãƒªã®é¸æŠã‚’è§£é™¤
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ
    selectedJournalCategory = category;
    const btn = document.querySelector(`.category-btn[data-category="${category}"]`);
    if (btn) {
        btn.classList.add('active');
    }
    
    // é¸æŠè¡¨ç¤ºã‚’æ›´æ–°
    const display = document.getElementById('selectedCategoryDisplay');
    const categoryNames = {
        good: 'ğŸ˜Š è‰¯ã‹ã£ãŸã“ã¨',
        more: 'ğŸ“ˆ ã‚‚ã£ã¨ã§ãã‚‹ã“ã¨',
        worry: 'ğŸ˜Ÿ æ‚©ã‚“ã§ã„ã‚‹ã“ã¨',
        task: 'âœ… æ˜æ—¥ã‚„ã‚‹ã“ã¨'
    };
    
    if (display) {
        display.textContent = `é¸æŠä¸­: ${categoryNames[category]}`;
        display.classList.add('has-selection');
    }
    
    // ãƒ’ãƒ³ãƒˆéè¡¨ç¤º
    const hint = document.getElementById('categoryRequiredHint');
    if (hint) {
        hint.classList.remove('show');
    }
}

function setupManualCategoryVoiceRecognition(buttonId, inputId) {
    const button = document.getElementById(buttonId);
    const input = document.getElementById(inputId);
    
    if (!button || !input) {
        console.error('ãƒœã‚¿ãƒ³ã¾ãŸã¯å…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    
    let recognition = null;
    let isRecording = false;
    let silenceTimer = null;
    let lastResultTime = Date.now();
    let finalTranscript = '';
    let resultIndex = 0; // â­ å‡¦ç†æ¸ˆã¿ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨˜éŒ²
    
    const clickHandler = function() {
        if (!selectedJournalCategory) {
            const hint = document.getElementById('categoryRequiredHint');
            if (hint) {
                hint.classList.add('show');
                setTimeout(() => hint.classList.remove('show'), 3000);
            }
            alert('ã¾ãšã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }
        
        if (isRecording) {
            console.log('ğŸ›‘ éŸ³å£°å…¥åŠ›ã‚’æ‰‹å‹•åœæ­¢');
            if (recognition) {
                recognition.stop();
            }
            isRecording = false;
            button.textContent = 'ğŸ¤';
            button.style.background = '';
            if (silenceTimer) {
                clearTimeout(silenceTimer);
                silenceTimer = null;
            }
        } else {
            if (!('webkitSpeechRecognition' in window)) {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            console.log('ğŸ¤ éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹: ã‚«ãƒ†ã‚´ãƒª =', selectedJournalCategory);
            
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.continuous = true;
            recognition.interimResults = true;
            
            finalTranscript = '';
            resultIndex = 0; // â­ ãƒªã‚»ãƒƒãƒˆ
            isRecording = true;
            button.textContent = 'â¹ï¸';
            button.style.background = '#ef4444';
            
            recognition.onresult = function(event) {
                console.log('ğŸ“ éŸ³å£°èªè­˜çµæœã‚’å—ä¿¡ (resultIndex:', resultIndex, ', total:', event.results.length, ')');
                lastResultTime = Date.now();
                
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                }
                
                let interimTranscript = '';
                let newFinalTranscript = '';
                
                // â­ æœªå‡¦ç†ã®çµæœã ã‘ã‚’å‡¦ç†ï¼ˆresultIndexã‹ã‚‰é–‹å§‹ï¼‰
                for (let i = resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        newFinalTranscript += transcript;
                        resultIndex = i + 1; // â­ å‡¦ç†æ¸ˆã¿ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
                        console.log('âœ… ç¢ºå®šãƒ†ã‚­ã‚¹ãƒˆ[' + i + ']:', transcript);
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                if (newFinalTranscript) {
                    finalTranscript += newFinalTranscript;
                    console.log('ğŸ“Œ ç´¯ç©ãƒ†ã‚­ã‚¹ãƒˆ:', finalTranscript);
                }
                
                const displayText = finalTranscript + interimTranscript;
                input.value = displayText;
                
                // 7ç§’é–“éŸ³å£°ãŒãªã‘ã‚Œã°è‡ªå‹•åœæ­¢
                silenceTimer = setTimeout(() => {
                    console.log('â±ï¸ 7ç§’é–“ç„¡éŸ³ â†’ è‡ªå‹•åœæ­¢');
                    if (recognition && isRecording) {
                        recognition.stop();
                    }
                }, 7000);
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¦ç´„è¡¨ç¤º
                if (displayText.length > 30) {
                    const tempInputs = JSON.parse(JSON.stringify(categoryVoiceInputs));
                    tempInputs[selectedJournalCategory] = [displayText];
                    const tempAnalysis = {
                        good: tempInputs.good || [],
                        more: tempInputs.more || [],
                        worry: tempInputs.worry || [],
                        task: tempInputs.task || []
                    };
                    displaySummary(tempAnalysis);
                }
            };
            
            recognition.onend = function() {
                console.log('ğŸ éŸ³å£°èªè­˜ãŒçµ‚äº† (æœ€çµ‚ãƒ†ã‚­ã‚¹ãƒˆ:', finalTranscript, ')');
                isRecording = false;
                button.textContent = 'ğŸ¤';
                button.style.background = '';
                
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                }
                
                if (finalTranscript && selectedJournalCategory) {
                    const trimmed = finalTranscript.trim();
                    const existing = categoryVoiceInputs[selectedJournalCategory];
                    
                    // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                    const isDuplicate = existing.some(text => {
                        return text === trimmed || text.includes(trimmed) || trimmed.includes(text);
                    });
                    
                    if (trimmed && !isDuplicate) {
                        categoryVoiceInputs[selectedJournalCategory].push(trimmed);
                        console.log('âœ… ã‚«ãƒ†ã‚´ãƒªã«è¿½åŠ :', selectedJournalCategory, trimmed);
                        
                        updateJournalInputFromCategories();
                        
                        const analysis = createManualCategoryAnalysis();
                        displaySummary(analysis);
                        
                        input.value = '';
                    } else if (isDuplicate) {
                        console.log('âš ï¸ é‡è¤‡ãƒ†ã‚­ã‚¹ãƒˆã®ãŸã‚è¿½åŠ ã—ã¾ã›ã‚“ã§ã—ãŸ:', trimmed);
                        input.value = '';
                    } else {
                        console.log('âš ï¸ ç©ºã®ãƒ†ã‚­ã‚¹ãƒˆã®ãŸã‚è¿½åŠ ã—ã¾ã›ã‚“ã§ã—ãŸ');
                        input.value = '';
                    }
                    
                    finalTranscript = '';
                    resultIndex = 0; // â­ ãƒªã‚»ãƒƒãƒˆ
                }
            };
            
            recognition.onerror = function(event) {
                console.error('âŒ éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
                isRecording = false;
                button.textContent = 'ğŸ¤';
                button.style.background = '';
                
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                }
                
                if (event.error === 'no-speech') {
                    alert('éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                } else if (event.error === 'network') {
                    alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } else if (event.error !== 'aborted') {
                    alert('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ' + event.error);
                }
                
                finalTranscript = '';
                resultIndex = 0; // â­ ãƒªã‚»ãƒƒãƒˆ
            };
            
            recognition.start();
        }
    };
    
    button.removeEventListener('click', clickHandler);
    button.addEventListener('click', clickHandler);
}

function updateJournalInputFromCategories() {
    const input = document.getElementById('journalInput');
    if (!input) return;
    
    let fullText = [];
    
    if (categoryVoiceInputs.good.length > 0) {
        fullText.push('ã€è‰¯ã‹ã£ãŸã“ã¨ã€‘');
        fullText.push(...categoryVoiceInputs.good);
    }
    
    if (categoryVoiceInputs.more.length > 0) {
        fullText.push('ã€ã‚‚ã£ã¨ã§ãã‚‹ã“ã¨ã€‘');
        fullText.push(...categoryVoiceInputs.more);
    }
    
    if (categoryVoiceInputs.worry.length > 0) {
        fullText.push('ã€æ‚©ã‚“ã§ã„ã‚‹ã“ã¨ã€‘');
        fullText.push(...categoryVoiceInputs.worry);
    }
    
    if (categoryVoiceInputs.task.length > 0) {
        fullText.push('ã€æ˜æ—¥ã‚„ã‚‹ã“ã¨ã€‘');
        fullText.push(...categoryVoiceInputs.task);
    }
    
    input.value = fullText.join('\n');
}

function createManualCategoryAnalysis() {
    return {
        good: categoryVoiceInputs.good.slice(),
        more: categoryVoiceInputs.more.slice(),
        worry: categoryVoiceInputs.worry.slice(),
        task: categoryVoiceInputs.task.slice()
    };
}

function resetCategorySelection() {
    selectedJournalCategory = null;
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const display = document.getElementById('selectedCategoryDisplay');
    if (display) {
        display.textContent = 'ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ã‹ã‚‰éŸ³å£°å…¥åŠ›ã—ã¦ãã ã•ã„';
        display.classList.remove('has-selection');
    }
}

function clearCategoryVoiceInputs() {
    categoryVoiceInputs = {
        good: [],
        more: [],
        worry: [],
        task: []
    };
    resetCategorySelection();
}
function setupJournalVoiceRecognition(buttonId, inputId) {
    const button = document.getElementById(buttonId);
    const input = document.getElementById(inputId);
    
    if (!button || !input) return;
    
    if (!('webkitSpeechRecognition' in window)) {
        button.disabled = true;
        button.textContent = 'éŸ³å£°èªè­˜ã¯éå¯¾å¿œã§ã™';
        return;
    }
    
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.continuous = false;  // é‡è¦: false ã«å¤‰æ›´
    recognition.interimResults = true;
    recognition.maxAlternatives = 1;
    
    let isListening = false;
    let finalTranscript = '';
    let shouldRestart = false;  // å†é–‹ãƒ•ãƒ©ã‚°
    let restartTimer = null;
    
    button.addEventListener('click', () => {
        if (isListening) {
            // åœæ­¢
            shouldRestart = false;
            clearTimeout(restartTimer);
            recognition.stop();
            button.classList.remove('listening');
            button.textContent = button.textContent.replace('ğŸ”´ åœæ­¢', 'ğŸ¤ éŸ³å£°å…¥åŠ›');
            isListening = false;
        } else {
            // é–‹å§‹
            finalTranscript = input.value || '';
            shouldRestart = true;
            startRecognition();
        }
    });
    
    function startRecognition() {
        try {
            recognition.start();
            button.classList.add('listening');
            button.textContent = button.textContent.replace('ğŸ¤ éŸ³å£°å…¥åŠ›', 'ğŸ”´ åœæ­¢');
            isListening = true;
        } catch (e) {
            console.error('éŸ³å£°èªè­˜ã®é–‹å§‹ã«å¤±æ•—:', e);
            // æ—¢ã«é–‹å§‹ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç„¡è¦–
            if (e.name !== 'InvalidStateError') {
                isListening = false;
                shouldRestart = false;
            }
        }
    }
    
    recognition.onstart = () => {
        console.log('éŸ³å£°èªè­˜é–‹å§‹');
    };
    
    recognition.onresult = (event) => {
        let interimTranscript = '';
        
        // å…¨ã¦ã®çµæœã‚’å‡¦ç†ï¼ˆcontinuous=falseãªã®ã§å•é¡Œãªã„ï¼‰
        for (let i = 0; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            
            if (event.results[i].isFinal) {
                // ç¢ºå®šã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼‰
                if (!finalTranscript.includes(transcript)) {
                    finalTranscript += transcript;
                }
            } else {
                interimTranscript += transcript;
            }
        }
        
        // è¡¨ç¤ºã‚’æ›´æ–°
        input.value = finalTranscript + interimTranscript;
        
        // è¦ç´„ã‚’æ›´æ–°
        const fullText = finalTranscript + interimTranscript;
        if (fullText.trim().length >= 50) {
            const analysis = analyzJournal(fullText);
            displaySummary(analysis);
        }
    };
    
    recognition.onerror = (event) => {
        console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
        
        if (event.error === 'no-speech') {
            // ç„¡éŸ³æ¤œå‡º - è‡ªå‹•å†é–‹
            console.log('ç„¡éŸ³ã‚’æ¤œå‡ºã€å†é–‹ã—ã¾ã™');
            // ä½•ã‚‚ã—ãªã„ï¼ˆonendã§å†é–‹ã•ã‚Œã‚‹ï¼‰
        } else if (event.error === 'aborted') {
            // ä¸­æ–­ã•ã‚ŒãŸ - å†é–‹ã—ãªã„
            shouldRestart = false;
        } else {
            // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
            console.log('ã‚¨ãƒ©ãƒ¼ã®ãŸã‚åœæ­¢');
            shouldRestart = false;
            button.classList.remove('listening');
            button.textContent = button.textContent.replace('ğŸ”´ åœæ­¢', 'ğŸ¤ éŸ³å£°å…¥åŠ›');
            isListening = false;
        }
    };
    
    recognition.onend = () => {
        console.log('éŸ³å£°èªè­˜çµ‚äº†');
        
        if (shouldRestart && isListening) {
            // 500mså¾…ã£ã¦ã‹ã‚‰å†é–‹ï¼ˆé‡è¤‡ã‚’é˜²ãï¼‰
            clearTimeout(restartTimer);
            restartTimer = setTimeout(() => {
                if (shouldRestart && isListening) {
                    console.log('è‡ªå‹•å†é–‹');
                    startRecognition();
                }
            }, 500);
        } else {
            button.classList.remove('listening');
            button.textContent = button.textContent.replace('ğŸ”´ åœæ­¢', 'ğŸ¤ éŸ³å£°å…¥åŠ›');
            isListening = false;
        }
    };
}
function setupVoiceRecognition(buttonId, inputId, isJournal = false, isActivity = false) {
    const button = document.getElementById(buttonId);
    const input = document.getElementById(inputId);
    
    if (!button || !input) return;
    
    if (!('webkitSpeechRecognition' in window)) {
        button.disabled = true;
        button.textContent = 'éŸ³å£°èªè­˜ã¯éå¯¾å¿œã§ã™';
        return;
    }
    
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.continuous = false;  // continuous ã‚’ false ã«å¤‰æ›´
    recognition.interimResults = true;
    
    let isListening = false;
    let finalTranscript = '';
    let isProcessing = false;  // å‡¦ç†ä¸­ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
    
    button.addEventListener('click', () => {
        if (isListening) {
            recognition.stop();
            button.classList.remove('listening');
            button.textContent = button.textContent.replace('ğŸ”´ åœæ­¢', 'ğŸ¤ éŸ³å£°å…¥åŠ›');
            isListening = false;
        } else {
            if (isProcessing) return;  // å‡¦ç†ä¸­ãªã‚‰ç„¡è¦–
            finalTranscript = '';
            recognition.start();
            button.classList.add('listening');
            button.textContent = button.textContent.replace('ğŸ¤ éŸ³å£°å…¥åŠ›', 'ğŸ”´ åœæ­¢');
            isListening = true;
        }
    });
    
    recognition.onresult = (event) => {
        if (isProcessing) return;  // å‡¦ç†ä¸­ãªã‚‰ç„¡è¦–
        
        let interimTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript;
            } else {
                interimTranscript += transcript;
            }
        }
        
        const fullText = finalTranscript + interimTranscript;
        input.value = fullText;
        
        // è¡Œå‹•ã‚¿ãƒ–ã®å ´åˆã¯è‡ªå‹•çš„ã«ã‚«ãƒ†ã‚´ãƒªã‚’æ¤œå‡ºã—ã¦é¸æŠ
        if (isActivity && fullText) {
            autoSelectActivityCategory(fullText);
        }
        
        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã®å ´åˆã¯è‡ªå‹•è¦ç´„ã‚’è¡¨ç¤º
        if (isJournal && finalTranscript) {
            const analysis = analyzJournal(fullText);
            displaySummary(analysis);
        }
    };
    
    recognition.onerror = (event) => {
        console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
        button.classList.remove('listening');
        button.textContent = button.textContent.replace('ğŸ”´ åœæ­¢', 'ğŸ¤ éŸ³å£°å…¥åŠ›');
        isListening = false;
        isProcessing = false;  // ã‚¨ãƒ©ãƒ¼æ™‚ã«ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
    };
    
    recognition.onend = () => {
        if (isProcessing) return;  // ã™ã§ã«å‡¦ç†ä¸­ãªã‚‰ç„¡è¦–
        
        isProcessing = true;  // å‡¦ç†é–‹å§‹
        
        button.classList.remove('listening');
        button.textContent = button.textContent.replace('ğŸ”´ åœæ­¢', 'ğŸ¤ éŸ³å£°å…¥åŠ›');
        isListening = false;
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆäºŒé‡å®Ÿè¡Œã‚’é˜²ãï¼‰
        setTimeout(() => {
            isProcessing = false;
        }, 500);
    };
}
        
        // éŸ³å£°å…¥åŠ›ã§è‡ªå‹•çš„ã«ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ
        function autoSelectActivityCategory(text) {
            // ãƒ†ã‚­ã‚¹ãƒˆã‚’å°æ–‡å­—åŒ–
            const lowerText = text.toLowerCase();
            
            // å„ã‚«ãƒ†ã‚´ãƒªã®ãƒãƒƒãƒãƒ³ã‚°ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
            let bestMatch = null;
            let bestMatchEmoji = null;
            let bestScore = 0;
            
            activityCategories.forEach(category => {
                const categoryName = category.name.toLowerCase();
                let score = 0;
                
                // ã‚«ãƒ†ã‚´ãƒªåãŒç›´æ¥å«ã¾ã‚Œã¦ã„ã‚‹ã‹
                if (lowerText.includes(categoryName)) {
                    score += 10;
                }
                
                // é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
                const keywords = getCategoryKeywords(category.name);
                keywords.forEach(keyword => {
                    if (lowerText.includes(keyword)) {
                        score += 5;
                    }
                });
                
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = category.name;
                    bestMatchEmoji = category.emoji;
                }
            });
            
            // ãƒãƒƒãƒã—ãŸã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Œã°ã€selectCategoryé–¢æ•°ã‚’å‘¼ã³å‡ºã—
            if (bestMatch && bestScore >= 5) {
                selectCategory(bestMatch, bestMatchEmoji);
            }
        }
        function getCategoryKeywords(categoryName) {
            const keywordMap = {
                'ä»•äº‹': ['ä¼šè­°', 'ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°', 'ãƒ—ãƒ¬ã‚¼ãƒ³', 'è³‡æ–™', 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ', 'æ¥­å‹™', 'ã‚ªãƒ•ã‚£ã‚¹', 'ä¼ç”»', 'å ±å‘Š', 'ãƒ¡ãƒ¼ãƒ«'],
                'å‹‰å¼·': ['å­¦ç¿’', 'å‹‰å¼·', 'èª­æ›¸', 'æœ¬', 'ã‚³ãƒ¼ã‚¹', 'è¬›åº§', 'ã‚»ãƒŸãƒŠãƒ¼', 'è©¦é¨“', 'ç ”ç©¶', 'å¾©ç¿’'],
                'é‹å‹•': ['ã‚¸ãƒ ', 'ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°', 'ã‚¸ãƒ§ã‚®ãƒ³ã‚°', 'ç­‹ãƒˆãƒ¬', 'ãƒ¨ã‚¬', 'ã‚¹ãƒãƒ¼ãƒ„', 'æ•£æ­©', 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°', 'ã‚¹ãƒˆãƒ¬ãƒƒãƒ'],
                'é£Ÿäº‹': ['æœé£Ÿ', 'æ˜¨é£Ÿ', 'å¤•é£Ÿ', 'é£Ÿã¹', 'ãƒ©ãƒ³ãƒ', 'ãƒ‡ã‚£ãƒŠãƒ¼', 'æ–™ç†', 'é£Ÿäº‹', 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³', 'ã‚«ãƒ•ã‚§'],
                'ç¡çœ ': ['çœ ', 'å¯', 'ä»•äº‹', 'èµ·', 'ä¼‘æ¯', 'æ˜¨å¯', 'æœ', 'ç–²ã‚Œ'],
                'èª­æ›¸': ['æœ¬', 'å°èª¬', 'æ¼«ç”»', 'èª­ã‚“', 'é›‘èªŒ', 'è¨˜äº‹', 'ãƒ–ãƒƒã‚¯'],
                'å®¶äº‹': ['æƒé™¤', 'æ´—æ¿¯', 'æ–™ç†', 'ç‰‡ä»˜ã‘', 'è²·ã„ç‰©', 'ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°', 'æ•´ç†'],
                'è¶£å‘³': ['è¶£å‘³', 'ã‚²ãƒ¼ãƒ ', 'éŸ³æ¥½', 'æ˜ ç”»', 'ãƒ‰ãƒ©ãƒ', 'ã‚¢ãƒ‹ãƒ¡', 'çµµ', 'å†™çœŸ', 'ã‚«ãƒ©ã‚ªã‚±']
            };
            
            return keywordMap[categoryName] || [];
        }
        
        // ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        
        // è¦ç´„ã‚’è¡¨ç¤º
        function displaySummary(analysis) {
            const summarySection = document.getElementById('summarySection');
            summarySection.classList.add('active');
            
            // Good
            const goodEl = document.getElementById('summaryGood');
            const goodCommentEl = document.getElementById('commentGood');
            if (analysis.good.length > 0) {
                goodEl.textContent = analysis.good.map(s => 'ãƒ»' + s).join('\n');
                goodCommentEl.textContent = generateAIComment('good', analysis.good);
            } else {
                goodEl.textContent = 'ï¼ˆãªã—ï¼‰';
                goodCommentEl.textContent = '';
            }
            
            // More
            const moreEl = document.getElementById('summaryMore');
            const moreCommentEl = document.getElementById('commentMore');
            if (analysis.more.length > 0) {
                moreEl.textContent = analysis.more.map(s => 'ãƒ»' + s).join('\n');
                moreCommentEl.textContent = generateAIComment('more', analysis.more);
            } else {
                moreEl.textContent = 'ï¼ˆãªã—ï¼‰';
                moreCommentEl.textContent = '';
            }
            
            // Worry
            const worryEl = document.getElementById('summaryWorry');
            const worryCommentEl = document.getElementById('commentWorry');
            if (analysis.worry.length > 0) {
                worryEl.textContent = analysis.worry.map(s => 'ãƒ»' + s).join('\n');
                worryCommentEl.textContent = generateAIComment('worry', analysis.worry);
            } else {
                worryEl.textContent = 'ï¼ˆãªã—ï¼‰';
                worryCommentEl.textContent = '';
            }
            
            // Task
            const taskEl = document.getElementById('summaryTask');
            const taskCommentEl = document.getElementById('commentTask');
            if (analysis.task.length > 0) {
                taskEl.textContent = analysis.task.map(s => 'ãƒ»' + s).join('\n');
                taskCommentEl.textContent = generateAIComment('task', analysis.task);
            } else {
                taskEl.textContent = 'ï¼ˆãªã—ï¼‰';
                taskCommentEl.textContent = '';
            }
        }
        
        // åˆæœŸåŒ–
        renderActivityQuickButtons();
        renderActivityLogs();
        renderGoals();
        initializeReportMonths();
        renderMoneyLogs();
        renderWeightLogs();
        renderJournalLogs();
        renderCalendar();
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ°—åˆ†ã‚’é¸æŠçŠ¶æ…‹ã«
        selectMood('normal');
        
        setupVoiceRecognition('activityVoiceButton', 'activityInput', false, true);
        setupVoiceRecognition('moneyVoiceButton', 'moneyInput');
        setupVoiceRecognition('weightVoiceButton', 'weightInput');
        setupManualCategoryVoiceRecognition('journalVoiceButton', 'journalInput');
        setupJournalInputListener();
    </script>
    <!-- è¡Œå‹•ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editActivityModal" class="modal">
        <div class="modal-content">
            <h3>âœï¸ è¡Œå‹•ã‚’ç·¨é›†</h3>
            
            <label>å†…å®¹</label>
            <input type="text" id="editActivityText" placeholder="è¡Œå‹•å†…å®¹">
            
            <label>ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="editActivityCategory">
                <!-- ã‚«ãƒ†ã‚´ãƒªã¯å‹•çš„ã«ç”Ÿæˆ -->
            </select>
            
            <label>é–‹å§‹æ™‚åˆ»</label>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="datetime-local" id="editActivityStartTime" style="flex: 1;">
                <button type="button" onclick="setCurrentTimeToStart()" class="quick-time-btn">ç¾åœ¨æ™‚åˆ»</button>
            </div>
            
            <label>çµ‚äº†æ™‚åˆ»</label>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="datetime-local" id="editActivityEndTime" style="flex: 1;">
                <button type="button" onclick="setCurrentTimeToEnd()" class="quick-time-btn">ç¾åœ¨æ™‚åˆ»</button>
            </div>
            
            <!-- ã‚¯ã‚¤ãƒƒã‚¯æ™‚é–“èª¿æ•´ -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">ã‚¯ã‚¤ãƒƒã‚¯èª¿æ•´</label>
                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                    <button type="button" onclick="adjustEndTime(5)" class="quick-adjust-btn">+5åˆ†</button>
                    <button type="button" onclick="adjustEndTime(15)" class="quick-adjust-btn">+15åˆ†</button>
                    <button type="button" onclick="adjustEndTime(30)" class="quick-adjust-btn">+30åˆ†</button>
                    <button type="button" onclick="adjustEndTime(60)" class="quick-adjust-btn">+1æ™‚é–“</button>
                    <button type="button" onclick="adjustEndTime(-5)" class="quick-adjust-btn">-5åˆ†</button>
                    <button type="button" onclick="adjustEndTime(-15)" class="quick-adjust-btn">-15åˆ†</button>
                </div>
            </div>
            
            <!-- æ‰€è¦æ™‚é–“è¡¨ç¤º -->
            <div id="durationDisplay" style="padding: 10px; background: #f0f0f0; border-radius: 5px; margin-bottom: 15px; text-align: center; font-weight: bold;">
                æ‰€è¦æ™‚é–“: <span id="calculatedDuration">--</span>
            </div>
            
            <div class="modal-actions">
                <button type="button" onclick="closeEditActivityModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" onclick="saveEditActivity()" class="primary">ä¿å­˜</button>
            </div>
        </div>
    </div>
<!-- ãŠé‡‘ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editMoneyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ’° ãŠé‡‘ã®è¨˜éŒ²ã‚’ç·¨é›†</h3>
            <button class="modal-close" onclick="closeEditMoneyModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>å†…å®¹</label>
                <input type="text" id="editMoneyText" class="input-field" />
            </div>
            
            <div class="form-group">
                <label>ã‚«ãƒ†ã‚´ãƒª</label>
                <select id="editMoneyCategory" class="input-field">
                    <!-- ã‚«ãƒ†ã‚´ãƒªãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                </select>
            </div>
            
            <div class="form-group">
                <label>é‡‘é¡</label>
                <input type="number" id="editMoneyAmount" class="input-field" placeholder="åå…¥ã¯æ­£ã®æ•°ã€æ”¯å‡ºã¯è² ã®æ•°" />
            </div>
            
            <div class="form-group">
                <label>è¨˜éŒ²æ—¥æ™‚</label>
                <input type="datetime-local" id="editMoneyTimestamp" class="input-field" />
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeEditMoneyModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn-primary" onclick="saveMoneyEdit()">ğŸ’¾ ä¿å­˜</button>
        </div>
    </div>
</div>

    <style>
        .quick-time-btn, .quick-adjust-btn {
            padding: 8px 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .quick-time-btn:hover, .quick-adjust-btn:hover {
            background: #45a049;
        }

        .quick-adjust-btn {
            background: #2196F3;
        }

        .quick-adjust-btn:hover {
            background: #0b7dda;
        }
    </style>
</body>
</html>
