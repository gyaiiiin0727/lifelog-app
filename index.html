<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>ãƒ©ã‚¤ãƒ•ãƒ­ã‚°ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ç‰ˆï¼‰ - ç›®æ¨™ãƒ»é€²æ—ç®¡ç†</title>
  <style>
    :root{
      --fg:#111;
      --muted:#666;
      --bg:#fff;
      --card:#fff;
      --line:#111;
      --soft:#f3f3f3;
      --soft2:#fafafa;
      --radius:12px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Arial,sans-serif;
      background:var(--bg);
      color:var(--fg);
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
    }
    .container{max-width:980px;margin:0 auto;padding:18px}
    h1{font-size:20px;text-align:center;margin:6px 0 16px}
    .tabs{
      display:flex;gap:0;border-bottom:2px solid #e6e6e6;
      overflow-x:auto;-webkit-overflow-scrolling:touch;
    }
    .tabs::-webkit-scrollbar{display:none}
    .tab-btn{
      flex:1;min-width:92px;
      padding:12px 10px;background:none;border:none;
      border-bottom:3px solid transparent;
      font-size:14px;color:var(--muted);
      cursor:pointer;white-space:nowrap;
    }
    .tab-btn.active{color:var(--fg);border-bottom-color:var(--fg);font-weight:700}
    .tab{display:none;padding:16px 0}
    .tab.active{display:block}
    .card{
      background:var(--card);
      border:2px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      margin:12px 0;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    .btn{
      border:2px solid var(--line);
      background:var(--fg);
      color:var(--bg);
      padding:10px 14px;border-radius:10px;
      font-weight:700;cursor:pointer;
      -webkit-tap-highlight-color:rgba(0,0,0,0.1);
      touch-action:manipulation;
    }
    .btn.secondary{
      background:var(--bg);color:var(--fg);
    }
    .btn:active{transform:scale(.98)}
    .input, select, textarea{
      border:2px solid var(--line);
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      background:#fff;
      width:100%;
    }
    textarea{min-height:90px;resize:vertical}
    .status{margin-top:10px;color:var(--muted);font-size:13px}
    .section-title{
      font-size:16px;font-weight:800;margin:14px 0 8px;
      display:flex;align-items:center;gap:10px;
    }

    /* Goals */
    .month-selector{
      display:flex;align-items:center;gap:10px;
      border:2px solid var(--line);
      border-radius:12px;
      padding:12px;background:#fff;
    }
    .month-label{font-size:18px;font-weight:900;letter-spacing:.5px}
    .goal-form{
      display:grid;
      grid-template-columns: 1fr 140px 140px;
      gap:10px;
    }
    @media (max-width:720px){
      .goal-form{grid-template-columns:1fr}
    }
    .goal-list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .goal-item{
      border:2px solid #ddd;border-radius:12px;background:#fff;padding:12px;
    }
    .goal-item.completed{opacity:.75;background:var(--soft2)}
    .goal-title{
      font-weight:900;font-size:15px;
      display:flex;gap:10px;align-items:center;
    }
    .chip{
      display:inline-flex;align-items:center;gap:6px;
      border:1px solid #ddd;background:var(--soft2);
      padding:3px 8px;border-radius:999px;
      font-size:12px;color:var(--muted);
    }
    .goal-actions{display:flex;gap:8px;align-items:center}
    .icon-btn{
      border:2px solid #ddd;background:#fff;border-radius:10px;
      padding:8px 10px;cursor:pointer;
    }
    .icon-btn:active{transform:scale(.98)}
    .progress-wrap{margin-top:10px}
    .bar{
      height:14px;border:2px solid var(--line);
      border-radius:999px;overflow:hidden;background:#fff;
    }
    .bar > div{
      height:100%;
      width:0%;
      background:var(--fg);
      transition:width .2s ease;
    }
    .bar-meta{display:flex;justify-content:space-between;margin-top:6px;color:var(--muted);font-size:12px}
    .progress-input{
      display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap;
    }
    .progress-input select{width:auto;min-width:92px}
    .progress-input input{flex:1;min-width:180px}
    .history{
      margin-top:10px;border-top:1px solid #eee;padding-top:10px;
    }
    details summary{cursor:pointer;font-weight:800}
    .hist-item{
      margin-top:8px;background:var(--soft2);border:1px solid #eee;
      padding:10px;border-radius:10px;
    }
    .hist-head{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .hist-comment{margin-top:6px}
    .empty{
      padding:18px;border:2px dashed #ccc;border-radius:12px;color:var(--muted);
      text-align:center;background:var(--soft2);
    }
    .danger{color:#b00020}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ““ ãƒ©ã‚¤ãƒ•ãƒ­ã‚°ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ç‰ˆï¼‰</h1>

    <nav class="tabs" aria-label="tabs">
      <button class="tab-btn active" data-tab="activity">â±ï¸ è¡Œå‹•</button>
      <button class="tab-btn" data-tab="money">ğŸ’° ãŠé‡‘</button>
      <button class="tab-btn" data-tab="journal">ğŸ“” ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</button>
      <button class="tab-btn" data-tab="goals">ğŸ¯ ç›®æ¨™</button>
    </nav>

    <!-- placeholders -->
    <section id="activity" class="tab active" aria-label="activity">
      <div class="card">
        <div class="section-title">â±ï¸ è¡Œå‹•</div>
        <div class="small">ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€Œç›®æ¨™ã€æ©Ÿèƒ½ã‚’å®‰å®šã•ã›ã‚‹ãŸã‚ã®ã‚¯ãƒªãƒ¼ãƒ³ç‰ˆã§ã™ã€‚å¿…è¦ãªã‚‰è¡Œå‹•/ãŠé‡‘/ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚‚æ®µéšçš„ã«ç§»æ¤ã—ã¾ã™ã€‚</div>
      </div>
    </section>

    <section id="money" class="tab" aria-label="money">
      <div class="card">
        <div class="section-title">ğŸ’° ãŠé‡‘</div>
        <div class="small">ï¼ˆç°¡æ˜“ã‚¿ãƒ–ï¼‰</div>
      </div>
    </section>

    <section id="journal" class="tab" aria-label="journal">
      <div class="card">
        <div class="section-title">ğŸ“” ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</div>
        <div class="small">ï¼ˆç°¡æ˜“ã‚¿ãƒ–ï¼‰</div>
      </div>
    </section>

    <!-- Goals -->
    <section id="goals" class="tab" aria-label="goals">
      <div class="card">
        <div class="section-title">ğŸ¯ ç›®æ¨™ç®¡ç†</div>

        <div class="month-selector">
          <button class="btn secondary" id="prevMonthBtn">â—€ å‰æœˆ</button>
          <div class="spacer"></div>
          <div class="month-label" id="currentGoalsMonth">-</div>
          <div class="spacer"></div>
          <button class="btn secondary" id="nextMonthBtn">æ¬¡æœˆ â–¶</button>
        </div>

        <div style="height:12px"></div>

        <div class="goal-form" aria-label="goal form">
          <input class="input" id="goalInput" placeholder="æ–°ã—ã„ç›®æ¨™ï¼ˆä¾‹ï¼šã‚¢ãƒ—ãƒªåˆ¶ä½œï¼‰" />
          <select id="goalCategory">
            <option value="ä»•äº‹">ğŸ’¼ ä»•äº‹</option>
            <option value="å‹‰å¼·">ğŸ“š å‹‰å¼·</option>
            <option value="å¥åº·">ğŸ’ª å¥åº·</option>
            <option value="è¶£å‘³">ğŸ¨ è¶£å‘³</option>
            <option value="äººé–“é–¢ä¿‚">ğŸ‘¥ äººé–“é–¢ä¿‚</option>
            <option value="ãŠé‡‘">ğŸ’° ãŠé‡‘</option>
            <option value="ãã®ä»–">ğŸ“Œ ãã®ä»–</option>
          </select>
          <button class="btn" id="addGoalBtn">â• ç›®æ¨™ã‚’è¿½åŠ </button>
        </div>

        <div id="goalStatus" class="status"></div>
      </div>

      <div class="card">
        <div class="section-title">ğŸ“Š é”æˆçŠ¶æ³</div>
        <div id="goalsProgress"></div>
      </div>

      <div class="card">
        <div class="section-title" id="goalsListTitle">ä»Šæœˆã®ç›®æ¨™ãƒªã‚¹ãƒˆ</div>
        <div id="goalsList" class="goal-list"></div>
      </div>

      <div class="card">
        <div class="section-title">ğŸ§¹ ãƒ‡ãƒ¼ã‚¿æ“ä½œ</div>
        <div class="row">
          <button class="btn secondary" id="exportBtn">â¬‡ï¸ ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ã‚’JSONå‡ºåŠ›</button>
          <button class="btn secondary" id="importBtn">â¬†ï¸ JSONã‚’è²¼ã‚Šä»˜ã‘ã¦å¾©å…ƒ</button>
          <div class="spacer"></div>
          <button class="btn secondary" id="clearBtn">ğŸ—‘ï¸ ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ã‚’å…¨å‰Šé™¤</button>
        </div>
        <div class="small">localStorageã‚­ãƒ¼: <code>monthlyGoals</code></div>
        <div id="ioArea" style="display:none;margin-top:12px">
          <textarea id="ioText" class="input" placeholder="ã“ã“ã«JSONã‚’è²¼ã‚Šä»˜ã‘"></textarea>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="applyImportBtn">å¾©å…ƒã™ã‚‹</button>
            <button class="btn secondary" id="closeIoBtn">é–‰ã˜ã‚‹</button>
          </div>
          <div id="ioStatus" class="status"></div>
        </div>
      </div>
    </section>
  </div>

  <script>
    'use strict';

    /******************************************************************
     * é‡è¦ï¼šTDZï¼ˆCannot access before initializationï¼‰ã‚’é¿ã‘ã‚‹ãŸã‚ã€
     *       ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã¯æœ€ä¸Šéƒ¨ã§åˆæœŸåŒ–ã™ã‚‹
     ******************************************************************/
    const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
    let selectedGoalsMonth = currentMonth;
    let monthlyGoals = safeParseJSON(localStorage.getItem('monthlyGoals'), []);

    function safeParseJSON(str, fallback){
      try{
        if(!str) return fallback;
        const v = JSON.parse(str);
        return Array.isArray(v) ? v : fallback;
      }catch(e){
        console.warn('JSON parse failed. reset to fallback.', e);
        return fallback;
      }
    }

    function saveGoals(){
      localStorage.setItem('monthlyGoals', JSON.stringify(monthlyGoals));
    }

    function fmtMonth(ym){
      const [y,m] = ym.split('-').map(Number);
      return `${y}å¹´${m}æœˆ`;
    }

    function showStatus(elId, msg, isError=false){
      const el = document.getElementById(elId);
      if(!el) return;
      el.textContent = msg;
      el.classList.toggle('danger', !!isError);
      if(msg){
        setTimeout(()=>{ if(el.textContent === msg) el.textContent = ''; }, 2400);
      }
    }

    /**************** Tabs ****************/
    function switchTab(tabId){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      const tab = document.getElementById(tabId);
      const btn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
      if(tab) tab.classList.add('active');
      if(btn) btn.classList.add('active');

      if(tabId === 'goals'){
        // ç›®æ¨™ã‚¿ãƒ–è¡¨ç¤ºæ™‚ã«å¿…ãšå†æç”»
        updateGoalsMonthDisplay();
        renderGoals();
        renderGoalsProgress();
      }
    }

    /**************** Goals - month nav ****************/
    function changeGoalsMonth(offset){
      // typeof ã‚¬ãƒ¼ãƒ‰ï¼ˆä¸‡ä¸€ï¼‰
      if(typeof selectedGoalsMonth === 'undefined' || !selectedGoalsMonth){
        selectedGoalsMonth = currentMonth;
      }
      const [year, month] = selectedGoalsMonth.split('-').map(Number);
      const date = new Date(year, month - 1 + offset, 1);
      selectedGoalsMonth = date.toISOString().slice(0, 7);
      updateGoalsMonthDisplay();
      renderGoals();
      renderGoalsProgress();
    }

    function updateGoalsMonthDisplay(){
      if(typeof selectedGoalsMonth === 'undefined' || !selectedGoalsMonth){
        selectedGoalsMonth = currentMonth;
      }
      const display = document.getElementById('currentGoalsMonth');
      if(display) display.textContent = fmtMonth(selectedGoalsMonth);

      const title = document.getElementById('goalsListTitle');
      if(title){
        title.textContent = (selectedGoalsMonth === currentMonth)
          ? 'ä»Šæœˆã®ç›®æ¨™ãƒªã‚¹ãƒˆ'
          : `${fmtMonth(selectedGoalsMonth)}ã®ç›®æ¨™ãƒªã‚¹ãƒˆ`;
      }
    }

    /**************** Goals - CRUD ****************/
    function addGoal(){
      const input = document.getElementById('goalInput');
      const categorySelect = document.getElementById('goalCategory');
      const text = (input?.value || '').trim();
      const category = categorySelect?.value || 'ãã®ä»–';

      if(!text){
        showStatus('goalStatus', 'âŒ ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
        return;
      }
      if(typeof selectedGoalsMonth === 'undefined' || !selectedGoalsMonth){
        selectedGoalsMonth = currentMonth;
      }

      const goal = {
        id: Date.now(),
        text,
        category,
        createdAt: new Date().toISOString(),
        month: selectedGoalsMonth,
        completed: false,

        // 10æ®µéšé€²æ—ï¼ˆå¾Œæ–¹äº’æ›ã‚ã‚Šï¼‰
        currentLevel: 0,
        progress: [] // {date, level, comment, timestamp}
      };

      monthlyGoals.unshift(goal);
      saveGoals();

      input.value = '';
      showStatus('goalStatus', 'âœ“ ç›®æ¨™ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      renderGoals();
      renderGoalsProgress();
    }

    function deleteGoal(goalId){
      if(!confirm('ã“ã®ç›®æ¨™ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      monthlyGoals = monthlyGoals.filter(g => g.id !== goalId);
      saveGoals();
      renderGoals();
      renderGoalsProgress();
      showStatus('goalStatus', 'âœ“ å‰Šé™¤ã—ã¾ã—ãŸ');
    }

    function toggleGoalComplete(goalId){
      const g = monthlyGoals.find(x => x.id === goalId);
      if(!g) return;
      g.completed = !g.completed;
      saveGoals();
      renderGoals();
      renderGoalsProgress();
    }

    function addProgressToGoal(goalId){
      const levelSelect = document.getElementById(`level-${goalId}`);
      const commentInput = document.getElementById(`comment-${goalId}`);
      const level = parseInt(levelSelect?.value ?? '0', 10);
      const comment = (commentInput?.value || '').trim();

      if(Number.isNaN(level) || level < 0 || level > 10){
        alert('ãƒ¬ãƒ™ãƒ«ã¯0ã€œ10ã§é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      if(!comment){
        alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const goal = monthlyGoals.find(g => g.id === goalId);
      if(!goal){
        alert('ç›®æ¨™ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      if(!Array.isArray(goal.progress)) goal.progress = [];
      const entry = {
        date: new Date().toISOString().slice(0,10),
        level,
        comment,
        timestamp: new Date().toISOString()
      };
      goal.progress.unshift(entry);
      goal.currentLevel = level;
      goal.completed = (level === 10) ? true : goal.completed;

      saveGoals();
      commentInput.value = '';
      renderGoals();
      renderGoalsProgress();
      showStatus('goalStatus', 'âœ“ é€²æ—ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
    }

    function renderProgressBar(level){
      const pct = Math.max(0, Math.min(10, level)) * 10;
      return `
        <div class="progress-wrap">
          <div class="bar" aria-label="progress bar"><div style="width:${pct}%"></div></div>
          <div class="bar-meta">
            <span>Lv.${level}/10</span>
            <span>${pct}%</span>
          </div>
        </div>
      `;
    }

    function renderProgressHistory(goal){
      const hist = Array.isArray(goal.progress) ? goal.progress : [];
      if(hist.length === 0){
        return `<div class="empty">ã¾ã é€²æ—å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
      }
      return hist.map(h => {
        const ts = new Date(h.timestamp || Date.now());
        const tsStr = isNaN(ts.getTime()) ? '' : ts.toLocaleString();
        return `
          <div class="hist-item">
            <div class="hist-head">
              <span class="chip">ğŸ“… ${h.date || ''}</span>
              <span class="chip">ğŸ“¶ Lv.${h.level ?? 0}</span>
              ${tsStr ? `<span class="chip">ğŸ•’ ${tsStr}</span>` : ''}
            </div>
            <div class="hist-comment">${escapeHtml(h.comment || '')}</div>
          </div>
        `;
      }).join('');
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }

    function renderGoals(){
      const container = document.getElementById('goalsList');
      if(!container) return;

      if(typeof selectedGoalsMonth === 'undefined' || !selectedGoalsMonth){
        selectedGoalsMonth = currentMonth;
      }

      const currentGoals = monthlyGoals.filter(g => g.month === selectedGoalsMonth);

      if(currentGoals.length === 0){
        container.innerHTML = `<div class="empty">${(selectedGoalsMonth === currentMonth) ? 'ä»Šæœˆ' : 'é¸æŠã—ãŸæœˆ'}ã®ç›®æ¨™ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
        return;
      }

      const emoji = {
        'å¥åº·':'ğŸ’ª','ä»•äº‹':'ğŸ’¼','å‹‰å¼·':'ğŸ“š','è¶£å‘³':'ğŸ¨','äººé–“é–¢ä¿‚':'ğŸ‘¥','ãŠé‡‘':'ğŸ’°','ãã®ä»–':'ğŸ“Œ'
      };

      container.innerHTML = currentGoals.map(goal => {
        const level = (goal.currentLevel ?? 0);
        const catEmoji = emoji[goal.category] || 'ğŸ“Œ';
        return `
          <div class="goal-item ${goal.completed ? 'completed' : ''}">
            <div class="row">
              <div class="goal-title">
                <span>${catEmoji}</span>
                <span>${escapeHtml(goal.text)}</span>
              </div>
              <div class="spacer"></div>
              <span class="chip">${catEmoji} ${escapeHtml(goal.category)}</span>
              <div class="goal-actions">
                <button class="icon-btn" onclick="window._toggleGoal(${goal.id})" title="å®Œäº†åˆ‡æ›¿">âœ…</button>
                <button class="icon-btn" onclick="window._deleteGoal(${goal.id})" title="å‰Šé™¤">ğŸ—‘ï¸</button>
              </div>
            </div>

            ${renderProgressBar(level)}

            <div class="progress-input">
              <select id="level-${goal.id}" aria-label="level">
                ${Array.from({length:11},(_,i)=>`<option value="${i}" ${i===level?'selected':''}>Lv.${i}</option>`).join('')}
              </select>
              <input id="comment-${goal.id}" class="input" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä¾‹ï¼šåŸºç¤ã‚³ãƒ¼ãƒ‰ã®ä½œæˆï¼‰" maxlength="120" />
              <button class="btn" onclick="window._addProgress(${goal.id})">ğŸ“¤ è¨˜éŒ²</button>
            </div>

            <div class="history">
              <details>
                <summary>ğŸ“š é€²æ—å±¥æ­´ã‚’è¡¨ç¤º</summary>
                <div style="margin-top:10px">
                  ${renderProgressHistory(goal)}
                </div>
              </details>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderGoalsProgress(){
      const container = document.getElementById('goalsProgress');
      if(!container) return;

      if(typeof selectedGoalsMonth === 'undefined' || !selectedGoalsMonth){
        selectedGoalsMonth = currentMonth;
      }

      const currentGoals = monthlyGoals.filter(g => g.month === selectedGoalsMonth);
      if(currentGoals.length === 0){
        container.innerHTML = `<div class="empty">ç›®æ¨™ã‚’è¿½åŠ ã™ã‚‹ã¨ã€ã“ã“ã«é›†è¨ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>`;
        return;
      }

      const total = currentGoals.length;
      const completed = currentGoals.filter(g => !!g.completed).length;
      const pct = Math.round((completed / total) * 100);

      // ã‚«ãƒ†ã‚´ãƒªåˆ¥
      const stats = {};
      for(const g of currentGoals){
        const k = g.category || 'ãã®ä»–';
        if(!stats[k]) stats[k] = {total:0, completed:0};
        stats[k].total++;
        if(g.completed) stats[k].completed++;
      }

      const statRows = Object.entries(stats).map(([k,v])=>{
        const p = Math.round((v.completed / v.total) * 100);
        return `<div class="row" style="padding:8px 0;border-top:1px solid #eee">
          <span class="chip">${escapeHtml(k)}</span>
          <span class="small">${v.completed}/${v.total}ï¼ˆ${p}%ï¼‰</span>
        </div>`;
      }).join('');

      container.innerHTML = `
        <div class="row">
          <div class="chip">âœ… å®Œäº† ${completed}/${total}</div>
          <div class="chip">ğŸ“ˆ é”æˆç‡ ${pct}%</div>
        </div>
        <div style="margin-top:10px">${renderProgressBar(Math.round(pct/10))}</div>
        <div style="margin-top:10px;border:2px solid #eee;border-radius:12px;padding:10px;background:var(--soft2)">
          <div class="small" style="font-weight:800;color:#111;margin-bottom:6px">ã‚«ãƒ†ã‚´ãƒªåˆ¥</div>
          ${statRows}
        </div>
      `;
    }

    /**************** Import / Export ****************/
    function openIoArea(mode){
      const area = document.getElementById('ioArea');
      const text = document.getElementById('ioText');
      const ioStatus = document.getElementById('ioStatus');
      area.style.display = 'block';
      ioStatus.textContent = '';
      if(mode === 'export'){
        text.value = JSON.stringify(monthlyGoals, null, 2);
      }else{
        text.value = '';
      }
      area.dataset.mode = mode;
    }

    function closeIoArea(){
      const area = document.getElementById('ioArea');
      area.style.display = 'none';
      area.dataset.mode = '';
      document.getElementById('ioStatus').textContent = '';
    }

    function applyImport(){
      const area = document.getElementById('ioArea');
      const mode = area.dataset.mode;
      if(mode !== 'import') return;

      const text = document.getElementById('ioText').value.trim();
      if(!text){
        showStatus('ioStatus', 'âŒ JSONã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„', true);
        return;
      }
      try{
        const v = JSON.parse(text);
        if(!Array.isArray(v)) throw new Error('Array expected');
        monthlyGoals = v;
        saveGoals();
        renderGoals();
        renderGoalsProgress();
        showStatus('ioStatus', 'âœ“ å¾©å…ƒã—ã¾ã—ãŸ');
      }catch(e){
        console.error(e);
        showStatus('ioStatus', 'âŒ JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', true);
      }
    }

    function clearGoals(){
      if(!confirm('localStorageã®ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      monthlyGoals = [];
      saveGoals();
      renderGoals();
      renderGoalsProgress();
      showStatus('goalStatus', 'âœ“ å…¨å‰Šé™¤ã—ã¾ã—ãŸ');
    }

    /**************** Boot ****************/
    document.addEventListener('DOMContentLoaded', () => {
      // tabs
      document.querySelectorAll('.tab-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>switchTab(btn.dataset.tab));
      });

      // goals nav + add
      document.getElementById('prevMonthBtn').addEventListener('click', ()=>changeGoalsMonth(-1));
      document.getElementById('nextMonthBtn').addEventListener('click', ()=>changeGoalsMonth(1));
      document.getElementById('addGoalBtn').addEventListener('click', addGoal);

      // Enter key on input
      document.getElementById('goalInput').addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){ e.preventDefault(); addGoal(); }
      });

      // IO
      document.getElementById('exportBtn').addEventListener('click', ()=>openIoArea('export'));
      document.getElementById('importBtn').addEventListener('click', ()=>openIoArea('import'));
      document.getElementById('closeIoBtn').addEventListener('click', closeIoArea);
      document.getElementById('applyImportBtn').addEventListener('click', applyImport);
      document.getElementById('clearBtn').addEventListener('click', clearGoals);

      // first paint
      updateGoalsMonthDisplay();
      renderGoals();
      renderGoalsProgress();
    });

    /**************** Expose only needed handlers (inline onclick uses these) ****************/
    window._deleteGoal = deleteGoal;
    window._toggleGoal = toggleGoalComplete;
    window._addProgress = addProgressToGoal;
  </script>
</body>
</html>
