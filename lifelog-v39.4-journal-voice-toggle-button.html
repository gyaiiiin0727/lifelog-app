<!DOCTYPE html>

<html lang="ja">
<head>
<!-- „Ç≠„É£„ÉÉ„Ç∑„É•ÁÑ°ÂäπÂåñ -->
<meta content="no-cache, no-store, must-revalidate" http-equiv="Cache-Control"/>
<meta content="no-cache" http-equiv="Pragma"/>
<meta content="0" http-equiv="Expires"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" name="viewport"/>
<title>„É©„Ç§„Éï„É≠„Ç∞„Ç¢„Éó„É™ v35.0 - ÂÆåÂÖ®‰øÆÊ≠£ÁâàÔºàwindowÂÖ¨Èñã‰øÆÊ≠£Ôºâ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js">
function renderDonutChart(canvasId, legendId, items, key, suffix) {
  const canvas = document.getElementById(canvasId);
  const legendEl = document.getElementById(legendId);
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const total = items.reduce((s, i) => s + (Number(i[key]) || 0), 0);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!total) {
    if (legendEl) legendEl.innerHTML = '';
    return;
  }

  const palette = ['#4F46E5','#16A34A','#F59E0B','#0EA5E9','#EF4444','#A855F7','#64748B','#22C55E','#E11D48','#F97316'];
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const rOuter = 140;
  const rInner = 88;

  let start = -Math.PI / 2;
  items.forEach((it, idx) => {
    const v = Number(it[key]) || 0;
    if (v <= 0) return;
    const angle = (v / total) * Math.PI * 2;
    const end = start + angle;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.closePath();
    ctx.fillStyle = palette[idx % palette.length];
    ctx.fill();

    ctx.beginPath();
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.stroke();

    start = end;
  });

  ctx.beginPath();
  ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  ctx.fillStyle = '#111';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.font = '700 18px system-ui';
  ctx.fillText('ÂêàË®à', cx, cy - 10);
  ctx.font = '800 22px system-ui';
  ctx.fillText(`${total}${suffix}`, cx, cy + 18);

  if (legendEl) {
    legendEl.innerHTML = items
      .filter(it => (Number(it[key]) || 0) > 0)
      .map((it, idx) => {
        const v = Number(it[key]) || 0;
        const pct = Math.round((v / total) * 100);
        return `<div class="legend-row">
          <span class="legend-dot" style="background:${palette[idx % palette.length]}"></span>
          <span class="legend-cat">${it.cat}</span>
          <span class="legend-amt">${v}${suffix}</span>
          <span class="legend-pct">${pct}%</span>
        </div>`;
      }).join('');
  }
}

</script>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
            background: #ffffff;
            color: #333;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        
        button {
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            touch-action: manipulation;
            user-select: none;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8em;
            color: #000;
        }
        
        .tab-nav {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab-nav::-webkit-scrollbar {
            display: none;
        }
        
        .tab-button {
            flex: 1;
            min-width: 80px;
            padding: 15px 10px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 0.95em;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            color: #000;
            border-bottom-color: #000;
            font-weight: 600;
        }
        
        .tab-button:active {
            opacity: 0.7;
        }
        
        .tab-content {
            position: relative;
            z-index: 1;
            display: none;
        }
        
        .tab-content.active {
            z-index: 10;
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .voice-button {
            width: 100%;
            padding: 18px;
            background: #fff;
            border: 2px solid #000;
            border-radius: 12px;
            font-size: 1.1em;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .voice-button:hover {
            background: #000;
            color: #fff;
        }
        
        .voice-button:active {
            transform: scale(0.98);
        }
        
        .voice-button.listening {
            background: #000;
            color: #fff;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .quick-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .quick-button {
            padding: 12px 8px;
            background: #fff;
            border: 1px solid #333;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .quick-button:hover {
            background: #f5f5f5;
            border-color: #000;
        }
        
        .quick-button.selected {
            background: #000;
            color: #fff;
            border-color: #000;
            font-weight: bold;
        }
        
        .quick-button:active {
            background: #000;
            color: #fff;
            transform: scale(0.95);
        }
        
        .text-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
        }
        
        .text-input:focus {
            outline: none;
            border-color: #000;
            border-width: 2px;
        }
        
        textarea.text-input {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }
        
        .add-button {
            width: 100%;
            padding: 14px;
            background: #000;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .add-button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            color: #666;
            font-size: 0.9em;
        }
        
        .logs-section {
            margin-top: 30px;
        }
        
        .section-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-item {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .log-item:hover {
            border-color: #000;
        }
        
        /* „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ„Éú„Çø„É≥ */
        .manage-button {
            padding: 8px 15px;
            background: #fff;
            color: #000;
            border: 1px solid #000;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .manage-button:hover {
            background: #000;
            color: #fff;
        }
        
        /* Ê∞óÂàÜÈÅ∏Êäû */
        /* „Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû„ÇíÈùûË°®Á§∫ */
        .category-selector,
        .category-required-hint,
        .selected-category-display {
            display: none !important;
        }

        /* journal„Çø„Éñ„ÅåÈùû„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊôÇ„ÅØÂÆåÂÖ®ÈùûË°®Á§∫ */
        .journal-tab:not(.active) {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* „Ç∏„É£„Éº„Éä„É´„Çø„Éñ‰ª•Â§ñ„Åß„ÅØÊ∞óÂàÜÈÅ∏Êäû„ÇíÈùûË°®Á§∫ */
        #reportActivity .mood-selector,
        #reportMoney .mood-selector,
        #goals .mood-selector {
            display: none !important;
        }
        
        /* „Ç∏„É£„Éº„Éä„É´„Çø„Éñ‰ª•Â§ñ„Åß„ÅØÊó•‰ªòÈÅ∏Êäû„Éª„ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Éª‰øùÂ≠ò„Éú„Çø„É≥„ÇíÈùûË°®Á§∫ */
        #reportActivity .date-selector,
        #reportMoney .date-selector,
        #goals .date-selector,
        #reportActivity textarea,
        #reportMoney textarea,
        .mood-selector {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }
        
        .mood-selector-title {
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            color: #000;
        }
        
        .mood-buttons {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }
        
        .mood-button {
            flex: 1;
            padding: 15px 5px;
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .mood-button:hover {
            border-color: #666;
            transform: translateY(-2px);
        }
        
        .mood-button.selected {
            border-color: #000;
            background: #f0f8ff;
            border-width: 3px;
        }
        
        .mood-emoji {
            font-size: 2em;
        }
        
        .mood-label {
            font-size: 0.8em;
            color: #666;
            font-weight: 500;
        }
        
        .mood-button.selected .mood-label {
            color: #000;
            font-weight: 600;
        }
        
        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: #fff;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #000;
        }
        
        .modal-close {
            float: right;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }
        
        .modal-close:hover {
            color: #000;
        }
        
        /* „Ç∏„É£„Éº„Éä„É´Ë¶ÅÁ¥Ñ„Çª„ÇØ„Ç∑„Éß„É≥ */
        .summary-section {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }
        
        .summary-section.active {
            display: block;
        }
        
        .summary-item {
            margin-bottom: 20px;
        }
        
        .summary-label {
            font-weight: 600;
            font-size: 1em;
            margin-bottom: 8px;
            color: #000;
        }
        
        .summary-content {
            padding: 12px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            min-height: 60px;
            white-space: pre-wrap;
        }
        
        .ai-comment {
            margin-top: 10px;
            padding: 12px;
            background: #f0f8ff;
            border-left: 4px solid #000;
            border-radius: 4px;
            font-size: 0.9em;
            color: #333;
        }
        
        .ai-comment::before {
            content: 'üí¨ AI„Åã„Çâ„ÅÆ„Ç≥„É°„É≥„Éà: ';
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }
        
        /* „Ç´„É¨„É≥„ÉÄ„Éº */
        .calendar {
            margin-top: 20px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .calendar-nav {
            padding: 8px 15px;
            background: #fff;
            border: 1px solid #000;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .calendar-nav:active {
            background: #000;
            color: #fff;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            padding: 10px 5px;
            font-size: 0.9em;
            color: #666;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            background: #fff;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            border-color: #000;
        }
        
        .calendar-day.today {
            background: #000;
            color: #fff;
            font-weight: 600;
        }
        
        .calendar-day.has-journal {
            background: #f0f8ff;
            border-color: #666;
        }
        
        .calendar-day.today.has-journal {
            background: #000;
            color: #fff;
        }
        
        .calendar-day.empty {
            background: transparent;
            border: none;
            cursor: default;
        }
        
        .calendar-day-mood {
            font-size: 1.2em;
            margin-top: 2px;
        }
        
        /* „É¨„Éù„Éº„Éà */
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            padding: 15px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 600;
            color: #000;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        /* AI„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ */
        .ai-feedback-container {
            margin: 20px 0;
            padding: 25px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            border: 2px solid #000;
        }
        
        .ai-feedback-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .feedback-section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        
        .feedback-section h4 {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 12px;
            color: #000;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .feedback-item {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }
        
        .feedback-icon {
            font-size: 1.2em;
        }
        
        .ai-advice-box {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #000;
            margin: 15px 0;
            line-height: 1.8;
        }
        
        .ai-advice-box::before {
            content: 'üí¨ AI„Åã„Çâ„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ';
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #000;
        }
        
        .goals-list {
            list-style: none;
            padding: 0;
        }
        
        .goals-list li {
            padding: 10px;
            margin: 8px 0;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 3px solid #000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .goals-list li::before {
            content: '‚Ä¢';
            font-size: 1.5em;
            color: #000;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5em;
                margin-bottom: 20px;
            }
            
            .tab-button {
                min-width: 70px;
                padding: 12px 8px;
                font-size: 0.85em;
            }
            
            .voice-button {
                padding: 16px;
                font-size: 1em;
            }
            
            .quick-buttons {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 8px;
            }
            
            .quick-button {
                padding: 10px 5px;
                font-size: 0.85em;
                min-height: 48px;
            }
            
            .modal-content {
                padding: 20px;
            }
        }

        /* Á∂ôÁ∂ö‰∏≠Ë°®Á§∫„ÅÆ„Çπ„Çø„Ç§„É´ */
        .ongoing-badge {
            display: inline-block;
            padding: 3px 8px;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            color: white;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .log-item.ongoing {
            border-left: 4px solid #22c55e;
            background: linear-gradient(to right, #f0fdf4, #ffffff);
        }

        .log-item {
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
        }

        .log-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .log-info {
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #666;
        }

        .time-display {
            color: #333;
            font-weight: 500;
        }

        .category-badge {
            padding: 2px 8px;
            background: #f0f0f0;
            border-radius: 12px;
            font-size: 0.9em;
        }

        .log-actions {
            display: flex;
            gap: 8px;
        }

        .log-actions button {
            padding: 5px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 0.9em;
        }

        .log-actions button:hover {
            background: #f5f5f5;
        }

        .end-btn {
            background: #22c55e !important;
            color: white !important;
            border: none !important;
            font-weight: bold;
        }

        .end-btn:hover {
            background: #16a34a !important;
        }
.report-section {
    margin: 20px 0;
    padding: 15px;
    background: #f9f9f9;
    border-radius: 8px;
}

.report-controls {
    margin-bottom: 15px;
    display: flex;
    gap: 10px;
    align-items: center;
}

.report-controls label {
    display: flex;
    gap: 5px;
    align-items: center;
}

.report-controls input[type="month"] {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.report-controls button {
    padding: 8px 16px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.report-controls button:hover {
    background: #45a049;
}

.category-summary {
    margin: 10px 0;
    padding: 15px;
    background: white;
    border-radius: 8px;
    border: 1px solid #ddd;
    cursor: pointer;
    transition: all 0.2s;
}

.category-summary:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}

.category-stats {
    display: flex;
    gap: 20px;
    margin-top: 5px;
    font-size: 0.9em;
    color: #666;
}

.category-details {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
    display: none;
}

.category-details.show {
    display: block;
}

.detail-item {
    padding: 10px;
    margin: 5px 0;
    background: #f5f5f5;
    border-radius: 4px;
    font-size: 0.9em;
}

.detail-item strong {
    display: block;
    margin-bottom: 5px;
}

.total-summary {
    margin: 20px 0;
    padding: 15px;
    background: #e3f2fd;
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
}

.btn-icon {
    background: none;
    border: none;
    font-size: 1.2em;
    cursor: pointer;
    padding: 5px;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.btn-icon:hover {
    opacity: 1;
}

.category-badge {
    display: inline-block;
    padding: 2px 8px;
    background: #f0f0f0;
    border-radius: 4px;
    font-size: 0.85em;
    color: #666;
}
/* ÁõÆÊ®ôÊ©üËÉΩ„ÅÆ„Çπ„Çø„Ç§„É´ */
.goals-section {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.goals-list-section {
    margin: 20px 0;
}

.goal-item {
    background: white;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    border: 2px solid #e0e0e0;
    transition: all 0.2s;
}

.goal-item:hover {
    border-color: #4CAF50;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.goal-item.completed {
    opacity: 0.7;
    background: #f0f8f0;
}

.goal-item.completed .goal-text {
    text-decoration: line-through;
    color: #999;
}

.goal-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.goal-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.goal-text {
    flex: 1;
    font-size: 1.05em;
    font-weight: 500;
}

.goal-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.goal-category {
    padding: 4px 10px;
    background: #f0f0f0;
    border-radius: 4px;
    font-size: 0.9em;
}

.goals-progress-section {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
}

.progress-summary {
    margin-bottom: 20px;
}

.progress-bar-container {
    width: 100%;
    height: 30px;
    background: #e0e0e0;
    border-radius: 15px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

.progress-text {
    text-align: center;
    font-size: 1.2em;
    font-weight: bold;
    color: #4CAF50;
}

.category-progress h4 {
    margin-bottom: 15px;
    color: #333;
}

.category-stat {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    margin: 5px 0;
    background: white;
    border-radius: 4px;
    border-left: 4px solid #4CAF50;
}

.goals-feedback-section {
    margin: 20px 0;
}

.goals-feedback-section h3 {
    margin-bottom: 15px;
}

.feedback-content {
    line-height: 1.8;
}

.feedback-content p {
    margin: 15px 0;
}

.feedback-content ul {
    padding-left: 20px;
}

.feedback-content li {
    margin: 8px 0;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #999;
    font-size: 1.1em;
}
/* „Ç∏„É£„Éº„Éä„É´„É≠„Ç∞„ÅÆÊîπÂñÑ„Çπ„Çø„Ç§„É´ */
.journal-log-item {
    background: white;
    border-radius: 12px;
    margin: 15px 0;
    padding: 15px;
    border: 2px solid #e0e0e0;
    transition: all 0.2s;
}

.journal-log-item:hover {
    border-color: #4CAF50;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.journal-log-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    padding: 5px 0;
}

.journal-date {
    font-weight: 600;
    font-size: 1.05em;
    color: #333;
}

.toggle-icon {
    color: #999;
    font-size: 0.9em;
    transition: transform 0.2s;
}

.journal-summary-preview {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #f0f0f0;
}

.summary-preview-item {
    margin: 10px 0;
}

.summary-label-mini {
    display: inline-block;
    font-weight: 600;
    font-size: 0.9em;
    margin-bottom: 5px;
    color: #555;
}

.summary-items {
    margin-left: 10px;
}

.summary-bullet {
    font-size: 0.95em;
    color: #666;
    line-height: 1.6;
    margin: 3px 0;
}

.summary-more {
    font-size: 0.85em;
    color: #999;
    font-style: italic;
    margin-top: 3px;
}

.journal-detail {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.journal-detail.show {
    max-height: 2000px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 2px solid #e0e0e0;
}

.journal-full-text {
    background: #f9f9f9;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.journal-full-text strong {
    display: block;
    margin-bottom: 10px;
    color: #333;
}

.journal-full-summary {
    background: #f0f8ff;
    padding: 15px;
    border-radius: 8px;
}

.journal-full-summary > strong {
    display: block;
    margin-bottom: 15px;
    color: #333;
}

.summary-detail-section {
    margin: 15px 0;
}

.summary-detail-label {
    font-weight: 600;
    color: #555;
    margin-bottom: 8px;
}

.summary-detail-item {
    margin: 5px 0;
    padding-left: 10px;
    color: #666;
    line-height: 1.6;
}
/* ÊâãÂãï„Ç´„ÉÜ„Ç¥„É™ÈÅ∏ÊäûUI */
.category-selector {
    margin: 15px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px solid #e9ecef;
}

.category-selector-title {
    font-size: 14px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.category-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 10px;
}

.category-btn {
    padding: 12px;
    border: 2px solid #dee2e6;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.category-btn:hover {
    background: #f8f9fa;
    transform: translateY(-1px);
}

.category-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.category-btn.good { border-color: #28a745; }
.category-btn.good.active { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-color: #28a745; }

.category-btn.more { border-color: #17a2b8; }
.category-btn.more.active { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); border-color: #17a2b8; }

.category-btn.worry { border-color: #ffc107; }
.category-btn.worry.active { background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); border-color: #ffc107; color: white; }

.category-btn.task { border-color: #007bff; }
.category-btn.task.active { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); border-color: #007bff; }

.selected-category-display {
    padding: 8px 12px;
    background: white;
    border-radius: 6px;
    font-size: 13px;
    text-align: center;
    color: #6c757d;
    border: 1px solid #dee2e6;
}

.selected-category-display.has-selection {
    font-weight: 600;
    color: #495057;
}

/* Èü≥Â£∞ÂÖ•Âäõ„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´Ë™øÊï¥ */
.voice-input-section {
    position: relative;
}

.category-required-hint {
    font-size: 12px;
    color: #dc3545;
    margin-top: 5px;
    display: none;
}

.category-required-hint.show {
    display: block;
}

        /* „ÅäÈáë„Çø„Éñ: ÂèéÂÖ•/ÊîØÂá∫„Çø„Éñ */
        .money-type-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .money-type-tab {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .money-type-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .money-categories {
            display: none;
            margin-bottom: 20px;
        }
        
        .money-categories.active {
            display: block;
        }
        
        .money-category-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .category-edit-button {
            width: 100%;
            padding: 12px;
            background: #f0f0f0;
            border: 2px dashed #999;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .category-edit-button:hover {
            background: #e0e0e0;
            border-color: #666;
        }

        /* ‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØË°®Á§∫ */
        .today-tasks-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .today-tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .today-tasks-header h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        
        .refresh-tasks-button {
            padding: 8px 15px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .refresh-tasks-button:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }
        
        .today-tasks-content {
            background: white;
            border-radius: 12px;
            padding: 15px;
        }
        
        .task-group {
            margin-bottom: 20px;
        }
        
        .task-group:last-child {
            margin-bottom: 0;
        }
        
        .task-group-title {
            font-weight: bold;
            font-size: 16px;
            color: #667eea;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }
        
        .task-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #f9f9f9;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .task-item:hover {
            background: #f0f0f0;
        }
        
        .task-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }
        
        .task-label {
            flex: 1;
            font-size: 15px;
            color: #333;
            cursor: pointer;
        }
        
        .task-checkbox:checked + .task-label {
            text-decoration: line-through;
            color: #999;
        }
        
        .loading-tasks,
        .no-tasks {
            text-align: center;
            color: #999;
            padding: 20px;
            font-size: 14px;
        }

        /* ÁõÆÊ®ô„ÅÆÊúàÈÅ∏Êäû */
        .month-selector-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .month-nav-button {
            padding: 10px 20px;
            background: white;
            border: 2px solid white;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .month-nav-button:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }
        
        .current-month-display {
            font-size: 24px;
            font-weight: bold;
            color: white;
            min-width: 180px;
            text-align: center;
        }

        /* „Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ */
        .category-edit-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px;
        }
        
        .category-edit-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }
        
        .category-edit-item:hover {
            background: #f0f0f0;
        }
        
        .category-edit-emoji {
            font-size: 24px;
            margin-right: 12px;
        }
        
        .category-edit-name {
            flex: 1;
            font-size: 16px;
            font-weight: 500;
        }
        
        .add-category-section {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .add-category-section h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #333;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .input-field-small {
            width: 60px;
            padding: 10px;
            font-size: 20px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        
        .btn-primary-small {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .btn-primary-small:hover {
            transform: scale(1.05);
        }

        /* „É¨„Éù„Éº„ÉàÊ©üËÉΩ„ÅÆ„Çπ„Çø„Ç§„É´ */
        .report-type-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .report-type-tab {
            flex: 1;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .report-type-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .report-content {
            display: none;
        }
        
        .report-content.active {
            display: block;
        }
        
        .report-month-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
        }
        
        .month-nav-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid white;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .month-nav-btn:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }
        
        .report-current-month {
            font-size: 24px;
            font-weight: bold;
            color: white;
            min-width: 180px;
            text-align: center;
        }
        
        /* „Ç´„É¨„É≥„ÉÄ„Éº */
        .report-calendar {
            margin-bottom: 30px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 12px;
        }
        
        .calendar-header {
            padding: 10px;
            text-align: center;
            font-weight: bold;
            background: #667eea;
            color: white;
            border-radius: 8px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            padding: 8px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .calendar-day.empty {
            background: transparent;
            cursor: default;
        }
        
        .calendar-day.has-records {
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            border: 2px solid #00acc1;
        }
        
        .calendar-day.has-records:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .calendar-day-number {
            font-weight: bold;
            font-size: 16px;
        }
        
        .calendar-day-count {
            font-size: 12px;
            color: #00acc1;
            margin-top: 4px;
        }
        
        .calendar-day-balance {
            font-size: 11px;
            margin-top: 4px;
            font-weight: bold;
        }
        
        .calendar-day-balance.positive {
            color: #4caf50;
        }
        
        .calendar-day-balance.negative {
            color: #f44336;
        }
        
        /* Ê¶ÇË¶Å */
        .report-summary {
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 16px;
        }
        
        .report-summary h3 {
            margin: 0 0 15px 0;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .summary-stat-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-stat-item.income {
            border-left: 4px solid #4caf50;
        }
        
        .summary-stat-item.expense {
            border-left: 4px solid #f44336;
        }
        
        .summary-stat-item.positive {
            border-left: 4px solid #4caf50;
        }
        
        .summary-stat-item.negative {
            border-left: 4px solid #f44336;
        }
        
        .summary-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        
        .summary-stat-label {
            font-size: 14px;
            color: #666;
        }
        
        /* „Ç∞„É©„Éï */
        .report-chart-section {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .report-chart-section h3 {
            margin: 0 0 15px 0;
        }
        
        /* Êó•Âà•Ë©≥Á¥∞ */
        .report-details {
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .report-details h3 {
            margin: 0 0 15px 0;
        }
        
        .daily-detail-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .daily-detail-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .daily-detail-item.income {
            border-left-color: #4caf50;
        }
        
        .daily-detail-item.expense {
            border-left-color: #f44336;
        }
        
        .daily-detail-time {
            font-size: 14px;
            color: #999;
            white-space: nowrap;
        }
        
        .daily-detail-content {
            flex: 1;
        }
        
        .daily-detail-category {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .daily-detail-text {
            color: #333;
            margin-bottom: 5px;
        }
        
        .daily-detail-amount {
            font-weight: bold;
            font-size: 16px;
        }
        
        .daily-summary {
            padding: 12px;
            background: #f0f7ff;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        /* „Ç∑„É≥„Éó„É´„Å™ÁôΩÈªí„Éì„Ç∏„Éç„Çπ„Éá„Ç∂„Ç§„É≥ */
        .simple-month-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: #ffffff;
            border: 2px solid #000000;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .simple-nav-btn {
            padding: 10px 20px;
            background: #000000;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .simple-nav-btn:hover {
            background: #333333;
        }
        
        .simple-month-display {
            font-size: 24px;
            font-weight: 700;
            color: #000000;
        }
        
        /* „Ç´„É¨„É≥„ÉÄ„Éº */
        .simple-calendar {
            background: #ffffff;
            border: 2px solid #000000;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .calendar-header {
            padding: 12px;
            text-align: center;
            font-weight: 700;
            background: #000000;
            color: #ffffff;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .calendar-day {
            min-height: 60px;
            padding: 8px;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .calendar-day.empty {
            background: #f5f5f5;
            border-color: #f5f5f5;
            cursor: default;
        }
        
        .calendar-day.has-records {
            background: #f9f9f9;
            border: 2px solid #000000;
        }
        
        .calendar-day.has-records:hover {
            background: #e8e8e8;
        }
        
        .calendar-day-number {
            font-weight: 700;
            font-size: 18px;
            color: #000000;
            margin-bottom: 4px;
        }
        
        .calendar-day-count {
            font-size: 12px;
            color: #666666;
            font-weight: 600;
        }
        
        .calendar-day-balance {
            font-size: 11px;
            font-weight: 700;
            margin-top: 4px;
        }
        
        .calendar-day-balance.positive {
            color: #000000;
        }
        
        .calendar-day-balance.negative {
            color: #666666;
        }
        
        /* Ê¶ÇË¶Å */
        .simple-summary {
            background: #ffffff;
            border: 2px solid #000000;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .simple-summary h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 700;
            color: #000000;
            border-bottom: 2px solid #000000;
            padding-bottom: 10px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .summary-stat-item {
            background: #f9f9f9;
            border: 1px solid #000000;
            border-radius: 4px;
            padding: 15px;
            text-align: center;
        }
        
        .summary-stat-item.income {
            border-left: 4px solid #000000;
        }
        
        .summary-stat-item.expense {
            border-left: 4px solid #666666;
        }
        
        .summary-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #000000;
            margin-bottom: 8px;
        }
        
        .summary-stat-label {
            font-size: 14px;
            color: #666666;
            font-weight: 600;
        }
        
        /* „Ç∞„É©„Éï */
        .simple-chart {
            background: #ffffff;
            border: 2px solid #000000;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .simple-chart h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 700;
            color: #000000;
            border-bottom: 2px solid #000000;
            padding-bottom: 10px;
        }
        
        /* Êó•Âà•Ë©≥Á¥∞ */
        .simple-details {
            background: #ffffff;
            border: 2px solid #000000;
            border-radius: 4px;
            padding: 20px;
        }
        
        .simple-details h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 700;
            color: #000000;
            border-bottom: 2px solid #000000;
            padding-bottom: 10px;
        }
        
        .empty-message {
            text-align: center;
            color: #999999;
            padding: 30px;
            font-size: 14px;
        }
        
        .daily-detail-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .daily-detail-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            border-left: 4px solid #000000;
        }
        
        .daily-detail-item.income {
            border-left-color: #000000;
        }
        
        .daily-detail-item.expense {
            border-left-color: #666666;
        }
        
        .daily-detail-time {
            font-size: 14px;
            color: #666666;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .daily-detail-content {
            flex: 1;
        }
        
        .daily-detail-category {
            font-weight: 700;
            color: #000000;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .daily-detail-text {
            color: #333333;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .daily-detail-amount {
            font-weight: 700;
            font-size: 16px;
            color: #000000;
        }
        
        .daily-summary {
            padding: 15px;
            background: #f9f9f9;
            border: 1px solid #000000;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 700;
            color: #000000;
        }
    
/* ===== Monochrome UI overrides (v35.4) ===== */
body { background:#fff !important; color:#111 !important; }
.container { max-width: 980px !important; }
h1 { font-size:20px !important; }

.tab-nav{
  border-bottom: 2px solid #e6e6e6 !important;
  background:#fff !important;
}
.tab-button{
  background: transparent !important;
  color:#666 !important;
  border:none !important;
  border-bottom: 3px solid transparent !important;
  padding: 12px 10px !important;
  border-radius: 0 !important;
  box-shadow:none !important;
}
.tab-button.active{
  color:#111 !important;
  border-bottom-color:#111 !important;
  font-weight:800 !important;
}
.tab-content{ padding-top:16px !important; }

button, .btn-primary, .refresh-tasks-button, .action-btn, .save-btn{
  border-radius: 10px !important;
}

.btn-primary, .save-btn, .action-btn.primary, .refresh-tasks-button{
  background:#111 !important;
  border:2px solid #111 !important;
  color:#fff !important;
}
.btn-secondary, .action-btn.secondary{
  background:#fff !important;
  border:2px solid #111 !important;
  color:#111 !important;
}

/* Cards / sections */
.today-tasks-section, .section, .card, .goals-input-section, .goals-list-section, .goals-progress-section, .goals-feedback-section{
  background:#fff !important;
  border:2px solid #111 !important;
  border-radius:12px !important;
  box-shadow:none !important;
}
.status-message{ color:#666 !important; }

/* Inputs */
input, select, textarea{
  border:2px solid #111 !important;
  border-radius:10px !important;
  background:#fff !important;
  color:#111 !important;
}
input::placeholder, textarea::placeholder{ color:#888 !important; }

/* Goal progress bars: force monochrome */
.progress-bar-fill, .progress-fill{
  background:#111 !important;
}
.goal-item{
  border:2px solid #ddd !important;
  border-radius:12px !important;
  background:#fff !important;
}
.goal-item.completed{ opacity:.75 !important; }


/* ===== Journal v2 (fixed fields) ===== */
.journal-v2.card{ margin-top: 10px; }
.journal-v2-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.journal-v2-label{ font-weight:800; color:#111; }
.journal-v2-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px; }
.journal-v2-grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px; }
@media (max-width: 760px){
  .journal-v2-grid, .journal-v2-grid2{ grid-template-columns:1fr; }
}
.journal-v2-field-head{ font-weight:900; margin-bottom:6px; }
.journal-v2-voice.card{ border:2px solid #111; border-radius:12px; padding:12px; background:#fff; margin-top:12px; }
.empty-state{ padding:18px; border:2px dashed #ccc; border-radius:12px; color:#666; background:#fafafa; }

/* hide legacy journal category/mood UI to keep one UX */
#journal .category-selector, 
#journal .mood-selector,
#journal #categoryRequiredHint,
#journal .selected-category-display{
  display:none !important;
}
/* make legacy voice button monochrome if still visible */
#journal #journalVoiceButton{
  background:#111 !important;
  color:#fff !important;
  border:2px solid #111 !important;
  border-radius:10px !important;
}


/* ===== FIX: progress bar fill (v36.4) ===== */
.progress-bar-fill{
  height: 100%;
  width: 0%;
  background: #111;
  border-radius: 15px;
  display: block;
  transition: width 0.25s ease;
}


/* ===== Enhancement: 10% tick marks on progress bar (v36.5) ===== */
.progress-bar-container{
  position: relative;
  overflow: hidden;
}
/* tick overlay */
.progress-bar-container::after{
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  background:
    repeating-linear-gradient(
      to right,
      rgba(0,0,0,0.22) 0px,
      rgba(0,0,0,0.22) 1px,
      rgba(0,0,0,0) 1px,
      rgba(0,0,0,0) 10%
    );
  mix-blend-mode: multiply;
}


/* ===== Enhancement: fill ends square at tick boundary (v36.6) ===== */
.progress-bar-container{
  overflow: hidden; /* Ëßí‰∏∏„ÅØÂ§ñÊû†„Å†„Åë„Å´ÈÅ©Áî® */
}
.progress-bar-fill{
  border-radius: 999px 0 0 999px; /* Â∑¶„Å†„Åë‰∏∏„Åè„ÄÅÂè≥Á´Ø„ÅØËßí„Å´„Åô„Çã */
}


/* ===== Enhancement: block (10 segments) filled gauge (v36.7) ===== */
.progress-bar-container{
  border-radius: 999px;
  overflow: hidden;
}
/* Fill uses block pattern aligned to 10% segments */
.progress-bar-fill{
  height: 100%;
  background:
    repeating-linear-gradient(
      to right,
      #111 0%,
      #111 9%,
      transparent 9%,
      transparent 10%
    );
  border-radius: 999px 0 0 999px; /* left rounded, right squared */
}


/* ===== Enhancement: MUST/WANT visual differentiation (v36.8) ===== */
.journal-v2-field.must .journal-v2-field-head{
  display:inline-block;
  padding: 6px 10px;
  border-radius: 999px;
  background:#111;
  color:#fff;
}
.journal-v2-field.want .journal-v2-field-head{
  display:inline-block;
  padding: 6px 10px;
  border-radius: 999px;
  background:#fff;
  color:#111;
  border:2px dashed #111;
}

/* textarea emphasis */
#journalV2Must{
  border:2px solid #111 !important;
}
#journalV2Want{
  border:2px dashed #111 !important;
}

/* (optional) if you later add progress bars for MUST/WANT, these helpers are ready */
.progress-bar-fill.must{
  background:
    repeating-linear-gradient(to right,#111 0%,#111 9%,transparent 9%,transparent 10%);
}
.progress-bar-fill.want{
  background:
    repeating-linear-gradient(45deg,#111 0,#111 6px, transparent 6px, transparent 12px);
}


/* ===== AI Summary Cards UI (v36.9) ===== */
.ai-summary-cards{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:16px;}
@media(max-width:760px){.ai-summary-cards{grid-template-columns:1fr;}}
.ai-summary-card{border:2px solid #111;border-radius:14px;padding:14px;background:#fff;}
.ai-summary-title{font-weight:900;margin-bottom:10px;}
.ai-summary-body{display:grid;grid-template-columns:auto 1fr;gap:8px 10px;align-items:start;}
.ai-chip{font-size:12px;padding:4px 8px;border-radius:999px;background:#eee;font-weight:700;white-space:nowrap;}
.ai-chip.must{background:#111;color:#fff;}
.ai-chip.want{background:#fff;color:#111;border:2px dashed #111;}
.ai-text{font-size:14px;line-height:1.5;color:#111;}


/* ===== Journal Simplify UI (v37.0) ===== */
#journalV2Target{ display:none !important; }
.journal-v2-grid, .journal-v2-grid2{ display:none !important; }
.journal-simple.card{ border:2px solid #111; border-radius:14px; padding:14px; background:#fff; margin-top:12px; }
.journal-hints{ margin:0 0 12px 18px; padding:0; color:#111; }
.journal-hints li{ margin:4px 0; }
.journal-raw{ min-height: 220px; line-height:1.55; }
.journal-simple-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px; }


/* ===== Journal Ultra Simple (v37.1) ===== */
.journal-v2.card{ padding:16px !important; }
.journal-v2-voice.card{ background:#111 !important; color:#fff !important; border:2px solid #111 !important; }
.journal-v2-voice.card .section-title, .journal-v2-voice.card .small{ color:#fff !important; }
#journalV2VoiceBtn{ width:100% !important; padding:18px 16px !important; font-size:18px !important; border-radius:14px !important; }
#journalV2StopBtn{ padding:12px 14px !important; border-radius:12px !important; }
.journal-hints{ display:none !important; }
.ai-summary-cards{ display:none !important; }

.journal-raw{ min-height: 220px; font-size:16px; }
.journal-log{ margin-top:16px; border:2px solid #111; border-radius:14px; padding:14px; background:#fff; }
.journal-log-title{ font-weight:900; margin-bottom:10px; }
.journal-log-item{ border-top:1px solid #eee; padding-top:10px; margin-top:10px; }
.journal-log-item:first-child{ border-top:none; padding-top:0; margin-top:0; }
.journal-log-head{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.journal-log-date{ font-weight:900; }
.journal-log-actions{ margin-left:auto; display:flex; gap:8px; }
.journal-log-snippet{ color:#444; margin-top:6px; white-space:pre-wrap; }
details.journal-summary{ margin-top:8px; }
details.journal-summary summary{ cursor:pointer; font-weight:800; }
.journal-summary-open{ margin-top:8px; padding-top:8px; border-top:1px dashed #e0e0e0; }

.summary-grid{ display:grid; grid-template-columns:auto 1fr; gap:6px 10px; margin-top:8px; }
.summary-k{ font-size:12px; padding:4px 8px; border-radius:999px; background:#eee; font-weight:700; white-space:nowrap; }
.summary-k.must{ background:#111; color:#fff; }
.summary-k.want{ background:#fff; color:#111; border:2px dashed #111; }
.summary-v{ white-space:pre-wrap; font-size:13px; }
.journal-controls-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:12px; }
#journalV3SummarizeBtn{ background:#fff !important; color:#111 !important; border:2px solid #111 !important; }


/* ===== v37.3 Journal layout fixes ===== */
#journalInput{ display:none !important; } /* legacy journal textarea only */
#journalStatus{ display:none !important; } /* legacy journal status only */
button.add-button[onclick*="saveJournalWithAI"]{ display:none !important; } /* legacy journal save only */
.journal-today-summary{
  margin-top:16px;
  border:2px solid #111;
  border-radius:14px;
  padding:14px;
  background:#fff;
}
.journal-v2-voice.card .journal-v2-row label{ display:none !important; }
.journal-v2-voice.card .journal-v2-row select{ display:none !important; }
.journal-v2-voice.card .journal-v2-row{ justify-content:center; }

/* ===== v37.5 Journal UI polish (scoped) ===== */
#journal .journal-v2.card{ padding:16px !important; }
#journal .journal-v2-voice.card{
  background:#111 !important; color:#fff !important; border:2px solid #111 !important;
  padding:12px !important; border-radius:14px !important;
}
#journal .journal-v2-voice.card .section-title{ margin:0 0 8px !important; color:#fff !important; }
#journal #journalV2VoiceBtn{ width:100% !important; padding:14px 12px !important; font-size:16px !important; border-radius:12px !important; }
#journal #journalV2StopBtn{ padding:10px 12px !important; border-radius:12px !important; }
#journal .journal-v2-voice.card .small{ display:none !important; } /* Èï∑Êñá„ÅÆÊ≥®ÊÑèÊñá„ÅØÈùûË°®Á§∫ */
#journal .journal-v2-voice.card .journal-v2-row{ justify-content:flex-start !important; gap:10px !important; }

#journal .journal-simple.card{ border:2px solid #111 !important; border-radius:14px !important; padding:14px !important; }
#journal #journalV3Raw{
  width:100% !important;
  min-height: 180px !important;
  resize: vertical !important;
  font-size:16px !important;
  line-height:1.55 !important;
}

#journal .journal-hints{
  list-style:none !important;
  margin:10px 0 0 !important;
  padding:0 !important;
  display:flex !important;
  flex-wrap:wrap !important;
  gap:8px !important;
}
#journal .journal-hints li{
  margin:0 !important;
  padding:6px 10px !important;
  border:1px solid #ddd !important;
  border-radius:999px !important;
  background:#f6f6f6 !important;
  font-size:12px !important;
}

#journal .journal-simple-row{ margin-top:10px !important; }

/* Êóß„Ç∏„É£„Éº„Éä„É´Êó•‰ªò„Éñ„É≠„ÉÉ„ÇØ„ÅØJS„ÅßÂâäÈô§ÔºàÂøµ„ÅÆ„Åü„ÇÅ input „ÇÇÈö†„ÅôÔºâ */
#journal #journalDate{ display:none !important; }


/* ===== v37.6 Journal UI: single date, single voice bar, no legacy blocks ===== */
#journal #journalDate, #journal button[onclick*="setJournalDateToToday"] { display:none !important; } /* legacy date selector */
#journal #journalVoiceButton { display:none !important; } /* legacy big voice button */
#journal .mood-selector, #journal .category-selection-section { display:none !important; } /* legacy selectors */
#journal button.add-button[onclick*="saveJournalWithAI"]{ display:none !important; } /* legacy save */
#journal #journalInput { display:none !important; } /* legacy textarea */
#journal .journal-hints-memo, #journal .journal-hints-list, #journal .hint-box { display:none !important; } /* legacy hints if any */

/* keep only ONE voice UI (our v2 buttons) and style like your image */
#journal .journal-v2-voice.card{
  background: transparent !important;
  border: none !important;
  padding: 0 !important;
  margin: 10px 0 14px !important;
  box-shadow: none !important;
}
#journal .journal-v2-voice.card .section-title,
#journal .journal-v2-voice.card .small{
  display:none !important;
}

/* big black bar button */
#journal #journalV2VoiceBtn{
  width:100% !important;
  background:#111 !important;
  color:#fff !important;
  border:2px solid #111 !important;
  border-radius:10px !important;
  padding:14px 16px !important;
  font-size:16px !important;
  font-weight:800 !important;
  box-shadow:none !important;
}

/* stop button centered below */
#journal #journalV2StopBtn{
  display:block !important;
  margin:10px auto 0 !important;
  border-radius:8px !important;
  padding:10px 18px !important;
  border:2px solid #111 !important;
  background:#fff !important;
  color:#111 !important;
  font-weight:800 !important;
}

/* make transcript textarea look natural */
#journal #journalV3Raw{
  width:100% !important;
  min-height:160px !important;
  resize: vertical !important;
}

/* hint chips already exist; make them compact */
#journal .journal-hint-chips{ display:flex; flex-wrap:wrap; gap:8px; margin:10px 0 12px; }
#journal .journal-hint-chip{ border:1px solid #ddd; background:#f6f6f6; padding:6px 10px; border-radius:999px; font-size:12px; color:#222; }

/* hide extra technical buttons to keep simple (JSON / ÂÖ®ÂâäÈô§ / IO) */
#journal #journalV2ExportBtn, #journal #journalV2ImportBtn, #journal #journalV2ClearBtn,
#journal #journalV2IO { display:none !important; }


/* ===== v37.7 Journal polish: softer borders + prominent AI button + big mood cards ===== */
#journal .card{ border:1px solid #e6e6e6 !important; box-shadow:none !important; }
#journal .journal-simple.card, 
#journal .journal-v2.card,
#journal .journal-today-summary,
#journal .journal-log{ border:1px solid #e6e6e6 !important; }
#journal .section-title{ border:none !important; }
#journal .journal-v2-voice.card{ border:none !important; }
#journal .input, #journal textarea{ border:1px solid #dcdcdc !important; }
#journal #journalV3Raw{ border:1px solid #d0d0d0 !important; border-radius:10px !important; }

/* Mood cards */
#journal .journal-mood-wrap{
  margin-top:12px;
  border:1px solid #e6e6e6;
  border-radius:14px;
  padding:14px;
  background:#fff;
}
#journal .journal-mood-title{
  font-weight:900;
  text-align:center;
  margin-bottom:12px;
}
#journal .journal-mood-grid{
  display:grid;
  grid-template-columns: repeat(5, minmax(110px, 1fr));
  gap:12px;
}
@media (max-width: 760px){
  #journal .journal-mood-grid{ grid-template-columns: repeat(5, 1fr); gap: 8px; }
  #journal .mood-card{padding: 12px 6px; border-radius: 18px;}
  #journal .mood-emoji{font-size: 26px; margin-bottom: 6px;}
  #journal .mood-label{font-size: 12px;}
}
#journal .mood-card{
  border:2px solid #e0e0e0;
  border-radius:18px;
  padding:16px 10px;
  background:#fff;
  cursor:pointer;
  text-align:center;
  user-select:none;
}
#journal .mood-emoji{ font-size:34px; line-height:1; margin-bottom:10px; }
#journal .mood-label{ font-weight:800; }
#journal .mood-card.active{
  border-color:#111;
  box-shadow: 0 0 0 2px rgba(17,17,17,0.08);
}

/* Actions row */
#journal .journal-actions-row{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin-top:12px;
}
#journal #journalV3SummarizeBtn{
  background:#111 !important;
  color:#fff !important;
  border:2px solid #111 !important;
  border-radius:12px !important;
  padding:12px 16px !important;
  font-weight:900 !important;
}
#journal #journalV3SummarizeBtn:hover{ filter:brightness(0.95); }
#journal #journalV3SummarizeBtn:active{ transform:translateY(1px); }

#journal .btn-primary{ border-radius:12px !important; }


/* ===== v37.8 Journal layout closer to target (mobile-first) ===== */
#journal .journal-dateblock{
  background:#f7f7f7;
  border:1px solid #e6e6e6;
  border-radius:14px;
  padding:14px;
  margin:12px 0 14px;
}
#journal .journal-date-title{ font-weight:900; margin-bottom:10px; }
#journal .journal-date-row{ display:flex; gap:10px; align-items:center; }
#journal .journal-date-row .input{ flex:1; height:44px; border-radius:12px; }
#journal .btn-today{
  height:44px;
  padding:0 14px;
  border-radius:12px;
  border:1px solid #2e7d32;
  background:#2e7d32;
  color:#fff;
  font-weight:900;
}
#journal .journal-top-actions{
  display:flex;
  gap:10px;
  margin-top:12px;
}
#journal .journal-top-actions .btn-primary{
  height:44px;
  padding:0 16px;
  border-radius:12px;
  border:2px solid #111;
  background:#111;
  color:#fff;
  font-weight:900;
}
#journal .journal-top-actions .btn-ai{
  height:44px;
  padding:0 16px;
  border-radius:12px;
  border:2px solid #111;
  background:#111;
  color:#fff;
  font-weight:900;
  flex:1;
}

#journal .journal-ai-sticky{
  display:none;
}
@media (max-width: 760px){
  /* hide top action row on mobile and use sticky bottom bar like your mock */
  #journal .journal-top-actions{ display:none; }
  #journal .journal-ai-sticky{
    display:block;
    position:sticky;
    bottom:0;
    width:100%;
    margin:14px 0 0;
    background:#111;
    color:#fff;
    border:2px solid #111;
    border-radius:12px;
    padding:14px 16px;
    font-weight:900;
    z-index:10;
  }
}



/* ===== v37.9 UX: mood under date + big AI button under content ===== */
#journal .mood-selector{ margin: 12px 0 14px; border:1px solid #e6e6e6; border-radius:14px; padding:14px; background:#fff; }
#journal .mood-selector-title{ font-weight:900; text-align:center; margin-bottom:12px; }
#journal .mood-buttons{ display:grid; grid-template-columns: repeat(5, minmax(110px, 1fr)); gap:12px; }
@media (max-width: 760px){
  #journal .mood-buttons{ grid-template-columns: repeat(5, 1fr); gap: 8px; }
  #journal .mood-button{ padding: 12px 6px; border-radius: 18px; }
  #journal .mood-emoji{ font-size: 26px; margin-bottom: 6px; }
  #journal .mood-label{ font-size: 12px; }
}
#journal .mood-button{ border:2px solid #e0e0e0; border-radius:18px; padding:16px 10px; background:#fff; }
#journal .mood-emoji{ font-size:34px; margin-bottom:10px; display:block; }
#journal .mood-label{ font-weight:800; }
#journal .mood-button.selected, #journal .mood-button.active{ border-color:#111; }

#journal .journal-ai-inline{ margin-top:14px; }
#journal .journal-ai-big{
  width:100%;
  background:#111;
  color:#fff;
  border:2px solid #111;
  border-radius:14px;
  padding:18px 16px;
  font-weight:900;
  font-size:18px;
}
#journal .journal-ai-big:active{ transform: translateY(1px); }

/* remove sticky bar from v37.8 */
#journal .journal-ai-sticky{ display:none !important; }


/* ===== v38.0 Final journal tweaks (remove duplicates + place mood under date + big AI under content) ===== */
#journal .journal-top-actions .btn-ai{ display:none !important; } /* no top AI */
#journal #journalV3SummarizeBtn{ display:none !important; } /* keep logic but hide */
#journal #journalV2Mood, #journal #journalV2SummarizeBtn{ display:none !important; }

/* Mood cards layout (bigger tap targets) */
#journal .journal-mood-wrap{
  margin: 12px 0 14px;
  border:1px solid #e6e6e6;
  border-radius:14px;
  padding:14px;
  background:#fff;
}
#journal .journal-mood-title{ font-weight:900; text-align:center; margin-bottom:12px; }
#journal .journal-mood-grid{
  display:grid;
  grid-template-columns: repeat(5, minmax(110px, 1fr));
  gap:12px;
}
@media (max-width: 760px){
  #journal .journal-mood-grid{ grid-template-columns: repeat(5, 1fr); gap: 8px; }
  #journal .mood-card{padding: 12px 6px; border-radius: 18px;}
  #journal .mood-emoji{font-size: 26px; margin-bottom: 6px;}
  #journal .mood-label{font-size: 12px;}
}
#journal .mood-card{
  border:2px solid #e0e0e0;
  border-radius:18px;
  padding:16px 10px;
  background:#fff;
  cursor:pointer;
  text-align:center;
  user-select:none;
}
#journal .mood-emoji{ font-size:34px; line-height:1; margin-bottom:10px; }
#journal .mood-label{ font-weight:800; }
#journal .mood-card.active{
  border-color:#111;
  box-shadow: 0 0 0 2px rgba(17,17,17,0.08);
}

/* Big AI button under content */
#journal .journal-ai-inline{ margin-top:14px; }
#journal .journal-ai-big{
  width:100%;
  background:#111;
  color:#fff;
  border:2px solid #111;
  border-radius:14px;
  padding:18px 16px;
  font-weight:900;
  font-size:18px;
}
#journal .journal-ai-big:active{ transform: translateY(1px); }

/* remove any sticky AI */
#journal .journal-ai-sticky{ display:none !important; }


/* ‚úÖ „Ç∏„É£„Éº„Éä„É´Ôºö„Çπ„Éû„Éõ„Åß„ÇÇÊäº„Åó„ÇÑ„Åô„ÅÑ‰øùÂ≠ò„Éú„Çø„É≥ */
.save-btn-big{
  width:100%;
  margin: 10px 0 0;
  padding: 14px 14px;
  border-radius: 16px;
  border: 1px solid #111;
  background: #111;
  color: #fff;
  font-weight: 800;
  font-size: 16px;
  cursor: pointer;
}
.save-btn-big:active{ transform: scale(0.99); }



/* „ÅäÈáë„É¨„Éù„Éº„ÉàÔºöÂÜÜ„Ç∞„É©„Éï„ÅÆÂá°‰æãÔºà„Çπ„Éû„Éõ„Åß„ÇÇÂ¥©„Çå„Å´„Åè„ÅÑÔºö„Ç∞„É©„Éï„ÅÆ‰∏ã„Å´Âõ∫ÂÆöÔºâ */
.money-legend {
  margin: 16px auto 0;
  max-width: 420px;
  padding: 0 8px;
}
.money-legend .legend-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid #eee;
}
.money-legend .legend-dot {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  flex-shrink: 0;
}
.money-legend .legend-cat {
  flex: 1;
  font-weight: 600;
}
.money-legend .legend-amt {
  color: #333;
}
.money-legend .legend-pct {
  color: #666;
  min-width: 44px;
  text-align: right;
}

/* Money report breakdown filters (segmented buttons) */
.money-breakdown-filters{
  display:flex;
  gap:10px;
  margin: 12px 0 18px 0;
  flex-wrap: wrap;
}
.money-breakdown-filters .seg-btn{
  border:2px solid #111;
  background:#fff;
  color:#111;
  padding:10px 16px;
  border-radius:999px;
  font-weight:700;
  cursor:pointer;
}
.money-breakdown-filters .seg-btn.active{
  background:#111;
  color:#fff;
}
.money-breakdown-filters .seg-btn:disabled{
  opacity:.5;
  cursor:not-allowed;
}


/* ===== Activity Report Chart ===== */
#activityCategoryChart .bar-row{
  display:flex; align-items:center; gap:10px;
  padding:10px 0; border-bottom:1px solid #eee;
}
#activityCategoryChart .bar-label{ width:78px; font-weight:700; font-size:13px; color:#111; }
#activityCategoryChart .bar-track{ flex:1; height:10px; border-radius:999px; background:#f1f1f1; overflow:hidden; }
#activityCategoryChart .bar-fill{ height:100%; background:#111; width:0%; }
#activityCategoryChart .bar-value{ width:70px; text-align:right; font-variant-numeric: tabular-nums; font-size:12px; color:#111; }
#activityCategoryChart .bar-sub{ font-size:11px; color:#666; margin-top:8px; }


/* Ë°åÂãï„É¨„Éù„Éº„Éà: „Ç∞„É©„ÉïÂàáÊõø */
.activity-chart-controls{
  display:flex;
  gap:12px;
  justify-content:center;
  flex-wrap:wrap;
  margin:12px 0 8px;
}
.segmented{
  display:flex;
  gap:0;
  border:1px solid #111;
  border-radius:12px;
  overflow:hidden;
  background:#fff;
}
.seg-btn{
  appearance:none;
  border:0;
  background:transparent;
  padding:10px 14px;
  font-weight:700;
  cursor:pointer;
}
.seg-btn.active{
  background:#111;
  color:#fff;
}
.activity-legend{
  margin-top:12px;
  max-width:560px;
  margin-left:auto;
  margin-right:auto;
}

/* „ÅäÈáë„É¨„Éù„Éº„Éà: „Ç∞„É©„ÉïÂàáÊõøÔºà„Çπ„Éû„Éõ„ÅßÂ¥©„Çå„Å´„Åè„ÅÑÔºâ */
.money-chart-controls{
  display:flex;
  gap:12px;
  justify-content:center;
  flex-wrap:wrap;
  margin:12px 0 8px;
}
#moneyChartArea{
  display:flex;
  justify-content:center;
}
#moneyChartArea canvas{
  max-width:360px;
  width:100%;
  height:auto;
}
.activity-legend .legend-row{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 6px;
  border-bottom:1px solid #eee;
}
.activity-legend .legend-dot{
  width:14px;
  height:14px;
  border-radius:50%;
  flex-shrink:0;
}
.activity-legend .legend-cat{
  flex:1;
  font-weight:700;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.activity-legend .legend-amt{
  min-width:72px;
  text-align:right;
  font-weight:700;
}
.activity-legend .legend-pct{
  min-width:44px;
  text-align:right;
  color:#666;
}



/* Money report bar chart styles */
#moneyChartArea .bar-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

#moneyChartArea .bar-label {
  width: 78px;
  font-weight: 700;
  font-size: 13px;
  color: #111;
}

#moneyChartArea .bar-track {
  flex: 1;
  height: 10px;
  border-radius: 999px;
  background: #f1f1f1;
  overflow: hidden;
}

#moneyChartArea .bar-fill {
  height: 100%;
  background: #111;
  width: 0%;
}

#moneyChartArea .bar-value {
  width: 70px;
  text-align: right;
  font-variant-numeric: tabular-nums;
  font-size: 12px;
  color: #111;
}


/* ===== Goals tab: monochrome calendar + month selector ===== */
#goals .calendar-grid{
  background:#f9f9f9;
  padding:10px;
  border-radius:4px;
}
#goals .calendar-header{
  background:#000;
  color:#fff;
  font-weight:700;
  border-radius:4px;
  font-size:14px;
}
#goals .calendar-day{
  min-height:60px;
  padding:8px;
  background:#fff;
  border:1px solid #e0e0e0;
  border-radius:4px;
  cursor:pointer;
  transition:background 0.2s ease;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
#goals .calendar-day.empty{
  background:#f5f5f5;
  border-color:#f5f5f5;
  cursor:default;
}
#goals .calendar-day.has-records{
  background:#f9f9f9;
  border:2px solid #000;
}
#goals .calendar-day.has-records:hover{ background:#e8e8e8; }
#goals .calendar-day-number{
  font-weight:700;
  font-size:16px;
  color:#000;
  margin-bottom:4px;
}
#goals .calendar-day-count{
  font-size:12px;
  color:#666;
  font-weight:600;
}
#goals .calendar-day-balance{
  font-size:11px;
  font-weight:700;
  margin-top:4px;
}
#goals .calendar-day-balance.positive{ color:#000; }
#goals .calendar-day-balance.negative{ color:#666; }

/* month selector */
#goals .month-selector,
#goals .simple-month-selector{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:16px;
  margin-bottom:20px;
  padding:0;
  background:transparent;
  border-radius:0;
}
#goals .month-nav-btn,
#goals .simple-nav-btn,
#goals #prevMonthBtn,
#goals #nextMonthBtn{
  background:#fff;
  border:2px solid #000;
  color:#000;
  font-weight:700;
  border-radius:4px;
  padding:6px 14px;
  cursor:pointer;
  transition:background 0.2s ease;
}
#goals .month-nav-btn:hover,
#goals .simple-nav-btn:hover,
#goals #prevMonthBtn:hover,
#goals #nextMonthBtn:hover{
  background:#e8e8e8;
}
#goals #currentGoalsMonth,
#goals .simple-month-display{
  font-size:18px;
  font-weight:700;
  color:#000;
  min-width:140px;
  text-align:center;
}

</style>

<style>
/* Ë°åÂãï„Çø„ÉñÔºöÂè≥‰∏ã„ÅÆ„Äå‚öôÔ∏è „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ„Äç„Éú„Çø„É≥„ÅÆ„ÅøÈùûË°®Á§∫ */
.logs-section .section-title .manage-button {
  display: none !important;
}
</style>

</head>
<body>
<div class="container">
<h1>üìä „É©„Ç§„Éï„É≠„Ç∞ v35.0 - ÂÆåÂÖ®‰øÆÊ≠£ÁâàÔºàwindowÂÖ¨Èñã‰øÆÊ≠£Ôºâ</h1>
<div class="tab-nav">
<button class="tab-button active" onclick="switchTab('activity')">‚è±Ô∏è Ë°åÂãï</button>
<button class="tab-button" onclick="switchTab('money')">üí∞ „ÅäÈáë</button>
<button class="tab-button" onclick="switchTab('journal')">üìî „Ç∏„É£„Éº„Éä„É´</button>
<button class="tab-button" onclick="switchTab('reportActivity')">üìä Ë°åÂãï„É¨„Éù„Éº„Éà</button>
<button class="tab-button" onclick="switchTab('reportMoney')">üí∞ „ÅäÈáë„É¨„Éù„Éº„Éà</button>
<button class="tab-button" onclick="switchTab('goals')">üéØ ÁõÆÊ®ô</button>
</div>
<!-- Ë°åÂãï„Çø„Éñ -->
<div class="tab-content active" id="activity">
<!-- ‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØË°®Á§∫ -->
<div class="today-tasks-section" id="todayTasksSection">
<div class="today-tasks-header">
<h3>üìã ‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØ</h3>
<button class="refresh-tasks-button" onclick="refreshTodayTasks()">üîÑ Êõ¥Êñ∞</button>
</div>
<div class="today-tasks-content" id="todayTasksContent">
<div class="loading-tasks">Êò®Êó•„ÅÆ„Ç∏„É£„Éº„Éä„É´„Åã„ÇâË™≠„ÅøËæº„Åø‰∏≠...</div>
</div>
</div>
<!-- „Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû -->
<div class="category-selection-section" style="margin: 20px 0; padding: 20px; background: #f9f9f9; border-radius: 12px; border: 1px solid #e0e0e0;">
<div style="font-weight: 600; margin-bottom: 15px; color: #000; text-align: center;">üìÇ „Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû</div>
<div id="activityCategoryButtons" class="category-buttons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
<!-- Ë°åÂãï„Ç´„ÉÜ„Ç¥„É™„Éú„Çø„É≥„ÅØJavaScript„ÅßÁîüÊàê -->
</div>
<button class="category-edit-button" onclick="editActivityCategories()">‚úèÔ∏è „Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜ</button>
<div id="selectedActivityCategory" style="margin-top: 15px; padding: 10px; background: white; border-radius: 8px; text-align: center; color: #666;">
                    „Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                </div>
</div>
<!-- Ë©≥Á¥∞ÂÖ•Âäõ -->
<button class="voice-button" id="activityVoiceButton" style="margin-top: 10px;">üé§ Èü≥Â£∞ÂÖ•Âäõ</button>
<input class="text-input" id="activityDetailInput" placeholder="Ë©≥Á¥∞Ôºà‰ªªÊÑèÔºâ ‰æãÔºö„Ç∏„É†„Åß1ÊôÇÈñì" style="margin-top: 10px;" type="text"/>
<div class="quick-buttons" id="activityQuickButtons"></div>
<!-- ÊôÇÈñìË®òÈå≤Ê©üËÉΩ -->
<div class="time-input-section" style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 12px;">
<div style="font-weight: 600; margin-bottom: 10px; color: #000;">‚è±Ô∏è ÊôÇÈñì„ÇíË®òÈå≤</div>
<!-- „Ç∑„É≥„Éó„É´: Ë®òÈå≤„Éú„Çø„É≥„ÇíÊäº„Åô„Å†„Åë -->
<div style="text-align: center; color: #666; font-size: 0.9em; margin-bottom: 10px;">
                    ‚Äª Ë®òÈå≤„Éú„Çø„É≥„ÅßÈñãÂßã„ÄÅ„É≠„Ç∞„ÅÆÁµÇ‰∫Ü„Éú„Çø„É≥„ÅßÁµÇ‰∫Ü
                </div>
</div>
<button class="add-button" onclick="addActivity()">‚ûï Ë®òÈå≤</button>
<div class="status" id="activityStatus"></div>

<div class="logs-section">
<div class="section-title">
<span>‰ªäÊó•„ÅÆË°åÂãï</span>
<button class="manage-button" onclick="editActivityCategories()">‚öôÔ∏è „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ</button>
</div>
<div id="activityLogs"></div>
</div>


</div>
<!-- „ÅäÈáë„Çø„Éñ -->
<div class="tab-content" id="money">
<!-- ÂèéÂÖ•/ÊîØÂá∫„Çø„Éñ -->
<div class="money-type-tabs">
<button class="money-type-tab active" data-type="expense" onclick="switchMoneyType('expense')">
                    üí∏ ÊîØÂá∫
                </button>
<button class="money-type-tab" data-type="income" onclick="switchMoneyType('income')">
                    üí∞ ÂèéÂÖ•
                </button>
</div>
<!-- ÊîØÂá∫„Ç´„ÉÜ„Ç¥„É™ -->
<div class="money-categories active" id="expenseCategories">
<div class="category-selector-title">üìä ÊîØÂá∫„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû:</div>
<div class="category-buttons money-category-buttons">
<button class="category-btn" data-category="È£üË≤ª" onclick="selectMoneyCategory('È£üË≤ª')">üçΩÔ∏è È£üË≤ª</button>
<button class="category-btn" data-category="Êó•Áî®ÂìÅ" onclick="selectMoneyCategory('Êó•Áî®ÂìÅ')">üß¥ Êó•Áî®ÂìÅ</button>
<button class="category-btn" data-category="Ë°£Êúç" onclick="selectMoneyCategory('Ë°£Êúç')">üëï Ë°£Êúç</button>
<button class="category-btn" data-category="ÁæéÂÆπ" onclick="selectMoneyCategory('ÁæéÂÆπ')">üíÑ ÁæéÂÆπ</button>
<button class="category-btn" data-category="‰∫§ÈöõË≤ª" onclick="selectMoneyCategory('‰∫§ÈöõË≤ª')">ü§ù ‰∫§ÈöõË≤ª</button>
<button class="category-btn" data-category="ÂåªÁôÇË≤ª" onclick="selectMoneyCategory('ÂåªÁôÇË≤ª')">‚öïÔ∏è ÂåªÁôÇË≤ª</button>
<button class="category-btn" data-category="ÊïôËÇ≤Ë≤ª" onclick="selectMoneyCategory('ÊïôËÇ≤Ë≤ª')">üìö ÊïôËÇ≤Ë≤ª</button>
<button class="category-btn" data-category="ÂÖâÁÜ±Ë≤ª" onclick="selectMoneyCategory('ÂÖâÁÜ±Ë≤ª')">üí° ÂÖâÁÜ±Ë≤ª</button>
<button class="category-btn" data-category="‰∫§ÈÄöË≤ª" onclick="selectMoneyCategory('‰∫§ÈÄöË≤ª')">üöÉ ‰∫§ÈÄöË≤ª</button>
<button class="category-btn" data-category="Â®ØÊ•Ω" onclick="selectMoneyCategory('Â®ØÊ•Ω')">üéÆ Â®ØÊ•Ω</button>
</div>
<button class="category-edit-button" onclick="editMoneyCategories('expense')">‚úèÔ∏è „Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜ</button>
</div>
<!-- ÂèéÂÖ•„Ç´„ÉÜ„Ç¥„É™ -->
<div class="money-categories" id="incomeCategories">
<div class="category-selector-title">üí∞ ÂèéÂÖ•„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû:</div>
<div class="category-buttons money-category-buttons">
<button class="category-btn" data-category="Áµ¶Êñô" onclick="selectMoneyCategory('Áµ¶Êñô')">üíº Áµ¶Êñô</button>
<button class="category-btn" data-category="„Åä„Åì„Å•„Åã„ÅÑ" onclick="selectMoneyCategory('„Åä„Åì„Å•„Åã„ÅÑ')">üíµ „Åä„Åì„Å•„Åã„ÅÑ</button>
<button class="category-btn" data-category="Ë≥û‰∏é" onclick="selectMoneyCategory('Ë≥û‰∏é')">üéÅ Ë≥û‰∏é</button>
<button class="category-btn" data-category="ÂâØÊ•≠" onclick="selectMoneyCategory('ÂâØÊ•≠')">üíª ÂâØÊ•≠</button>
<button class="category-btn" data-category="ÊäïË≥á" onclick="selectMoneyCategory('ÊäïË≥á')">üìà ÊäïË≥á</button>
<button class="category-btn" data-category="Ëá®ÊôÇÂèéÂÖ•" onclick="selectMoneyCategory('Ëá®ÊôÇÂèéÂÖ•')">üéâ Ëá®ÊôÇÂèéÂÖ•</button>
</div>
<button class="category-edit-button" onclick="editMoneyCategories('income')">‚úèÔ∏è „Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜ</button>
</div>
<div class="selected-category-display" id="selectedMoneyCategory">
                „Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
            </div>
<!-- ÂÖ•ÂäõÊ¨Ñ -->
<input class="text-input" id="moneyInput" placeholder="„É°„É¢Ôºà‰ªªÊÑèÔºâ ‰æãÔºö„Ç´„Éï„Çß" type="text"/>
<input class="text-input" id="moneyAmount" placeholder="ÈáëÈ°çÔºàÂÜÜÔºâ" type="number"/>
<button class="add-button" onclick="addMoney()">‚ûï Ë®òÈå≤</button>
<div class="status" id="moneyStatus"></div>
<div class="logs-section">
<h2 class="section-title">‰ªäÊó•„ÅÆ„ÅäÈáë</h2>
<div id="moneyLogs"></div>
</div>
</div>
<!-- „Ç∏„É£„Éº„Éä„É´„Çø„Éñ -->
<div class="tab-content journal-tab" id="journal">
<div class="journal-v2 card">
<div class="journal-dateblock">
<div class="journal-date-title">üìÖ Ë®òÈå≤„Åô„ÇãÊó•‰ªò„ÇíÈÅ∏Êäû</div>
<div class="journal-date-row">
<input class="input" id="journalV2Date" type="date"/>
<button class="btn-today" id="journalV2TodayBtn">‰ªäÊó•</button>
</div>
<div class="journal-top-actions">
<button class="btn-primary" id="journalV2SaveBtn">‰øùÂ≠ò</button>
</div>
<!-- Ê∞óÂàÜÈÅ∏Êäû -->
<div class="mood-selector">
<div class="mood-selector-title">‰ªäÊó•„ÅÆÊ∞óÂàÜ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</div>
<div class="mood-buttons">
<button class="mood-button" data-mood="great" onclick="selectMood('great')">
<span class="mood-emoji">üòä</span>
<span class="mood-label">ÊúÄÈ´ò</span>
</button>
<button class="mood-button" data-mood="good" onclick="selectMood('good')">
<span class="mood-emoji">üôÇ</span>
<span class="mood-label">ËâØ„ÅÑ</span>
</button>
<button class="mood-button" data-mood="normal" onclick="selectMood('normal')">
<span class="mood-emoji">üòê</span>
<span class="mood-label">ÊôÆÈÄö</span>
</button>
<button class="mood-button" data-mood="bad" onclick="selectMood('bad')">
<span class="mood-emoji">üòî</span>
<span class="mood-label">ÊÇ™„ÅÑ</span>
</button>
<button class="mood-button" data-mood="terrible" onclick="selectMood('terrible')">
<span class="mood-emoji">üò¢</span>
<span class="mood-label">ÊúÄÊÇ™</span>
</button>
</div>
</div>
<!-- Êó•‰ªòÈÅ∏Êäû -->
<div style="margin: 15px 0; padding: 15px; background: #f9f9f9; border-radius: 12px;">
<label style="display: block; margin-bottom: 5px; font-weight: 600;">üìÖ Ë®òÈå≤„Åô„ÇãÊó•‰ªò„ÇíÈÅ∏Êäû</label>
<div style="display: flex; gap: 10px; align-items: center;">
<input id="journalDate" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em;" type="date">
<button onclick="setJournalDateToToday()" style="padding: 10px 15px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap;" type="button">‰ªäÊó•</button>
</input></div>
<div style="margin-top: 5px; font-size: 0.9em; color: #666;">
                    ‚Äª ÈÅéÂéª„ÅÆÊó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„ÄÅÈÅ°„Å£„Å¶Ë®òÈå≤„Åß„Åç„Åæ„Åô
                </div>
</div>
<textarea class="text-input" id="journalInput" placeholder="‰ªäÊó•„ÅÆÊåØ„ÇäËøî„Çä„ÇíÊõ∏„Åç„Åæ„Åó„Çá„ÅÜ...

‰æãÔºö
Êúù„Åã„Çâ„Ç∏„É†„Å´Ë°å„Å£„Å¶Ê∞óÊåÅ„Å°„Çà„ÅèÊ±ó„ÇíÊµÅ„Åó„Åü„ÄÇ
ÂçàÂæå„ÅØÈõÜ‰∏≠„Åó„Å¶‰ªï‰∫ã„Åå„Åß„Åç„Åü„ÄÇ
ÊòéÊó•„ÅØÊó©Ëµ∑„Åç„Åó„Å¶Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´Âèñ„ÇäÁµÑ„ÇÇ„ÅÜ„ÄÇ"></textarea>
<!-- Ëá™ÂãïË¶ÅÁ¥Ñ„Çª„ÇØ„Ç∑„Éß„É≥ -->
<div class="summary-section" id="summarySection">
<h3 style="margin-bottom: 15px;">üìù Ëá™ÂãïË¶ÅÁ¥Ñ</h3>
<div class="summary-item">
<div class="summary-label">üòä GoodÔºàËâØ„Åã„Å£„Åü„Åì„Å®Ôºâ</div>
<div class="summary-content" id="summaryGood"></div>
<div class="ai-comment" id="commentGood"></div>
</div>
<div class="summary-item">
<div class="summary-label">üìà MoreÔºà„ÇÇ„Å£„Å®ËâØ„Åè„Åß„Åç„Çã„Åì„Å®Ôºâ</div>
<div class="summary-content" id="summaryMore"></div>
<div class="ai-comment" id="commentMore"></div>
</div>
<div class="summary-item">
<div class="summary-label">ü§î ÊÇ©„Çì„Åß„ÅÑ„Çã„Åì„Å®</div>
<div class="summary-content" id="summaryWorry"></div>
<div class="ai-comment" id="commentWorry"></div>
</div>
<div class="summary-item">
<div class="summary-label">‚úÖ Must: „ÇÑ„Çâ„Å™„Åç„ÇÉ„ÅÑ„Åë„Å™„ÅÑ„Åì„Å®</div>
<div class="summary-content" id="summaryTaskMust"></div>
<div class="ai-comment" id="commentTaskMust"></div>
</div>
<div class="summary-item">
<div class="summary-label">üí° Want: „ÇÑ„Çä„Åü„ÅÑ„Åì„Å®</div>
<div class="summary-content" id="summaryTaskWant"></div>
<div class="ai-comment" id="commentTaskWant"></div>
</div>
</div>
</div>
<div class="journal-mood-wrap" data-selected="" id="journalMoodWrap">
<div class="journal-mood-title">‰ªäÊó•„ÅÆÊ∞óÂàÜ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</div>
<div aria-label="‰ªäÊó•„ÅÆÊ∞óÂàÜ" class="journal-mood-grid" role="radiogroup">
<div aria-checked="false" class="mood-card" data-mood="ÊúÄÈ´ò" role="radio" tabindex="0">
<div class="mood-emoji">üòä</div><div class="mood-label">ÊúÄÈ´ò</div>
</div>
<div aria-checked="false" class="mood-card" data-mood="ËâØ„ÅÑ" role="radio" tabindex="0">
<div class="mood-emoji">üôÇ</div><div class="mood-label">ËâØ„ÅÑ</div>
</div>
<div aria-checked="false" class="mood-card" data-mood="ÊôÆÈÄö" role="radio" tabindex="0">
<div class="mood-emoji">üòê</div><div class="mood-label">ÊôÆÈÄö</div>
</div>
<div aria-checked="false" class="mood-card" data-mood="ÊÇ™„ÅÑ" role="radio" tabindex="0">
<div class="mood-emoji">üòî</div><div class="mood-label">ÊÇ™„ÅÑ</div>
</div>
<div aria-checked="false" class="mood-card" data-mood="ÊúÄÊÇ™" role="radio" tabindex="0">
<div class="mood-emoji">üò¢</div><div class="mood-label">ÊúÄÊÇ™</div>
</div>
</div>
</div>
<div class="status-message" id="journalV2Status"></div>
<div class="journal-v2-voice card">
<div class="section-title" style="margin:0 0 8px;">üé§ Èü≥Â£∞ÂÖ•Âäõ</div>
<div class="journal-v2-row" style="margin-bottom:10px;">
<label class="journal-v2-label">ÂÖ•ÂäõÂÖà</label>
<select class="input" id="journalV2Target" style="max-width:340px;">
<option value="events">‰ªäÊó•„ÅÆÂá∫Êù•‰∫ã</option>
<option value="learnings">Â≠¶„Å≥</option>
<option value="feelings">ÊÑüÊÉÖ</option>
<option value="gratitude">ÊÑüË¨ù</option>
<option value="must">ÊòéÊó•„ÇÑ„Çã„Åì„Å®ÔºàMUSTÔºâ</option>
<option value="want">ÊòéÊó•„ÇÑ„Çã„Åì„Å®ÔºàWANTÔºâ</option>
</select>
<div class="spacer"></div>
<button class="btn-primary" id="journalV2VoiceBtn">üé§ Èü≥Â£∞ÂÖ•Âäõ</button>
<button class="btn-secondary" disabled="" id="journalV2StopBtn" style="display:none">ÂÅúÊ≠¢</button>
</div>
<div class="small">‚Äª „ÅÜ„Åæ„ÅèË™çË≠ò„Åï„Çå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ„Éñ„É©„Ç¶„Ç∂„ÅÆ„Éû„Ç§„ÇØË®±ÂèØ„Å®HTTPSÔºà„Åæ„Åü„ÅØ„É≠„Éº„Ç´„É´Ôºâ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
</div>
<div class="journal-simple card">
<div class="section-title" style="margin:0 0 8px;">üó£Ô∏è Ë©±„Åó„ÅüÂÜÖÂÆπÔºà„Åù„ÅÆ„Åæ„ÅæÔºâ</div>
<div class="small" style="margin-bottom:10px;">È†ÖÁõÆ„ÅØ„ÄåË©±„Åô„Éí„É≥„Éà„Äç„Åß„Åô„ÄÇ„ÅÇ„Å®„ÅØËá™Áî±„Å´Ë©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
<ul class="journal-hints">
<li>‰ªäÊó•„ÅÇ„Å£„Åü„Åì„Å®</li>
<li>Ê∞ó„Å•„ÅÑ„Åü„Åì„Å®„ÉªÂ≠¶„Å≥</li>
<li>„É¢„É§„Å£„Å®„Åó„Åü„Åì„Å®„ÉªÊÑüÊÉÖ</li>
<li>ÊÑüË¨ù</li>
<li>ÊòéÊó•„ÇÑ„Çã„Åì„Å®ÔºöMUST / WANT</li>
</ul>
<textarea class="input journal-raw" id="journalV3Raw" placeholder="‰ªäÊó•„ÅÆÊåØ„ÇäËøî„Çä„Çí„Åù„ÅÆ„Åæ„ÅæË©±„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÊñáÂ≠óËµ∑„Åì„Åó„ÇÇOKÔºâ"></textarea>
<div class="journal-ai-inline">
<button class="journal-ai-big" id="journalAiBigBtn">‚ú® AI„ÅßÊï¥„Åà„Çã</button>
</div>
<div class="journal-simple-row">
<button class="btn-secondary" id="journalV3ClearBtn">„Åì„ÅÆÊó•„ÅÆÂÜÖÂÆπ„Çí„ÇØ„É™„Ç¢</button>
<div class="spacer"></div>
<div class="small"></div>
</div>
</div>


<div class="journal-v2-grid">
<div class="journal-v2-field">
<div class="journal-v2-field-head">‰ªäÊó•„ÅÆÂá∫Êù•‰∫ã</div>
<textarea class="input" id="journalV2Events" placeholder="‰æãÔºö„Ç¢„Éó„É™Âà∂‰Ωú„ÅÆÂü∫Á§é„Ç≥„Éº„Éâ„ÇíÊõ∏„ÅÑ„Åü / Êâì„Å°Âêà„Çè„Åõ„Åå„ÅÇ„Å£„Åü"></textarea>
</div>
<div class="journal-v2-field">
<div class="journal-v2-field-head">Â≠¶„Å≥</div>
<textarea class="input" id="journalV2Learnings" placeholder="‰æãÔºöÂÖà„Å´Â∞è„Åï„ÅèÂãï„ÅèÂΩ¢„Çí‰Ωú„Çã„Å®ÈÄ≤„ÇÄ"></textarea>
</div>
<div class="journal-v2-field">
<div class="journal-v2-field-head">ÊÑüÊÉÖ</div>
<textarea class="input" id="journalV2Feelings" placeholder="‰æãÔºöÂ∞ë„ÅóÁÑ¶„Å£„Åü / ÈÄ≤„Çì„ÅßÂ¨â„Åó„ÅÑ"></textarea>
</div>
<div class="journal-v2-field">
<div class="journal-v2-field-head">ÊÑüË¨ù</div>
<textarea class="input" id="journalV2Gratitude" placeholder="‰æãÔºöÁõ∏Ë´á„Å´‰πó„Å£„Å¶„Åè„Çå„Åü / ÊôÇÈñì„Çí‰Ωú„Çå„Åü"></textarea>
</div>
</div>
<div class="journal-v2-grid2">
<div class="journal-v2-field must">
<div class="journal-v2-field-head">ÊòéÊó•„ÇÑ„Çã„Åì„Å®ÔºàMUSTÔºâ</div>
<textarea class="input" id="journalV2Must" placeholder="‰æãÔºö‰ªïÊßò„ÇíÂõ∫„ÇÅ„Çã / 1„Éö„Éº„Ç∏ÂÆüË£Ö„Åô„Çã"></textarea>
</div>
<div class="journal-v2-field want">
<div class="journal-v2-field-head">ÊòéÊó•„ÇÑ„Çã„Åì„Å®ÔºàWANTÔºâ</div>
<textarea class="input" id="journalV2Want" placeholder="‰æãÔºö„Éá„Ç∂„Ç§„É≥„ÇíÊï¥„Åà„Çã / Ê©üËÉΩ„ÇíËøΩÂä†„Åô„Çã"></textarea>
</div>
</div>
</div>
<div style="height:12px"></div><button class="voice-button" id="journalVoiceButton" onclick="startJournalVoice()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin: 16px 0; transition: all 0.3s;">
                üé§ Èü≥Â£∞ÂÖ•Âäõ
            </button><div id="journalV2IO" style="display:none; margin-top:12px;">
<textarea class="input" id="journalV2IOText" placeholder="„Åì„Åì„Å´JSON„ÇíË≤º„Çä‰ªò„Åë"></textarea>
<div class="journal-v2-row" style="margin-top:10px;">
<button class="btn-primary" id="journalV2ApplyImportBtn">Âæ©ÂÖÉ„Åô„Çã</button>
<div class="spacer"></div>
<button class="btn-secondary" id="journalV2CloseIOBtn">Èñâ„Åò„Çã</button>
</div>
<div class="status-message" id="journalV2IOStatus"></div>
</div><div class="logs-section">
<h2 class="section-title">üìÖ ÊúàÈñì„Ç´„É¨„É≥„ÉÄ„Éº</h2>
<div class="calendar">
<div class="calendar-header">
<button class="calendar-nav" onclick="changeMonth(-1)">‚óÄ ÂâçÊúà</button>
<span id="calendarMonth" style="font-weight: 600;"></span>
<button class="calendar-nav" onclick="changeMonth(1)">Ê¨°Êúà ‚ñ∂</button>
</div>
<div class="calendar-grid" id="calendar"></div>
</div>


<div class="journal-today-summary" id="journalV3TodaySummary">
<div class="journal-log-title">üß† ‰ªäÊó•„ÅÆË¶ÅÁ¥ÑÔºàÈÅ∏Êäû‰∏≠„ÅÆÊó•‰ªòÔºâ</div>
<div class="small" id="journalV3TodaySummaryEmpty">„Åæ„Å†Ë¶ÅÁ¥Ñ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„ÄåË¶ÅÁ¥ÑÔºà„Éá„É¢Ôºâ„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
<div id="journalV3TodaySummaryBody" style="display:none;">
<div class="summary-grid">
<div class="summary-k">Âá∫Êù•‰∫ã</div><div class="summary-v" id="todaySumEvents">‚Äî</div>
<div class="summary-k">Â≠¶„Å≥</div><div class="summary-v" id="todaySumLearnings">‚Äî</div>
<div class="summary-k">ÊÑüÊÉÖ</div><div class="summary-v" id="todaySumFeelings">‚Äî</div>
<div class="summary-k">ÊÑüË¨ù</div><div class="summary-v" id="todaySumGratitude">‚Äî</div>
<div class="summary-k must">MUST</div><div class="summary-v" id="todaySumMust">‚Äî</div>
<div class="summary-k want">WANT</div><div class="summary-v" id="todaySumWant">‚Äî</div>
</div>
</div>
</div>

<div class="journal-log" id="journalV3Log" data-only-tab="journal">
<div class="journal-log-title">üßæ „É≠„Ç∞ÔºàË¶ÅÁ¥Ñ„ÅØ„Åì„Åì„ÅßÁ¢∫Ë™çÔºâ</div>
<div class="small" id="journalV3LogList">„Åæ„Å†„É≠„Ç∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>
</div>

<h2 class="section-title" style="margin-top: 30px;">„Ç∏„É£„Éº„Éä„É´Â±•Ê≠¥</h2>
<div id="journalLogs"></div>

</div></div>
</div>


<!-- „Ç´„ÉÜ„Ç¥„É™ÈÅ∏ÊäûUIÔºà„Ç∏„É£„Éº„Éä„É´„ÅÆÈü≥Â£∞ÂÖ•ÂäõÂâç„Å´ÈÖçÁΩÆÔºâ -->
<div class="category-selector" data-only-tab="journal">
<div style="display: none;">
<div class="category-selector-title">
        üéØ Èü≥Â£∞ÂÖ•Âäõ„Åô„Çã„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû:
    </div></div>
<div class="category-buttons">
<button class="category-btn good" data-category="good" onclick="selectJournalCategory('good')">
            üòä ËâØ„Åã„Å£„Åü„Åì„Å®
        </button>
<button class="category-btn more" data-category="more" onclick="selectJournalCategory('more')">
            üìà „ÇÇ„Å£„Å®„Åß„Åç„Çã„Åì„Å®
        </button>
<button class="category-btn worry" data-category="worry" onclick="selectJournalCategory('worry')">
            üòü ÊÇ©„Çì„Åß„ÅÑ„Çã„Åì„Å®
        </button>
<button class="category-btn task-must" data-category="taskMust" onclick="selectJournalCategory('taskMust')">
            ‚úÖ Must: „ÇÑ„Çâ„Å™„Åç„ÇÉ„ÅÑ„Åë„Å™„ÅÑ„Åì„Å®
        </button>
<button class="category-btn task-want" data-category="taskWant" onclick="selectJournalCategory('taskWant')">
            üí° Want: „ÇÑ„Çä„Åü„ÅÑ„Åì„Å®
        </button>
</div>
<div class="selected-category-display" id="selectedCategoryDisplay">
        „Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Å¶„Åã„ÇâÈü≥Â£∞ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
    </div>
<div class="category-required-hint" id="categoryRequiredHint">
        ‚ö†Ô∏è „Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
    </div>
</div>
<!-- üé§ Èü≥Â£∞ÂÖ•Âäõ„Éú„Çø„É≥ -->

<button class="add-button" data-only-tab="journal" onclick="saveJournalWithAI()">üìù ‰øùÂ≠ò</button>
<div class="status" id="journalStatus" data-only-tab="journal"></div>


<!-- ‰ªäÊúà„ÅÆÁõÆÊ®ô„Çø„Éñ -->
<div class="tab-content" id="goals">
<h2 class="section-title">üéØ ÁõÆÊ®ôÁÆ°ÁêÜ</h2>
<!-- ÊúàÈÅ∏Êäû -->
<div class="month-selector-section">
<button class="month-nav-button" onclick="changeGoalsMonth(-1)">‚óÄ ÂâçÊúà</button>
<div class="current-month-display" id="currentGoalsMonth">2026Âπ¥1Êúà</div>
<button class="month-nav-button" onclick="changeGoalsMonth(1)">Ê¨°Êúà ‚ñ∂</button>
</div>
<div class="goals-section">
<div class="form-group">
<label>Êñ∞„Åó„ÅÑÁõÆÊ®ô„ÇíËøΩÂä†</label>
<input class="input-field" id="goalInput" placeholder="‰æã: ÊØéÊó•30ÂàÜÈÅãÂãï„Åô„Çã" type="text"/>
</div>
<div class="form-group">
<label>„Ç´„ÉÜ„Ç¥„É™</label>
<select class="input-field" id="goalCategory">
<option value="ÂÅ•Â∫∑">üí™ ÂÅ•Â∫∑</option>
<option value="‰ªï‰∫ã">üíº ‰ªï‰∫ã</option>
<option value="ÂãâÂº∑">üìö ÂãâÂº∑</option>
<option value="Ë∂£Âë≥">üé® Ë∂£Âë≥</option>
<option value="‰∫∫ÈñìÈñ¢‰øÇ">üë• ‰∫∫ÈñìÈñ¢‰øÇ</option>
<option value="„ÅäÈáë">üí∞ „ÅäÈáë</option>
<option value="„Åù„ÅÆ‰ªñ">üìå „Åù„ÅÆ‰ªñ</option>
</select>
</div>
<button class="btn-primary" onclick="addGoal()">‚ûï ÁõÆÊ®ô„ÇíËøΩÂä†</button>
<div class="status-message" id="goalStatus"></div>
</div>
<div class="goals-list-section">
<h3 id="goalsListTitle">‰ªäÊúà„ÅÆÁõÆÊ®ô„É™„Çπ„Éà</h3>
<div id="goalsList"></div>
</div>
<div class="goals-progress-section">
<h3>üìä ÈÅîÊàêÁä∂Ê≥Å</h3>
<div id="goalsProgress"></div>
</div>
<div class="goals-feedback-section">
<h3>ü§ñ AI „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ</h3>
<div class="ai-feedback-box" id="goalsFeedback">
            ÁõÆÊ®ô„ÇíË®≠ÂÆö„Åô„Çã„Å®„ÄÅAI„Åå„ÅÇ„Å™„Åü„ÅÆË°åÂãïË®òÈå≤„Å®„Ç∏„É£„Éº„Éä„É´„ÇíÂàÜÊûê„Åó„Å¶„ÄÅÈÅîÊàê„Å´Âêë„Åë„Åü„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÊèê‰æõ„Åó„Åæ„Åô„ÄÇ
        </div>
<button class="btn-secondary" onclick="generateGoalsFeedback()">üîÑ „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÊõ¥Êñ∞</button>
</div>
</div>
<!-- Ë°åÂãï„É¨„Éù„Éº„Éà„Çø„Éñ -->
<div class="tab-content" id="reportActivity">
<h2 class="section-title">üìä Ë°åÂãï„É¨„Éù„Éº„Éà</h2>
<!-- ÊúàÈÅ∏Êäû -->
<div class="simple-month-selector">
<button class="simple-nav-btn" onclick="changeReportMonth('activity', -1)">‚óÄ ÂâçÊúà</button>
<div class="simple-month-display" id="activityReportMonthDisplay">2026Âπ¥1Êúà</div>
<button class="simple-nav-btn" onclick="changeReportMonth('activity', 1)">Ê¨°Êúà ‚ñ∂</button>
</div>
<!-- „Ç´„É¨„É≥„ÉÄ„Éº -->
<div class="simple-calendar" id="activityCalendar"></div>
<!-- Ê¶ÇË¶Å -->
<div class="simple-summary">
<h3>üìã ÊúàÈñìÊ¶ÇË¶Å</h3>
<div id="activitySummary"></div>
</div>

<!-- „Ç´„ÉÜ„Ç¥„É™Âà• -->
<div class="simple-summary">
  <h3>üìä „Ç´„ÉÜ„Ç¥„É™Âà• ÂêàË®à</h3>
  <div class="activity-chart-controls">
    <div class="segmented">
      <button type="button" class="seg-btn" id="activityMetricCountBtn" onclick="setActivityChartMetric('count')">ÂõûÊï∞</button>
      <button type="button" class="seg-btn" id="activityMetricMinutesBtn" onclick="setActivityChartMetric('minutes')">ÊôÇÈñì</button>
    </div>
    <div class="segmented">
      <button type="button" class="seg-btn" id="activityChartBarBtn" onclick="setActivityChartType('bar')">Ê£í</button>
      <button type="button" class="seg-btn" id="activityChartPieBtn" onclick="setActivityChartType('pie')">ÂÜÜ</button>
    </div>
  </div>
  <div id="activityCategoryChart" class="activity-category-chart"></div>
  <div id="activityCategoryLegend" class="activity-legend"></div>
</div>

<!-- Êó•Âà•Ë©≥Á¥∞ -->
<div class="simple-details">
<h3>üìÖ Êó•Âà•Ë©≥Á¥∞</h3>
<div id="activityDailyDetails">
<p class="empty-message">„Ç´„É¨„É≥„ÉÄ„Éº„ÅÆÊó•‰ªò„Çí„Çø„ÉÉ„Éó„Åó„Å¶Ë©≥Á¥∞„ÇíË°®Á§∫</p>
</div>
</div>
</div>
<!-- „ÅäÈáë„É¨„Éù„Éº„Éà„Çø„Éñ -->
<div class="tab-content" id="reportMoney">
<h2 class="section-title">üí∞ „ÅäÈáë„É¨„Éù„Éº„Éà</h2>
<!-- ÊúàÈÅ∏Êäû -->
<div class="simple-month-selector">
<button class="simple-nav-btn" onclick="changeReportMonth('money', -1)">‚óÄ ÂâçÊúà</button>
<div class="simple-month-display" id="moneyReportMonthDisplay">2026Âπ¥1Êúà</div>
<button class="simple-nav-btn" onclick="changeReportMonth('money', 1)">Ê¨°Êúà ‚ñ∂</button>
</div>
<!-- „Ç´„É¨„É≥„ÉÄ„Éº -->
<div class="simple-calendar" id="moneyCalendar"></div>
<!-- Ê¶ÇË¶Å -->
<div class="simple-summary">
<h3>üí∞ ÊúàÈñìÊ¶ÇË¶Å</h3>
<div id="moneySummary"></div>
</div>
<!-- „Ç∞„É©„Éï -->
<div class="simple-chart">
  <h3 id="moneyBreakdownTitle">üìä ÊîØÂá∫ÂÜÖË®≥</h3>

  <div class="money-breakdown-filters" role="tablist" aria-label="ÂÜÖË®≥„ÅÆË°®Á§∫ÂàáÊõø">
    <button id="moneyModeExpense" class="seg-btn active" type="button">ÊîØÂá∫</button>
    <button id="moneyModeIncome" class="seg-btn" type="button">ÂèéÂÖ•</button>
  </div>

  <div class="money-chart-controls">
    <div class="segmented" aria-label="ÈõÜË®à„ÅÆÂçò‰Ωç">
      <button type="button" class="seg-btn" id="moneyMetricAmountBtn" onclick="setMoneyChartMetric('amount')">ÈáëÈ°ç</button>
      <button type="button" class="seg-btn" id="moneyMetricCountBtn" onclick="setMoneyChartMetric('count')">ÂõûÊï∞</button>
    </div>
    <div class="segmented" aria-label="„Ç∞„É©„Éï„ÅÆÁ®ÆÈ°û">
      <button type="button" class="seg-btn" id="moneyChartPieBtn" onclick="setMoneyChartType('pie')">ÂÜÜ</button>
      <button type="button" class="seg-btn" id="moneyChartBarBtn" onclick="setMoneyChartType('bar')">Ê£í</button>
    </div>
  </div>

  <div id="moneyChartArea"></div>
  <div id="moneyLegend" class="money-legend"></div>
</div>
<!-- Êó•Âà•Ë©≥Á¥∞ -->
<div class="simple-details">
<h3>üìÖ Êó•Âà•Ë©≥Á¥∞</h3>
<div id="moneyDailyDetails">
<p class="empty-message">„Ç´„É¨„É≥„ÉÄ„Éº„ÅÆÊó•‰ªò„Çí„Çø„ÉÉ„Éó„Åó„Å¶Ë©≥Á¥∞„ÇíË°®Á§∫</p>
</div>
</div>
</div>
<!-- „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´ -->
<div class="modal" id="categoryModal">
<div class="modal-content">
<span class="modal-close" onclick="closeCategoryManager()">√ó</span>
<h2 class="modal-title">‚öôÔ∏è „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ</h2>
<div style="margin-bottom: 20px;">
<input class="text-input" id="newCategoryName" placeholder="Êñ∞„Åó„ÅÑ„Ç´„ÉÜ„Ç¥„É™ÂêçÔºà‰æãÔºöË™≠Êõ∏Ôºâ" type="text"/>
<input class="text-input" id="newCategoryEmoji" placeholder="ÁµµÊñáÂ≠óÔºà‰æãÔºöüìñÔºâ" type="text"/>
<button class="add-button" onclick="addCategory()">‚ûï ËøΩÂä†</button>
</div>
<h3 style="margin-bottom: 10px;">ÁèæÂú®„ÅÆ„Ç´„ÉÜ„Ç¥„É™</h3>
<div id="categoryList"></div>
</div>
</div>
<script>

// --- HTML„Ç®„Çπ„Ç±„Éº„ÉóÔºàÂá°‰æãË°®Á§∫Áî®Ôºâ ---
function escapeHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}



// ‚úÖ Êúà„Ç≠„ÉºÁîüÊàêÔºà„É≠„Éº„Ç´„É´ÊôÇÈñì„Éô„Éº„ÇπÔºâ
// iOS/Android„Åß toISOString() „Çí‰Ωø„ÅÜ„Å®„ÄÅ„Çø„Ç§„É†„Çæ„Éº„É≥Â∑Æ„Åß„ÄåÊúà„Åå1„Å§Êàª„Çã„Äç„Åì„Å®„Åå„ÅÇ„Çä„ÄÅ
// ‰æã: 2026-01-01 00:00(JST) -> 2025-12-31T15:00Z -> '2025-12' „Å®„Å™„Å£„Å¶ÊúàÁßªÂãï„Åå2„É∂ÊúàÈ£õ„Å∂„ÄÇ
// „Åì„Çå„ÇíÈÅø„Åë„Çã„Åü„ÇÅ„ÄÅÊúà„Ç≠„Éº„ÅØÂøÖ„Åö„É≠„Éº„Ç´„É´„ÅÆ getFullYear()/getMonth() „Åß‰Ωú„Çã„ÄÇ
function monthKeyFromDate(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  return `${y}-${m}`;
}
function monthKeyFromTimestamp(ts) {
  return monthKeyFromDate(new Date(ts));
}

// --- Êó•‰ªò„Ç≠„Éº„ÅØ„É≠„Éº„Ç´„É´ÊôÇÈñì„ÅßÁµ±‰∏ÄÔºàUTC„Åö„ÇåÈò≤Ê≠¢Ôºâ ---
function localDateKey(dateObj){
  const y = dateObj.getFullYear();
  const m = String(dateObj.getMonth() + 1).padStart(2,'0');
  const d = String(dateObj.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}
function localDateKeyFromTimestamp(ts){
  return localDateKey(new Date(ts));
}
function localDateKeyFromMonthDay(monthKey, day){
  const [y, m] = monthKey.split('-').map(Number); // monthKey: "YYYY-MM"
  return localDateKey(new Date(y, m - 1, day));
}



        // „Éá„Éº„ÇøÊ†ºÁ¥ç
        let activities = JSON.parse(localStorage.getItem('activities') || '[]');
        window.moneyRecords = JSON.parse(localStorage.getItem('moneyRecords') || '[]');
        let weightRecords = JSON.parse(localStorage.getItem('weightRecords') || '[]');
        let journals = JSON.parse(localStorage.getItem('journals') || '[]');
        
        // „Ç´„Çπ„Çø„É†„Ç´„ÉÜ„Ç¥„É™
        let activityCategories = JSON.parse(localStorage.getItem('activityCategories') || JSON.stringify([
            { name: '‰ªï‰∫ã', emoji: 'üíº' },
            { name: 'ÂãâÂº∑', emoji: 'üìö' },
            { name: 'ÈÅãÂãï', emoji: 'üèÉ' },
            { name: 'È£ü‰∫ã', emoji: 'üçΩÔ∏è' },
            { name: 'Áù°Áú†', emoji: 'üò¥' },
            { name: 'Ë™≠Êõ∏', emoji: 'üìñ' },
            { name: 'ÂÆ∂‰∫ã', emoji: 'üè†' },
            { name: 'Ë∂£Âë≥', emoji: 'üé®' },
            { name: 'ÁßªÂãï', emoji: 'üöó' },
            { name: '„Åù„ÅÆ‰ªñ', emoji: 'üìù' }
 ]));
        
        // „Ç´„É¨„É≥„ÉÄ„ÉºÁî®
        let currentCalendarDate = new Date();
        
        // ÁèæÂú®ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÊ∞óÂàÜ
        let selectedMood = 'normal';
        
        // ÁèæÂú®ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Ç´„ÉÜ„Ç¥„É™
        let selectedCategory = null;
        let selectedCategoryEmoji = null;
        
        // „Çø„Ç§„Éû„ÉºÈñ¢ÈÄ£
        let timerStartTime = null;
        let timerInterval = null;
        let timerRunning = false;
        let timerElapsedSeconds = 0;
        
        // Ê∞óÂàÜ„ÅÆÁµµÊñáÂ≠ó„Éû„ÉÉ„Éî„É≥„Ç∞
        const moodEmojis = {
            great: 'üòä',
            good: 'üôÇ',
            normal: 'üòê',
            bad: 'üòî',
            terrible: 'üò¢'
        };
        
        // Ê∞óÂàÜÈÅ∏Êäû
        function selectMood(mood) {
            selectedMood = mood;
            
            // „Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.mood-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            const selectedButton = document.querySelector(`.mood-button[data-mood="${mood}"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
            }
        }
        
        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchTab(tabName) {
  try {
    console.log("switchTab called:", tabName);
    // „Çø„ÉñÊú¨‰Ωì„ÇíÁ¢∫ÂÆü„Å´1„Å§„Å†„ÅëË°®Á§∫
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.classList.remove('active');
      tab.style.display = 'none';
    });

    // „Çø„Éñ„Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñË°®Á§∫
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

    const target = document.getElementById(tabName);
    if (target) {
      target.classList.add('active');
      target.style.display = 'block';
    }

    // ÂØæÂøú„Åô„Çã„Éú„Çø„É≥„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
    const btn = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
    if (btn) btn.classList.add('active');

    // „Çø„ÉñÂõ∫ÊúâË¶ÅÁ¥†Ôºàdata-only-tabÔºâ„ÅÆË°®Á§∫ÂàáÊõø
    applyTabOnlyVisibility(tabName);

    // ÁîªÈù¢‰∏äÈÉ®„Å´Êàª„ÅôÔºà„Çπ„Éû„Éõ„Åß„ÅÆ‰ΩìÈ®ìÊîπÂñÑÔºâ
    window.scrollTo({ top: 0, behavior: 'smooth' });
  } catch (e) {
    console.error("switchTab error:", e);
  }

    if (tabName === 'reportMoney') { setTimeout(() => { try { renderMoneyReport(); } catch(e) {} }, 0); }
}

function applyTabOnlyVisibility(activeTab) {
  document.querySelectorAll('[data-only-tab]').forEach(el => {
    const tabs = (el.getAttribute('data-only-tab') || '').split(',').map(s => s.trim()).filter(Boolean);
    const shouldShow = tabs.includes(activeTab);
    if (!el.dataset.origDisplay) {
      const cs = window.getComputedStyle(el);
      el.dataset.origDisplay = (cs.display && cs.display !== 'none') ? cs.display : 'block';
    }
    el.style.display = shouldShow ? el.dataset.origDisplay : 'none';
  });
}

        
        // „ÇØ„Ç§„ÉÉ„ÇØ„Éú„Çø„É≥„ÇíÂãïÁöÑÁîüÊàê
        function renderActivityQuickButtons() {
            const container = document.getElementById('activityQuickButtons');
            container.innerHTML = activityCategories.map(cat => 
                `<button class="quick-button" data-category="${cat.name}" data-emoji="${cat.emoji}" onclick="selectCategory('${cat.name}', '${cat.emoji}')">${cat.emoji} ${cat.name}</button>`
            ).join('');
        }
        
        // „Ç´„ÉÜ„Ç¥„É™ÈÅ∏ÊäûÔºà„ÇØ„Ç§„ÉÉ„ÇØ„Éú„Çø„É≥Ôºâ
        function selectCategory(categoryName, categoryEmoji) {
            selectedCategory = categoryName;
            selectedCategoryEmoji = categoryEmoji;

            // Êñ∞ÂÆüË£ÖÔºà„Çø„Ç§„É´ÈÅ∏ÊäûÔºâÂÅ¥„Å®ÂêåÊúü
            window.selectedActivityCategoryName = categoryName;
            window.selectedActivityCategoryEmoji = categoryEmoji;

            // „Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.quick-button').forEach(btn => {
                btn.classList.remove('selected');
            });

            const selectedButton = document.querySelector(`.quick-button[data-category="${categoryName}"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
            }

            // ÂÖ•ÂäõÊ¨Ñ„Å´„Éï„Ç©„Éº„Ç´„Çπ
            document.getElementById('activityDetailInput')?.focus();
        }


        // „ÇØ„Ç§„ÉÉ„ÇØËøΩÂä†Ôºö„ÅäÈáë
        function quickAddMoney(category, amount) {
            document.getElementById('moneyInput').value = category;
            document.getElementById('moneyAmount').value = Math.abs(amount);
            addMoney();
        }
        
        // Ë°åÂãï„ÇíË®òÈå≤
        function addActivity() {
            const text = (document.getElementById('activityDetailInput')?.value || '').trim();

            const categoryName = window.selectedActivityCategoryName || selectedCategory;
            const categoryEmoji = window.selectedActivityCategoryEmoji || selectedCategoryEmoji;

            if (!categoryName) {
                alert('‚ùå „Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

    // Ë©≥Á¥∞„ÅØ‰ªªÊÑèÔºàÁ©∫„Åß„ÇÇÁôªÈå≤„Åß„Åç„ÇãÔºâ
// Êñ∞„Åó„ÅÑË®òÈå≤„Çí‰ΩúÊàêÔºàÈñãÂßãÊôÇÂàª„ÅÆ„ÅøÔºâ
            const activity = {
                id: Date.now(),
                text: text || '',
                category: categoryName,
                categoryEmoji: categoryEmoji || 'üìù',
                startTime: new Date().toISOString(),
                endTime: null,  // Á∂ôÁ∂ö‰∏≠
                timestamp: new Date().toISOString()
            };

            activities.unshift(activity);
            localStorage.setItem('activities', JSON.stringify(activities));

            // ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢
            const detailEl = document.getElementById('activityDetailInput');
            if (detailEl) detailEl.value = '';

            // „Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„Éà
            selectedCategory = null;
            selectedCategoryEmoji = null;
            window.selectedActivityCategoryName = null;
            window.selectedActivityCategoryEmoji = null;

            // „ÇØ„Ç§„ÉÉ„ÇØ„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„ÇØ„É™„Ç¢
            document.querySelectorAll('.quick-button').forEach(btn => {
                btn.classList.remove('selected');
            });

            // „É≠„Ç∞„ÇíÊõ¥Êñ∞
            renderActivityLogs();

            alert('‚úì Ë®òÈå≤„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü');
        }


        // Á∂ôÁ∂ö‰∏≠„ÅÆË®òÈå≤„ÇíÁµÇ‰∫Ü
        function endActivity(id) {
            const activity = activities.find(a => a.id === id);
            if (!activity) return;
            
            // ÁµÇ‰∫ÜÊôÇÂàª„ÇíË®òÈå≤
            activity.endTime = new Date().toISOString();
            
            // ÊâÄË¶ÅÊôÇÈñì„ÇíË®àÁÆó
            const start = new Date(activity.startTime || activity.timestamp);
            const end = new Date(activity.endTime);
            const durationMinutes = Math.round((end - start) / 1000 / 60);
            activity.durationMinutes = durationMinutes;
            
            localStorage.setItem('activities', JSON.stringify(activities));
            renderActivityLogs();
            
            const hours = Math.floor(durationMinutes / 60);
            const minutes = durationMinutes % 60;
            const durationStr = hours > 0 ? `${hours}ÊôÇÈñì${minutes}ÂàÜ` : `${minutes}ÂàÜ`;
            
            alert(`‚úì ÁµÇ‰∫Ü„Åó„Åæ„Åó„ÅüÔºà${durationStr}Ôºâ`);
        }

        function addMoney() {
            const input = document.getElementById('moneyInput');
            const amountInput = document.getElementById('moneyAmount');
            const text = input.value.trim();
            const amount = parseFloat(amountInput.value);
            
            if (!selectedMoneyCategory) {
                showStatus('moneyStatus', '‚ùå „Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (isNaN(amount)) {
                showStatus('moneyStatus', '‚ùå ÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // ÊîØÂá∫„ÅÆÂ†¥Âêà„ÅØ„Éû„Ç§„Éä„Çπ„Å´
            const finalAmount = currentMoneyType === 'expense' ? -Math.abs(amount) : Math.abs(amount);
            
            const record = {
                id: Date.now(),
                text: text || '',
                amount: finalAmount,
                category: selectedMoneyCategory,
                type: currentMoneyType,
                timestamp: new Date().toISOString()
            };
            
            window.moneyRecords.unshift(record);
            console.log("üí∞ Êñ∞„Åó„ÅÑË®òÈå≤„ÇíËøΩÂä†:", record);
            console.log("ËøΩÂä†Âæå„ÅÆ moneyRecords ‰ª∂Êï∞:", window.moneyRecords.length);
            localStorage.setItem('moneyRecords', JSON.stringify(window.moneyRecords));
            
            input.value = '';
            amountInput.value = '';
            showStatus('moneyStatus', '‚úì Ë®òÈå≤„Åó„Åæ„Åó„Åü');
            renderMoneyLogs();
        }
        

// „ÅäÈáë„Çø„Éñ: ÂèéÂÖ•/ÊîØÂá∫„ÅÆÂàá„ÇäÊõø„Åà
let currentMoneyType = 'expense'; // 'expense' „Åæ„Åü„ÅØ 'income'
let selectedMoneyCategory = null;

function switchMoneyType(type) {
    currentMoneyType = type;
    
    // „Çø„Éñ„Éú„Çø„É≥„ÅÆ active Áä∂ÊÖã„ÇíÊõ¥Êñ∞
    document.querySelectorAll('.money-type-tab').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`.money-type-tab[data-type="${type}"]`).classList.add('active');
    
    // „Ç´„ÉÜ„Ç¥„É™Ë°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
    if (type === 'expense') {
        document.getElementById('expenseCategories').classList.add('active');
        document.getElementById('incomeCategories').classList.remove('active');
    } else {
        document.getElementById('expenseCategories').classList.remove('active');
        document.getElementById('incomeCategories').classList.add('active');
    }
    
    // „Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„Éà
    selectedMoneyCategory = null;
    document.querySelectorAll('.money-category-buttons .category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById('selectedMoneyCategory').textContent = '„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
  applyTabOnlyVisibility(tabName);
}


function selectMoneyCategory(category) {
    selectedMoneyCategory = category;
    
    // ÂÖ®„Å¶„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Éú„Çø„É≥„Åã„Çâ active „ÇíÂâäÈô§
    document.querySelectorAll('.money-category-buttons .category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // ÈÅ∏Êäû„Åï„Çå„Åü„Ç´„ÉÜ„Ç¥„É™„Éú„Çø„É≥„Å´ active „ÇíËøΩÂä†
    const activeContainer = currentMoneyType === 'expense' ? 
        document.getElementById('expenseCategories') : 
        document.getElementById('incomeCategories');
    const btn = activeContainer.querySelector(`[data-category="${category}"]`);
    if (btn) {
        btn.classList.add('active');
    }
    
    // ÈÅ∏ÊäûË°®Á§∫„ÇíÊõ¥Êñ∞
    const display = document.getElementById('selectedMoneyCategory');
    display.textContent = `ÈÅ∏Êäû‰∏≠: ${(window.selectedActivityCategoryEmoji || '')} ${category}`.trim();
    display.classList.add('has-selection');
}


// „ÅäÈáë„Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜÊ©üËÉΩ
window.expenseCategories = [
    { name: 'È£üË≤ª', emoji: 'üçΩÔ∏è' },
    { name: 'Êó•Áî®ÂìÅ', emoji: 'üß¥' },
    { name: 'Ë°£Êúç', emoji: 'üëï' },
    { name: 'ÁæéÂÆπ', emoji: 'üíÑ' },
    { name: '‰∫§ÈöõË≤ª', emoji: 'ü§ù' },
    { name: 'ÂåªÁôÇË≤ª', emoji: '‚öïÔ∏è' },
    { name: 'ÊïôËÇ≤Ë≤ª', emoji: 'üìö' },
    { name: 'ÂÖâÁÜ±Ë≤ª', emoji: 'üí°' },
    { name: '‰∫§ÈÄöË≤ª', emoji: 'üöÉ' },
    { name: 'Â®ØÊ•Ω', emoji: 'üéÆ' }
];

window.incomeCategories = [
    { name: 'Áµ¶Êñô', emoji: 'üíº' },
    { name: '„Åä„Åì„Å•„Åã„ÅÑ', emoji: 'üíµ' },
    { name: 'Ë≥û‰∏é', emoji: 'üéÅ' },
    { name: 'ÂâØÊ•≠', emoji: 'üíª' },
    { name: 'ÊäïË≥á', emoji: 'üìà' },
    { name: 'Ëá®ÊôÇÂèéÂÖ•', emoji: 'üéâ' }
];

// LocalStorage„Åã„ÇâË™≠„ÅøËæº„Åø
function loadMoneyCategories() {
    const savedExpense = localStorage.getItem('expenseCategories');
    const savedIncome = localStorage.getItem('incomeCategories');
    
    if (savedExpense) {
        expenseCategories = JSON.parse(savedExpense);
    }
    if (savedIncome) {
        incomeCategories = JSON.parse(savedIncome);
    }
    
    renderMoneyCategories();
}

// „Ç´„ÉÜ„Ç¥„É™„ÇíÊèèÁîª
function renderMoneyCategories() {
    // ÊîØÂá∫„Ç´„ÉÜ„Ç¥„É™
    const expenseContainer = document.querySelector('#expenseCategories .money-category-buttons');
    if (expenseContainer) {
        expenseContainer.innerHTML = expenseCategories.map(cat => 
            `<button class="category-btn" onclick="selectMoneyCategory('${cat.name}')" data-category="${cat.name}">${cat.emoji} ${cat.name}</button>`
        ).join('');
    }
    
    // ÂèéÂÖ•„Ç´„ÉÜ„Ç¥„É™
    const incomeContainer = document.querySelector('#incomeCategories .money-category-buttons');
    if (incomeContainer) {
        incomeContainer.innerHTML = incomeCategories.map(cat => 
            `<button class="category-btn" onclick="selectMoneyCategory('${cat.name}')" data-category="${cat.name}">${cat.emoji} ${cat.name}</button>`
        ).join('');
    }
}

// „Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
function editMoneyCategories(type) {
    const modal = document.getElementById('moneyCategoryEditModal');
    modal.style.display = 'block';
    
    const title = modal.querySelector('h3');
    title.textContent = type === 'expense' ? 'üí∏ ÊîØÂá∫„Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜ' : 'üí∞ ÂèéÂÖ•„Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜ';
    
    // „É¢„Éº„ÉÄ„É´„Å´ type „Çí‰øùÂ≠ò
    modal.dataset.editingType = type;
    
    renderCategoryEditList(type);
}

// „Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜ„É™„Çπ„Éà„ÇíÊèèÁîª
function renderCategoryEditList(type) {
    const container = document.getElementById('categoryEditList');
    const categories = type === 'expense' ? expenseCategories : incomeCategories;
    
    container.innerHTML = categories.map((cat, index) => `
        <div class="category-edit-item">
            <span class="category-edit-emoji">${cat.emoji}</span>
            <span class="category-edit-name">${cat.name}</span>
            <button class="btn-icon" onclick="deleteMoneyCategoryItem('${type}', ${index})" title="ÂâäÈô§">üóëÔ∏è</button>
        </div>
    `).join('');
}

// „Ç´„ÉÜ„Ç¥„É™ËøΩÂä†
function addMoneyCategory() {
    const modal = document.getElementById('moneyCategoryEditModal');
    const type = modal.dataset.editingType;
    const nameInput = document.getElementById('newCategoryName');
    const emojiInput = document.getElementById('newCategoryEmoji');
    
    const name = nameInput.value.trim();
    const emoji = emojiInput.value.trim() || 'üìå';
    
    if (!name) {
        alert('„Ç´„ÉÜ„Ç¥„É™Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    const categories = type === 'expense' ? expenseCategories : incomeCategories;
    
    // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
    if (categories.some(c => c.name === name)) {
        alert('„Åô„Åß„Å´Âêå„ÅòÂêçÂâç„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÅåÂ≠òÂú®„Åó„Åæ„Åô');
        return;
    }
    
    categories.push({ name, emoji });
    
    // ‰øùÂ≠ò
    localStorage.setItem(type === 'expense' ? 'expenseCategories' : 'incomeCategories', JSON.stringify(categories));
    
    // „É™„Çª„ÉÉ„Éà
    nameInput.value = '';
    emojiInput.value = '';
    
    // ÂÜçÊèèÁîª
    renderCategoryEditList(type);
    renderMoneyCategories();
}

// „Ç´„ÉÜ„Ç¥„É™ÂâäÈô§
function deleteMoneyCategoryItem(type, index) {
    if (!confirm('„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
    
    const categories = type === 'expense' ? expenseCategories : incomeCategories;
    categories.splice(index, 1);
    
    // ‰øùÂ≠ò
    localStorage.setItem(type === 'expense' ? 'expenseCategories' : 'incomeCategories', JSON.stringify(categories));
    
    // ÂÜçÊèèÁîª
    renderCategoryEditList(type);
    renderMoneyCategories();
}

// „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
function closeMoneyCategoryEditModal() {
    document.getElementById('moneyCategoryEditModal').style.display = 'none';
}

/* ===== Ë°åÂãï„Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜÔºà„ÅäÈáë„Å®Âêå„ÅòUX„Å´Áµ±‰∏ÄÔºâ ===== */
function renderActivityCategories() {
    const wrap = document.getElementById('activityCategoryButtons');
    if (!wrap) return;

    // „Éú„Çø„É≥„ÇíÁîüÊàê
    wrap.innerHTML = activityCategories.map(cat => {
        const safeName = String(cat.name || '').replace(/"/g, '&quot;');
        const safeEmoji = String(cat.emoji || '');
        return `<button class="category-btn" data-category="${safeName}" onclick="selectActivityCategory('${safeName.replace(/'/g, "\'")}')">
                    ${safeEmoji} ${safeName}
                </button>`;
    }).join('');

    // Êó¢„Å´ÈÅ∏Êäû„Åå„ÅÇ„Çå„Å∞ÂÜç„Éè„Ç§„É©„Ç§„Éà
    if (window.selectedActivityCategoryName) {
        selectActivityCategory(window.selectedActivityCategoryName);
    }
}

function editActivityCategories() {
    renderActivityCategoryEditList();
    const modal = document.getElementById('activityCategoryEditModal');
    if (modal) modal.style.display = 'flex';
}

// Á∑®ÈõÜ„É™„Çπ„Éà„ÇíÊèèÁîª
function renderActivityCategoryEditList() {
    const list = document.getElementById('activityCategoryEditList');
    if (!list) return;

    list.innerHTML = activityCategories.map((cat, idx) => `
        <div class="category-edit-item">
            <span class="category-display">${cat.emoji || ''} ${cat.name || ''}</span>
            <button class="btn-delete" onclick="deleteActivityCategoryItem(${idx})">ÂâäÈô§</button>
        </div>
    `).join('') || '<div style="color:#666;">„Ç´„ÉÜ„Ç¥„É™„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
}

// ËøΩÂä†
function addActivityCategory() {
    const emojiEl = document.getElementById('newActivityCategoryEmoji');
    const nameEl = document.getElementById('newActivityCategoryName');
    const emoji = (emojiEl?.value || '').trim() || 'üìù';
    const name = (nameEl?.value || '').trim();

    if (!name) {
        alert('‚ùå „Ç´„ÉÜ„Ç¥„É™Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }

    // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
    if (activityCategories.some(c => (c.name || '') === name)) {
        alert('‚ùå Âêå„Åò„Ç´„ÉÜ„Ç¥„É™Âêç„ÅåÊó¢„Å´„ÅÇ„Çä„Åæ„Åô');
        return;
    }

    activityCategories.push({ name, emoji });

    // ‰øùÂ≠ò
    localStorage.setItem('activityCategories', JSON.stringify(activityCategories));

    // UIÊõ¥Êñ∞
    renderActivityCategoryEditList();
    renderActivityCategories();

    // ÂÖ•Âäõ„ÇØ„É™„Ç¢
    if (emojiEl) emojiEl.value = '';
    if (nameEl) nameEl.value = '';
}

// ÂâäÈô§
function deleteActivityCategoryItem(index) {
    if (!confirm('„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

    const removed = activityCategories.splice(index, 1)[0];

    // ‰øùÂ≠ò
    localStorage.setItem('activityCategories', JSON.stringify(activityCategories));

    // ÈÅ∏Êäû‰∏≠„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÅåÊ∂à„Åà„Åü„ÇâËß£Èô§
    if (removed && removed.name && window.selectedActivityCategoryName === removed.name) {
        window.selectedActivityCategoryName = null;
        window.selectedActivityCategoryEmoji = null;
        const display = document.getElementById('selectedActivityCategory');
        if (display) {
            display.textContent = '„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            display.style.color = '#666';
            display.style.fontWeight = 'normal';
        }
    }

    renderActivityCategoryEditList();
    renderActivityCategories();
}

function closeActivityCategoryEditModal() {
    const modal = document.getElementById('activityCategoryEditModal');
    if (modal) modal.style.display = 'none';
}

// Êó¢Â≠ò„ÅÆÂëº„Å≥Âá∫„Åó‰∫íÊèõÔºàÂè§„ÅÑ„Éú„Çø„É≥„ÅåÊÆã„Å£„Å¶„ÇÇÂãï„Åè„Çà„ÅÜ„Å´Ôºâ
function openCategoryManager() {
    editActivityCategories();
}
window.openCategoryManager = openCategoryManager;
        // ‰ΩìÈáç„ÇíË®òÈå≤
        function addWeight() {
            const input = document.getElementById('weightInput');
            const weight = parseFloat(input.value);
            
            if (isNaN(weight) || weight <= 0) {
                showStatus('weightStatus', '‚ùå Ê≠£„Åó„ÅÑ‰ΩìÈáç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const record = {
                id: Date.now(),
                weight: weight,
                timestamp: new Date().toISOString()
            };
            
            weightRecords.unshift(record);
            localStorage.setItem('weightRecords', JSON.stringify(weightRecords));
            
            input.value = '';
            showStatus('weightStatus', '‚úì Ë®òÈå≤„Åó„Åæ„Åó„Åü');
            renderWeightLogs();
        }
        
        // „Ç∏„É£„Éº„Éä„É´Ëá™ÂãïË¶ÅÁ¥Ñ
// ÊîπÂñÑÁâà„Ç∏„É£„Éº„Éä„É´ÂàÜÊûêÈñ¢Êï∞
        // ÊîπÂñÑÁâà„Ç∏„É£„Éº„Éä„É´ÂàÜÊûêÈñ¢Êï∞Ôºà„Éá„Éê„ÉÉ„Ç∞Âº∑ÂåñÁâàÔºâ
        // ÂÆåÂÖ®ÊîπÂñÑÁâà„Ç∏„É£„Éº„Éä„É´ÂàÜÊûêÈñ¢Êï∞ÔºàË§áÊï∞Ë¶ÅÁ¥†ÂØæÂøúÔºâ
// Èü≥Â£∞ÂÖ•Âäõ„ÉÜ„Ç≠„Çπ„Éà„ÅÆÂâçÂá¶ÁêÜ„Å®È´òÁ≤æÂ∫¶ÂàÜÊûê

function preprocessVoiceText(text) {
    console.log('=== ÂâçÂá¶ÁêÜÈñãÂßã ===');
    console.log('ÂÖÉ„ÅÆ„ÉÜ„Ç≠„Çπ„Éà:', text);
    
    // 1. ÊòéÁ¢∫„Å™Âå∫Âàá„Çä„Éù„Ç§„É≥„Éà„ÇíÊ§úÂá∫
    let processed = text;
    
    // Êé•Á∂öË©û„ÅÆÂâç„Å´Âè•ÁÇπ„ÇíËøΩÂä†Ôºà„Ç´„Ç∏„É•„Ç¢„É´Ë°®ÁèæÂØæÂøúÔºâ
    const conjunctions = [
        '„Åæ„Åü', '„Åù„Åó„Å¶', '„Åù„Çå„Åã„Çâ', '„ÅÇ„Å®', '„Åß„ÇÇ', '„Å†„Åë„Å©', '„Åó„Åã„Åó',
        '„Åü„Å†', '„Åë„Å©', '‰∏ÄÊñπ', '„Å°„Å™„Åø„Å´', 'Ê¨°„Å´', '„Åï„Çâ„Å´', '„Åù„Çå„Åß'
    ];
    
    conjunctions.forEach(conj => {
        // „Äå„Åß„Åô[Êé•Á∂öË©û]„Äç„Äå„Åó„Åü[Êé•Á∂öË©û]„Äç„Äå„Å†[Êé•Á∂öË©û]„Äç„Å™„Å©„ÇíÊ§úÂá∫
        const patterns = [
            new RegExp(`(„Åß„Åô|„Åó„Åü|„Å†„Å£„Åü|„Åß„Åó„Åü|„Åæ„Åô|„Åæ„Åó„Åü|„Å†|„Åü)${conj}`, 'g'),
            new RegExp(`(„Åì„Å®|„ÅÆ|„ÇÇ„ÅÆ)${conj}`, 'g')
        ];
        
        patterns.forEach(pattern => {
            processed = processed.replace(pattern, (match, p1) => {
                console.log(`Âè•ÁÇπÊåøÂÖ•: "${match}" ‚Üí "${p1}„ÄÇ${conj}"`);
                return `${p1}„ÄÇ${conj}`;
            });
        });
    });
    
    // 2. „Ç´„ÉÜ„Ç¥„É™„Ç≠„Éº„ÉØ„Éº„Éâ„ÅÆÂâç„Å´Âè•ÁÇπ„ÇíËøΩÂä†
    const categoryMarkers = [
        '„Çà„Åã„Å£„Åü„Åì„Å®', 'ËâØ„Åã„Å£„Åü„Åì„Å®', '„ÅÑ„ÅÑ„Åì„Å®',
        '„ÇÇ„Å£„Å®„Åß„Åç„Çã„Åì„Å®', '„ÇÇ„Å£„Å®',
        'ÊÇ©„Çì„Åß„Çã„Åì„Å®', 'ÂøÉÈÖç„Å™„Åì„Å®', '‰∏çÂÆâ„Å™„Åì„Å®',
        'ÊòéÊó•', 'ÊòéÊó•„ÅØ', 'ÊòéÊó•„ÅÆ', 'ÊòéÊó•„ÇÑ„Çã„Åì„Å®'
    ];
    
    categoryMarkers.forEach(marker => {
        const pattern = new RegExp(`(„Åß„Åô|„Åó„Åü|„Å†„Å£„Åü|„Åß„Åó„Åü|„Åæ„Åô|„Åæ„Åó„Åü|„Å†|„Åü|„Åì„Å®)([^„ÄÇ])*(${marker})`, 'g');
        processed = processed.replace(pattern, (match, p1, p2, p3) => {
            // Êó¢„Å´Âè•ÁÇπ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
            if (match.includes('„ÄÇ')) return match;
            const insertion = `${p1}„ÄÇ${p2 || ''}${p3}`;
            console.log(`„Ç´„ÉÜ„Ç¥„É™ÂâçÂè•ÁÇπÊåøÂÖ•: "${match}" ‚Üí "${insertion}"`);
            return insertion;
        });
    });
    
    // 3. Èü≥Â£∞Ë™çË≠òÁâπÊúâ„ÅÆË™§Â§âÊèõ„Çí‰øÆÊ≠£
    const corrections = [
        ['Â¶ªÊÉ≥', 'ÊúÄÈ´ò'],
        ['Ë©ï‰æ°„ÇíÈÄ≤„ÇÅ„Çâ„Çå„Åü', 'Ë©ï‰æ°„Çí„ÇÇ„Çâ„Åà„Åü'],
        ['„Åß„Åô„Åæ„Åü', '„Åß„Åô„ÄÇ„Åæ„Åü'],
        ['„Åì„Å®Â¶ªÊÉ≥', '„Åì„Å®ÊúÄÈ´ò'],
        ['„Åì„Å®„Åå', '„Åì„Å®„Åß']
    ];
    
    corrections.forEach(([wrong, correct]) => {
        if (processed.includes(wrong)) {
            console.log(`Ë™§Â§âÊèõ‰øÆÊ≠£: "${wrong}" ‚Üí "${correct}"`);
            processed = processed.replace(new RegExp(wrong, 'g'), correct);
        }
    });
    
    console.log('ÂâçÂá¶ÁêÜÂæå:', processed);
    console.log('=== ÂâçÂá¶ÁêÜÂÆå‰∫Ü ===\n');
    
    return processed;
}

function analyzJournal(text) {
    console.log('\n=== „Ç∏„É£„Éº„Éä„É´ÂàÜÊûêÈñãÂßã ===');
    
    // ÂâçÂá¶ÁêÜ„ÇíÈÅ©Áî®
    const preprocessed = preprocessVoiceText(text);
    
    const analysis = {
        good: [],
        more: [],
        worry: [],
        task: []
    };

    // „Ç≠„Éº„ÉØ„Éº„Éâ„Éë„Çø„Éº„É≥ÔºàÊã°ÂºµÁâàÔºâ
    const patterns = {
        good: {
            keywords: [
                '„Çà„Åã„Å£„Åü', 'ËâØ„Åã„Å£„Åü', '„ÅÑ„ÅÑ', 'ËâØ„ÅÑ', '„ÅÜ„Çå„Åó„ÅÑ', 'Â¨â„Åó„ÅÑ',
                'Ê•Ω„Åó„Åã„Å£„Åü', 'Ê•Ω„Åó„ÅÑ', '„Åü„ÅÆ„Åó„ÅÑ', 'Âπ∏„Åõ', '„Åó„ÅÇ„Çè„Åõ',
                'ÊàêÂäü', '„Åß„Åç„Åü', 'ÈÅîÊàê', 'ÈÄ≤„Çì„Å†', 'È†ÜË™ø', '„ÇÑ„Å£„Åü',
                'Ê∫ÄË∂≥', '„ÅÇ„Çä„Åå„Åü„ÅÑ', 'ÊÑüË¨ù', 'ÊúÄÈ´ò', 'Á¥†Êô¥„Çâ„Åó„ÅÑ',
                'ÂÖÖÂÆü', '„Éù„Ç∏„ÉÜ„Ç£„Éñ', 'ÂâçÂêë„Åç', '„Åå„Çì„Å∞„Å£„Åü', 'È†ëÂºµ„Å£„Åü',
                'Ë©ï‰æ°', '„ÇÇ„Çâ„Åà„Åü', 'Ë§í„ÇÅ„Çâ„Çå„Åü', 'Ë™ç„ÇÅ„Çâ„Çå„Åü', 'ÈÄÄÈô¢'
            ],
            verbs: ['„Åß„Åç„Åü', 'ÈÄ≤„Çì„Å†', '„ÇÑ„Å£„Åü', 'ÈÅîÊàê„Åó„Åü', 'ÊàêÂäü„Åó„Åü']
        },
        more: {
            keywords: [
                '„ÇÇ„Å£„Å®', '„Åï„Çâ„Å´', 'ÊîπÂñÑ', '„ÇÇ„ÅÜÂ∞ë„Åó', 'Ê¨°„ÅØ', 'Ê¨°Âõû',
                'Â∑•Â§´', 'ÂäπÁéá', '„Çà„Çä„Çà„Åè', 'Âêë‰∏ä', '‰º∏„Å∞„Åô', 'Á£®„Åè',
                'Âº∑Âåñ', '„Çπ„Ç≠„É´„Ç¢„ÉÉ„Éó', 'ÊàêÈï∑', '„É¨„Éô„É´„Ç¢„ÉÉ„Éó', 'Áô∫Â±ï',
                '„Åß„Åç„Çã„Åì„Å®', '„ÇÑ„Çå„Çã„Åì„Å®', 'ÂèØËÉΩÊÄß', '„ÉÅ„É£„É≥„Çπ'
            ],
            verbs: ['ÊîπÂñÑ„Åô„Çã', 'Âêë‰∏ä„Åô„Çã', 'ÊàêÈï∑„Åô„Çã', 'Á£®„Åè', '‰º∏„Å∞„Åô']
        },
        worry: {
            keywords: [
                'ÂøÉÈÖç', '‰∏çÂÆâ', 'ÊÇ©„Åø', 'Âõ∞„Å£„Åü', 'Èõ£„Åó„ÅÑ', 'Â§ßÂ§â',
                '„Å§„Çâ„ÅÑ', '„Åç„Å§„ÅÑ', '„Åó„Çì„Å©„ÅÑ', '„Çπ„Éà„É¨„Çπ', '„Éó„É¨„ÉÉ„Ç∑„É£„Éº',
                'ÁÑ¶„Çä', '„Ç§„É©„Ç§„É©', '„ÇÇ„ÇÑ„ÇÇ„ÇÑ', 'ÊÇ≤„Åó„ÅÑ', 'ËêΩ„Å°Ëæº„ÇÄ',
                'ÂæåÊÇî', 'Â§±Êïó', '„Éü„Çπ', '„Éà„É©„Éñ„É´', 'ÂïèÈ°å',
                '„Çè„Åã„Çâ„Å™„ÅÑ', '„Åß„Åç„Å™„ÅÑ', '„ÅÜ„Åæ„Åè„ÅÑ„Åã„Å™„ÅÑ', '„ÇÑ„Å∞„ÅÑ'
            ],
            verbs: ['Âõ∞„Çã', 'ÊÇ©„ÇÄ', 'ÂøÉÈÖç„Åô„Çã', '‰∏çÂÆâ„Å´„Å™„Çã', 'ËêΩ„Å°Ëæº„ÇÄ']
        },
        task: {
            keywords: [
                'ÊòéÊó•', '‰ªäÂæå', '„Åì„Çå„Åã„Çâ', 'Ê¨°', '‰∫àÂÆö', 'Ë®àÁîª',
                '„ÇÑ„Çã', '„Åô„Çã', '„Åó„Çà„ÅÜ', '„ÇÑ„Çç„ÅÜ', 'Âèñ„ÇäÁµÑ„ÇÄ', 'ÈÄ≤„ÇÅ„Çã',
                'Ê∫ñÂÇô', 'ÂØæÂøú', 'ÂÆüÊñΩ', 'Ë°å„ÅÜ', 'Âßã„ÇÅ„Çã', '„Çπ„Çø„Éº„Éà',
                'È†ëÂºµ„Çã', '„Åå„Çì„Å∞„Çã', '„Éà„É©„Ç§', '„ÉÅ„É£„É¨„É≥„Ç∏', 'ÊåëÊà¶'
            ],
            verbs: ['„ÇÑ„Çã', '„Åô„Çã', 'Âèñ„ÇäÁµÑ„ÇÄ', 'ÈÄ≤„ÇÅ„Çã', 'Âßã„ÇÅ„Çã', 'È†ëÂºµ„Çã']
        }
    };

    // ÂâçÂá¶ÁêÜÊ∏à„Åø„ÉÜ„Ç≠„Çπ„Éà„Çí„Çª„Ç∞„É°„É≥„Éà„Å´ÂàÜÂâ≤
    const sentences = preprocessed
        .split(/[„ÄÇÔºÅÔºü\n]/)
        .filter(s => s.trim().length > 0);
    
    console.log('„Çª„Ç∞„É°„É≥„Éà„Å´ÂàÜÂâ≤:', sentences);

    sentences.forEach((sentence, idx) => {
        const trimmed = sentence.trim();
        if (trimmed.length === 0) return;

        console.log(`\n--- „Çª„Ç∞„É°„É≥„Éà ${idx + 1}: "${trimmed}" ---`);

        let matched = false;
        let matchedCategories = [];

        // ÂêÑ„Ç´„ÉÜ„Ç¥„É™„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºàË§áÊï∞„Ç´„ÉÜ„Ç¥„É™ÂØæÂøúÔºâ
        Object.keys(patterns).forEach(category => {
            const pattern = patterns[category];
            const hasKeyword = pattern.keywords.some(kw => trimmed.includes(kw));
            const hasVerb = pattern.verbs && pattern.verbs.some(v => trimmed.includes(v));

            if (hasKeyword || hasVerb) {
                console.log(`  ‚úì ${category}„Å´ÂàÜÈ°û („Ç≠„Éº„ÉØ„Éº„Éâ: ${hasKeyword}, ÂãïË©û: ${hasVerb})`);
                
                // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
                if (!analysis[category].includes(trimmed)) {
                    analysis[category].push(trimmed);
                    matchedCategories.push(category);
                    matched = true;
                }
            }
        });

        if (!matched) {
            console.log('  ‚Üí more„Å´ÂàÜÈ°ûÔºà„Éá„Éï„Ç©„É´„ÉàÔºâ');
            if (!analysis.more.includes(trimmed)) {
                analysis.more.push(trimmed);
            }
        } else {
            console.log(`  ‚Üí ${matchedCategories.join(', ')}„Å´ÂàÜÈ°û`);
        }
    });

    // ÂêÑ„Ç´„ÉÜ„Ç¥„É™„ÇíÊúÄÂ§ß5‰ª∂„Å´Âà∂Èôê
    Object.keys(analysis).forEach(key => {
        if (analysis[key].length > 5) {
            analysis[key] = analysis[key].slice(0, 5);
        }
    });

    console.log('\n=== ÂàÜÊûêÁµêÊûú ===');
    console.log('Good:', analysis.good);
    console.log('More:', analysis.more);
    console.log('Worry:', analysis.worry);
    console.log('Task:', analysis.task);
    console.log('=== ÂàÜÊûêÂÆå‰∫Ü ===\n');

    return analysis;
}
        
        // „Ç∏„É£„Éº„Éä„É´„Çí‰øùÂ≠ò
        function addJournal() {
            const input = document.getElementById('journalInput');
            const text = input.value.trim();
            const journalDateInput = document.getElementById('journalDate');

    // „É°„É¢„ÅØ‰ªªÊÑèÔºàÁ©∫„Åß„ÇÇÁôªÈå≤„Åß„Åç„ÇãÔºâ
// ÈÅ∏Êäû„Åï„Çå„ÅüÊó•‰ªò„ÇíÂèñÂæóÔºàÊú™ÈÅ∏Êäû„ÅÆÂ†¥Âêà„ÅØ‰ªäÊó•Ôºâ
            let selectedDate;
            if (journalDateInput.value) {
                // Êó•‰ªòÂÖ•Âäõ„Åã„ÇâÊó•‰ªò„ÇíÂèñÂæó„Åó„ÄÅÁèæÂú®ÊôÇÂàª„ÇíË®≠ÂÆö
                selectedDate = new Date(journalDateInput.value + 'T' + new Date().toTimeString().split(' ')[0]);
            } else {
                selectedDate = new Date();
            }
            
            // Ëá™ÂãïË¶ÅÁ¥Ñ
            const analysis = createManualCategoryAnalysis();
            
            const record = {
                id: Date.now(),
                text: text || '',
                mood: selectedMood,
                summary: analysis,
                timestamp: selectedDate.toISOString()
            };
            
            // ÈÅ∏Êäû„Åó„ÅüÊó•‰ªò„ÅÆ„Ç∏„É£„Éº„Éä„É´„Çí‰∏äÊõ∏„ÅçÁ¢∫Ë™ç
            const targetDateStr = selectedDate.toLocaleDateString('ja-JP');
            const existingIndex = journals.findIndex(j => 
                new Date(j.timestamp).toLocaleDateString('ja-JP') === targetDateStr
            );
            
            if (existingIndex >= 0) {
                if (confirm(`${targetDateStr}„ÅÆ„Ç∏„É£„Éº„Éä„É´„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü`)) {
                    journals[existingIndex] = record;
                } else {
                    return;
                }
            } else {
                journals.unshift(record);
            }
            
            localStorage.setItem('journals', JSON.stringify(journals));
            
            input.value = '';
            clearCategoryVoiceInputs(); // „Ç´„ÉÜ„Ç¥„É™ÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢
            journalDateInput.value = ''; // Êó•‰ªò„Çí„É™„Çª„ÉÉ„Éà
            // Keep summary visible after save
            
            // Ê∞óÂàÜÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„Éà
            selectedMood = 'normal';
            document.querySelectorAll('.mood-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            showStatus('journalStatus', `‚úì ${targetDateStr}„ÅÆË®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`);
            renderJournalLogs();
            renderCalendar();
        }
        
        // Êó•‰ªò„Çí‰ªäÊó•„Å´Ë®≠ÂÆö
        function setJournalDateToToday() {
            const today = new Date();
            const dateStr = localDateKey(today);
            document.getElementById('journalDate').value = dateStr;
        }
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´‰ªäÊó•„ÅÆÊó•‰ªò„ÇíË®≠ÂÆö
        document.addEventListener('DOMContentLoaded', () => {
            setJournalDateToToday();
        });
        
        // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
        function showStatus(elementId, message) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            setTimeout(() => {
                statusEl.textContent = '';
            }, 3000);
        }
        
        // „É≠„Ç∞Ë°®Á§∫ÔºöË°åÂãï
// Ë°åÂãï„É≠„Ç∞Ë°®Á§∫ÔºàÁ∑®ÈõÜ„ÉªÂâäÈô§„Éú„Çø„É≥‰ªò„ÅçÔºâ

// ‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØ„ÇíË°®Á§∫
function renderTodayTasks() {
    const container = document.getElementById('todayTasksContent');
    
    // Êò®Êó•„ÅÆÊó•‰ªò„ÇíÂèñÂæó
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = localDateKey(yesterday);
    
    // Êò®Êó•„ÅÆ„Ç∏„É£„Éº„Éä„É´„ÇíÂèñÂæó
    const yesterdayJournal = journalRecords.find(record => {
        const recordDate = localDateKey(new Date(record.timestamp));
        return recordDate === yesterdayStr;
    });
    
    if (!yesterdayJournal) {
        container.innerHTML = '<div class="no-tasks">Êò®Êó•„ÅÆ„Ç∏„É£„Éº„Éä„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        return;
    }
    
    // Must „Çø„Çπ„ÇØ„Å® Want „Çø„Çπ„ÇØ„ÇíÂèñÂæó
    const mustTasks = yesterdayJournal.taskMust || [];
    const wantTasks = yesterdayJournal.taskWant || [];
    
    if (mustTasks.length === 0 && wantTasks.length === 0) {
        container.innerHTML = '<div class="no-tasks">Êò®Êó•„ÅÆ„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        return;
    }
    
    let html = '';
    
    // Must „Çø„Çπ„ÇØ
    if (mustTasks.length > 0) {
        html += '<div class="task-group">';
        html += '<div class="task-group-title">‚úÖ MustÔºà„ÇÑ„Çâ„Å™„Åç„ÇÉ„ÅÑ„Åë„Å™„ÅÑ„Åì„Å®Ôºâ</div>';
        mustTasks.forEach((task, index) => {
            html += `
                <div class="task-item">
                    <input type="checkbox" id="mustTask${index}" class="task-checkbox">
                    <label for="mustTask${index}" class="task-label">${task}</label>
                </div>
            `;
        });
        html += '</div>';
    }
    
    // Want „Çø„Çπ„ÇØ
    if (wantTasks.length > 0) {
        html += '<div class="task-group">';
        html += '<div class="task-group-title">üí° WantÔºà„ÇÑ„Çä„Åü„ÅÑ„Åì„Å®Ôºâ</div>';
        wantTasks.forEach((task, index) => {
            html += `
                <div class="task-item">
                    <input type="checkbox" id="wantTask${index}" class="task-checkbox">
                    <label for="wantTask${index}" class="task-label">${task}</label>
                </div>
            `;
        });
        html += '</div>';
    }
    
    container.innerHTML = html;
}

function refreshTodayTasks() {
    renderTodayTasks();
    showStatus('activityStatus', '‚úì „Çø„Çπ„ÇØ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
}

// „É¨„Éù„Éº„ÉàÊ©üËÉΩ
let selectedReportType = 'activity'; // 'activity' „Åæ„Åü„ÅØ 'money'
let activityReportMonth = monthKeyFromDate(new Date()); // YYYY-MM
let moneyReportMonth = monthKeyFromDate(new Date());
let moneyBreakdownMode = 'expense'; // 'expense' | 'income' | 'all'
// „É¨„Éù„Éº„Éà„Çø„Ç§„Éó„ÅÆÂàá„ÇäÊõø„Åà
function switchReportType(type) {
    selectedReportType = type;
    
    // „Çø„Éñ„Éú„Çø„É≥„ÅÆ active Áä∂ÊÖã„ÇíÊõ¥Êñ∞
    document.querySelectorAll('.report-type-tab').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`.report-type-tab[data-type="${type}"]`).classList.add('active');
    
    // „É¨„Éù„Éº„ÉàÂÜÖÂÆπ„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
    if (type === 'activity') {
        document.getElementById('activityReport').classList.add('active');
        document.getElementById('moneyReport').classList.remove('active');
    } else {
        document.getElementById('activityReport').classList.remove('active');
        document.getElementById('moneyReport').classList.add('active');
    }
}

// Êúà„ÅÆÂ§âÊõ¥
function changeReportMonth(type, offset) {
    if (type === 'activity') {
        const [year, month] = activityReportMonth.split('-').map(Number);
        const date = new Date(year, month - 1 + offset, 1);
        activityReportMonth = monthKeyFromDate(date);
        updateReportMonthDisplay('activity');
        renderActivityReport();
    } else {
        const [year, month] = moneyReportMonth.split('-').map(Number);
        const date = new Date(year, month - 1 + offset, 1);
        moneyReportMonth = monthKeyFromDate(date);
        updateReportMonthDisplay('money');
        renderMoneyReport();
    }
}

// ÊúàË°®Á§∫„ÇíÊõ¥Êñ∞
function updateReportMonthDisplay(type) {
    const monthNames = ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', 
                        '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'];
    
    if (type === 'activity') {
        const [year, month] = activityReportMonth.split('-').map(Number);
        document.getElementById('activityReportMonthDisplay').textContent = `${year}Âπ¥${monthNames[month - 1]}`;
    } else {
        const [year, month] = moneyReportMonth.split('-').map(Number);
        document.getElementById('moneyReportMonthDisplay').textContent = `${year}Âπ¥${monthNames[month - 1]}`;
    }
}

// Ë°åÂãï„É¨„Éù„Éº„Éà„ÇíÊèèÁîª
function renderActivityReport() {
    renderActivityCalendar();
    renderActivitySummary();
    renderActivityChart();
    renderActivityDailyDetails();
}

// „ÅäÈáë„É¨„Éù„Éº„Éà„ÇíÊèèÁîª
function renderMoneyReport() {
  renderMoneyCalendar();
  renderMoneySummary();

  // ÂàùÊúüÂÄ§
  window.moneyBreakdownMode = window.moneyBreakdownMode || 'expense'; // 'expense' | 'income'
  window.moneyChartMetric   = window.moneyChartMetric   || 'amount';  // 'amount'  | 'count'
  window.moneyChartType     = window.moneyChartType     || 'pie';     // 'pie'     | 'bar'

  initMoneyBreakdownButtons();
  updateMoneyChartButtons();
  renderMoneyBreakdown();

  renderMoneyDailyDetails();
}

function initMoneyBreakdownButtons() {
  const btnExpense = document.getElementById('moneyModeExpense');
  const btnIncome  = document.getElementById('moneyModeIncome');

  if (btnExpense && !btnExpense.dataset.bound) {
    btnExpense.addEventListener('click', () => setMoneyBreakdownMode('expense'));
    btnExpense.dataset.bound = '1';
  }
  if (btnIncome && !btnIncome.dataset.bound) {
    btnIncome.addEventListener('click', () => setMoneyBreakdownMode('income'));
    btnIncome.dataset.bound = '1';
  }

  // ÂàùÊúüÁä∂ÊÖã„ÇíÂèçÊò†
  setMoneyBreakdownMode(window.moneyBreakdownMode || 'expense', true);
}

function setMoneyBreakdownMode(mode, skipRender) {
  window.moneyBreakdownMode = mode;

  // „Éú„Çø„É≥„ÅÆË¶ã„ÅüÁõÆ
  const btnExpense = document.getElementById('moneyModeExpense');
  const btnIncome  = document.getElementById('moneyModeIncome');
  if (btnExpense) btnExpense.classList.toggle('active', mode === 'expense');
  if (btnIncome)  btnIncome.classList.toggle('active',  mode === 'income');

  // „Çø„Ç§„Éà„É´
  const titleEl = document.getElementById('moneyBreakdownTitle');
  if (titleEl) titleEl.textContent = (mode === 'income') ? 'üìä ÂèéÂÖ•ÂÜÖË®≥' : 'üìä ÊîØÂá∫ÂÜÖË®≥';

  if (!skipRender) renderMoneyBreakdown();
}

function updateMoneyChartButtons() {
  const metric = window.moneyChartMetric || 'amount';
  const type   = window.moneyChartType || 'pie';

  const amountBtn = document.getElementById('moneyMetricAmountBtn');
  const countBtn  = document.getElementById('moneyMetricCountBtn');
  const pieBtn    = document.getElementById('moneyChartPieBtn');
  const barBtn    = document.getElementById('moneyChartBarBtn');

  if (amountBtn) amountBtn.classList.toggle('active', metric === 'amount');
  if (countBtn)  countBtn.classList.toggle('active',  metric === 'count');
  if (pieBtn)    pieBtn.classList.toggle('active',    type === 'pie');
  if (barBtn)    barBtn.classList.toggle('active',    type === 'bar');
}

function setMoneyChartMetric(metric) {
  window.moneyChartMetric = metric;
  updateMoneyChartButtons();
  renderMoneyBreakdown();
}

function setMoneyChartType(type) {
  window.moneyChartType = type;
  updateMoneyChartButtons();
  renderMoneyBreakdown();
}

function renderMoneyBreakdown() {
  const area = document.getElementById('moneyChartArea');
  const legend = document.getElementById('moneyLegend');
  if (!area) return;

  // ÂØæË±°Êúà„ÅÆ„É¨„Ç≥„Éº„Éâ
  const monthRecords = (window.moneyRecords || []).filter(r => monthKeyFromTimestamp(r.timestamp) === moneyReportMonth);

  // ÊîØÂá∫/ÂèéÂÖ•„ÅßÊäΩÂá∫
  const mode = window.moneyBreakdownMode || 'expense';
  const filtered = monthRecords.filter(r => {
    const amt = Number(r.amount) || 0;
    return mode === 'income' ? (amt > 0) : (amt < 0);
  });

  // „Ç´„ÉÜ„Ç¥„É™Âà•„Å´ÈõÜË®à
  const byCat = {};
  filtered.forEach(r => {
    const cat = ((r.category || '„Åù„ÅÆ‰ªñ') + '').trim() || '„Åù„ÅÆ‰ªñ';
    byCat[cat] = byCat[cat] || { amount: 0, count: 0 };
    byCat[cat].count += 1;
    const amt = Math.abs(Number(r.amount) || 0);
    byCat[cat].amount += amt;
  });

  const items = Object.entries(byCat)
    .map(([cat, v]) => ({ cat, amount: v.amount, count: v.count }))
    .sort((a, b) => {
      const key = (window.moneyChartMetric === 'count') ? 'count' : 'amount';
      return (b[key] || 0) - (a[key] || 0);
    });

  const key = (window.moneyChartMetric === 'count') ? 'count' : 'amount';

  if (!items.length) {
    area.innerHTML = '<p class="empty-message">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
    if (legend) legend.innerHTML = '';
    return;
  }

  if (window.moneyChartType === 'bar') {
    // Ê£íÔºà„É™„Çπ„ÉàÂΩ¢ÂºèÔºâ
    const maxVal = Math.max(...items.map(i => Number(i[key]) || 0), 0);
    const suffix = key === 'count' ? 'Âõû' : 'ÂÜÜ';

    area.innerHTML = `
      <div style="width:100%;max-width:560px;">
        ${items.map(i => {
          const v = Number(i[key]) || 0;
          const w = maxVal ? Math.round((v / maxVal) * 100) : 0;
          const shown = (key === 'amount') ? Math.round(v).toLocaleString() : v;
          return `
            <div class="bar-row">
              <div class="bar-label">${escapeHtml(i.cat)}</div>
              <div class="bar-track"><div class="bar-fill" style="width:${w}%"></div></div>
              <div class="bar-value">${shown}${suffix}</div>
            </div>
          `;
        }).join('')}
      </div>
    `;
    if (legend) legend.innerHTML = '';
  } else {
    // ÂÜÜÔºà„Éâ„Éº„Éä„ÉÑÔºâ
    area.innerHTML = `
      <div style="width:100%;display:flex;justify-content:center;">
        <canvas id="moneyPieChart" width="360" height="360"></canvas>
      </div>
    `;
    const suffix = key === 'count' ? 'Âõû' : 'ÂÜÜ';
    renderDonutChart('moneyPieChart', 'moneyLegend', items, key, suffix);
  }
}

// Ë°åÂãï„Ç´„É¨„É≥„ÉÄ„Éº
function renderActivityCalendar() {
    const container = document.getElementById('activityCalendar');
    const [year, month] = activityReportMonth.split('-').map(Number);
    
    // „Åù„ÅÆÊúà„ÅÆË®òÈå≤„ÇíÂèñÂæó
    const monthRecords = activities.filter(record => {
        const recordDate = monthKeyFromTimestamp(record.timestamp);
        return recordDate === activityReportMonth;
    });
    
    // Êó•Âà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
    const dayGroups = {};
    monthRecords.forEach(record => {
        const day = new Date(record.timestamp).getDate();
        if (!dayGroups[day]) dayGroups[day] = [];
        dayGroups[day].push(record);
    });
    
    // „Ç´„É¨„É≥„ÉÄ„Éº„ÇíÁîüÊàê
    const firstDay = new Date(year, month - 1, 1).getDay();
    const daysInMonth = new Date(year, month, 0).getDate();
    
    let html = '<div class="calendar-grid">';
    html += '<div class="calendar-header">Êó•</div>';
    html += '<div class="calendar-header">Êúà</div>';
    html += '<div class="calendar-header">ÁÅ´</div>';
    html += '<div class="calendar-header">Ê∞¥</div>';
    html += '<div class="calendar-header">Êú®</div>';
    html += '<div class="calendar-header">Èáë</div>';
    html += '<div class="calendar-header">Âúü</div>';
    
    // Á©∫ÁôΩ„Çª„É´
    for (let i = 0; i < firstDay; i++) {
        html += '<div class="calendar-day empty"></div>';
    }
    
    // Êó•‰ªò„Çª„É´
    for (let day = 1; day <= daysInMonth; day++) {
        const hasRecords = dayGroups[day] && dayGroups[day].length > 0;
        const count = hasRecords ? dayGroups[day].length : 0;
        html += `
            <div class="calendar-day ${hasRecords ? 'has-records' : ''}" 
                 onclick="showActivityDayDetails(${day})">
                <div class="calendar-day-number">${day}</div>
                ${hasRecords ? `<div class="calendar-day-count">${count}‰ª∂</div>` : ''}
            </div>
        `;
    }
    
    html += '</div>';
    container.innerHTML = html;
}

// Ë°åÂãïÊ¶ÇË¶Å
function renderActivitySummary() {
    const container = document.getElementById('activitySummary');
    
    const monthRecords = activities.filter(record => {
        const recordDate = monthKeyFromTimestamp(record.timestamp);
        return recordDate === activityReportMonth;
    });
    
    const totalCount = monthRecords.length;
    const categoryCount = {};
    
    monthRecords.forEach(record => {
        const category = record.category || '„Åù„ÅÆ‰ªñ';
        categoryCount[category] = (categoryCount[category] || 0) + 1;
    });
    
    const topCategory = Object.entries(categoryCount).sort((a, b) => b[1] - a[1])[0];
    
    container.innerHTML = `
        <div class="summary-stats">
            <div class="summary-stat-item">
                <div class="summary-stat-value">${totalCount}</div>
                <div class="summary-stat-label">Á∑èË°åÂãïÊï∞</div>
            </div>
            <div class="summary-stat-item">
                <div class="summary-stat-value">${Object.keys(categoryCount).length}</div>
                <div class="summary-stat-label">„Ç´„ÉÜ„Ç¥„É™Êï∞</div>
            </div>
            ${topCategory ? `
            <div class="summary-stat-item">
                <div class="summary-stat-value">${topCategory[0]}</div>
                <div class="summary-stat-label">ÊúÄÂ§ö„Ç´„ÉÜ„Ç¥„É™ (${topCategory[1]}Âõû)</div>
            </div>
            ` : ''}
        </div>
    `;
}

// „ÅäÈáë„Ç´„É¨„É≥„ÉÄ„ÉºÔºàÂêåÊßò„ÅÆÂÆüË£ÖÔºâ
function renderMoneyCalendar() {
    const container = document.getElementById('moneyCalendar');
    console.log("renderMoneyCalendar: moneyReportMonth=", moneyReportMonth, "moneyRecords.length=", moneyRecords.length);
    const [year, month] = moneyReportMonth.split('-').map(Number);
    
    const monthRecords = moneyRecords.filter(record => {
        const recordDate = monthKeyFromTimestamp(record.timestamp);
        return recordDate === moneyReportMonth;
    });
    
    const dayGroups = {};
    monthRecords.forEach(record => {
        const day = new Date(record.timestamp).getDate();
        if (!dayGroups[day]) dayGroups[day] = { income: 0, expense: 0 };
        if (record.amount > 0) {
            dayGroups[day].income += record.amount;
        } else {
            dayGroups[day].expense += Math.abs(record.amount);
        }
    });
    
    const firstDay = new Date(year, month - 1, 1).getDay();
    const daysInMonth = new Date(year, month, 0).getDate();
    
    let html = '<div class="calendar-grid">';
    html += '<div class="calendar-header">Êó•</div>';
    html += '<div class="calendar-header">Êúà</div>';
    html += '<div class="calendar-header">ÁÅ´</div>';
    html += '<div class="calendar-header">Ê∞¥</div>';
    html += '<div class="calendar-header">Êú®</div>';
    html += '<div class="calendar-header">Èáë</div>';
    html += '<div class="calendar-header">Âúü</div>';
    
    for (let i = 0; i < firstDay; i++) {
        html += '<div class="calendar-day empty"></div>';
    }
    
    for (let day = 1; day <= daysInMonth; day++) {
        const hasRecords = dayGroups[day];
        const balance = hasRecords ? (dayGroups[day].income - dayGroups[day].expense) : 0;
        html += `
            <div class="calendar-day ${hasRecords ? 'has-records' : ''}" 
                 onclick="showMoneyDayDetails(${day})">
                <div class="calendar-day-number">${day}</div>
                ${hasRecords ? `<div class="calendar-day-balance ${balance >= 0 ? 'positive' : 'negative'}">${balance >= 0 ? '+' : ''}${balance.toLocaleString()}ÂÜÜ</div>` : ''}
            </div>
        `;
    }
    
    html += '</div>';
    container.innerHTML = html;
}
    console.log("moneyCalendar HTML generated, length=", html.length, "first 200 chars:", html.substring(0, 200));

// „ÅäÈáëÊ¶ÇË¶Å
function renderMoneySummary() {
    const container = document.getElementById('moneySummary');
    
    const monthRecords = moneyRecords.filter(record => {
        const recordDate = monthKeyFromTimestamp(record.timestamp);
        return recordDate === moneyReportMonth;
    });
    
    let totalIncome = 0;
    let totalExpense = 0;
    
    monthRecords.forEach(record => {
        if (record.amount > 0) {
            totalIncome += record.amount;
        } else {
            totalExpense += Math.abs(record.amount);
        }
    });
    
    const balance = totalIncome - totalExpense;
    
    container.innerHTML = `
        <div class="summary-stats">
            <div class="summary-stat-item income">
                <div class="summary-stat-value">+${totalIncome.toLocaleString()}ÂÜÜ</div>
                <div class="summary-stat-label">ÂèéÂÖ•</div>
            </div>
            <div class="summary-stat-item expense">
                <div class="summary-stat-value">-${totalExpense.toLocaleString()}ÂÜÜ</div>
                <div class="summary-stat-label">ÊîØÂá∫</div>
            </div>
            <div class="summary-stat-item ${balance >= 0 ? 'positive' : 'negative'}">
                <div class="summary-stat-value">${balance >= 0 ? '+' : ''}${balance.toLocaleString()}ÂÜÜ</div>
                <div class="summary-stat-label">ÂêàË®à</div>
            </div>
        </div>
    `;
}

// „Ç∞„É©„ÉïÊèèÁîªÁî®„ÅÆÈñ¢Êï∞ÔºàChart.js„Çí‰ΩøÁî®Ôºâ
function renderActivityChart() {
  const wrap = document.getElementById('activityCategoryChart');
  const legend = document.getElementById('activityCategoryLegend');
  if (!wrap) return;

  // ÂàùÊúüÂÄ§
  window.activityChartMetric = window.activityChartMetric || 'count'; // 'count' | 'minutes'
  window.activityChartType = window.activityChartType || 'bar';       // 'bar' | 'pie'
  updateActivityChartButtons();

  // ÂØæË±°Êúà„ÅÆË°åÂãï„Å†„ÅëÊäΩÂá∫
  const monthActs = (activities || []).filter(a => {
    const recordMonth = monthKeyFromTimestamp(a.timestamp);
    return recordMonth === activityReportMonth;
  });

  if (!monthActs.length) {
    wrap.innerHTML = '<p class="empty-message">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
    if (legend) legend.innerHTML = '';
    return;
  }

  // „Ç´„ÉÜ„Ç¥„É™Âà•„Å´ÈõÜË®àÔºàÂõûÊï∞ + ÂàÜÔºâ
  const byCat = {};
  monthActs.forEach(a => {
    const cat = ((a.category || 'Êú™ÂàÜÈ°û') + '').trim() || 'Êú™ÂàÜÈ°û';
    byCat[cat] = byCat[cat] || { count: 0, minutes: 0 };
    byCat[cat].count += 1;

    // durationMinutes „ÅåÁÑ°„ÅÑ/0 „ÅÆÂ†¥Âêà„ÅØ start/end „Åã„ÇâÊé®ÂÆö
    let mins = Number(a.durationMinutes) || 0;
    if (mins <= 0 && a.startTime && a.endTime) {
      const diff = Math.round((new Date(a.endTime) - new Date(a.startTime)) / 60000);
      if (diff > 0) mins = diff;
    }
    byCat[cat].minutes += mins;
  });

  const key = window.activityChartMetric === 'minutes' ? 'minutes' : 'count';
  const items = Object.entries(byCat)
    .map(([cat, v]) => ({ cat, count: v.count, minutes: v.minutes }))
    .sort((a, b) => (b[key] || 0) - (a[key] || 0));

  if (window.activityChartType === 'pie') {
    renderActivityPie(items, key);
  } else {
    renderActivityBars(items, key);
  }
}

function updateActivityChartButtons(){
  const metric = window.activityChartMetric || 'count';
  const type = window.activityChartType || 'bar';
  const countBtn = document.getElementById('activityMetricCountBtn');
  const minBtn = document.getElementById('activityMetricMinutesBtn');
  const barBtn = document.getElementById('activityChartBarBtn');
  const pieBtn = document.getElementById('activityChartPieBtn');
  if (countBtn) countBtn.classList.toggle('active', metric === 'count');
  if (minBtn) minBtn.classList.toggle('active', metric === 'minutes');
  if (barBtn) barBtn.classList.toggle('active', type === 'bar');
  if (pieBtn) pieBtn.classList.toggle('active', type === 'pie');
}

function setActivityChartMetric(metric){
  window.activityChartMetric = metric;
  renderActivityChart();
}

function setActivityChartType(type){
  window.activityChartType = type;
  renderActivityChart();
}

function renderActivityBars(items, key){
  const wrap = document.getElementById('activityCategoryChart');
  const legend = document.getElementById('activityCategoryLegend');
  if (!wrap) return;
  if (legend) legend.innerHTML = '';

  const maxVal = Math.max(...items.map(i => Number(i[key]) || 0), 0);
  const suffix = key === 'minutes' ? 'ÂàÜ' : 'Âõû';

  wrap.innerHTML = items.map(i => {
    const v = Number(i[key]) || 0;
    const w = maxVal ? Math.round((v / maxVal) * 100) : 0;
    return `
      <div class="bar-row">
        <div class="bar-label">${escapeHtml(i.cat)}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${w}%"></div></div>
        <div class="bar-value">${v}${suffix}</div>
      </div>
    `;
  }).join('');
}

function renderActivityPie(items, key){
  const wrap = document.getElementById('activityCategoryChart');
  const legend = document.getElementById('activityCategoryLegend');
  if (!wrap) return;

  const total = items.reduce((s, i) => s + (Number(i[key]) || 0), 0);
  const suffix = key === 'minutes' ? 'ÂàÜ' : 'Âõû';

  if (!total) {
    wrap.innerHTML = '<p class="empty-message">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
    if (legend) legend.innerHTML = '';
    return;
  }

  wrap.innerHTML = `
    <div style="display:flex;justify-content:center;">
      <canvas id="activityPieChart" width="320" height="320" style="max-width:320px;width:100%;height:auto;"></canvas>
    </div>
  `;

  const canvas = document.getElementById('activityPieChart');
  const ctx = canvas.getContext('2d');

  const palette = ['#4F46E5','#16A34A','#F59E0B','#0EA5E9','#EF4444','#A855F7','#64748B','#22C55E','#E11D48','#F97316'];

  let start = -Math.PI / 2;
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const rOuter = 140;
  const rInner = 88;

  items.forEach((it, idx) => {
    const v = Number(it[key]) || 0;
    if (v <= 0) return;
    const angle = (v / total) * Math.PI * 2;
    const end = start + angle;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.closePath();
    ctx.fillStyle = palette[idx % palette.length];
    ctx.fill();

    // Âå∫Âàá„ÇäÁ∑ö
    ctx.beginPath();
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.stroke();

    start = end;
  });

  // „Éâ„Éº„Éä„ÉÑÁ©¥
  ctx.beginPath();
  ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  // ‰∏≠Â§Æ„ÉÜ„Ç≠„Çπ„Éà
  ctx.fillStyle = '#111';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.font = '700 18px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText('ÂêàË®à', cx, cy - 10);
  ctx.font = '800 22px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText(`${total}${suffix}`, cx, cy + 18);

  // Âá°‰æãÔºà‰∏ãÔºâ
  if (legend) {
    legend.innerHTML = items
      .filter(it => (Number(it[key]) || 0) > 0)
      .map((it, idx) => {
        const v = Number(it[key]) || 0;
        const pct = Math.round((v / total) * 100);
        return `
          <div class="legend-row">
            <span class="legend-dot" style="background:${palette[idx % palette.length]}"></span>
            <span class="legend-cat">${escapeHtml(it.cat)}</span>
            <span class="legend-amt">${v}${suffix}</span>
            <span class="legend-pct">${pct}%</span>
          </div>
        `;
      }).join('');
  }
}

function renderMoneyPieChart(expenses) {
  const canvas = document.getElementById('moneyPieChart');
  const legendEl = document.getElementById('moneyLegend');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  // È´òDPIÂØæÂøú
  const dpr = window.devicePixelRatio || 1;
  const displaySize = Math.min(canvas.clientWidth || 400, 400);
  canvas.width = Math.floor(displaySize * dpr);
  canvas.height = Math.floor(displaySize * dpr);
  canvas.style.width = displaySize + 'px';
  canvas.style.height = displaySize + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  // ÈõÜË®àÔºà„Ç´„ÉÜ„Ç¥„É™Âà•Ôºâ
  const byCategory = {};
  let total = 0;
  (expenses || []).forEach(r => {
    const amt = Number(r.amount) || 0;
    if (amt <= 0) return;
    const cat = r.category || '„Åù„ÅÆ‰ªñ';
    byCategory[cat] = (byCategory[cat] || 0) + amt;
    total += amt;
  });

  // „ÇØ„É™„Ç¢
  ctx.clearRect(0, 0, displaySize, displaySize);
  if (legendEl) legendEl.innerHTML = '';

  if (total <= 0 || Object.keys(byCategory).length === 0) {
    // Á©∫Ë°®Á§∫
    ctx.font = '16px Arial';
    ctx.fillStyle = '#666';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', displaySize / 2, displaySize / 2);
    return;
  }

  const colors = ['#4f46e5','#16a34a','#f59e0b','#ef4444','#06b6d4','#8b5cf6','#f97316','#10b981','#0ea5e9','#a855f7'];

  const entries = Object.entries(byCategory).sort((a,b)=>b[1]-a[1]);
  const cx = displaySize / 2;
  const cy = displaySize / 2;
  const radius = Math.min(displaySize, displaySize) * 0.36;

  let startAngle = -Math.PI / 2;
  entries.forEach(([cat, amt], i) => {
    const slice = (amt / total) * Math.PI * 2;
    const endAngle = startAngle + slice;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, radius, startAngle, endAngle);
    ctx.closePath();
    ctx.fillStyle = colors[i % colors.length];
    ctx.fill();

    // ÁôΩ„ÅÑÂ¢ÉÁïåÁ∑ö
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.stroke();

    startAngle = endAngle;
  });

  // Áúü„Çì‰∏≠„ÅÆÁ©¥Ôºà„Éâ„Éº„Éä„ÉÑÈ¢®Ôºâ
  ctx.beginPath();
  ctx.arc(cx, cy, radius * 0.58, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  // ‰∏≠Â§Æ„ÉÜ„Ç≠„Çπ„Éà
  ctx.fillStyle = '#111';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.font = 'bold 18px Arial';
  ctx.fillText(`ÂêàË®à`, cx, cy - 10);
  ctx.font = 'bold 20px Arial';
  ctx.fillText(`${Math.round(total).toLocaleString()}ÂÜÜ`, cx, cy + 18);

  // Âá°‰æã
  if (legendEl) {
    legendEl.innerHTML = entries.map(([cat, amt], i) => {
      const pct = Math.round((amt / total) * 100);
      return `
        <div class="legend-row">
          <span class="legend-dot" style="background:${colors[i % colors.length]}"></span>
          <span class="legend-cat">${escapeHtml(cat)}</span>
          <span class="legend-amt">${Math.round(amt).toLocaleString()}ÂÜÜ</span>
          <span class="legend-pct">${pct}%</span>
        </div>
      `;
    }).join('');
  }
}


// Êó•Âà•Ë©≥Á¥∞
function renderActivityDailyDetails() {
    const container = document.getElementById('activityDailyDetails');
    container.innerHTML = '<p style="text-align:center;color:#999;">„Ç´„É¨„É≥„ÉÄ„Éº„ÅÆÊó•‰ªò„Çí„Çø„ÉÉ„Éó„Åó„Å¶Ë©≥Á¥∞„ÇíË°®Á§∫</p>';
}

function renderMoneyDailyDetails() {
    const container = document.getElementById('moneyDailyDetails');
    container.innerHTML = '<p style="text-align:center;color:#999;">„Ç´„É¨„É≥„ÉÄ„Éº„ÅÆÊó•‰ªò„Çí„Çø„ÉÉ„Éó„Åó„Å¶Ë©≥Á¥∞„ÇíË°®Á§∫</p>';
}

// Êó•‰ªò„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆË©≥Á¥∞Ë°®Á§∫
function showActivityDayDetails(day) {
window.showActivityDayDetails = showActivityDayDetails; // „Ç∞„É≠„Éº„Éê„É´„Å´ÊòéÁ§∫ÁöÑ„Å´ÂÖ¨Èñã
    const [year, month] = activityReportMonth.split('-').map(Number);
    const targetDate = new Date(year, month - 1, day);
    const dateStr = localDateKey(targetDate);
    
    const dayRecords = activities.filter(record => {
        const recordDate = localDateKey(new Date(record.timestamp));
        return recordDate === dateStr;
    });
    
    const container = document.getElementById('activityDailyDetails');
    
    if (dayRecords.length === 0) {
        container.innerHTML = `<p style="text-align:center;color:#999;">${month}Êúà${day}Êó•„ÅÆË®òÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>`;
        return;
    }
    
    let html = `<h4>${month}Êúà${day}Êó•„ÅÆË°åÂãï (${dayRecords.length}‰ª∂)</h4>`;
    html += '<div class="daily-detail-list">';
    
    dayRecords.forEach(record => {
        const time = new Date(record.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        html += `
            <div class="daily-detail-item">
                <div class="daily-detail-time">${time}</div>
                <div class="daily-detail-content">
                    <div class="daily-detail-category">${record.category || '„Åù„ÅÆ‰ªñ'}</div>
                    <div class="daily-detail-text">${record.text || 'Ôºà„É°„É¢„Å™„ÅóÔºâ'}</div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    // „Çπ„ÇØ„É≠„Éº„É´
    container.scrollIntoView({ behavior: 'smooth' });
}

function showMoneyDayDetails(day) {
window.showMoneyDayDetails = showMoneyDayDetails; // „Ç∞„É≠„Éº„Éê„É´„Å´ÊòéÁ§∫ÁöÑ„Å´ÂÖ¨Èñã
    console.log("showMoneyDayDetails called", day, "moneyReportMonth:", moneyReportMonth, "moneyRecords:", moneyRecords.length);
    const [year, month] = moneyReportMonth.split('-').map(Number);
    const targetDate = new Date(year, month - 1, day);
    const dateStr = localDateKey(targetDate);
    
    const dayRecords = moneyRecords.filter(record => {
        const recordDate = localDateKey(new Date(record.timestamp));
        return recordDate === dateStr;
    });
    console.log("dayRecords filtered:", dayRecords.length, dayRecords);
    
    const container = document.getElementById('moneyDailyDetails');
    
    if (dayRecords.length === 0) {
        container.innerHTML = `<p style="text-align:center;color:#999;">${month}Êúà${day}Êó•„ÅÆË®òÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>`;
        return;
    }
    
    let totalIncome = 0;
    let totalExpense = 0;
    
    dayRecords.forEach(record => {
        if (record.amount > 0) {
            totalIncome += record.amount;
        } else {
            totalExpense += Math.abs(record.amount);
        }
    });
    
    let html = `<h4>${month}Êúà${day}Êó•„ÅÆÂèéÊîØ (${dayRecords.length}‰ª∂)</h4>`;
    html += `<div class="daily-summary">ÂèéÂÖ•: +${totalIncome.toLocaleString()}ÂÜÜ / ÊîØÂá∫: -${totalExpense.toLocaleString()}ÂÜÜ</div>`;
    html += '<div class="daily-detail-list">';
    
    dayRecords.forEach(record => {
        const time = new Date(record.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        const isIncome = record.amount > 0;
        html += `
            <div class="daily-detail-item ${isIncome ? 'income' : 'expense'}">
                <div class="daily-detail-time">${time}</div>
                <div class="daily-detail-content">
                    <div class="daily-detail-category">${record.category || (isIncome ? 'ÂèéÂÖ•' : 'ÊîØÂá∫')}</div>
                    <div class="daily-detail-text">${record.text || 'Ôºà„É°„É¢„Å™„ÅóÔºâ'}</div>
                    <div class="daily-detail-amount">${isIncome ? '+' : '-'}${Math.abs(record.amount).toLocaleString()}ÂÜÜ</div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    container.scrollIntoView({ behavior: 'smooth' });
}
function renderActivityLogs() {
    const container = document.getElementById('activityLogs');
    const today = new Date().toLocaleDateString('ja-JP');
    const todayActivities = activities.filter(a => {
        const activityDate = new Date(a.startTime || a.timestamp).toLocaleDateString('ja-JP');
        return activityDate === today;
    });
    
    if (todayActivities.length === 0) {
        container.innerHTML = '<p style="color: #999;">Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
        return;
    }
    
    container.innerHTML = todayActivities.map(record => {
        const startTime = new Date(record.startTime || record.timestamp);
        const startTimeStr = startTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        
        // Á∂ôÁ∂ö‰∏≠„Åã„Å©„ÅÜ„ÅãÂà§ÂÆö
        const isOngoing = !record.endTime;
        
        let timeDisplay = '';
        let statusBadge = '';
        
        if (isOngoing) {
            // Á∂ôÁ∂ö‰∏≠„ÅÆÂ†¥Âêà
            const now = new Date();
            const elapsedMinutes = Math.round((now - startTime) / 1000 / 60);
            const hours = Math.floor(elapsedMinutes / 60);
            const minutes = elapsedMinutes % 60;
            const elapsedStr = hours > 0 ? `${hours}ÊôÇÈñì${minutes}ÂàÜ` : `${minutes}ÂàÜ`;
            
            timeDisplay = `${startTimeStr}„Äú (${elapsedStr}ÁµåÈÅé)`;
            statusBadge = '<span class="ongoing-badge">üü¢ Á∂ôÁ∂ö‰∏≠</span>';
        } else {
            // ÁµÇ‰∫ÜÊ∏à„Åø„ÅÆÂ†¥Âêà
            const endTime = new Date(record.endTime);
            const endTimeStr = endTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            const durationMinutes = record.durationMinutes || 0;
            const hours = Math.floor(durationMinutes / 60);
            const minutes = durationMinutes % 60;
            const durationStr = hours > 0 ? `${hours}ÊôÇÈñì${minutes}ÂàÜ` : `${minutes}ÂàÜ`;
            
            timeDisplay = `${startTimeStr}„Äú${endTimeStr} (${durationStr})`;
        }
        
        const categoryBadge = record.category && record.categoryEmoji 
            ? `<span class="category-badge">${record.categoryEmoji} ${record.category}</span>`
            : '';
        
        const actionButtons = isOngoing
            ? `<button onclick="endActivity(${record.id})" class="end-btn">‚èπÔ∏è ÁµÇ‰∫Ü</button>
               <button onclick="editActivity(${record.id})">‚úèÔ∏è Á∑®ÈõÜ</button>
               <button onclick="deleteActivity(${record.id})">üóëÔ∏è</button>`
            : `<button onclick="editActivity(${record.id})">‚úèÔ∏è Á∑®ÈõÜ</button>
               <button onclick="deleteActivity(${record.id})">üóëÔ∏è</button>`;
        
        return `
            <div class="log-item ${isOngoing ? 'ongoing' : ''}">
                <div class="log-header">
                    <strong>${record.text || 'Ôºà„É°„É¢„Å™„ÅóÔºâ'}</strong>
                    ${statusBadge}
                </div>
                <div class="log-info">
                    <span class="time-display">${timeDisplay}</span>
                    ${categoryBadge}
                </div>
                <div class="log-actions">
                    ${actionButtons}
                </div>
            </div>
        `;
    }).join('');
}

// Á∂ôÁ∂ö‰∏≠„ÅÆË®òÈå≤„ÇíÂÆöÊúüÁöÑ„Å´Êõ¥Êñ∞Ôºà1ÂàÜ„Åî„Å®Ôºâ
setInterval(() => {
    const hasOngoing = activities.some(a => !a.endTime);
    if (hasOngoing) {
        renderActivityLogs();
    }
}, 60000);


// Á∑®ÈõÜ‰∏≠„ÅÆË°åÂãïID
window.editingActivityId = null;

// Ë°åÂãï„ÇíÁ∑®ÈõÜÔºà„É¢„Éº„ÉÄ„É´ÁâàÔºâ
// „ÅäÈáëÁ∑®ÈõÜÊ©üËÉΩ
window.editingMoneyId = null;

function editMoney(id) {
    const record = window.moneyRecords.find(r => r.id === id);
    if (!record) {
        alert('Ë®òÈå≤„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        return;
    }
    
    window.editingMoneyId = id;
    
    // „É¢„Éº„ÉÄ„É´„Å´ÁèæÂú®„ÅÆÂÄ§„ÇíË®≠ÂÆö
    document.getElementById('editMoneyText').value = record.text || '';
    document.getElementById('editMoneyAmount').value = record.amount || 0;
    
    // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Çídatetime-localÂΩ¢Âºè„Å´Â§âÊèõ
    if (record.timestamp) {
        const date = new Date(record.timestamp);
        const formatted = formatDateTimeLocal(date);
        document.getElementById('editMoneyTimestamp').value = formatted;
    }
    
    // „Ç´„ÉÜ„Ç¥„É™„Çª„É¨„ÇØ„Éà„ÇíÁîüÊàê
    const categorySelect = document.getElementById('editMoneyCategory');
    const allCategories = [...(window.expenseCategories || []), ...(window.incomeCategories || [])];
    categorySelect.innerHTML = allCategories.map(cat => 
        `<option value="${cat.name}" ${record.category === cat.name ? 'selected' : ''}>
            ${cat.emoji} ${cat.name}
        </option>`
    ).join('');
    
    // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
    document.getElementById('editMoneyModal').style.display = 'flex';
}
window.editMoney = editMoney; // „Ç∞„É≠„Éº„Éê„É´„Å´ÊòéÁ§∫ÁöÑ„Å´ÂÖ¨Èñã

function closeEditMoneyModal() {
    document.getElementById('editMoneyModal').style.display = 'none';
    window.editingMoneyId = null;
}

window.closeEditMoneyModal = closeEditMoneyModal; // „Ç∞„É≠„Éº„Éê„É´„Å´ÊòéÁ§∫ÁöÑ„Å´ÂÖ¨Èñã
function saveMoneyEdit() {
    const record = window.moneyRecords.find(r => r.id === window.editingMoneyId);
    if (!record) {
        alert('Ë®òÈå≤„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        return;
    }
    
    const text = document.getElementById('editMoneyText').value.trim();
    const amount = parseFloat(document.getElementById('editMoneyAmount').value);
    const categoryName = document.getElementById('editMoneyCategory').value;
    const timestamp = document.getElementById('editMoneyTimestamp').value;

    // „É°„É¢„ÅØ‰ªªÊÑèÔºàÁ©∫„Åß„ÇÇ‰øùÂ≠ò„Åß„Åç„ÇãÔºâ
if (isNaN(amount)) {
        alert('‚ùå ÊúâÂäπ„Å™ÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    // „Ç´„ÉÜ„Ç¥„É™„ÅÆÁµµÊñáÂ≠ó„ÇíÂèñÂæó
    const allCategories = [...(window.expenseCategories || []), ...(window.incomeCategories || [])];
    const category = allCategories.find(c => c.name === categoryName);
    const categoryEmoji = category ? category.emoji : 'üí∞';
    
    // Êõ¥Êñ∞
    record.text = text;
    record.amount = amount;
    record.category = categoryName;
    record.categoryEmoji = categoryEmoji;
    
    if (timestamp) {
        record.timestamp = new Date(timestamp).toISOString();
    }
    
    // ‰øùÂ≠ò
    localStorage.setItem('moneyRecords', JSON.stringify(window.moneyRecords));
    
    // ÂÜçÊèèÁîª
    renderMoneyLogs();
    
    // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    closeEditMoneyModal();
    
    showStatus('moneyStatus', '‚úì Ë®òÈå≤„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
}

window.saveMoneyEdit = saveMoneyEdit; // „Ç∞„É≠„Éº„Éê„É´„Å´ÊòéÁ§∫ÁöÑ„Å´ÂÖ¨Èñã
function deleteMoney(id) {
    if (!confirm('„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
        return;
    }
    
    window.moneyRecords = window.moneyRecords.filter(r => r.id !== id);
    localStorage.setItem('moneyRecords', JSON.stringify(window.moneyRecords));
    renderMoneyLogs();
    showStatus('moneyStatus', '‚úì Ë®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
}

window.deleteMoney = deleteMoney; // „Ç∞„É≠„Éº„Éê„É´„Å´ÊòéÁ§∫ÁöÑ„Å´ÂÖ¨Èñã
function formatDateTimeLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}
function editActivity(id) {
    const activity = activities.find(a => a.id === id);
    if (!activity) return;
    
    window.editingActivityId = id;
    
    // „Ç´„ÉÜ„Ç¥„É™„Çª„É¨„ÇØ„Éà„ÇíÁîüÊàê
    const categorySelect = document.getElementById('editActivityCategory');
    categorySelect.innerHTML = activityCategories.map((cat, idx) => 
        `<option value="${idx}" ${activity.category === cat.name ? 'selected' : ''}>
            ${cat.emoji} ${cat.name}
        </option>`
    ).join('');
    
    // ÂÜÖÂÆπ„Çí„Çª„ÉÉ„Éà
    document.getElementById('editActivityText').value = activity.text;
    
    // ÈñãÂßãÊôÇÂàª„Çí„Çª„ÉÉ„Éà
    const startTime = new Date(activity.startTime || activity.timestamp);
    document.getElementById('editActivityStartTime').value = formatDateTimeLocal(startTime);
    
    // ÁµÇ‰∫ÜÊôÇÂàª„Çí„Çª„ÉÉ„Éà
    if (activity.endTime) {
        const endTime = new Date(activity.endTime);
        document.getElementById('editActivityEndTime').value = formatDateTimeLocal(endTime);
    } else {
        document.getElementById('editActivityEndTime').value = '';
    }
    
    // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
    document.getElementById('editActivityModal').style.display = 'flex';
    
    // ÊâÄË¶ÅÊôÇÈñì„ÇíÊõ¥Êñ∞
    updateDurationDisplay();
}

// Êó•ÊôÇ„Çídatetime-localÂΩ¢Âºè„Å´Â§âÊèõ
function formatDateTimeLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}

// Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
function closeEditActivityModal() {
    document.getElementById('editActivityModal').style.display = 'none';
    window.editingActivityId = null;
}

// Á∑®ÈõÜ„Çí‰øùÂ≠ò
function saveEditActivity() {
    const activity = activities.find(a => a.id === window.editingActivityId);
    if (!activity) return;
    
    const text = document.getElementById('editActivityText').value.trim();
    const startTime = document.getElementById('editActivityStartTime').value;
    const endTime = document.getElementById('editActivityEndTime').value;
    const categoryIdx = parseInt(document.getElementById('editActivityCategory').value);
    
    if (!text) {
        alert('‚ùå ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    if (!startTime) {
        alert('‚ùå ÈñãÂßãÊôÇÂàª„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    // „Éá„Éº„Çø„ÇíÊõ¥Êñ∞
    activity.text = text;
    activity.category = activityCategories[categoryIdx].name;
    activity.categoryEmoji = activityCategories[categoryIdx].emoji;
    activity.startTime = new Date(startTime).toISOString();
    activity.timestamp = new Date(startTime).toISOString();
    
    if (endTime) {
        activity.endTime = new Date(endTime).toISOString();
        const duration = (new Date(endTime) - new Date(startTime)) / 1000 / 60;
        activity.durationMinutes = Math.max(0, Math.round(duration));
    } else {
        activity.endTime = null;
        activity.durationMinutes = 0;
    }
    
    // ‰øùÂ≠ò
    localStorage.setItem('activities', JSON.stringify(activities));
    
    // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    closeEditActivityModal();
    
    // ÂÜç„É¨„É≥„ÉÄ„É™„É≥„Ç∞
    renderActivityLogs();
    
    alert('‚úì ‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
}

// ÈñãÂßãÊôÇÂàª„Å´ÁèæÂú®ÊôÇÂàª„Çí„Çª„ÉÉ„Éà
function setCurrentTimeToStart() {
    const now = new Date();
    document.getElementById('editActivityStartTime').value = formatDateTimeLocal(now);
    updateDurationDisplay();
}

// ÁµÇ‰∫ÜÊôÇÂàª„Å´ÁèæÂú®ÊôÇÂàª„Çí„Çª„ÉÉ„Éà
function setCurrentTimeToEnd() {
    const now = new Date();
    document.getElementById('editActivityEndTime').value = formatDateTimeLocal(now);
    updateDurationDisplay();
}

// ÁµÇ‰∫ÜÊôÇÂàª„ÇíË™øÊï¥
function adjustEndTime(minutes) {
    const endTimeInput = document.getElementById('editActivityEndTime');
    let endTime;
    
    if (endTimeInput.value) {
        endTime = new Date(endTimeInput.value);
    } else {
        const startTime = new Date(document.getElementById('editActivityStartTime').value);
        endTime = new Date(startTime.getTime());
    }
    
    endTime.setMinutes(endTime.getMinutes() + minutes);
    endTimeInput.value = formatDateTimeLocal(endTime);
    
    updateDurationDisplay();
}

// ÊâÄË¶ÅÊôÇÈñì„ÇíÊõ¥Êñ∞
function updateDurationDisplay() {
    const startTime = document.getElementById('editActivityStartTime').value;
    const endTime = document.getElementById('editActivityEndTime').value;
    const durationSpan = document.getElementById('calculatedDuration');
    
    if (!startTime) {
        durationSpan.textContent = '--';
        return;
    }
    
    if (!endTime) {
        durationSpan.textContent = 'Á∂ôÁ∂ö‰∏≠';
        return;
    }
    
    const start = new Date(startTime);
    const end = new Date(endTime);
    const durationMinutes = Math.round((end - start) / 1000 / 60);
    
    if (durationMinutes < 0) {
        durationSpan.textContent = '‚ö†Ô∏è ÁµÇ‰∫ÜÊôÇÂàª„ÅåÈñãÂßãÊôÇÂàª„Çà„ÇäÂâç„Åß„Åô';
        durationSpan.style.color = 'red';
    } else {
        const hours = Math.floor(durationMinutes / 60);
        const minutes = durationMinutes % 60;
        
        if (hours > 0) {
            durationSpan.textContent = `${hours}ÊôÇÈñì${minutes}ÂàÜ`;
        } else {
            durationSpan.textContent = `${minutes}ÂàÜ`;
        }
        durationSpan.style.color = '#000';
    }
}

// ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
document.addEventListener('DOMContentLoaded', () => {
    const startTimeInput = document.getElementById('editActivityStartTime');
    const endTimeInput = document.getElementById('editActivityEndTime');
    
    if (startTimeInput) startTimeInput.addEventListener('input', updateDurationDisplay);
    if (endTimeInput) endTimeInput.addEventListener('input', updateDurationDisplay);
});
        function deleteActivity(id) {
            if (confirm('„Åì„ÅÆË°åÂãï„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                activities = activities.filter(a => a.id !== id);
                localStorage.setItem('activities', JSON.stringify(activities));
                renderActivityLogs();
            }
        }
        
        // „É≠„Ç∞Ë°®Á§∫Ôºö„ÅäÈáë
function renderMoneyLogs() {
    console.log("üîç renderMoneyLogs „Éá„Éê„ÉÉ„Ç∞");
    const moneyRecords = window.moneyRecords || [];
    console.log("moneyRecords ÂÖ®‰ª∂Êï∞:", moneyRecords.length);
    console.log("‰ªäÊó•„ÅÆÊó•‰ªò:", new Date().toLocaleDateString('ja-JP'));
    const todayRecords = moneyRecords.filter(m => new Date(m.timestamp).toLocaleDateString('ja-JP') === new Date().toLocaleDateString('ja-JP'));
    console.log("‰ªäÊó•„ÅÆË®òÈå≤:", todayRecords);
    const container = document.getElementById('moneyLogs');
    const today = new Date().toLocaleDateString('ja-JP');
    const todayMoney = moneyRecords.filter(m => 
        new Date(m.timestamp).toLocaleDateString('ja-JP') === today
    );
    
    if (todayMoney.length === 0) {
        container.innerHTML = '<div class="log-item">Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        return;
    }
    
    const total = todayMoney.reduce((sum, r) => sum + r.amount, 0);
    
    container.innerHTML = `
        <div class="log-item" style="background: ${total >= 0 ? '#f0f8ff' : '#fff5f5'};">
            <strong>‰ªäÊó•„ÅÆÂèéÊîØ: ¬•${total.toLocaleString()}</strong>
        </div>
    ` + todayMoney.map(record => {
        const categoryText = record.categoryEmoji ? 
            `${record.categoryEmoji} ${record.category}` : 
            (record.category || '');
        
        return `
            <div class="log-item">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <strong>${record.text || 'Ôºà„É°„É¢„Å™„ÅóÔºâ'}</strong> - ¬•${record.amount.toLocaleString()}
                        ${categoryText ? `<br><span class="category-badge">${categoryText}</span>` : ''}
                        <br>
                        <small>${new Date(record.timestamp).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</small>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn-icon" onclick="editMoney(${record.id})" title="Á∑®ÈõÜ">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="deleteMoney(${record.id})" title="ÂâäÈô§">üóëÔ∏è</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}
        
        // „É≠„Ç∞Ë°®Á§∫Ôºö‰ΩìÈáç
        function renderWeightLogs() {
            const container = document.getElementById('weightLogs');
            if (weightRecords.length === 0) {
                container.innerHTML = '<div class="log-item">Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            const recent = weightRecords.slice(0, 10);
            container.innerHTML = recent.map(record => `
                <div class="log-item">
                    <strong>${record.weight} kg</strong>
                    <br>
                    <small>${new Date(record.timestamp).toLocaleString('ja-JP', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'})}</small>
                </div>
            `).join('');
        }
        
        // „É≠„Ç∞Ë°®Á§∫Ôºö„Ç∏„É£„Éº„Éä„É´
// ÊîπÂñÑÁâà„Ç∏„É£„Éº„Éä„É´„É≠„Ç∞Ë°®Á§∫
function renderJournalLogs() {
    const container = document.getElementById('journalLogs');
    const journals = JSON.parse(localStorage.getItem('journals') || '[]');
    
    if (journals.length === 0) {
        container.innerHTML = '<div class="log-item">Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        return;
    }
    
    const recent = journals.slice(0, 10);
    container.innerHTML = recent.map(record => {
        const date = new Date(record.timestamp);
        const dateStr = date.toLocaleDateString('ja-JP', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'short'
        });
        
        // Ê∞óÂàÜ„ÅÆÁµµÊñáÂ≠ó
        const moodEmojis = {
            'great': 'üòä',
            'good': 'üôÇ',
            'normal': 'üòê',
            'bad': 'üòî',
            'terrible': 'üò¢'
        };
        const moodEmoji = moodEmojis[record.mood] || 'üòê';
        
        // AIÂàÜÊûêÁµêÊûú„Çí‰ΩøÁî®Ôºà„Åæ„Åü„ÅØÁ©∫„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ
        const summary = record.aiAnalysis || { good: [], more: [], worry: [], task: [] };
        
        // Ë¶ÅÁ¥Ñ„ÅåÁ©∫„Åß„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        const hasGood = summary.good && summary.good.length > 0;
        const hasMore = summary.more && summary.more.length > 0;
        const hasWorry = summary.worry && summary.worry.length > 0;
        const hasTask = summary.task && summary.task.length > 0;
        
        const hasSummary = hasGood || hasMore || hasWorry || hasTask;
        
        return `
            <div class="journal-log-item">
                <div class="journal-log-header" onclick="toggleJournalDetail('journal-${record.id}')">
                    <div class="journal-date">
                        ${moodEmoji} ${dateStr}
                    </div>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                
                ${hasSummary ? `
                <div class="journal-summary-preview">
                    ${hasGood ? `
                        <div class="summary-preview-item">
                            <span class="summary-label-mini">üòä Good</span>
                            <div class="summary-items">
                                ${summary.good.slice(0, 2).map(item => 
                                    `<div class="summary-bullet">‚Ä¢ ${item}</div>`
                                ).join('')}
                                ${summary.good.length > 2 ? 
                                    `<div class="summary-more">‰ªñ${summary.good.length - 2}‰ª∂</div>` 
                                    : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${hasWorry ? `
                        <div class="summary-preview-item">
                            <span class="summary-label-mini">ü§î ÊÇ©„Åø</span>
                            <div class="summary-items">
                                ${summary.worry.slice(0, 2).map(item => 
                                    `<div class="summary-bullet">‚Ä¢ ${item}</div>`
                                ).join('')}
                                ${summary.worry.length > 2 ? 
                                    `<div class="summary-more">‰ªñ${summary.worry.length - 2}‰ª∂</div>` 
                                    : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${hasTask ? `
                        <div class="summary-preview-item">
                            <span class="summary-label-mini">‚úÖ „Çø„Çπ„ÇØ</span>
                            <div class="summary-items">
                                ${summary.task.slice(0, 2).map(item => 
                                    `<div class="summary-bullet">‚Ä¢ ${item}</div>`
                                ).join('')}
                                ${summary.task.length > 2 ? 
                                    `<div class="summary-more">‰ªñ${summary.task.length - 2}‰ª∂</div>` 
                                    : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
                ` : ''}
                
                <div id="journal-${record.id}" class="journal-detail">
                    <div class="journal-full-text">
                        <strong>üìÑ ÂÖ®Êñá:</strong>
                        <div style="white-space: pre-wrap; margin-top: 10px; line-height: 1.6;">
                            ${record.text || 'Ôºà„É°„É¢„Å™„ÅóÔºâ'}
                        </div>
                    </div>
                    
                    ${hasSummary ? `
                    <div class="journal-full-summary">
                        <strong>üìù Ë©≥Á¥∞„Å™Ë¶ÅÁ¥Ñ:</strong>
                        
                        ${hasGood ? `
                            <div class="summary-detail-section">
                                <div class="summary-detail-label">üòä GoodÔºàËâØ„Åã„Å£„Åü„Åì„Å®Ôºâ</div>
                                ${summary.good.map(item => 
                                    `<div class="summary-detail-item">‚Ä¢ ${item}</div>`
                                ).join('')}
                            </div>
                        ` : ''}
                        
                        ${hasMore ? `
                            <div class="summary-detail-section">
                                <div class="summary-detail-label">üìà MoreÔºà„ÇÇ„Å£„Å®ËâØ„Åè„Åß„Åç„Çã„Åì„Å®Ôºâ</div>
                                ${summary.more.map(item => 
                                    `<div class="summary-detail-item">‚Ä¢ ${item}</div>`
                                ).join('')}
                            </div>
                        ` : ''}
                        
                        ${hasWorry ? `
                            <div class="summary-detail-section">
                                <div class="summary-detail-label">ü§î ÊÇ©„Çì„Åß„ÅÑ„Çã„Åì„Å®</div>
                                ${summary.worry.map(item => 
                                    `<div class="summary-detail-item">‚Ä¢ ${item}</div>`
                                ).join('')}
                            </div>
                        ` : ''}
                        
                        ${hasTask ? `
                            <div class="summary-detail-section">
                                <div class="summary-detail-label">‚úÖ ÊòéÊó•„ÅÆ„Çø„Çπ„ÇØ</div>
                                ${summary.task.map(item => 
                                    `<div class="summary-detail-item">‚Ä¢ ${item}</div>`
                                ).join('')}
                            </div>
                        ` : ''}
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function toggleJournalDetail(id) {
    const element = document.getElementById(id);
    const parent = element.closest('.journal-log-item');
    const icon = parent.querySelector('.toggle-icon');
    
    if (element.classList.contains('show')) {
        element.classList.remove('show');
        icon.textContent = '‚ñº';
    } else {
        element.classList.add('show');
        icon.textContent = '‚ñ≤';
    }
}
        
        // „Ç´„É¨„É≥„ÉÄ„ÉºË°®Á§∫
// „É™„ÉÉ„ÉÅ„É¨„Éù„Éº„ÉàÊ©üËÉΩ

// ÂàùÊúüÂåñ: ‰ªäÊúà„Çí„Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö
function initializeReportMonths() {
    const now = new Date();
    const currentMonth = monthKeyFromDate(now); // YYYY-MM
    document.getElementById('activityReportMonthDisplay').value = currentMonth;
    document.getElementById('moneyReportMonthDisplay').value = currentMonth;
}

// Ë°åÂãï„É¨„Éù„Éº„ÉàÁîüÊàê
function generateActivityReport() {
    const month = document.getElementById('activityReportMonthDisplay').value;
    if (!month) {
        alert('ÊúüÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    const [year, monthNum] = month.split('-');
    const startDate = new Date(year, monthNum - 1, 1);
    const endDate = new Date(year, monthNum, 0, 23, 59, 59);
    
    // ÊúüÈñìÂÜÖ„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Çí„Éï„Ç£„É´„Çø„Éº
    const filteredActivities = activities.filter(a => {
        const actDate = new Date(a.timestamp);
        return actDate >= startDate && actDate <= endDate;
    });
    
    if (filteredActivities.length === 0) {
        document.getElementById('activityReportContent').innerHTML = '<p style="text-align:center; color:#999;">„Åì„ÅÆÊúüÈñì„Å´Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
        document.getElementById('activityChartCanvas').style.display = 'none';
        return;
    }
    
    // „Ç´„ÉÜ„Ç¥„É™Âà•„Å´ÈõÜË®à
    const categoryData = {};
    
    filteredActivities.forEach(activity => {
        const cat = activity.category || 'Êú™ÂàÜÈ°û';
        const emoji = activity.categoryEmoji || 'üìã';
        
        if (!categoryData[cat]) {
            categoryData[cat] = {
                emoji: emoji,
                totalMinutes: 0,
                count: 0,
                details: []
            };
        }
        
        // ÊâÄË¶ÅÊôÇÈñìË®àÁÆó
        let minutes = 0;
        if (activity.endTime && activity.startTime) {
            const start = new Date(activity.startTime);
            const end = new Date(activity.endTime);
            minutes = Math.round((end - start) / 60000);
        }
        
        categoryData[cat].totalMinutes += minutes;
        categoryData[cat].count += 1;
        categoryData[cat].details.push({
            text: activity.text,
            startTime: activity.startTime,
            endTime: activity.endTime,
            minutes: minutes
        });
    });
    
    // HTMLÁîüÊàê
    let html = '';
    let totalMinutes = 0;
    let totalCount = 0;
    
    const sortedCategories = Object.keys(categoryData).sort((a, b) => 
        categoryData[b].totalMinutes - categoryData[a].totalMinutes
    );
    
    sortedCategories.forEach(cat => {
        const data = categoryData[cat];
        const hours = Math.floor(data.totalMinutes / 60);
        const mins = data.totalMinutes % 60;
        
        totalMinutes += data.totalMinutes;
        totalCount += data.count;
        
        html += `
            <div class="category-summary" onclick="toggleCategoryDetail('activity-${cat}')">
                <div class="category-header">
                    <span>${data.emoji} ${cat}</span>
                    <span>‚ñº</span>
                </div>
                <div class="category-stats">
                    <span>‚è±Ô∏è ${hours}ÊôÇÈñì${mins}ÂàÜ</span>
                    <span>üìù ${data.count}Âõû</span>
                </div>
                <div id="activity-${cat}" class="category-details">
                    ${data.details.sort((a, b) => new Date(b.startTime) - new Date(a.startTime)).map(detail => {
                        const start = detail.startTime ? new Date(detail.startTime).toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-';
                        const end = detail.endTime ? new Date(detail.endTime).toLocaleString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : 'Á∂ôÁ∂ö‰∏≠';
                        const durationText = detail.endTime ? `${Math.floor(detail.minutes / 60)}ÊôÇÈñì${detail.minutes % 60}ÂàÜ` : 'Á∂ôÁ∂ö‰∏≠';
                        
                        return `
                            <div class="detail-item">
                                <strong>${detail.text}</strong>
                                <div>${start} „Äú ${end} (${durationText})</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    });
    
    const totalHours = Math.floor(totalMinutes / 60);
    const totalMins = totalMinutes % 60;
    
    html = `
        <div class="total-summary">
            üìä ÂêàË®à: ${totalHours}ÊôÇÈñì${totalMins}ÂàÜ / ${totalCount}Âõû„ÅÆË®òÈå≤
        </div>
    ` + html;
    
    document.getElementById('activityReportContent').innerHTML = html;
    
    // „Ç∞„É©„ÉïÊèèÁîª
    drawActivityChart(categoryData);
}

// „ÅäÈáë„É¨„Éù„Éº„ÉàÁîüÊàê
// ‰ªäÊúà„ÅÆÁõÆÊ®ôÊ©üËÉΩ
let monthlyGoals = (() => { try { const v = JSON.parse(localStorage.getItem('monthlyGoals') || '[]'); return Array.isArray(v) ? v : []; } catch(e){ console.warn('monthlyGoals parse failed', e); return []; } })();


// ÁõÆÊ®ô„ÅÆÊúàÈÅ∏ÊäûÊ©üËÉΩ
const goalsCurrentMonth = monthKeyFromDate(new Date()); // YYYY-MM
var selectedGoalsMonth = goalsCurrentMonth;

function changeGoalsMonth(offset) {
    const [year, month] = selectedGoalsMonth.split('-').map(Number);
    const date = new Date(year, month - 1 + offset, 1);
    selectedGoalsMonth = monthKeyFromDate(date);
    
    updateGoalsMonthDisplay();
    renderGoals();
    renderGoalsProgress();
}

function updateGoalsMonthDisplay() {
    const [year, month] = selectedGoalsMonth.split('-').map(Number);
    const monthNames = ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', 
                        '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'];
    
    const display = document.getElementById('currentGoalsMonth');
    display.textContent = `${year}Âπ¥${monthNames[month - 1]}`;
    
    // Month filtering now uses selectedGoalsMonth
    const title = document.getElementById('goalsListTitle');
    if (selectedGoalsMonth === goalsCurrentMonth) {
        title.textContent = '‰ªäÊúà„ÅÆÁõÆÊ®ô„É™„Çπ„Éà';
    } else {
        title.textContent = `${year}Âπ¥${monthNames[month - 1]}„ÅÆÁõÆÊ®ô„É™„Çπ„Éà`;
    }
}
function addGoal() {
    const input = document.getElementById('goalInput');
    const categorySelect = document.getElementById('goalCategory');
    const text = input.value.trim();
    const category = categorySelect.value;
    
    if (!text) {
        showStatus('goalStatus', '‚ùå ÁõÆÊ®ô„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    const goal = {
        id: Date.now(),
        text: text || '',
        category: category,
        createdAt: new Date().toISOString(),
        month: (selectedGoalsMonth || goalsCurrentMonth), // YYYY-MMÔºàË°®Á§∫‰∏≠„ÅÆÊúà„Å´ËøΩÂä†Ôºâ
        completed: false
    };
    
    monthlyGoals.unshift(goal);
    localStorage.setItem('monthlyGoals', JSON.stringify(monthlyGoals));
    
    input.value = '';
    renderGoals();
    showStatus('goalStatus', '‚úì ÁõÆÊ®ô„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
}

function toggleGoalComplete(id) {
    const goal = monthlyGoals.find(g => g.id === id);
    if (goal) {
        goal.completed = !goal.completed;
        localStorage.setItem('monthlyGoals', JSON.stringify(monthlyGoals));
        renderGoals();
        generateGoalsFeedback();
    }
}

function deleteGoal(id) {
    if (!confirm('„Åì„ÅÆÁõÆÊ®ô„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
    
    monthlyGoals = monthlyGoals.filter(g => g.id !== id);
    localStorage.setItem('monthlyGoals', JSON.stringify(monthlyGoals));
    renderGoals();
    showStatus('goalStatus', '‚úì ÁõÆÊ®ô„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
}

function renderGoals() {
    const container = document.getElementById('goalsList');
    const currentGoals = monthlyGoals.filter(g => g.month === selectedGoalsMonth);
    
    if (currentGoals.length === 0) {
        const isCurrentMonth = selectedGoalsMonth === goalsCurrentMonth;
        container.innerHTML = `<div class="empty-state">${isCurrentMonth ? '‰ªäÊúà' : 'ÈÅ∏Êäû„Åó„ÅüÊúà'}„ÅÆÁõÆÊ®ô„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>`;
        renderGoalsProgress();
        return;
    }
    
    container.innerHTML = currentGoals.map(goal => {
        const categoryEmoji = {
            'ÂÅ•Â∫∑': 'üí™', '‰ªï‰∫ã': 'üíº', 'ÂãâÂº∑': 'üìö',
            'Ë∂£Âë≥': 'üé®', '‰∫∫ÈñìÈñ¢‰øÇ': 'üë•', '„ÅäÈáë': 'üí∞', '„Åù„ÅÆ‰ªñ': 'üìå'
        }[goal.category] || 'üìå';
        
        return `
            <div class="goal-item ${goal.completed ? 'completed' : ''}">
                <div class="goal-header">
                    <input type="checkbox" 
                           ${goal.completed ? 'checked' : ''} 
                           onchange="toggleGoalComplete(${goal.id})"
                           class="goal-checkbox" />
                    <span class="goal-text">${goal.text}</span>
                </div>
                <div class="goal-meta">
                    <span class="goal-category">${categoryEmoji} ${goal.category}</span>
                    <button class="btn-icon" onclick="deleteGoal(${goal.id})" title="ÂâäÈô§">üóëÔ∏è</button>
                </div>
            </div>
        `;
    }).join('');
    
    renderGoalsProgress();
}

function renderGoalsProgress() {
    const container = document.getElementById('goalsProgress');
    const currentGoals = monthlyGoals.filter(g => g.month === selectedGoalsMonth);
    
    if (currentGoals.length === 0) {
        container.innerHTML = '<div class="empty-state">ÁõÆÊ®ô„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
        return;
    }
    
    const completed = currentGoals.filter(g => g.completed).length;
    const total = currentGoals.length;
    const percentage = Math.round((completed / total) * 100);
    
    // „Ç´„ÉÜ„Ç¥„É™Âà•„ÅÆÈÅîÊàêÁä∂Ê≥Å
    const categoryStats = {};
    currentGoals.forEach(goal => {
        if (!categoryStats[goal.category]) {
            categoryStats[goal.category] = { total: 0, completed: 0 };
        }
        categoryStats[goal.category].total++;
        if (goal.completed) {
            categoryStats[goal.category].completed++;
        }
    });
    
    let html = `
        <div class="progress-summary">
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${percentage}%"></div>
            </div>
            <div class="progress-text">
                ${completed} / ${total} ÈÅîÊàê (${percentage}%)
            </div>
        </div>
        
        <div class="category-progress">
            <h4>„Ç´„ÉÜ„Ç¥„É™Âà•ÈÅîÊàêÁä∂Ê≥Å</h4>
            ${Object.entries(categoryStats).map(([category, stats]) => {
                const catEmoji = {
                    'ÂÅ•Â∫∑': 'üí™', '‰ªï‰∫ã': 'üíº', 'ÂãâÂº∑': 'üìö',
                    'Ë∂£Âë≥': 'üé®', '‰∫∫ÈñìÈñ¢‰øÇ': 'üë•', '„ÅäÈáë': 'üí∞', '„Åù„ÅÆ‰ªñ': 'üìå'
                }[category] || 'üìå';
                const catPercentage = Math.round((stats.completed / stats.total) * 100);
                
                return `
                    <div class="category-stat">
                        <span>${catEmoji} ${category}</span>
                        <span>${stats.completed}/${stats.total} (${catPercentage}%)</span>
                    </div>
                `;
            }).join('')}
        </div>
    `;
    
    container.innerHTML = html;
}

function generateGoalsFeedback() {
    // Month filtering now uses selectedGoalsMonth
    const currentGoals = monthlyGoals.filter(g => g.month === selectedGoalsMonth);
    
    if (currentGoals.length === 0) {
        document.getElementById('goalsFeedback').innerHTML = 
            '<p>ÁõÆÊ®ô„ÇíË®≠ÂÆö„Åô„Çã„Å®„ÄÅAI„Åå„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÊèê‰æõ„Åó„Åæ„Åô„ÄÇ</p>';
        return;
    }
    
    // ‰ªäÊúà„ÅÆË°åÂãïË®òÈå≤„ÇíÂèñÂæó
    const [year, month] = currentMonth.split('-');
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0, 23, 59, 59);
    
    const monthActivities = activities.filter(a => {
        const actDate = new Date(a.timestamp);
        return actDate >= startDate && actDate <= endDate;
    });
    
    // ‰ªäÊúà„ÅÆ„Ç∏„É£„Éº„Éä„É´„ÇíÂèñÂæó
    const monthJournals = journals.filter(j => {
        const jDate = new Date(j.timestamp);
        return jDate >= startDate && jDate <= endDate;
    });
    
    // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÁîüÊàê
    let feedback = '<div class="feedback-content">';
    
    // ÂÖ®‰ΩìÁöÑ„Å™ÈÅîÊàêÂ∫¶
    const completed = currentGoals.filter(g => g.completed).length;
    const total = currentGoals.length;
    const percentage = Math.round((completed / total) * 100);
    
    if (percentage >= 80) {
        feedback += `<p>üéâ <strong>Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅ</strong> ${percentage}%„ÅÆÁõÆÊ®ô„ÇíÈÅîÊàê„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åì„ÅÆË™øÂ≠ê„ÅßÈ†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ</p>`;
    } else if (percentage >= 50) {
        feedback += `<p>üëç <strong>ËâØ„ÅÑ„Éö„Éº„Çπ„Åß„ÅôÔºÅ</strong> ${percentage}%„ÅÆÁõÆÊ®ô„ÇíÈÅîÊàêÊ∏à„Åø„ÄÇÊÆã„Çä„ÅÆÁõÆÊ®ô„ÇÇÈÅîÊàê„Åß„Åç„Çã„Çà„ÅÜÈ†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ</p>`;
    } else if (percentage >= 20) {
        feedback += `<p>üí™ <strong>„Åæ„Å†ÊôÇÈñì„Åå„ÅÇ„Çä„Åæ„ÅôÔºÅ</strong> ${percentage}%„ÅÆÈÅîÊàêÁéá„ÄÇÊÆã„Çä„ÅÆÊó•Êï∞„ÅßÁõÆÊ®ôÈÅîÊàê„ÇíÁõÆÊåá„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ</p>`;
    } else {
        feedback += `<p>‚ö†Ô∏è <strong>„Éö„Éº„Çπ„Ç¢„ÉÉ„Éó„ÅåÂøÖË¶Å„Åß„Åô</strong> ÁèæÂú®„ÅÆÈÅîÊàêÁéá„ÅØ${percentage}%„Åß„Åô„ÄÇÁõÆÊ®ô„ÇíË¶ãÁõ¥„Åô„Åã„ÄÅË°åÂãï„ÇíÂ¢ó„ÇÑ„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ</p>`;
    }
    
    // „Ç´„ÉÜ„Ç¥„É™Âà•„ÅÆÂàÜÊûê
    currentGoals.forEach(goal => {
        if (goal.completed) return;
        
        const relatedActivities = monthActivities.filter(a => 
            a.category === goal.category || 
            a.text.toLowerCase().includes(goal.text.toLowerCase().split(' ')[0])
        );
        
        const relatedJournals = monthJournals.filter(j =>
            j.text.toLowerCase().includes(goal.text.toLowerCase().split(' ')[0]) ||
            j.text.toLowerCase().includes(goal.category.toLowerCase())
        );
        
        if (relatedActivities.length > 0) {
            feedback += `<p>üìä <strong>${goal.category}„ÅÆÁõÆÊ®ô„Äå${goal.text}„Äç</strong><br>`;
            feedback += `‰ªäÊúà${relatedActivities.length}Âõû„ÅÆÈñ¢ÈÄ£„Åô„ÇãË°åÂãï„ÇíË®òÈå≤„Åó„Åæ„Åó„Åü„ÄÇÁ∂ôÁ∂ö„Åó„Å¶Âèñ„ÇäÁµÑ„Çì„Åß„ÅÑ„Åæ„Åô„Å≠ÔºÅ</p>`;
        } else if (relatedJournals.length > 0) {
            feedback += `<p>üìù <strong>${goal.category}„ÅÆÁõÆÊ®ô„Äå${goal.text}„Äç</strong><br>`;
            feedback += `„Ç∏„É£„Éº„Éä„É´„Å´${relatedJournals.length}ÂõûË®ÄÂèä„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÂÆüÈöõ„ÅÆË°åÂãï„Å´Áßª„Åõ„Çã„Å®„Åï„Çâ„Å´ËâØ„ÅÑ„Åß„Åó„Çá„ÅÜ„ÄÇ</p>`;
        } else {
            feedback += `<p>üí° <strong>${goal.category}„ÅÆÁõÆÊ®ô„Äå${goal.text}„Äç</strong><br>`;
            feedback += `„Åæ„Å†Èñ¢ÈÄ£„Åô„ÇãË°åÂãï„ÇÑ„Ç∏„É£„Éº„Éä„É´„ÅÆË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ‰ªäÊó•„Åã„ÇâÂßã„ÇÅ„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ</p>`;
        }
    });
    
    // „Éù„Ç∏„ÉÜ„Ç£„Éñ„Å™„Ç∏„É£„Éº„Éä„É´ÂàÜÊûê
    const positiveJournals = monthJournals.filter(j => 
        j.mood && ['ÊúÄÈ´ò', 'ËâØ„ÅÑ'].includes(j.mood)
    );
    
    if (positiveJournals.length > 0) {
        feedback += `<p>üòä <strong>„É°„É≥„Çø„É´Èù¢</strong><br>`;
        feedback += `‰ªäÊúà${positiveJournals.length}Êó•„ÄÅËâØ„ÅÑÊ∞óÂàÜ„ÅÆÊó•„Åå„ÅÇ„Çä„Åæ„Åó„Åü„ÄÇ„Éù„Ç∏„ÉÜ„Ç£„Éñ„Å™Áä∂ÊÖã„Çí‰øù„Å¶„Å¶„ÅÑ„Åæ„Åô„Å≠ÔºÅ</p>`;
    }
    
    // ÊîπÂñÑÊèêÊ°à
    const incompleteGoals = currentGoals.filter(g => !g.completed);
    if (incompleteGoals.length > 0) {
        feedback += `<p>üí™ <strong>‰ªäÂæå„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥ÊèêÊ°à</strong><br><ul style="margin-top: 10px;">`;
        incompleteGoals.slice(0, 3).forEach(goal => {
            feedback += `<li>„Äå${goal.text}„Äç„ÅÆ„Åü„ÇÅ„Å´„ÄÅ‰ªäÊó•„Åã„ÇâÂÖ∑‰ΩìÁöÑ„Å™Ë°åÂãï„Çí1„Å§Âßã„ÇÅ„Åæ„Åó„Çá„ÅÜ</li>`;
        });
        feedback += `</ul></p>`;
    }
    
    feedback += '</div>';
    
    document.getElementById('goalsFeedback').innerHTML = feedback;
}
function generateMoneyReport() {
    const month = document.getElementById('moneyReportMonthDisplay').value;
    if (!month) {
        alert('ÊúüÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    const [year, monthNum] = month.split('-');
    const startDate = new Date(year, monthNum - 1, 1);
    const endDate = new Date(year, monthNum, 0, 23, 59, 59);
    
    // ÊúüÈñìÂÜÖ„ÅÆË®òÈå≤„Çí„Éï„Ç£„É´„Çø„Éº
    const filteredRecords = (window.moneyRecords || []).filter(r => {
        const recDate = new Date(r.timestamp);
        return recDate >= startDate && recDate <= endDate;
    });
    
    if (filteredRecords.length === 0) {
        document.getElementById('moneyReportContent').innerHTML = '<p style="text-align:center; color:#999;">„Åì„ÅÆÊúüÈñì„Å´Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
        document.getElementById('moneyChartCanvas').style.display = 'none';
        return;
    }
    
    // „Ç´„ÉÜ„Ç¥„É™Âà•„Å´ÈõÜË®à
    const categoryData = {};
    
    filteredRecords.forEach(record => {
        const cat = record.category || 'Êú™ÂàÜÈ°û';
        const emoji = record.categoryEmoji || 'üí∞';
        
        if (!categoryData[cat]) {
            categoryData[cat] = {
                emoji: emoji,
                totalIncome: 0,
                totalExpense: 0,
                count: 0,
                details: []
            };
        }
        
        if (record.amount > 0) {
            categoryData[cat].totalIncome += record.amount;
        } else {
            categoryData[cat].totalExpense += Math.abs(record.amount);
        }
        
        categoryData[cat].count += 1;
        categoryData[cat].details.push({
            text: record.text,
            amount: record.amount,
            timestamp: record.timestamp
        });
    });
    
    // HTMLÁîüÊàê
    let html = '';
    let totalIncome = 0;
    let totalExpense = 0;
    let totalCount = 0;
    
    const sortedCategories = Object.keys(categoryData).sort((a, b) => 
        categoryData[b].totalExpense - categoryData[a].totalExpense
    );
    
    sortedCategories.forEach(cat => {
        const data = categoryData[cat];
        
        totalIncome += data.totalIncome;
        totalExpense += data.totalExpense;
        totalCount += data.count;
        
        html += `
            <div class="category-summary" onclick="toggleCategoryDetail('money-${cat}')">
                <div class="category-header">
                    <span>${data.emoji} ${cat}</span>
                    <span>‚ñº</span>
                </div>
                <div class="category-stats">
                    ${data.totalIncome > 0 ? `<span style="color:green;">üí∞ ÂèéÂÖ• ¬•${data.totalIncome.toLocaleString()}</span>` : ''}
                    ${data.totalExpense > 0 ? `<span style="color:red;">üí∏ ÊîØÂá∫ ¬•${data.totalExpense.toLocaleString()}</span>` : ''}
                    <span>üìù ${data.count}Âõû</span>
                </div>
                <div id="money-${cat}" class="category-details">
                    ${data.details.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(detail => {
                        const date = new Date(detail.timestamp).toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        const amountText = detail.amount > 0 ? 
                            `<span style="color:green;">+¬•${detail.amount.toLocaleString()}</span>` : 
                            `<span style="color:red;">-¬•${Math.abs(detail.amount).toLocaleString()}</span>`;
                        
                        return `
                            <div class="detail-item">
                                <strong>${detail.text}</strong>
                                <div>${date} / ${amountText}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    });
    
    html = `
        <div class="total-summary">
            üí∞ ÂèéÂÖ•: ¬•${totalIncome.toLocaleString()} | üí∏ ÊîØÂá∫: ¬•${totalExpense.toLocaleString()} | üìä ${totalCount}Âõû„ÅÆË®òÈå≤
            <div style="margin-top:10px; font-size:1.2em;">
                ${totalIncome - totalExpense >= 0 ? 'üìà' : 'üìâ'} ÂèéÊîØ: ¬•${(totalIncome - totalExpense).toLocaleString()}
            </div>
        </div>
    ` + html;
    
    document.getElementById('moneyReportContent').innerHTML = html;
    
    // „Ç∞„É©„ÉïÊèèÁîª
    drawMoneyChart(categoryData);
}

// Ë©≥Á¥∞Ë°®Á§∫„Éà„Ç∞„É´
function toggleCategoryDetail(id) {
    const element = document.getElementById(id);
    if (element) {
        element.classList.toggle('show');
    }
}

// Ë°åÂãï„Ç∞„É©„ÉïÊèèÁîª
function drawActivityChart(categoryData) {
    const canvas = document.getElementById('activityChartCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.style.display = 'block';
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const categories = Object.keys(categoryData);
    if (categories.length === 0) return;
    
    const totalMinutes = categories.reduce((sum, cat) => sum + categoryData[cat].totalMinutes, 0);
    if (totalMinutes === 0) return;
    
    // ÂÜÜ„Ç∞„É©„ÉïÊèèÁîª
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = Math.min(centerX, centerY) - 40;
    
    const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
    ];
    
    let currentAngle = -Math.PI / 2;
    
    categories.forEach((cat, index) => {
        const data = categoryData[cat];
        const sliceAngle = (data.totalMinutes / totalMinutes) * 2 * Math.PI;
        
        // ÊâáÂΩ¢ÊèèÁîª
        ctx.fillStyle = colors[index % colors.length];
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fill();
        
        // „É©„Éô„É´
        const labelAngle = currentAngle + sliceAngle / 2;
        const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
        const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
        
        const hours = Math.floor(data.totalMinutes / 60);
        const mins = data.totalMinutes % 60;
        
        ctx.fillStyle = '#000';
        ctx.font = 'bold 12px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(`${data.emoji}`, labelX, labelY - 10);
        ctx.font = '11px sans-serif';
        ctx.fillText(`${hours}h${mins}m`, labelX, labelY + 10);
        
        currentAngle += sliceAngle;
    });
}

// „ÅäÈáë„Ç∞„É©„ÉïÊèèÁîª
function drawMoneyChart(categoryData) {
    const canvas = document.getElementById('moneyChartCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.style.display = 'block';
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const categories = Object.keys(categoryData);
    if (categories.length === 0) return;
    
    const totalExpense = categories.reduce((sum, cat) => sum + categoryData[cat].totalExpense, 0);
    if (totalExpense === 0) return;
    
    // ÂÜÜ„Ç∞„É©„ÉïÊèèÁîª
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = Math.min(centerX, centerY) - 40;
    
    const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
    ];
    
    let currentAngle = -Math.PI / 2;
    
    categories.forEach((cat, index) => {
        const data = categoryData[cat];
        if (data.totalExpense === 0) return;
        
        const sliceAngle = (data.totalExpense / totalExpense) * 2 * Math.PI;
        
        // ÊâáÂΩ¢ÊèèÁîª
        ctx.fillStyle = colors[index % colors.length];
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fill();
        
        // „É©„Éô„É´
        const labelAngle = currentAngle + sliceAngle / 2;
        const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
        const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
        
        ctx.fillStyle = '#000';
        ctx.font = 'bold 12px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(`${data.emoji}`, labelX, labelY - 10);
        ctx.font = '11px sans-serif';
        ctx.fillText(`¬•${Math.round(data.totalExpense / 1000)}k`, labelX, labelY + 10);
        
        currentAngle += sliceAngle;
    });
}
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            document.getElementById('calendarMonth').textContent = 
                `${year}Âπ¥ ${month + 1}Êúà`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            let html = '';
            ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'].forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            for (let date = 1; date <= lastDate; date++) {
                const currentDate = new Date(year, month, date);
                const dateStr = currentDate.toLocaleDateString('ja-JP');
                
                // „Åù„ÅÆÊó•„ÅÆ„Ç∏„É£„Éº„Éä„É´„ÇíÂèñÂæó
                const journal = journals.find(j => 
                    new Date(j.timestamp).toLocaleDateString('ja-JP') === dateStr
                );
                const hasJournal = !!journal;
                
                const isToday = 
                    today.getFullYear() === year &&
                    today.getMonth() === month &&
                    today.getDate() === date;
                
                let className = 'calendar-day';
                if (isToday) className += ' today';
                if (hasJournal) className += ' has-journal';
                
                // Ê∞óÂàÜÁµµÊñáÂ≠ó„ÇíËøΩÂä†
                let moodEmoji = '';
                if (journal && journal.mood) {
                    moodEmoji = `<div class="calendar-day-mood">${moodEmojis[journal.mood]}</div>`;
                }
                
                html += `<div class="${className}" onclick="viewJournalByDate('${dateStr}')">${date}${moodEmoji}</div>`;
            }
            
            document.getElementById('calendar').innerHTML = html;
        }
        
        function changeMonth(delta) {
            // ÊúàÁßªÂãïÊôÇ„ÅÆ„ÄåÊúàÈ£õ„Å≥„ÄçÈò≤Ê≠¢ÔºöÂøÖ„Åö1Êó•„Å´Âõ∫ÂÆö„Åó„Å¶„Åã„ÇâÁßªÂãï
            currentCalendarDate.setDate(1);
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }
        
        function viewJournalByDate(dateStr) {
            const journal = journals.find(j => 
                new Date(j.timestamp).toLocaleDateString('ja-JP') === dateStr
            );
            
            if (journal) {
                const moodText = journal.mood ? `\n\nÊ∞óÂàÜ: ${moodEmojis[journal.mood]}` : '';
                alert(`${dateStr}„ÅÆ„Ç∏„É£„Éº„Éä„É´:${moodText}\n\n${journal.text}`);
            } else {
                alert(`${dateStr}„Å´„ÅØ„Ç∏„É£„Éº„Éä„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ`);
            }
        }
        
        // „É¨„Éù„Éº„ÉàË°®Á§∫
        function renderReports() {
            // Áµ±Ë®à
            document.getElementById('totalActivities').textContent = activities.length;
            
            const totalMoney = moneyRecords.reduce((sum, r) => sum + r.amount, 0);
            document.getElementById('totalMoney').textContent = `¬•${totalMoney.toLocaleString()}`;
            
            document.getElementById('totalJournals').textContent = journals.length;
            
            if (weightRecords.length > 0) {
                const avgWeight = weightRecords.reduce((sum, r) => sum + r.weight, 0) / weightRecords.length;
                document.getElementById('avgWeight').textContent = avgWeight.toFixed(1) + ' kg';
            }
            
            // Ë°åÂãï„ÉÅ„É£„Éº„Éà
            renderOverviewActivityChart();
            
            // Ê∞óÂàÜ„ÉÅ„É£„Éº„Éà
            renderMoodChart();
            
            // „ÅäÈáë„ÉÅ„É£„Éº„Éà
            renderMoneyChartLegacy();
            
            // ‰ΩìÈáç„ÉÅ„É£„Éº„Éà
            renderWeightChart();
            
            // AI„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            renderAIFeedback();
        }
        
        function renderOverviewActivityChart() {
            const ctx = document.getElementById('activityChart');
            if (!ctx) return;
            
            const categoryCounts = {};
            activityCategories.forEach(cat => {
                categoryCounts[cat.name] = activities.filter(a => a.text.includes(cat.name)).length;
            });
            
            if (window.activityChartInstance) {
                window.activityChartInstance.destroy();
            }
            
            window.activityChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(categoryCounts),
                    datasets: [{
                        label: 'ÂõûÊï∞',
                        data: Object.values(categoryCounts),
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        borderColor: 'rgba(0, 0, 0, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        function renderMoodChart() {
            const ctx = document.getElementById('moodChart');
            if (!ctx) return;
            
            // Ê∞óÂàÜ„ÅÆ„Ç´„Ç¶„É≥„Éà
            const moodCounts = {
                great: 0,
                good: 0,
                normal: 0,
                bad: 0,
                terrible: 0
            };
            
            journals.forEach(j => {
                if (j.mood && moodCounts.hasOwnProperty(j.mood)) {
                    moodCounts[j.mood]++;
                }
            });
            
            const moodLabels = {
                great: 'üòä ÊúÄÈ´ò',
                good: 'üôÇ ËâØ„ÅÑ',
                normal: 'üòê ÊôÆÈÄö',
                bad: 'üòî ÊÇ™„ÅÑ',
                terrible: 'üò¢ ÊúÄÊÇ™'
            };
            
            if (window.moodChartInstance) {
                window.moodChartInstance.destroy();
            }
            
            window.moodChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(moodCounts).map(k => moodLabels[k]),
                    datasets: [{
                        data: Object.values(moodCounts),
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.8)',   // great - green
                            'rgba(139, 195, 74, 0.8)',  // good - light green
                            'rgba(158, 158, 158, 0.8)', // normal - grey
                            'rgba(255, 152, 0, 0.8)',   // bad - orange
                            'rgba(244, 67, 54, 0.8)'    // terrible - red
                        ],
                        borderColor: [
                            'rgba(76, 175, 80, 1)',
                            'rgba(139, 195, 74, 1)',
                            'rgba(158, 158, 158, 1)',
                            'rgba(255, 152, 0, 1)',
                            'rgba(244, 67, 54, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function renderMoneyChartLegacy() {
            const ctx = document.getElementById('moneyChart');
            if (!ctx) return;
            
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last7Days.push(date.toLocaleDateString('ja-JP', {month: 'short', day: 'numeric'}));
            }
            
            const data = last7Days.map(dateStr => {
                const dayRecords = moneyRecords.filter(r => {
                    const recordDate = new Date(r.timestamp).toLocaleDateString('ja-JP', {month: 'short', day: 'numeric'});
                    return recordDate === dateStr;
                });
                return dayRecords.reduce((sum, r) => sum + r.amount, 0);
            });
            
            if (window.moneyChartInstance) {
                window.moneyChartInstance.destroy();
            }
            
            window.moneyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'ÂèéÊîØÔºàÂÜÜÔºâ',
                        data: data,
                        borderColor: 'rgba(0, 0, 0, 1)',
                        backgroundColor: 'rgba(0, 0, 0, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }
        
        function renderWeightChart() {
            const ctx = document.getElementById('weightChart');
            if (!ctx) return;
            
            const recent = weightRecords.slice(0, 10).reverse();
            
            if (window.weightChartInstance) {
                window.weightChartInstance.destroy();
            }
            
            window.weightChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: recent.map(r => new Date(r.timestamp).toLocaleDateString('ja-JP', {month: 'short', day: 'numeric'})),
                    datasets: [{
                        label: '‰ΩìÈáçÔºàkgÔºâ',
                        data: recent.map(r => r.weight),
                        borderColor: 'rgba(0, 0, 0, 1)',
                        backgroundColor: 'rgba(0, 0, 0, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }
        
        
        // AI„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÁîüÊàê
        function renderAIFeedback() {
            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);
            
            const recentActivities = activities.filter(a => new Date(a.timestamp) >= sevenDaysAgo);
            const recentJournals = journals.filter(j => new Date(j.timestamp) >= sevenDaysAgo);
            const recentMoney = moneyRecords.filter(m => new Date(m.timestamp) >= sevenDaysAgo);
            
            const recordedDates = new Set();
            [...recentActivities, ...recentJournals, ...recentMoney].forEach(record => {
                const date = new Date(record.timestamp).toLocaleDateString('ja-JP');
                recordedDates.add(date);
            });
            
            const recordedDays = recordedDates.size;
            
            const categoryCounts = {};
            activityCategories.forEach(cat => {
                categoryCounts[cat.name] = recentActivities.filter(a => 
                    a.text.includes(cat.name)
                ).length;
            });
            
            const topCategories = Object.entries(categoryCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .filter(([, count]) => count > 0);
            
            // ÊôÇÈñìÁµ±Ë®à„ÇíËøΩÂä†
            const totalMinutes = recentActivities.reduce((sum, a) => sum + (a.durationMinutes || 0), 0);
            const totalHours = Math.floor(totalMinutes / 60);
            const remainingMinutes = totalMinutes % 60;
            
            // „Ç´„ÉÜ„Ç¥„É™Âà•„ÅÆÊôÇÈñìÁµ±Ë®à
            const categoryTimes = {};
            activityCategories.forEach(cat => {
                const categoryActivities = recentActivities.filter(a => a.text.includes(cat.name));
                const categoryMinutes = categoryActivities.reduce((sum, a) => sum + (a.durationMinutes || 0), 0);
                if (categoryMinutes > 0) {
                    categoryTimes[cat.name] = {
                        emoji: cat.emoji,
                        hours: Math.floor(categoryMinutes / 60),
                        minutes: categoryMinutes % 60
                    };
                }
            });
            
            const moodCounts = {
                great: 0, good: 0, normal: 0, bad: 0, terrible: 0
            };
            
            recentJournals.forEach(j => {
                if (j.mood && moodCounts.hasOwnProperty(j.mood)) {
                    moodCounts[j.mood]++;
                }
            });
            
            const totalMoods = Object.values(moodCounts).reduce((sum, count) => sum + count, 0);
            const positiveMoods = moodCounts.great + moodCounts.good;
            const negativeMoods = moodCounts.bad + moodCounts.terrible;
            
            const totalIncome = recentMoney.filter(m => m.amount > 0).reduce((sum, m) => sum + m.amount, 0);
            const totalExpense = recentMoney.filter(m => m.amount < 0).reduce((sum, m) => sum + m.amount, 0);
            const balance = totalIncome + totalExpense;
            
            let advice = [];
            
            // ÊôÇÈñìÁµ±Ë®à„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ„ÇíËøΩÂä†
            if (totalMinutes > 0) {
                if (totalHours > 0) {
                    advice.push(`‚è±Ô∏è ‰ªäÈÄ±„ÅØÂêàË®à ${totalHours}ÊôÇÈñì${remainingMinutes > 0 ? remainingMinutes + 'ÂàÜ' : ''}„ÇíË®òÈå≤„Åó„Åæ„Åó„ÅüÔºÅ`);
                } else {
                    advice.push(`‚è±Ô∏è ‰ªäÈÄ±„ÅØÂêàË®à ${remainingMinutes}ÂàÜ„ÇíË®òÈå≤„Åó„Åæ„Åó„ÅüÔºÅ`);
                }
            }
            
            if (recordedDays >= 5) {
                advice.push('üìä Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅ‰ªäÈÄ±„ÅØ' + recordedDays + 'Êó•ÈñìË®òÈå≤„ÇíÁ∂ö„Åë„Å¶„ÅÑ„Åæ„Åô„ÄÇÁ∂ôÁ∂ö„ÅØÂäõ„Å™„Çä„Åß„Åô„Å≠ÔºÅ');
            } else if (recordedDays >= 3) {
                advice.push('üìä ‰ªäÈÄ±„ÅØ' + recordedDays + 'Êó•ÈñìË®òÈå≤„Åó„Åæ„Åó„Åü„ÄÇ„ÅÇ„Å®Â∞ë„Åó„ÅßÊØéÊó•Ë®òÈå≤ÈÅîÊàê„Åß„ÅôÔºÅ');
            } else {
                advice.push('üìä ‰ªäÈÄ±„ÅÆË®òÈå≤„ÅØ' + recordedDays + 'Êó•Èñì„Åß„Åô„ÄÇÊØéÊó•Â∞ë„Åó„Åö„Å§Ë®òÈå≤„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ');
            }
            
            if (topCategories.length > 0) {
                const topActivity = topCategories[0];
                advice.push('üéØ ‰ªäÈÄ±„ÅØ„Äå' + topActivity[0] + '„Äç„Çí' + topActivity[1] + 'ÂõûË®òÈå≤„Åó„Åæ„Åó„Åü„ÄÇÁ¥†Êô¥„Çâ„Åó„ÅÑÔºÅ');
            }
            
            if (totalMoods > 0) {
                const positiveRate = Math.round((positiveMoods / totalMoods) * 100);
                if (positiveRate >= 70) {
                    advice.push('üòä ‰ªäÈÄ±„ÅÆÊ∞óÂàÜ„ÅØÁ¥†Êô¥„Çâ„Åó„ÅÑÔºÅ' + positiveRate + '%„Åå„Éù„Ç∏„ÉÜ„Ç£„Éñ„Å™Ê∞óÂàÜ„Åß„Åó„Åü„ÄÇ');
                } else if (positiveRate >= 50) {
                    advice.push('üôÇ ‰ªäÈÄ±„ÅÆÊ∞óÂàÜ„ÅØ„Åæ„Åö„Åæ„Åö„ÄÇ' + positiveRate + '%„Åå„Éù„Ç∏„ÉÜ„Ç£„Éñ„Å™Ê∞óÂàÜ„Åß„Åó„Åü„ÄÇ');
                } else if (negativeMoods > positiveMoods) {
                    advice.push('üòî ‰ªäÈÄ±„ÅØÂ∞ë„ÅóÂ§ßÂ§â„Åß„Åó„Åü„Å≠„ÄÇÁÑ°ÁêÜ„Åõ„Åö„ÄÅËá™ÂàÜ„ÅÆ„Éö„Éº„Çπ„ÅßÈÄ≤„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ');
                }
            }
            
            if (recentMoney.length > 0) {
                if (balance >= 0) {
                    advice.push('üí∞ ‰ªäÈÄ±„ÅÆÂèéÊîØ„ÅØ+' + balance.toLocaleString() + 'ÂÜÜ„ÄÇÁ¥†Êô¥„Çâ„Åó„ÅÑÁÆ°ÁêÜ„Åß„Åô„Å≠ÔºÅ');
                } else {
                    advice.push('üí∏ ‰ªäÈÄ±„ÅÆÊîØÂá∫„ÅØ' + Math.abs(balance).toLocaleString() + 'ÂÜÜ„ÄÇÊù•ÈÄ±„ÅØÁØÄÁ¥Ñ„ÇíÂøÉ„Åå„Åë„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ');
                }
            }
            
            let goals = [];
            
            if (recordedDays < 7) {
                goals.push('üìÖ Êù•ÈÄ±„ÅØÊØéÊó•Ë®òÈå≤„ÇíÁõÆÊåá„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ');
            }
            
            if (topCategories.length > 0) {
                const topActivity = topCategories[0];
                goals.push('üéØ „Äå' + topActivity[0] + '„Äç„Çí' + (topActivity[1] + 2) + 'Âõû„ÇÑ„Å£„Å¶„Åø„Çã');
            }
            
            if (recentActivities.filter(a => a.text.includes('ÈÅãÂãï')).length < 3) {
                goals.push('üèÉ ÈÄ±3Âõû‰ª•‰∏ä„ÅÆÈÅãÂãï„Å´„ÉÅ„É£„É¨„É≥„Ç∏');
            }
            
            if (recentJournals.length < 5) {
                goals.push('üìù ÈÄ±5Âõû„ÅÆ„Ç∏„É£„Éº„Éä„É´Ë®òÈå≤„ÇíÁõÆÊåá„Åô');
            }
            
            if (balance < 0) {
                goals.push('üí∞ ÊîØÂá∫„ÇíÊÑèË≠ò„Åó„Å¶Ë®òÈå≤„ÇíÁ∂ö„Åë„Çã');
            }
            
            const weeklyAnalysisHTML = `
                <p><strong>üìä Ë®òÈå≤Êó•Êï∞:</strong> ${recordedDays}Êó• / 7Êó•</p>
                ${recordedDays >= 5 ? '<p style="color: #28a745;">‚ú® Á¥†Êô¥„Çâ„Åó„ÅÑÁ∂ôÁ∂öÂäõ„Åß„ÅôÔºÅ</p>' : ''}
                ${recentActivities.length > 0 ? `<p><strong>üìù Ë°åÂãïË®òÈå≤:</strong> ${recentActivities.length}Âõû</p>` : ''}
                ${recentJournals.length > 0 ? `<p><strong>‚úçÔ∏è „Ç∏„É£„Éº„Éä„É´:</strong> ${recentJournals.length}Âõû</p>` : ''}
            `;
            
            const behaviorPatternsHTML = topCategories.length > 0 ? `
                <p><strong>„Éà„ÉÉ„Éó3Ê¥ªÂãï:</strong></p>
                <ul>
                    ${topCategories.map(([name, count]) => `<li>${name}: ${count}Âõû</li>`).join('')}
                </ul>
                
                ${Object.keys(categoryTimes).length > 0 ? `
                    <p style="margin-top: 15px;"><strong>‚è±Ô∏è „Ç´„ÉÜ„Ç¥„É™Âà•„ÅÆÊôÇÈñì:</strong></p>
                    <ul>
                        ${Object.entries(categoryTimes).map(([name, time]) => {
                            let timeStr = '';
                            if (time.hours > 0 && time.minutes > 0) {
                                timeStr = `${time.hours}ÊôÇÈñì${time.minutes}ÂàÜ`;
                            } else if (time.hours > 0) {
                                timeStr = `${time.hours}ÊôÇÈñì`;
                            } else {
                                timeStr = `${time.minutes}ÂàÜ`;
                            }
                            return `<li>${time.emoji} ${name}: ${timeStr}</li>`;
                        }).join('')}
                    </ul>
                ` : ''}
            ` : '<p>„Åæ„Å†„Éá„Éº„Çø„ÅåÂ∞ë„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„Éë„Çø„Éº„É≥„ÇíÂàÜÊûê„Åß„Åç„Åæ„Åõ„Çì„ÄÇ</p>';
            
            const moodTrendsHTML = totalMoods > 0 ? `
                <p><strong>Ê∞óÂàÜ„ÅÆÂÜÖË®≥:</strong></p>
                <ul>
                    ${moodCounts.great > 0 ? `<li>üòä ÊúÄÈ´ò: ${moodCounts.great}Âõû</li>` : ''}
                    ${moodCounts.good > 0 ? `<li>üôÇ ËâØ„ÅÑ: ${moodCounts.good}Âõû</li>` : ''}
                    ${moodCounts.normal > 0 ? `<li>üòê ÊôÆÈÄö: ${moodCounts.normal}Âõû</li>` : ''}
                    ${moodCounts.bad > 0 ? `<li>üòî ÊÇ™„ÅÑ: ${moodCounts.bad}Âõû</li>` : ''}
                    ${moodCounts.terrible > 0 ? `<li>üò¢ ÊúÄÊÇ™: ${moodCounts.terrible}Âõû</li>` : ''}
                </ul>
            ` : '<p>„Åæ„Å†„Ç∏„É£„Éº„Éä„É´„ÅÆË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊ∞óÂàÜ„ÇíË®òÈå≤„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ</p>';
            
            const aiAdviceHTML = advice.length > 0 ? 
                advice.map(a => `<p>„Éª${a}</p>`).join('') : 
                '<p>„Éá„Éº„Çø„ÇíË®òÈå≤„Åó„Å¶„ÄÅAI„Åã„Çâ„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ„ÇíÂèó„ÅëÂèñ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ</p>';
            
            const weeklyGoalsHTML = goals.length > 0 ? `
                <ul>
                    ${goals.map(g => `<li>${g}</li>`).join('')}
                </ul>
            ` : '<p>Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅ„Åô„Åπ„Å¶„ÅÆÁõÆÊ®ô„ÇíÈÅîÊàê„Åó„Å¶„ÅÑ„Åæ„ÅôÔºÅ</p>';
            
            document.getElementById('weeklyAnalysis').innerHTML = weeklyAnalysisHTML;
            document.getElementById('behaviorPatterns').innerHTML = behaviorPatternsHTML;
            document.getElementById('moodTrends').innerHTML = moodTrendsHTML;
            document.getElementById('aiAdvice').innerHTML = aiAdviceHTML;
            document.getElementById('weeklyGoals').innerHTML = weeklyGoalsHTML;
        }
        // „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ
        // „Çø„Ç§„Éû„ÉºÊ©üËÉΩ
        function toggleTimer() {
            if (timerRunning) {
                // ÂÅúÊ≠¢
                clearInterval(timerInterval);
                timerRunning = false;
                document.getElementById('timerButton').innerHTML = '‚ñ∂Ô∏è „Çø„Ç§„Éû„ÉºÂÜçÈñã';
                document.getElementById('timerButton').style.background = '#4CAF50';
            } else {
                // ÈñãÂßã
                if (timerStartTime === null) {
                    timerStartTime = Date.now() - (timerElapsedSeconds * 1000);
                } else {
                    timerStartTime = Date.now() - (timerElapsedSeconds * 1000);
                }
                
                timerRunning = true;
                document.getElementById('timerButton').innerHTML = '‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢';
                document.getElementById('timerButton').style.background = '#FF9800';
                
                timerInterval = setInterval(() => {
                    timerElapsedSeconds = Math.floor((Date.now() - timerStartTime) / 1000);
                    updateTimerDisplay();
                }, 100);
            }
        }
        
        function updateTimerDisplay() {
            const hours = Math.floor(timerElapsedSeconds / 3600);
            const minutes = Math.floor((timerElapsedSeconds % 3600) / 60);
            const seconds = timerElapsedSeconds % 60;
            
            const display = 
                String(hours).padStart(2, '0') + ':' +
                String(minutes).padStart(2, '0') + ':' +
                String(seconds).padStart(2, '0');
            
            document.getElementById('timerDisplay').textContent = display;
        }
        
        function resetTimer() {
            clearInterval(timerInterval);
            timerStartTime = null;
            timerRunning = false;
            timerElapsedSeconds = 0;
            document.getElementById('timerDisplay').textContent = '00:00:00';
            document.getElementById('timerButton').innerHTML = '‚ñ∂Ô∏è „Çø„Ç§„Éû„ÉºÈñãÂßã';
            document.getElementById('timerButton').style.background = '#4CAF50';
        }
        
        // „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ
        function openCategoryManager() {
            document.getElementById('categoryModal').classList.add('active');
            renderCategoryList();
        }
        
        function closeCategoryManager() {
            document.getElementById('categoryModal').classList.remove('active');
        }
        
        function renderCategoryList() {
            const container = document.getElementById('categoryList');
            container.innerHTML = activityCategories.map((cat, index) => `
                <div class="log-item" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${cat.emoji} ${cat.name}</span>
                    <button onclick="deleteCategory(${index})" style="padding: 5px 10px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">ÂâäÈô§</button>
                </div>
            `).join('');
        }
        
        function addCategory() {
            const nameInput = document.getElementById('newCategoryName');
            const emojiInput = document.getElementById('newCategoryEmoji');
            
            const name = nameInput.value.trim();
            const emoji = emojiInput.value.trim();
            
            if (!name || !emoji) {
                alert('ÂêçÂâç„Å®ÁµµÊñáÂ≠ó„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            activityCategories.push({ name, emoji });
            localStorage.setItem('activityCategories', JSON.stringify(activityCategories));
            
            nameInput.value = '';
            emojiInput.value = '';
            
            renderCategoryList();
            renderActivityQuickButtons();
        }
        
        function deleteCategory(index) {
            if (confirm('„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                activityCategories.splice(index, 1);
                localStorage.setItem('activityCategories', JSON.stringify(activityCategories));
                renderCategoryList();
                renderActivityQuickButtons();
            }
        }
        
        // Èü≥Â£∞Ë™çË≠ò„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
// Èü≥Â£∞Ë™çË≠ò„ÅÆ‰∫åÈáçË®òÂÖ•„Éê„Ç∞‰øÆÊ≠£Áâà
// „Ç∏„É£„Éº„Éä„É´Â∞ÇÁî®Èü≥Â£∞Ë™çË≠òÔºàÂÜÖÂÆπ‰øùÊåÅÁâàÔºâ

// „Ç∏„É£„Éº„Éä„É´ÂÖ•Âäõ„Å´„É™„Ç¢„É´„Çø„Ç§„É†„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíËøΩÂä†
function setupJournalInputListener() {
    const journalInput = document.getElementById('journalInput');
    if (!journalInput) {
        console.error('journalInputË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        return;
    }
    
    let debounceTimer;
    
    journalInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        
        const text = journalInput.value.trim();
        
        // 50ÊñáÂ≠ó‰ª•‰∏äÂÖ•Âäõ„Åï„Çå„Åü„ÇâË¶ÅÁ¥Ñ„ÇíË°®Á§∫
        if (text.length >= 50) {
            debounceTimer = setTimeout(() => {
                // ÊâãÂãï„Ç´„ÉÜ„Ç¥„É™„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®
                const hasManualCategories = 
                    categoryVoiceInputs.good.length > 0 ||
                    categoryVoiceInputs.more.length > 0 ||
                    categoryVoiceInputs.worry.length > 0 ||
                    categoryVoiceInputs.taskMust.length > 0 ||
                    categoryVoiceInputs.taskWant.length > 0;
                
                let analysis;
                if (hasManualCategories) {
                    // ÊâãÂãï„Ç´„ÉÜ„Ç¥„É™„Çí‰ΩøÁî®
                    analysis = createManualCategoryAnalysis();
                } else {
                    // Ëá™ÂãïÂàÜÊûê„Çí‰ΩøÁî®ÔºàÊâãÂãïÂÖ•Âäõ„ÅÆÂ†¥ÂêàÔºâ
                    analysis = analyzJournal(text);
                }
                
                displaySummary(analysis);
            }, 1000); // 1ÁßíÂæÖ„Å£„Å¶„Åã„ÇâË¶ÅÁ¥Ñ
        } else {
            // Áü≠„ÅÑÂ†¥Âêà„ÅØË¶ÅÁ¥Ñ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈùûË°®Á§∫
            const summarySection = document.getElementById('summarySection');
            if (summarySection) {
                summarySection.classList.remove('active');
            }
        }
    });
}
// „Ç∏„É£„Éº„Éä„É´Â∞ÇÁî®Èü≥Â£∞Ë™çË≠òÔºà„Éê„Ç∞‰øÆÊ≠£ÁâàÔºâ
// „Ç∏„É£„Éº„Éä„É´Â∞ÇÁî®Èü≥Â£∞Ë™çË≠òÔºàÂÆåÂÖ®‰øÆÊ≠£ÁâàÔºâ
// ÊâãÂãï„Ç´„ÉÜ„Ç¥„É™ÈÅ∏ÊäûÊ©üËÉΩ
window.selectedJournalCategory = null;
let categoryVoiceInputs = {
    good: [],
    more: [],
    worry: [],
    taskMust: [],
    taskWant: []
};

function selectJournalCategory(category) {
    console.log('„Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû:', category);
    
    // Ââç„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Êñ∞„Åó„ÅÑ„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû
    window.selectedJournalCategory = category;
    const btn = document.querySelector(`.category-btn[data-category="${category}"]`);
    if (btn) {
        btn.classList.add('active');
    }
    
    // ÈÅ∏ÊäûË°®Á§∫„ÇíÊõ¥Êñ∞
    const display = document.getElementById('selectedCategoryDisplay');
    const categoryNames = {
        good: 'üòä ËâØ„Åã„Å£„Åü„Åì„Å®',
        more: 'üìà „ÇÇ„Å£„Å®„Åß„Åç„Çã„Åì„Å®',
        worry: 'üòü ÊÇ©„Çì„Åß„ÅÑ„Çã„Åì„Å®',
        taskMust: '‚úÖ Must: „ÇÑ„Çâ„Å™„Åç„ÇÉ„ÅÑ„Åë„Å™„ÅÑ„Åì„Å®',
        taskWant: 'üí° Want: „ÇÑ„Çä„Åü„ÅÑ„Åì„Å®'
    };
    
    if (display) {
        display.textContent = `ÈÅ∏Êäû‰∏≠: ${categoryNames[category]}`;
        display.classList.add('has-selection');
    }
    
    window.selectJournalCategory = selectJournalCategory; // „Ç∞„É≠„Éº„Éê„É´„Å´ÊòéÁ§∫ÁöÑ„Å´ÂÖ¨Èñã
    // „Éí„É≥„ÉàÈùûË°®Á§∫
    const hint = document.getElementById('categoryRequiredHint');
    if (hint) {
        hint.classList.remove('show');
    }
}

// =================================================================
// Èü≥Â£∞ÂÖ•ÂäõÊ©üËÉΩ
// =================================================================

// „Ç∏„É£„Éº„Éä„É´Èü≥Â£∞ÂÖ•ÂäõÁî®„ÅÆ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
window.journalRecognition = null;
window.isJournalRecording = false;
window.journalVoiceInputs = {}; // „Ç´„ÉÜ„Ç¥„É™Âà•„ÅÆÂÖ•Âäõ„Çí‰øùÂ≠ò

function startJournalVoice() {
    console.log('üéôÔ∏è startJournalVoice() Âëº„Å≥Âá∫„Åó');
    
    if (!('webkitSpeechRecognition' in window)) {
        alert('„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞Ë™çË≠ò„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
        return;
    }
    
    const button = document.getElementById('journalVoiceButton');
    const input = document.getElementById('journalInput');
    
    if (window.isJournalRecording) {
        // ÂÅúÊ≠¢
        console.log('‚èπÔ∏è Èü≥Â£∞Ë™çË≠ò„ÇíÂÅúÊ≠¢');
        if (window.journalRecognition) {
            window.journalRecognition.stop();
        }
        window.isJournalRecording = false;
        window.shouldRestartJournal = false;  // Ëá™ÂãïÂÜçÈñã„ÇíÁÑ°ÂäπÂåñ
        button.textContent = 'üé§ Èü≥Â£∞ÂÖ•Âäõ';
        button.style.background = '';
        return;
    }
    
    // ÈñãÂßã
    console.log('‚ñ∂Ô∏è Èü≥Â£∞Ë™çË≠ò„ÇíÈñãÂßã: „Ç´„ÉÜ„Ç¥„É™ =', window.selectedJournalCategory);
    window.journalRecognition = new webkitSpeechRecognition();
    window.journalRecognition.lang = 'ja-JP';
    window.journalRecognition.continuous = false;  // false „ÅÆ„Åæ„ÅæÔºà„Çπ„Éû„Éõ„ÅßÂÆâÂÆöÔºâ
    window.journalRecognition.interimResults = true;
    
    // Èü≥Â£∞Ë™çË≠òÈñãÂßãÊôÇ„ÅÆÂàùÊúü„ÉÜ„Ç≠„Çπ„Éà„Çí‰øùÂ≠ò
    const initialText = input.value || '';
    const processedResults = new Set();  // ÈáçË§áÈò≤Ê≠¢
    window.lastFinalText = window.lastFinalText || '';  // ÂâçÂõû„ÅÆÁ¢∫ÂÆö„ÉÜ„Ç≠„Çπ„Éà„Çí‰øùÂ≠ò
    let allText = '';
    
    window.journalRecognition.onresult = function(event) {
        console.log('üìù onresult:', event.results.length, 'ÂÄã„ÅÆÁµêÊûú');
        
        // event.resultIndex „Åã„ÇâÊúÄÂæå„Åæ„ÅßÂá¶ÁêÜÔºà„Çπ„Éû„ÉõÂØæÁ≠ñÔºâ
        for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
                const text = event.results[i][0].transcript;
                
                // ÂâçÂõû„Å®Âêå„Åò„ÉÜ„Ç≠„Çπ„Éà„Å™„ÇâÁÑ°Ë¶ñÔºàÂá∫„Å†„ÅóÈáçË§áÂØæÁ≠ñÔºâ
                if (text === window.lastFinalText) {
                    console.log('üîÑ ÂâçÂõû„Å®Âêå„Åò„ÉÜ„Ç≠„Çπ„Éà„Çí„Çπ„Ç≠„ÉÉ„Éó:', text);
                    continue;
                }
                
                // Âêå„Åò„ÉÜ„Ç≠„Çπ„Éà„ÅØ1Âõû„Å†„ÅëËøΩÂä†Ôºà„Çπ„Éû„ÉõÂØæÁ≠ñÔºâ
                if (!processedResults.has(text)) {
                    processedResults.add(text);
                    allText += text;
                    window.lastFinalText = text;  // ÊúÄÊñ∞„ÅÆÁ¢∫ÂÆö„ÉÜ„Ç≠„Çπ„Éà„Çí‰øùÂ≠ò
                    console.log(`‚úÖ [${i}] ËøΩÂä†:`, text);
                } else {
                    console.log(`‚ùå [${i}] ÈáçË§á„Çπ„Ç≠„ÉÉ„Éó:`, text);
                }
            }
        }
        
        const separator = initialText && allText ? '\n' : '';
        input.value = initialText + separator + allText;
    };
    
    window.journalRecognition.onerror = function(event) {
        console.error("‚ùå Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº:", event.error);
        
        if (event.error === 'no-speech') {
            console.log('‚ö†Ô∏è no-speech: Ëá™ÂãïÂÜçÈñã„Åó„Åæ„Åô');
            // no-speech „Ç®„É©„Éº„ÅØËá™ÂãïÂÜçÈñã
        } else {
            window.isJournalRecording = false;
            window.shouldRestartJournal = false;
            button.textContent = 'üé§ Èü≥Â£∞ÂÖ•Âäõ';
            button.style.background = '';
            
            if (event.error === 'not-allowed') {
                alert('„Éû„Ç§„ÇØ„ÅÆ‰ΩøÁî®„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            } else if (event.error !== 'aborted') {
                alert('Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº: ' + event.error);
            }
        }
    };
    
    window.journalRecognition.onend = function() {
        console.log('üîö Èü≥Â£∞Ë™çË≠ò„ÅåÁµÇ‰∫Ü');
        
        // Èå≤Èü≥‰∏≠„Éï„É©„Ç∞„ÅåON„Å™„ÇâËá™ÂãïÂÜçÈñãÔºà„É¶„Éº„Ç∂„Éº„ÅåÂÅúÊ≠¢„Éú„Çø„É≥„ÇíÊäº„Åô„Åæ„ÅßÁ∂ö„Åë„ÇãÔºâ
        if (window.isJournalRecording && window.shouldRestartJournal !== false) {
            console.log('üîÑ Ëá™ÂãïÂÜçÈñã„Åó„Åæ„ÅôÔºà600msÂæåÔºâ');
            setTimeout(function() {
                if (window.isJournalRecording) {
                    console.log('‚ñ∂Ô∏è ÂÜçÈñã');
                    window.journalRecognition.start();
                }
            }, 600);  // 600ms „ÅÆ„Éá„Ç£„É¨„Ç§Ôºà„Çπ„Éû„Éõ„ÅßÂÆâÂÆöÔºâ
        } else {
            // Êú¨ÂΩì„Å´ÁµÇ‰∫Ü
            window.isJournalRecording = false;
            button.textContent = 'üé§ Èü≥Â£∞ÂÖ•Âäõ';
            button.style.background = '';
        }
    };
    
    window.isJournalRecording = true;
    window.shouldRestartJournal = true;  // Ëá™ÂãïÂÜçÈñã„ÇíÊúâÂäπÂåñ
    button.textContent = '‚èπÔ∏è ÂÅúÊ≠¢';
    button.style.background = '#ef4444';
    window.journalRecognition.start();
}
// =================================================================

// Èü≥Â£∞ÂÖ•ÂäõÊ©üËÉΩ„Åì„Åì„Åæ„Åß

function setupManualCategoryVoiceRecognition(buttonId, inputId) {
    const button = document.getElementById(buttonId);
    const input = document.getElementById(inputId);
    
    if (!button || !input) {
        console.error('„Éú„Çø„É≥„Åæ„Åü„ÅØÂÖ•ÂäõÊ¨Ñ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        return;
    }
    
    let recognition = null;
    let isRecording = false;
    let silenceTimer = null;
    let finalTranscript = '';
    
    const clickHandler = function() {
    console.log("setupManualCategoryVoiceRecognition: buttonId=", buttonId, "inputId=", inputId, "button=", button, "input=", input);
        if (!selectedJournalCategory) {
        console.log("„Ç∏„É£„Éº„Éä„É´Èü≥Â£∞„Éú„Çø„É≥„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü„ÄÇselectedJournalCategory=", selectedJournalCategory);
            const hint = document.getElementById('categoryRequiredHint');
            if (hint) {
                hint.classList.add('show');
                setTimeout(() => hint.classList.remove('show'), 3000);
            }
            alert('„Åæ„Åö„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
        }
        
        if (isRecording) {
            console.log('üõë ÊâãÂãïÂÅúÊ≠¢');
            if (recognition) {
                recognition.stop();
            }
            isRecording = false;
            button.textContent = 'üé§';
            button.style.background = '';
            if (silenceTimer) {
                clearTimeout(silenceTimer);
                silenceTimer = null;
            }
        } else {
            if (!('webkitSpeechRecognition' in window)) {
                alert('„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞Ë™çË≠ò„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }
            
            console.log('üé§ Èü≥Â£∞ÂÖ•Âäõ„ÇíÈñãÂßã: „Ç´„ÉÜ„Ç¥„É™ =', selectedJournalCategory);
            
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.continuous = false;  // ‚≠ê continuous„Çífalse„Å´Â§âÊõ¥
            recognition.interimResults = true;
            
            finalTranscript = '';
            isRecording = true;
            button.textContent = '‚èπÔ∏è';
            button.style.background = '#ef4444';
            
            recognition.onresult = function(event) {
                console.log('üìù Èü≥Â£∞Ë™çË≠òÁµêÊûú„ÇíÂèó‰ø°');
                
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                }
                
                let interimTranscript = '';
                let newFinalTranscript = '';
                
                // ‚≠ê „Ç∑„É≥„Éó„É´„Å™„É´„Éº„ÉóÔºàcontinuous: false„Å™„ÅÆ„ÅßÈáçË§á„Å™„ÅóÔºâ
                for (let i = 0; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        newFinalTranscript += transcript;
                        console.log('‚úÖ Á¢∫ÂÆö„ÉÜ„Ç≠„Çπ„Éà:', transcript);
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                if (newFinalTranscript) {
                    finalTranscript = newFinalTranscript;  // ‚≠ê Á¥ØÁ©ç„Åß„ÅØ„Å™„ÅèÁΩÆ„ÅçÊèõ„Åà
                    console.log('üìå ÊúÄÁµÇ„ÉÜ„Ç≠„Çπ„Éà:', finalTranscript);
                }
                
                const displayText = finalTranscript + interimTranscript;
                input.value = displayText;
                
                // „É™„Ç¢„É´„Çø„Ç§„É†Ë¶ÅÁ¥ÑË°®Á§∫
                if (displayText.length > 30) {
                    const tempInputs = JSON.parse(JSON.stringify(categoryVoiceInputs));
                    tempInputs[selectedJournalCategory] = [displayText];
                    const tempAnalysis = {
                        good: tempInputs.good || [],
                        more: tempInputs.more || [],
                        worry: tempInputs.worry || [],
                        task: tempInputs.task || []
                    };
                    displaySummary(tempAnalysis);
                }
            };
            
            recognition.onend = function() {
                console.log('üèÅ Èü≥Â£∞Ë™çË≠ò„ÅåÁµÇ‰∫Ü (ÊúÄÁµÇ:', finalTranscript, ')');
                isRecording = false;
                button.textContent = 'üé§';
                button.style.background = '';
                
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                }
                
                if (finalTranscript && selectedJournalCategory) {
                    const trimmed = finalTranscript.trim();
                    const existing = categoryVoiceInputs[selectedJournalCategory];
                    
                    // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
                    const isDuplicate = existing.some(text => {
                        return text === trimmed || text.includes(trimmed) || trimmed.includes(text);
                    });
                    
                    if (trimmed && !isDuplicate) {
                        categoryVoiceInputs[selectedJournalCategory].push(trimmed);
                        console.log('‚úÖ „Ç´„ÉÜ„Ç¥„É™„Å´ËøΩÂä†:', selectedJournalCategory, trimmed);
                        
                        updateJournalInputFromCategories();
                        
                        const analysis = createManualCategoryAnalysis();
                        displaySummary(analysis);
                        
                        input.value = '';
                    } else if (isDuplicate) {
                        console.log('‚ö†Ô∏è ÈáçË§á„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Åü„ÇÅËøΩÂä†„Åó„Åæ„Åõ„Çì„Åß„Åó„Åü:', trimmed);
                        input.value = '';
                    } else {
                        console.log('‚ö†Ô∏è Á©∫„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Åü„ÇÅËøΩÂä†„Åó„Åæ„Åõ„Çì„Åß„Åó„Åü');
                        input.value = '';
                    }
                    
                    finalTranscript = '';
                }
            };
            
            recognition.onerror = function(event) {
                console.error('‚ùå Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº:', event.error);
                isRecording = false;
                button.textContent = 'üé§';
                button.style.background = '';
                
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                }
                
                if (event.error === 'no-speech') {
                    alert('Èü≥Â£∞„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else if (event.error === 'network') {
                    alert('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else if (event.error !== 'aborted') {
                    alert('Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº: ' + event.error);
                }
                
                finalTranscript = '';
            };
            
            recognition.start();
        }
    };
    
    button.removeEventListener('click', clickHandler);
    button.addEventListener('click', clickHandler);
}

function updateJournalInputFromCategories() {
    const input = document.getElementById('journalInput');
    if (!input) return;
    
    let fullText = [];
    
    if (categoryVoiceInputs.good.length > 0) {
        fullText.push('„ÄêËâØ„Åã„Å£„Åü„Åì„Å®„Äë');
        fullText.push(...categoryVoiceInputs.good);
    }
    
    if (categoryVoiceInputs.more.length > 0) {
        fullText.push('„Äê„ÇÇ„Å£„Å®„Åß„Åç„Çã„Åì„Å®„Äë');
        fullText.push(...categoryVoiceInputs.more);
    }
    
    if (categoryVoiceInputs.worry.length > 0) {
        fullText.push('„ÄêÊÇ©„Çì„Åß„ÅÑ„Çã„Åì„Å®„Äë');
        fullText.push(...categoryVoiceInputs.worry);
    }
    
    if (categoryVoiceInputs.taskMust.length > 0) {
        fullText.push('„ÄêMust: „ÇÑ„Çâ„Å™„Åç„ÇÉ„ÅÑ„Åë„Å™„ÅÑ„Åì„Å®„Äë');
        fullText.push(...categoryVoiceInputs.taskMust);
    }
    
    if (categoryVoiceInputs.taskWant.length > 0) {
        fullText.push('„ÄêWant: „ÇÑ„Çä„Åü„ÅÑ„Åì„Å®„Äë');
        fullText.push(...categoryVoiceInputs.taskWant);
    }
    
    input.value = fullText.join('\n');
}

function createManualCategoryAnalysis() {
    return {
        good: categoryVoiceInputs.good.slice(),
        more: categoryVoiceInputs.more.slice(),
        worry: categoryVoiceInputs.worry.slice(),
        taskMust: categoryVoiceInputs.taskMust.slice(),
        taskWant: categoryVoiceInputs.taskWant.slice()
    };
}

function resetCategorySelection() {
    selectedJournalCategory = null;
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const display = document.getElementById('selectedCategoryDisplay');
    if (display) {
        display.textContent = '„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Å¶„Åã„ÇâÈü≥Â£∞ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        display.classList.remove('has-selection');
    }
}

function clearCategoryVoiceInputs() {
    categoryVoiceInputs = {
        good: [],
        more: [],
        worry: [],
        taskMust: [],
        taskWant: []
    };
    resetCategorySelection();
}
function setupJournalVoiceRecognition(buttonId, inputId) {
    const button = document.getElementById(buttonId);
    const input = document.getElementById(inputId);
    
    if (!button || !input) return;
    
    if (!('webkitSpeechRecognition' in window)) {
        button.disabled = true;
        button.textContent = 'Èü≥Â£∞Ë™çË≠ò„ÅØÈùûÂØæÂøú„Åß„Åô';
        return;
    }
    
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.continuous = false;  // ÈáçË¶Å: false „Å´Â§âÊõ¥
    recognition.interimResults = true;
    recognition.maxAlternatives = 1;
    
    let isListening = false;
    let finalTranscript = '';
    let shouldRestart = false;  // ÂÜçÈñã„Éï„É©„Ç∞
    let restartTimer = null;
    
    button.addEventListener('click', () => {
        if (isListening) {
            // ÂÅúÊ≠¢
            shouldRestart = false;
            clearTimeout(restartTimer);
            recognition.stop();
            button.classList.remove('listening');
            button.textContent = button.textContent.replace('üî¥ ÂÅúÊ≠¢', 'üé§ Èü≥Â£∞ÂÖ•Âäõ');
            isListening = false;
        } else {
            // ÈñãÂßã
            finalTranscript = input.value || '';
            shouldRestart = true;
            startRecognition();
        }
    });
    
    function startRecognition() {
        try {
            recognition.start();
            button.classList.add('listening');
            button.textContent = button.textContent.replace('üé§ Èü≥Â£∞ÂÖ•Âäõ', 'üî¥ ÂÅúÊ≠¢');
            isListening = true;
        } catch (e) {
            console.error('Èü≥Â£∞Ë™çË≠ò„ÅÆÈñãÂßã„Å´Â§±Êïó:', e);
            // Êó¢„Å´ÈñãÂßã„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÁÑ°Ë¶ñ
            if (e.name !== 'InvalidStateError') {
                isListening = false;
                shouldRestart = false;
            }
        }
    }
    
    recognition.onstart = () => {
        console.log('Èü≥Â£∞Ë™çË≠òÈñãÂßã');
    };
    
    recognition.onresult = (event) => {
        let interimTranscript = '';
        
        // ÂÖ®„Å¶„ÅÆÁµêÊûú„ÇíÂá¶ÁêÜÔºàcontinuous=false„Å™„ÅÆ„ÅßÂïèÈ°å„Å™„ÅÑÔºâ
        for (let i = 0; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            
            if (event.results[i].isFinal) {
                // Á¢∫ÂÆö„Åó„Åü„ÉÜ„Ç≠„Çπ„Éà„ÇíËøΩÂä†ÔºàÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÔºâ
                if (!finalTranscript.includes(transcript)) {
                    finalTranscript += transcript;
                }
            } else {
                interimTranscript += transcript;
            }
        }
        
        // Ë°®Á§∫„ÇíÊõ¥Êñ∞
        input.value = finalTranscript + interimTranscript;
        
        // Ë¶ÅÁ¥Ñ„ÇíÊõ¥Êñ∞
        const fullText = finalTranscript + interimTranscript;
        if (fullText.trim().length >= 50) {
            const analysis = analyzJournal(fullText);
            displaySummary(analysis);
        }
    };
    
    recognition.onerror = (event) => {
        console.error('Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº:', event.error);
        
        if (event.error === 'no-speech') {
            // ÁÑ°Èü≥Ê§úÂá∫ - Ëá™ÂãïÂÜçÈñã
            console.log('ÁÑ°Èü≥„ÇíÊ§úÂá∫„ÄÅÂÜçÈñã„Åó„Åæ„Åô');
            // ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàonend„ÅßÂÜçÈñã„Åï„Çå„ÇãÔºâ
        } else if (event.error === 'aborted') {
            // ‰∏≠Êñ≠„Åï„Çå„Åü - ÂÜçÈñã„Åó„Å™„ÅÑ
            shouldRestart = false;
        } else {
            // „Åù„ÅÆ‰ªñ„ÅÆ„Ç®„É©„Éº
            console.log('„Ç®„É©„Éº„ÅÆ„Åü„ÇÅÂÅúÊ≠¢');
            shouldRestart = false;
            button.classList.remove('listening');
            button.textContent = button.textContent.replace('üî¥ ÂÅúÊ≠¢', 'üé§ Èü≥Â£∞ÂÖ•Âäõ');
            isListening = false;
        }
    };
    
    recognition.onend = () => {
        console.log('Èü≥Â£∞Ë™çË≠òÁµÇ‰∫Ü');
        
        if (shouldRestart && isListening) {
            // 500msÂæÖ„Å£„Å¶„Åã„ÇâÂÜçÈñãÔºàÈáçË§á„ÇíÈò≤„ÅêÔºâ
            clearTimeout(restartTimer);
            restartTimer = setTimeout(() => {
                if (shouldRestart && isListening) {
                    console.log('Ëá™ÂãïÂÜçÈñã');
                    startRecognition();
                }
            }, 500);
        } else {
            button.classList.remove('listening');
            button.textContent = button.textContent.replace('üî¥ ÂÅúÊ≠¢', 'üé§ Èü≥Â£∞ÂÖ•Âäõ');
            isListening = false;
        }
    };
}
function setupVoiceRecognition(buttonId, inputId, isJournal = false, isActivity = false) {
    const button = document.getElementById(buttonId);
    const input = document.getElementById(inputId);
    
    if (!button || !input) return;
    
    if (!('webkitSpeechRecognition' in window)) {
        button.disabled = true;
        button.textContent = 'Èü≥Â£∞Ë™çË≠ò„ÅØÈùûÂØæÂøú„Åß„Åô';
        return;
    }
    
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.continuous = false;  // continuous „Çí false „Å´Â§âÊõ¥
    recognition.interimResults = true;
    
    let isListening = false;
    let finalTranscript = '';
    let isProcessing = false;  // Âá¶ÁêÜ‰∏≠„Éï„É©„Ç∞„ÇíËøΩÂä†
    
    button.addEventListener('click', () => {
        if (isListening) {
            recognition.stop();
            button.classList.remove('listening');
            button.textContent = button.textContent.replace('üî¥ ÂÅúÊ≠¢', 'üé§ Èü≥Â£∞ÂÖ•Âäõ');
            isListening = false;
        } else {
            if (isProcessing) return;  // Âá¶ÁêÜ‰∏≠„Å™„ÇâÁÑ°Ë¶ñ
            finalTranscript = '';
            recognition.start();
            button.classList.add('listening');
            button.textContent = button.textContent.replace('üé§ Èü≥Â£∞ÂÖ•Âäõ', 'üî¥ ÂÅúÊ≠¢');
            isListening = true;
        }
    });
    
    recognition.onresult = (event) => {
        if (isProcessing) return;  // Âá¶ÁêÜ‰∏≠„Å™„ÇâÁÑ°Ë¶ñ
        
        let interimTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript;
            } else {
                interimTranscript += transcript;
            }
        }
        
        const fullText = finalTranscript + interimTranscript;
        input.value = fullText;
        
        // Ë°åÂãï„Çø„Éñ„ÅÆÂ†¥Âêà„ÅØËá™ÂãïÁöÑ„Å´„Ç´„ÉÜ„Ç¥„É™„ÇíÊ§úÂá∫„Åó„Å¶ÈÅ∏Êäû
        if (isActivity && fullText) {
            autoSelectActivityCategory(fullText);
        }
        
        // „Ç∏„É£„Éº„Éä„É´„ÅÆÂ†¥Âêà„ÅØËá™ÂãïË¶ÅÁ¥Ñ„ÇíË°®Á§∫
        if (isJournal && finalTranscript) {
            const analysis = analyzJournal(fullText);
            displaySummary(analysis);
        }
    };
    
    recognition.onerror = (event) => {
        console.error('Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº:', event.error);
        button.classList.remove('listening');
        button.textContent = button.textContent.replace('üî¥ ÂÅúÊ≠¢', 'üé§ Èü≥Â£∞ÂÖ•Âäõ');
        isListening = false;
        isProcessing = false;  // „Ç®„É©„ÉºÊôÇ„Å´„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
    };
    
    recognition.onend = () => {
        if (isProcessing) return;  // „Åô„Åß„Å´Âá¶ÁêÜ‰∏≠„Å™„ÇâÁÑ°Ë¶ñ
        
        isProcessing = true;  // Âá¶ÁêÜÈñãÂßã
        
        button.classList.remove('listening');
        button.textContent = button.textContent.replace('üî¥ ÂÅúÊ≠¢', 'üé§ Èü≥Â£∞ÂÖ•Âäõ');
        isListening = false;
        
        // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„ÉàÔºà‰∫åÈáçÂÆüË°å„ÇíÈò≤„ÅêÔºâ
        setTimeout(() => {
            isProcessing = false;
        }, 500);
    };
}
        
        // Èü≥Â£∞ÂÖ•Âäõ„ÅßËá™ÂãïÁöÑ„Å´„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû
        function autoSelectActivityCategory(text) {
            // „ÉÜ„Ç≠„Çπ„Éà„ÇíÂ∞èÊñáÂ≠óÂåñ
            const lowerText = text.toLowerCase();
            
            // ÂêÑ„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Çπ„Ç≥„Ç¢„ÇíË®àÁÆó
            let bestMatch = null;
            let bestMatchEmoji = null;
            let bestScore = 0;
            
            activityCategories.forEach(category => {
                const categoryName = category.name.toLowerCase();
                let score = 0;
                
                // „Ç´„ÉÜ„Ç¥„É™Âêç„ÅåÁõ¥Êé•Âê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã
                if (lowerText.includes(categoryName)) {
                    score += 10;
                }
                
                // Èñ¢ÈÄ£„Ç≠„Éº„ÉØ„Éº„Éâ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const keywords = getCategoryKeywords(category.name);
                keywords.forEach(keyword => {
                    if (lowerText.includes(keyword)) {
                        score += 5;
                    }
                });
                
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = category.name;
                    bestMatchEmoji = category.emoji;
                }
            });
            
            // „Éû„ÉÉ„ÉÅ„Åó„Åü„Ç´„ÉÜ„Ç¥„É™„Åå„ÅÇ„Çå„Å∞„ÄÅselectCategoryÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
            if (bestMatch && bestScore >= 5) {
                selectCategory(bestMatch, bestMatchEmoji);
            }
        }
        function getCategoryKeywords(categoryName) {
            const keywordMap = {
                '‰ªï‰∫ã': ['‰ºöË≠∞', '„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞', '„Éó„É¨„Çº„É≥', 'Ë≥áÊñô', '„Éó„É≠„Ç∏„Çß„ÇØ„Éà', 'Ê•≠Âãô', '„Ç™„Éï„Ç£„Çπ', '‰ºÅÁîª', 'Â†±Âëä', '„É°„Éº„É´'],
                'ÂãâÂº∑': ['Â≠¶Áøí', 'ÂãâÂº∑', 'Ë™≠Êõ∏', 'Êú¨', '„Ç≥„Éº„Çπ', 'Ë¨õÂ∫ß', '„Çª„Éü„Éä„Éº', 'Ë©¶È®ì', 'Á†îÁ©∂', 'Âæ©Áøí'],
                'ÈÅãÂãï': ['„Ç∏„É†', '„É©„É≥„Éã„É≥„Ç∞', '„Ç∏„Éß„ÇÆ„É≥„Ç∞', 'Á≠ã„Éà„É¨', '„É®„Ç¨', '„Çπ„Éù„Éº„ÉÑ', 'Êï£Ê≠©', '„Éà„É¨„Éº„Éã„É≥„Ç∞', '„Çπ„Éà„É¨„ÉÉ„ÉÅ'],
                'È£ü‰∫ã': ['ÊúùÈ£ü', 'Êò®È£ü', 'Â§ïÈ£ü', 'È£ü„Åπ', '„É©„É≥„ÉÅ', '„Éá„Ç£„Éä„Éº', 'ÊñôÁêÜ', 'È£ü‰∫ã', '„É¨„Çπ„Éà„É©„É≥', '„Ç´„Éï„Çß'],
                'Áù°Áú†': ['Áú†', 'ÂØù', '‰ªï‰∫ã', 'Ëµ∑', '‰ºëÊÅØ', 'Êò®ÂØù', 'Êúù', 'Áñ≤„Çå'],
                'Ë™≠Êõ∏': ['Êú¨', 'Â∞èË™¨', 'Êº´Áîª', 'Ë™≠„Çì', 'ÈõëË™å', 'Ë®ò‰∫ã', '„Éñ„ÉÉ„ÇØ'],
                'ÂÆ∂‰∫ã': ['ÊéÉÈô§', 'Ê¥óÊøØ', 'ÊñôÁêÜ', 'Áâá‰ªò„Åë', 'Ë≤∑„ÅÑÁâ©', '„ÇØ„É™„Éº„Éã„É≥„Ç∞', 'Êï¥ÁêÜ'],
                'Ë∂£Âë≥': ['Ë∂£Âë≥', '„Ç≤„Éº„É†', 'Èü≥Ê•Ω', 'Êò†Áîª', '„Éâ„É©„Éû', '„Ç¢„Éã„É°', 'Áµµ', 'ÂÜôÁúü', '„Ç´„É©„Ç™„Ç±']
            };
            
            return keywordMap[categoryName] || [];
        }
        
        // „ÇØ„Ç§„ÉÉ„ÇØ„Éú„Çø„É≥„Çí„Éè„Ç§„É©„Ç§„Éà
        
        // Ë¶ÅÁ¥Ñ„ÇíË°®Á§∫
        function displaySummary(analysis) {
            const summarySection = document.getElementById('summarySection');
            summarySection.classList.add('active');
            
            // Good
            const goodEl = document.getElementById('summaryGood');
            const goodCommentEl = document.getElementById('commentGood');
            if (analysis.good.length > 0) {
                goodEl.textContent = analysis.good.map(s => '„Éª' + s).join('\n');
                goodCommentEl.textContent = generateAIComment('good', analysis.good);
            } else {
                goodEl.textContent = 'Ôºà„Å™„ÅóÔºâ';
                goodCommentEl.textContent = '';
            }
            
            // More
            const moreEl = document.getElementById('summaryMore');
            const moreCommentEl = document.getElementById('commentMore');
            if (analysis.more.length > 0) {
                moreEl.textContent = analysis.more.map(s => '„Éª' + s).join('\n');
                moreCommentEl.textContent = generateAIComment('more', analysis.more);
            } else {
                moreEl.textContent = 'Ôºà„Å™„ÅóÔºâ';
                moreCommentEl.textContent = '';
            }
            
            // Worry
            const worryEl = document.getElementById('summaryWorry');
            const worryCommentEl = document.getElementById('commentWorry');
            if (analysis.worry.length > 0) {
                worryEl.textContent = analysis.worry.map(s => '„Éª' + s).join('\n');
                worryCommentEl.textContent = generateAIComment('worry', analysis.worry);
            } else {
                worryEl.textContent = 'Ôºà„Å™„ÅóÔºâ';
                worryCommentEl.textContent = '';
            }
            
            // Task Must
            const taskMustEl = document.getElementById('summaryTaskMust');
            const taskMustCommentEl = document.getElementById('commentTaskMust');
            if (analysis.taskMust && analysis.taskMust.length > 0) {
                taskMustEl.textContent = analysis.taskMust.map(s => '„Éª' + s).join('\n');
                taskMustCommentEl.textContent = generateAIComment('taskMust', analysis.taskMust);
            } else {
                taskMustEl.textContent = 'Ôºà„Å™„ÅóÔºâ';
                taskMustCommentEl.textContent = '';
            }
            
            // Task Want
            const taskWantEl = document.getElementById('summaryTaskWant');
            const taskWantCommentEl = document.getElementById('commentTaskWant');
            if (analysis.taskWant && analysis.taskWant.length > 0) {
                taskWantEl.textContent = analysis.taskWant.map(s => '„Éª' + s).join('\n');
                taskWantCommentEl.textContent = generateAIComment('taskWant', analysis.taskWant);
            } else {
                taskWantEl.textContent = 'Ôºà„Å™„ÅóÔºâ';
                taskWantCommentEl.textContent = '';
            }
        }
        
        // ================================
        // AI Backend Integration
        // ================================
        
        var BACKEND_URL = 'https://lifelog-backend.vercel.app';
        
        // „Éê„ÉÉ„ÇØ„Ç®„É≥„ÉâAPIÊé•Á∂ö„ÉÜ„Çπ„Éà
        async function testBackendAPI() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/test`);
                const data = await response.json();
                console.log('‚úÖ Backend API connection successful:', data);
                return data.success;
            } catch (error) {
                console.error('‚ùå Backend API connection failed:', error);
                return false;
            }
        }
        
        // AIÂàÜÊûêÊ©üËÉΩ
        async function analyzeWithAI(text, category, type = 'journal') {
            try {
                const response = await fetch(`${BACKEND_URL}/api/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text || '',
                        category: category,
                        type: type
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ AI Analysis result:', data);
                return data;
            } catch (error) {
                console.error('‚ùå AI Analysis failed:', error);
                return null;
            }
        }
        
        // AIÂàÜÊûê‰ªò„Åç„Ç∏„É£„Éº„Éä„É´‰øùÂ≠ò
        async function saveJournalWithAI() {
            const text = document.getElementById('journalInput').value.trim();
            const category = window.selectedJournalCategory || 'Êó•Ë®ò';
            
            if (!text) {
                alert('ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // „Éú„Çø„É≥„ÇíAIÂàÜÊûê‰∏≠„Å´Â§âÊõ¥
            const saveBtn = document.querySelector('.add-button[onclick="saveJournalWithAI()"]');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'ü§ñ AIÂàÜÊûê‰∏≠...';
            saveBtn.disabled = true;
            
            try {
                // AIÂàÜÊûê„ÇíÂÆüË°å
                const aiResult = await analyzeWithAI(text, category, 'journal');
                
                // „Ç∏„É£„Éº„Éä„É´„Éá„Éº„Çø„Çí‰ΩúÊàê
                const journal = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    category: category,
                    text: text || '',
                    aiAnalysis: aiResult ? aiResult.analysis : null
                };
                
                // LocalStorage„Å´‰øùÂ≠ò
                const journals = JSON.parse(localStorage.getItem('journals') || '[]');
                journals.push(journal);
                localStorage.setItem('journals', JSON.stringify(journals));
                
                // ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢
                document.getElementById('journalInput').value = '';
                window.selectedJournalCategory = 'Êó•Ë®ò';
                
                // „Ç´„ÉÜ„Ç¥„É™„Éú„Çø„É≥„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
                document.querySelectorAll('.journal-category-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // „Ç∏„É£„Éº„Éä„É´„É≠„Ç∞„ÇíÂÜç„É¨„É≥„ÉÄ„É™„É≥„Ç∞
                renderJournalLogs();
                
                // AIÂàÜÊûêÁµêÊûú„ÇíË°®Á§∫
                if (aiResult && aiResult.analysis) {
                    showAIAnalysisResult(aiResult.analysis);
                } else {
                    alert('‚úÖ „Ç∏„É£„Éº„Éä„É´„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
                }
                
            } catch (error) {
                console.error('‚ùå Error saving journal:', error);
                alert('‚ùå „Ç∏„É£„Éº„Éä„É´„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                // „Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }
        
        // AIÂàÜÊûêÁµêÊûúË°®Á§∫„É¢„Éº„ÉÄ„É´
        function showAIAnalysisResult(analysis) {
            const sentiment = analysis.sentiment || '‰∏çÊòé';
            const summary = analysis.summary || '„Çµ„Éû„É™„Éº„Å™„Åó';
            const keywords = analysis.keywords || [];
            const suggestions = analysis.suggestions || [];
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <h3>ü§ñ AIÂàÜÊûêÁµêÊûú</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>üòä ÊÑüÊÉÖ:</strong> ${sentiment}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>üìù Ë¶ÅÁ¥Ñ:</strong><br>
                        ${summary}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>üîë „Ç≠„Éº„ÉØ„Éº„Éâ:</strong><br>
                        ${keywords.map(k => `<span style="display: inline-block; background: #e3f2fd; padding: 5px 10px; border-radius: 15px; margin: 3px;">${k}</span>`).join('')}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>üí° ÊèêÊ°à:</strong><br>
                        ${suggestions.map(s => `<div style="padding: 5px 0;">„Éª${s}</div>`).join('')}
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" onclick="this.closest('.modal').remove()" class="primary">Èñâ„Åò„Çã</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´„Éê„ÉÉ„ÇØ„Ç®„É≥„ÉâÊé•Á∂ö„ÉÜ„Çπ„Éà
        testBackendAPI();
        
        // ÂàùÊúüÂåñ
        loadMoneyCategories();
        renderActivityQuickButtons();
        renderActivityLogs();
        renderTodayTasks();
        updateGoalsMonthDisplay();
        renderGoals();
        updateReportMonthDisplay('activity');
        updateReportMonthDisplay('money');
        renderActivityReport();
        renderMoneyReport();
        initializeReportMonths();
        renderMoneyLogs();
        renderWeightLogs();
        renderJournalLogs();
        renderCalendar();
        
        // „Éá„Éï„Ç©„É´„Éà„ÅÆÊ∞óÂàÜ„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´
        selectMood('normal');
        
        setupVoiceRecognition('activityVoiceButton', 'activityDetailInput', false, true);
        setupVoiceRecognition('moneyVoiceButton', 'moneyInput');
        setupVoiceRecognition('weightVoiceButton', 'weightInput');
        setupManualCategoryVoiceRecognition('journalVoiceButton', 'journalInput');
        setupJournalInputListener();
    
function renderDonutChart(canvasId, legendId, items, key, suffix) {
  const canvas = document.getElementById(canvasId);
  const legendEl = document.getElementById(legendId);
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const total = items.reduce((s, i) => s + (Number(i[key]) || 0), 0);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!total) {
    if (legendEl) legendEl.innerHTML = '';
    return;
  }

  const palette = ['#4F46E5','#16A34A','#F59E0B','#0EA5E9','#EF4444','#A855F7','#64748B','#22C55E','#E11D48','#F97316'];
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const rOuter = 140;
  const rInner = 88;

  let start = -Math.PI / 2;
  items.forEach((it, idx) => {
    const v = Number(it[key]) || 0;
    if (v <= 0) return;
    const angle = (v / total) * Math.PI * 2;
    const end = start + angle;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.closePath();
    ctx.fillStyle = palette[idx % palette.length];
    ctx.fill();

    ctx.beginPath();
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.stroke();

    start = end;
  });

  ctx.beginPath();
  ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  ctx.fillStyle = '#111';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.font = '700 18px system-ui';
  ctx.fillText('ÂêàË®à', cx, cy - 10);
  ctx.font = '800 22px system-ui';
  ctx.fillText(`${total}${suffix}`, cx, cy + 18);

  if (legendEl) {
    legendEl.innerHTML = items
      .filter(it => (Number(it[key]) || 0) > 0)
      .map((it, idx) => {
        const v = Number(it[key]) || 0;
        const pct = Math.round((v / total) * 100);
        return `<div class="legend-row">
          <span class="legend-dot" style="background:${palette[idx % palette.length]}"></span>
          <span class="legend-cat">${it.cat}</span>
          <span class="legend-amt">${v}${suffix}</span>
          <span class="legend-pct">${pct}%</span>
        </div>`;
      }).join('');
  }
}

</script>
<!-- Ë°åÂãïÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
<div class="modal" id="editActivityModal">
<div class="modal-content">
<h3>‚úèÔ∏è Ë°åÂãï„ÇíÁ∑®ÈõÜ</h3>
<label>ÂÜÖÂÆπ</label>
<input id="editActivityText" placeholder="Ë°åÂãïÂÜÖÂÆπ" type="text"/>
<label>„Ç´„ÉÜ„Ç¥„É™</label>
<select id="editActivityCategory">
<!-- „Ç´„ÉÜ„Ç¥„É™„ÅØÂãïÁöÑ„Å´ÁîüÊàê -->
</select>
<label>ÈñãÂßãÊôÇÂàª</label>
<div style="display: flex; gap: 10px; margin-bottom: 10px;">
<input id="editActivityStartTime" style="flex: 1;" type="datetime-local"/>
<button class="quick-time-btn" onclick="setCurrentTimeToStart()" type="button">ÁèæÂú®ÊôÇÂàª</button>
</div>
<label>ÁµÇ‰∫ÜÊôÇÂàª</label>
<div style="display: flex; gap: 10px; margin-bottom: 10px;">
<input id="editActivityEndTime" style="flex: 1;" type="datetime-local"/>
<button class="quick-time-btn" onclick="setCurrentTimeToEnd()" type="button">ÁèæÂú®ÊôÇÂàª</button>
</div>
<!-- „ÇØ„Ç§„ÉÉ„ÇØÊôÇÈñìË™øÊï¥ -->
<div style="margin-bottom: 15px;">
<label style="display: block; margin-bottom: 5px;">„ÇØ„Ç§„ÉÉ„ÇØË™øÊï¥</label>
<div style="display: flex; gap: 5px; flex-wrap: wrap;">
<button class="quick-adjust-btn" onclick="adjustEndTime(5)" type="button">+5ÂàÜ</button>
<button class="quick-adjust-btn" onclick="adjustEndTime(15)" type="button">+15ÂàÜ</button>
<button class="quick-adjust-btn" onclick="adjustEndTime(30)" type="button">+30ÂàÜ</button>
<button class="quick-adjust-btn" onclick="adjustEndTime(60)" type="button">+1ÊôÇÈñì</button>
<button class="quick-adjust-btn" onclick="adjustEndTime(-5)" type="button">-5ÂàÜ</button>
<button class="quick-adjust-btn" onclick="adjustEndTime(-15)" type="button">-15ÂàÜ</button>
</div>
</div>
<!-- ÊâÄË¶ÅÊôÇÈñìË°®Á§∫ -->
<div id="durationDisplay" style="padding: 10px; background: #f0f0f0; border-radius: 5px; margin-bottom: 15px; text-align: center; font-weight: bold;">
                ÊâÄË¶ÅÊôÇÈñì: <span id="calculatedDuration">--</span>
</div>
<div class="modal-actions">
<button onclick="closeEditActivityModal()" type="button">„Ç≠„É£„É≥„Çª„É´</button>
<button class="primary" onclick="saveEditActivity()" type="button">‰øùÂ≠ò</button>
</div>
</div>
</div>
<!-- „ÅäÈáëÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
<div class="modal" id="editMoneyModal">
<div class="modal-content">
<div class="modal-header">
<h3>üí∞ „ÅäÈáë„ÅÆË®òÈå≤„ÇíÁ∑®ÈõÜ</h3>
<button class="modal-close" onclick="closeEditMoneyModal()">√ó</button>
</div>
<div class="modal-body">
<div class="form-group">
<label>ÂÜÖÂÆπ</label>
<input class="input-field" id="editMoneyText" type="text"/>
</div>
<div class="form-group">
<label>„Ç´„ÉÜ„Ç¥„É™</label>
<select class="input-field" id="editMoneyCategory">
<!-- „Ç´„ÉÜ„Ç¥„É™„ÅåÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
</select>
</div>
<div class="form-group">
<label>ÈáëÈ°ç</label>
<input class="input-field" id="editMoneyAmount" placeholder="ÂèéÂÖ•„ÅØÊ≠£„ÅÆÊï∞„ÄÅÊîØÂá∫„ÅØË≤†„ÅÆÊï∞" type="number"/>
</div>
<div class="form-group">
<label>Ë®òÈå≤Êó•ÊôÇ</label>
<input class="input-field" id="editMoneyTimestamp" type="datetime-local"/>
</div>
</div>
<div class="modal-footer">
<button class="btn-secondary" onclick="closeEditMoneyModal()">„Ç≠„É£„É≥„Çª„É´</button>
<button class="btn-primary" onclick="saveMoneyEdit()">üíæ ‰øùÂ≠ò</button>
</div>
</div>
</div>
<style>
        .quick-time-btn, .quick-adjust-btn {
            padding: 8px 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .quick-time-btn:hover, .quick-adjust-btn:hover {
            background: #45a049;
        }

        .quick-adjust-btn {
            background: #2196F3;
        }

        .quick-adjust-btn:hover {
            background: #0b7dda;
        }
    
/* ===== FIX: ÁõÆÊ®ô„Çø„ÉñÔºàÊúàÈÅ∏ÊäûÔºâ„ÅÆÂÆü„ÇØ„É©„Çπ„Å´Âêà„Çè„Åõ„Å¶ÁôΩÈªíÂåñ ===== */
#goals .month-selector-section{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:20px;
  margin-bottom:20px;
  padding:15px;
  background:#ffffff !important;
  border:2px solid #000000;
  border-radius:12px;
}

#goals .month-nav-button{
  padding:10px 18px;
  background:#ffffff !important;
  border:2px solid #000000 !important;
  border-radius:10px;
  font-size:16px;
  font-weight:700;
  color:#000000 !important;
  cursor:pointer;
  transition:background 0.2s ease;
}

#goals .month-nav-button:hover{ background:#e8e8e8 !important; }

#goals .current-month-display{
  font-size:22px;
  font-weight:800;
  color:#000000 !important;
  min-width:180px;
  text-align:center;
}

</style>

<!-- Ë°åÂãï„Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
<div class="modal" id="activityCategoryEditModal">
  <div class="modal-content">
    <h3>‚è±Ô∏è Ë°åÂãï„Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜ</h3>
    <div class="category-edit-list" id="activityCategoryEditList">
      <!-- „Ç´„ÉÜ„Ç¥„É™„É™„Çπ„Éà„ÅØJavaScript„ÅßÁîüÊàê -->
    </div>
    <div class="add-category-section">
      <h4>Êñ∞„Åó„ÅÑ„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†</h4>
      <div class="form-row">
        <input class="input-field-small" id="newActivityCategoryEmoji" maxlength="2" placeholder="ÁµµÊñáÂ≠ó" type="text"/>
        <input class="input-field" id="newActivityCategoryName" placeholder="„Ç´„ÉÜ„Ç¥„É™Âêç" type="text"/>
        <button class="btn-primary-small" onclick="addActivityCategory()">‚ûï ËøΩÂä†</button>
      </div>
    </div>
    <div class="modal-buttons">
      <button class="btn-secondary" onclick="closeActivityCategoryEditModal()">Èñâ„Åò„Çã</button>
    </div>
  </div>
</div>

<!-- „ÅäÈáë„Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
<div class="modal" id="moneyCategoryEditModal">
<div class="modal-content">
<h3>üí∏ „Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜ</h3>
<div class="category-edit-list" id="categoryEditList">
<!-- „Ç´„ÉÜ„Ç¥„É™„É™„Çπ„Éà„ÅØJavaScript„ÅßÁîüÊàê -->
</div>
<div class="add-category-section">
<h4>Êñ∞„Åó„ÅÑ„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†</h4>
<div class="form-row">
<input class="input-field-small" id="newCategoryEmoji" maxlength="2" placeholder="ÁµµÊñáÂ≠ó" type="text"/>
<input class="input-field" id="newCategoryName" placeholder="„Ç´„ÉÜ„Ç¥„É™Âêç" type="text"/>
<button class="btn-primary-small" onclick="addMoneyCategory()">‚ûï ËøΩÂä†</button>
</div>
</div>
<div class="modal-buttons">
<button class="btn-secondary" onclick="closeMoneyCategoryEditModal()">Èñâ„Åò„Çã</button>
</div>
</div>
</div>
<script>
// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñÂá¶ÁêÜ
window.addEventListener('DOMContentLoaded', function() {
    console.log('üì± „Ç¢„Éó„É™ÂàùÊúüÂåñÈñãÂßã');
    
    // „Ç∏„É£„Éº„Éä„É´Â±•Ê≠¥„ÇíË°®Á§∫
    renderJournalLogs();
    console.log('‚úÖ „Ç∏„É£„Éº„Éä„É´Â±•Ê≠¥„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü');
    
    // „ÅäÈáë„ÅÆÂ±•Ê≠¥„ÇíË°®Á§∫
    renderMoneyLogs();
    console.log('‚úÖ „ÅäÈáëÂ±•Ê≠¥„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü');

    // „Ç´„ÉÜ„Ç¥„É™UI„ÇíÂàùÊúüÂåñ
    renderMoneyCategories();
    renderActivityCategories();
    
    // „Éá„Éï„Ç©„É´„Éà„Çø„Éñ„ÇíË®≠ÂÆö
    switchTab('activity');
    console.log('‚úÖ „Éá„Éï„Ç©„É´„Éà„Çø„Éñ„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Åü');
    
    // „Éê„ÉÉ„ÇØ„Ç®„É≥„ÉâAPI„ÉÜ„Çπ„Éà
    testBackendAPI();
});

function renderDonutChart(canvasId, legendId, items, key, suffix) {
  const canvas = document.getElementById(canvasId);
  const legendEl = document.getElementById(legendId);
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const total = items.reduce((s, i) => s + (Number(i[key]) || 0), 0);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!total) {
    if (legendEl) legendEl.innerHTML = '';
    return;
  }

  const palette = ['#4F46E5','#16A34A','#F59E0B','#0EA5E9','#EF4444','#A855F7','#64748B','#22C55E','#E11D48','#F97316'];
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const rOuter = 140;
  const rInner = 88;

  let start = -Math.PI / 2;
  items.forEach((it, idx) => {
    const v = Number(it[key]) || 0;
    if (v <= 0) return;
    const angle = (v / total) * Math.PI * 2;
    const end = start + angle;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.closePath();
    ctx.fillStyle = palette[idx % palette.length];
    ctx.fill();

    ctx.beginPath();
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.stroke();

    start = end;
  });

  ctx.beginPath();
  ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  ctx.fillStyle = '#111';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.font = '700 18px system-ui';
  ctx.fillText('ÂêàË®à', cx, cy - 10);
  ctx.font = '800 22px system-ui';
  ctx.fillText(`${total}${suffix}`, cx, cy + 18);

  if (legendEl) {
    legendEl.innerHTML = items
      .filter(it => (Number(it[key]) || 0) > 0)
      .map((it, idx) => {
        const v = Number(it[key]) || 0;
        const pct = Math.round((v / total) * 100);
        return `<div class="legend-row">
          <span class="legend-dot" style="background:${palette[idx % palette.length]}"></span>
          <span class="legend-cat">${it.cat}</span>
          <span class="legend-amt">${v}${suffix}</span>
          <span class="legend-pct">${pct}%</span>
        </div>`;
      }).join('');
  }
}

</script>
<script>
// Ë°åÂãï„Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû
window.selectedActivityCategoryName = '';

function selectActivityCategory(category) {
    console.log('Ë°åÂãï„Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû:', category);
    window.selectedActivityCategoryName = category;
    // ÁµµÊñáÂ≠ó„ÇÇ‰øùÊåÅÔºàÁ∑®ÈõÜÂæå„ÇÇÊï¥Âêà„ÅåÂèñ„Çå„Çã„Çà„ÅÜ„Å´ activityCategories „Åã„ÇâÂºï„ÅèÔºâ
    const catObj = (Array.isArray(activityCategories) ? activityCategories : []).find(c => c && c.name === category);
    window.selectedActivityCategoryEmoji = catObj ? (catObj.emoji || null) : null;

    
    // Ââç„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
    document.querySelectorAll('.category-selection-section .category-btn').forEach(btn => {
        btn.style.background = 'white';
        btn.style.borderColor = '#ddd';
        btn.style.fontWeight = 'normal';
    });
    
    // Êñ∞„Åó„ÅÑÈÅ∏Êäû„ÇíÂº∑Ë™ø
    const btn = document.querySelector(`.category-selection-section .category-btn[data-category="${category}"]`);
    if (btn) {
        btn.style.background = '#e3f2fd';
        btn.style.borderColor = '#2196f3';
        btn.style.fontWeight = 'bold';
    }
    
    // ÈÅ∏ÊäûË°®Á§∫„ÇíÊõ¥Êñ∞
    const display = document.getElementById('selectedActivityCategory');
    if (display) {
        display.textContent = `ÈÅ∏Êäû‰∏≠: ${category}`;
        display.style.color = '#2196f3';
        display.style.fontWeight = 'bold';
    }
}
window.selectActivityCategory = selectActivityCategory;



function renderDonutChart(canvasId, legendId, items, key, suffix) {
  const canvas = document.getElementById(canvasId);
  const legendEl = document.getElementById(legendId);
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const total = items.reduce((s, i) => s + (Number(i[key]) || 0), 0);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!total) {
    if (legendEl) legendEl.innerHTML = '';
    return;
  }

  const palette = ['#4F46E5','#16A34A','#F59E0B','#0EA5E9','#EF4444','#A855F7','#64748B','#22C55E','#E11D48','#F97316'];
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const rOuter = 140;
  const rInner = 88;

  let start = -Math.PI / 2;
  items.forEach((it, idx) => {
    const v = Number(it[key]) || 0;
    if (v <= 0) return;
    const angle = (v / total) * Math.PI * 2;
    const end = start + angle;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.closePath();
    ctx.fillStyle = palette[idx % palette.length];
    ctx.fill();

    ctx.beginPath();
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.stroke();

    start = end;
  });

  ctx.beginPath();
  ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  ctx.fillStyle = '#111';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.font = '700 18px system-ui';
  ctx.fillText('ÂêàË®à', cx, cy - 10);
  ctx.font = '800 22px system-ui';
  ctx.fillText(`${total}${suffix}`, cx, cy + 18);

  if (legendEl) {
    legendEl.innerHTML = items
      .filter(it => (Number(it[key]) || 0) > 0)
      .map((it, idx) => {
        const v = Number(it[key]) || 0;
        const pct = Math.round((v / total) * 100);
        return `<div class="legend-row">
          <span class="legend-dot" style="background:${palette[idx % palette.length]}"></span>
          <span class="legend-cat">${it.cat}</span>
          <span class="legend-amt">${v}${suffix}</span>
          <span class="legend-pct">${pct}%</span>
        </div>`;
      }).join('');
  }
}

</script>
<script>
// üåê ÂÖ®„Å¶„ÅÆÈñ¢Êï∞„Çí window „Å´ÂÖ¨ÈñãÔºàinline onclick ÂØæÂøúÔºâ
(function() {
    'use strict';
    
    // „Çø„ÉñÂàá„ÇäÊõø„Åà
    if (typeof switchTab === 'function') window.switchTab = switchTab;
    
    // Ê∞óÂàÜÈÅ∏Êäû
    if (typeof selectMood === 'function') window.selectMood = selectMood;
    
    // Ë°åÂãïË®òÈå≤
    if (typeof addActivity === 'function') window.addActivity = addActivity;
    if (typeof deleteActivity === 'function') window.deleteActivity = deleteActivity;
    if (typeof editActivity === 'function') window.editActivity = editActivity;
    if (typeof endActivity === 'function') window.endActivity = endActivity;
    if (typeof selectActivityCategory === 'function') window.selectActivityCategory = selectActivityCategory;
    if (typeof selectCategory === 'function') window.selectCategory = selectCategory;
    
    // „ÅäÈáëË®òÈå≤
    if (typeof addMoney === 'function') window.addMoney = addMoney;
    if (typeof deleteMoney === 'function') window.deleteMoney = deleteMoney;
    if (typeof editMoney === 'function') window.editMoney = editMoney;
    if (typeof selectMoneyType === 'function') window.selectMoneyType = selectMoneyType;
    if (typeof selectMoneyCategory === 'function') window.selectMoneyCategory = selectMoneyCategory;
    if (typeof editMoneyCategories === 'function') window.editMoneyCategories = editMoneyCategories;
    if (typeof deleteMoneyCategoryItem === 'function') window.deleteMoneyCategoryItem = deleteMoneyCategoryItem;
    
    // ÁõÆÊ®ôÁÆ°ÁêÜ
    if (typeof addGoal === 'function') window.addGoal = addGoal;
    if (typeof deleteGoal === 'function') window.deleteGoal = deleteGoal;
    if (typeof toggleGoalComplete === 'function') window.toggleGoalComplete = toggleGoalComplete;
    if (typeof recordProgress === 'function') window.recordProgress = recordProgress;
    if (typeof changeGoalsMonth === 'function') window.changeGoalsMonth = changeGoalsMonth;
    if (typeof generateGoalsFeedback === 'function') window.generateGoalsFeedback = generateGoalsFeedback;
    if (typeof renderGoals === 'function') window.renderGoals = renderGoals;
    if (typeof updateGoalsMonthDisplay === 'function') window.updateGoalsMonthDisplay = updateGoalsMonthDisplay;
    
    // „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ
    if (typeof addCategory === 'function') window.addCategory = addCategory;
    if (typeof openCategoryManager === 'function') window.openCategoryManager = openCategoryManager;
    if (typeof closeCategoryManager === 'function') window.closeCategoryManager = closeCategoryManager;
    
    // „Ç∏„É£„Éº„Éä„É´
    if (typeof saveJournalWithAI === 'function') window.saveJournalWithAI = saveJournalWithAI;
    if (typeof renderJournalLogs === 'function') window.renderJournalLogs = renderJournalLogs;
    
    // „Ç´„É¨„É≥„ÉÄ„Éº„Éª„É¨„Éù„Éº„Éà
    if (typeof changeMonth === 'function') window.changeMonth = changeMonth;
    if (typeof changeReportMonth === 'function') window.changeReportMonth = changeReportMonth;
    if (typeof refreshTodayTasks === 'function') window.refreshTodayTasks = refreshTodayTasks;
    
    // Èü≥Â£∞ÂÖ•Âäõ
    if (typeof startJournalVoice === 'function') window.startJournalVoice = startJournalVoice;
    if (typeof stopJournalVoice === 'function') window.stopJournalVoice = stopJournalVoice;
    
    // Á∑®ÈõÜ„ÉÄ„Ç§„Ç¢„É≠„Ç∞
    if (typeof saveActivityEdit === 'function') window.saveActivityEdit = saveActivityEdit;
    if (typeof cancelActivityEdit === 'function') window.cancelActivityEdit = cancelActivityEdit;
    if (typeof saveMoneyEdit === 'function') window.saveMoneyEdit = saveMoneyEdit;
    if (typeof cancelMoneyEdit === 'function') window.cancelMoneyEdit = cancelMoneyEdit;
    
    console.log('‚úÖ ÂÖ®„Å¶„ÅÆÈñ¢Êï∞„Çí window „Å´ÂÖ¨Èñã„Åó„Åæ„Åó„Åü');
})();

function renderDonutChart(canvasId, legendId, items, key, suffix) {
  const canvas = document.getElementById(canvasId);
  const legendEl = document.getElementById(legendId);
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const total = items.reduce((s, i) => s + (Number(i[key]) || 0), 0);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!total) {
    if (legendEl) legendEl.innerHTML = '';
    return;
  }

  const palette = ['#4F46E5','#16A34A','#F59E0B','#0EA5E9','#EF4444','#A855F7','#64748B','#22C55E','#E11D48','#F97316'];
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const rOuter = 140;
  const rInner = 88;

  let start = -Math.PI / 2;
  items.forEach((it, idx) => {
    const v = Number(it[key]) || 0;
    if (v <= 0) return;
    const angle = (v / total) * Math.PI * 2;
    const end = start + angle;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.closePath();
    ctx.fillStyle = palette[idx % palette.length];
    ctx.fill();

    ctx.beginPath();
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.stroke();

    start = end;
  });

  ctx.beginPath();
  ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  ctx.fillStyle = '#111';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.font = '700 18px system-ui';
  ctx.fillText('ÂêàË®à', cx, cy - 10);
  ctx.font = '800 22px system-ui';
  ctx.fillText(`${total}${suffix}`, cx, cy + 18);

  if (legendEl) {
    legendEl.innerHTML = items
      .filter(it => (Number(it[key]) || 0) > 0)
      .map((it, idx) => {
        const v = Number(it[key]) || 0;
        const pct = Math.round((v / total) * 100);
        return `<div class="legend-row">
          <span class="legend-dot" style="background:${palette[idx % palette.length]}"></span>
          <span class="legend-cat">${it.cat}</span>
          <span class="legend-amt">${v}${suffix}</span>
          <span class="legend-pct">${pct}%</span>
        </div>`;
      }).join('');
  }
}

</script>
<script>
/* ===== Window exposure safety (v35.4) ===== */
try{
  if (typeof switchTab === 'function') window.switchTab = switchTab;
  if (typeof addGoal === 'function') window.addGoal = addGoal;
  if (typeof changeGoalsMonth === 'function') window.changeGoalsMonth = changeGoalsMonth;
  if (typeof refreshTodayTasks === 'function') window.refreshTodayTasks = refreshTodayTasks;
  if (typeof selectActivityCategory === 'function') window.selectActivityCategory = selectActivityCategory;
} catch(e){ console.warn('window exposure failed', e); }

function renderDonutChart(canvasId, legendId, items, key, suffix) {
  const canvas = document.getElementById(canvasId);
  const legendEl = document.getElementById(legendId);
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const total = items.reduce((s, i) => s + (Number(i[key]) || 0), 0);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!total) {
    if (legendEl) legendEl.innerHTML = '';
    return;
  }

  const palette = ['#4F46E5','#16A34A','#F59E0B','#0EA5E9','#EF4444','#A855F7','#64748B','#22C55E','#E11D48','#F97316'];
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const rOuter = 140;
  const rInner = 88;

  let start = -Math.PI / 2;
  items.forEach((it, idx) => {
    const v = Number(it[key]) || 0;
    if (v <= 0) return;
    const angle = (v / total) * Math.PI * 2;
    const end = start + angle;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.closePath();
    ctx.fillStyle = palette[idx % palette.length];
    ctx.fill();

    ctx.beginPath();
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.stroke();

    start = end;
  });

  ctx.beginPath();
  ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  ctx.fillStyle = '#111';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.font = '700 18px system-ui';
  ctx.fillText('ÂêàË®à', cx, cy - 10);
  ctx.font = '800 22px system-ui';
  ctx.fillText(`${total}${suffix}`, cx, cy + 18);

  if (legendEl) {
    legendEl.innerHTML = items
      .filter(it => (Number(it[key]) || 0) > 0)
      .map((it, idx) => {
        const v = Number(it[key]) || 0;
        const pct = Math.round((v / total) * 100);
        return `<div class="legend-row">
          <span class="legend-dot" style="background:${palette[idx % palette.length]}"></span>
          <span class="legend-cat">${it.cat}</span>
          <span class="legend-amt">${v}${suffix}</span>
          <span class="legend-pct">${pct}%</span>
        </div>`;
      }).join('');
  }
}

</script>
<script>
/* ===== Goals module override (v35.5) : keep current UI, fix TDZ, keep logs ===== */
(function(){
  'use strict';

  const STORAGE_KEY = 'monthlyGoals';

  // Always safe month (YYYY-MM)
  function nowMonth(){
    return monthKeyFromDate(new Date());
  }

  // Global state (avoid TDZ by using window props)
  if (typeof window.currentMonth === 'undefined' || !window.currentMonth) {
    window.currentMonth = nowMonth();
  }
  if (typeof window.selectedGoalsMonth === 'undefined' || !window.selectedGoalsMonth) {
    window.selectedGoalsMonth = window.currentMonth;
  }

  function safeParse(str, fallback){
    try{
      if(!str) return fallback;
      const v = JSON.parse(str);
      return Array.isArray(v) ? v : fallback;
    }catch(e){
      return fallback;
    }
  }

  function loadGoals(){
    return safeParse(localStorage.getItem(STORAGE_KEY), []);
  }

  function saveGoals(goals){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(goals));
  }

  function fmtMonth(ym){
    const parts = String(ym).split('-');
    const y = Number(parts[0] || 0);
    const m = Number(parts[1] || 0);
    return `${y}Âπ¥${m}Êúà`;
  }

  function setText(id, text){
    const el = document.getElementById(id);
    if(el) el.textContent = text;
  }

  function setStatus(msg, isError){
    const el = document.getElementById('goalStatus');
    if(!el) return;
    el.textContent = msg || '';
    el.style.color = isError ? '#b00020' : '#666';
    if(msg){
      setTimeout(()=>{ if(el.textContent === msg) el.textContent=''; }, 2400);
    }
  }

  function ensureMonth(){
    if (!window.selectedGoalsMonth) window.selectedGoalsMonth = window.currentMonth || nowMonth();
    if (!window.currentMonth) window.currentMonth = nowMonth();
  }

  function updateGoalsMonthDisplay(){
    ensureMonth();
    setText('currentGoalsMonth', fmtMonth(window.selectedGoalsMonth));
    const title = document.getElementById('goalsListTitle');
    if(title){
      title.textContent = (window.selectedGoalsMonth === window.currentMonth)
        ? '‰ªäÊúà„ÅÆÁõÆÊ®ô„É™„Çπ„Éà'
        : `${fmtMonth(window.selectedGoalsMonth)}„ÅÆÁõÆÊ®ô„É™„Çπ„Éà`;
    }
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#39;");
  }

  function renderGoals(){
    ensureMonth();
    const list = document.getElementById('goalsList');
    if(!list) return;

    const goals = loadGoals();
    const current = goals.filter(g => g && g.month === window.selectedGoalsMonth);

    if(current.length === 0){
      list.innerHTML = `<div class="empty-state">ÁõÆÊ®ô„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ‰∏ä„ÅÆ„Éï„Ç©„Éº„É†„Åã„ÇâËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>`;
      return;
    }

    list.innerHTML = current.map(goal=>{
      const level = Number(goal.currentLevel ?? 0);
      const pct = Math.max(0, Math.min(10, level)) * 10;
      const completed = !!goal.completed;

      return `
        <div class="goal-item ${completed ? 'completed' : ''}">
          <div class="goal-header">
            <div class="goal-title">${escapeHtml(goal.text || '')}</div>
            <div class="goal-category">${escapeHtml(goal.category || '„Åù„ÅÆ‰ªñ')}</div>
          </div>

          <div class="goal-progress-container">
            <div class="progress-bar-container">
              <div class="progress-bar-fill" style="width:${pct}%"></div>
            </div>
            <div class="progress-text">Lv.${level}/10Ôºà${pct}%Ôºâ</div>
          </div>

          <div class="goal-progress-input">
            <select id="level-${goal.id}" class="progress-level-select">
              ${Array.from({length:11},(_,i)=>`<option value="${i}" ${i===level?'selected':''}>Lv.${i}</option>`).join('')}
            </select>
            <input id="comment-${goal.id}" class="progress-comment-input" placeholder="„Ç≥„É°„É≥„ÉàÔºà‰æãÔºöÂü∫Á§é„Ç≥„Éº„Éâ„ÅÆ‰ΩúÊàêÔºâ" maxlength="120" />
            <button class="btn-primary" onclick="window._goalAddProgress(${goal.id})">Ë®òÈå≤</button>
          </div>

          <div class="goal-actions">
            <button class="btn-secondary" onclick="window._goalToggle(${goal.id})">‚úÖ ÂÆå‰∫ÜÂàáÊõø</button>
            <button class="btn-secondary" onclick="window._goalDelete(${goal.id})">üóëÔ∏è ÂâäÈô§</button>
          </div>

          <details class="goal-history">
            <summary>üìö ÈÄ≤ÊçóÂ±•Ê≠¥</summary>
            <div class="goal-history-list">
              ${renderHistory(goal)}
            </div>
          </details>
        </div>
      `;
    }).join('');
  }

  function renderHistory(goal){
    const hist = Array.isArray(goal.progress) ? goal.progress : [];
    if(hist.length === 0){
      return `<div class="history-empty">„Åæ„Å†Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>`;
    }
    return hist.slice(0, 30).map(h=>{
      return `<div class="history-item">
        <div class="history-meta">üìÖ ${escapeHtml(h.date || '')} Ôºè üì∂ Lv.${Number(h.level ?? 0)}</div>
        <div class="history-comment">${escapeHtml(h.comment || '')}</div>
      </div>`;
    }).join('');
  }

  function renderGoalsProgress(){
    ensureMonth();
    const container = document.getElementById('goalsProgress');
    if(!container) return;

    const goals = loadGoals();
    const current = goals.filter(g => g && g.month === window.selectedGoalsMonth);

    if(current.length === 0){
      container.innerHTML = `<div class="empty-state">ÁõÆÊ®ô„ÇíËøΩÂä†„Åô„Çã„Å®ÈõÜË®à„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ</div>`;
      return;
    }

    const total = current.length;
    const completed = current.filter(g=>!!g.completed).length;
    const pct = Math.round((completed/total)*100);

    container.innerHTML = `
      <div class="summary-row">
        <div class="summary-chip">‚úÖ ÂÆå‰∫Ü ${completed}/${total}</div>
        <div class="summary-chip">üìà ÈÅîÊàêÁéá ${pct}%</div>
      </div>
      <div class="progress-bar-container" style="margin-top:10px">
        <div class="progress-bar-fill" style="width:${pct}%"></div>
      </div>
    `;
  }

  function addGoal(){
    ensureMonth();
    const input = document.getElementById('goalInput');
    const sel = document.getElementById('goalCategory');
    const text = (input?.value || '').trim();
    const category = sel?.value || '„Åù„ÅÆ‰ªñ';

    if(!text){
      setStatus('‚ùå ÁõÆÊ®ô„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', true);
      return;
    }

    const goals = loadGoals();
    const goal = {
      id: Date.now(),
      text,
      category,
      month: window.selectedGoalsMonth,   // ‚Üê „Åì„Åì„ÅåÈáçË¶ÅÔºàË°®Á§∫‰∏≠„ÅÆÊúà„Å´ËøΩÂä†Ôºâ
      createdAt: new Date().toISOString(),
      completed: false,
      currentLevel: 0,
      progress: []
    };
    goals.unshift(goal);
    saveGoals(goals);

    if(input) input.value = '';
    setStatus('‚úì ÁõÆÊ®ô„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', false);
    renderGoals();
    renderGoalsProgress();
  }

  function changeGoalsMonth(offset){
    ensureMonth();
    const [y,m] = String(window.selectedGoalsMonth).split('-').map(Number);
    const d = new Date(y, (m-1)+offset, 1);
    window.selectedGoalsMonth = monthKeyFromDate(d);
    updateGoalsMonthDisplay();
    renderGoals();
    renderGoalsProgress();
  }

  function goalDelete(id){
    if(!confirm('„Åì„ÅÆÁõÆÊ®ô„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
    const goals = loadGoals().filter(g => g && g.id !== id);
    saveGoals(goals);
    renderGoals();
    renderGoalsProgress();
  }

  function goalToggle(id){
    const goals = loadGoals();
    const g = goals.find(x => x && x.id === id);
    if(!g) return;
    g.completed = !g.completed;
    saveGoals(goals);
    renderGoals();
    renderGoalsProgress();
  }

  function goalAddProgress(id){
    const goals = loadGoals();
    const g = goals.find(x => x && x.id === id);
    if(!g) return;

    const levelEl = document.getElementById(`level-${id}`);
    const commentEl = document.getElementById(`comment-${id}`);
    const level = parseInt(levelEl?.value ?? '0', 10);
    const comment = (commentEl?.value || '').trim();

    if(Number.isNaN(level) || level < 0 || level > 10){
      alert('„É¨„Éô„É´„ÅØ0„Äú10„ÅßÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      return;
    }
    if(!comment){
      alert('„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      return;
    }

    if(!Array.isArray(g.progress)) g.progress = [];
    g.progress.unshift({
      date: new Date().toISOString().slice(0,10),
      level,
      comment,
      timestamp: new Date().toISOString()
    });
    g.currentLevel = level;
    if(level === 10) g.completed = true;

    saveGoals(goals);
    if(commentEl) commentEl.value = '';
    setStatus('‚úì ÈÄ≤Êçó„ÇíË®òÈå≤„Åó„Åæ„Åó„Åü', false);
    renderGoals();
    renderGoalsProgress();
  }

  // Expose for inline onclick (existing UI)
  window.addGoal = addGoal;
  window.changeGoalsMonth = changeGoalsMonth;
  window.renderGoals = renderGoals;
  window.renderGoalsProgress = renderGoalsProgress;
  window.updateGoalsMonthDisplay = updateGoalsMonthDisplay;

  // helpers for buttons inside rendered list
  window._goalDelete = goalDelete;
  window._goalToggle = goalToggle;
  window._goalAddProgress = goalAddProgress;

  // First paint (in case Goals tab is default active)
  document.addEventListener('DOMContentLoaded', ()=>{
    updateGoalsMonthDisplay();
    renderGoals();
    renderGoalsProgress();
  });

})();

function renderDonutChart(canvasId, legendId, items, key, suffix) {
  const canvas = document.getElementById(canvasId);
  const legendEl = document.getElementById(legendId);
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const total = items.reduce((s, i) => s + (Number(i[key]) || 0), 0);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!total) {
    if (legendEl) legendEl.innerHTML = '';
    return;
  }

  const palette = ['#4F46E5','#16A34A','#F59E0B','#0EA5E9','#EF4444','#A855F7','#64748B','#22C55E','#E11D48','#F97316'];
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const rOuter = 140;
  const rInner = 88;

  let start = -Math.PI / 2;
  items.forEach((it, idx) => {
    const v = Number(it[key]) || 0;
    if (v <= 0) return;
    const angle = (v / total) * Math.PI * 2;
    const end = start + angle;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.closePath();
    ctx.fillStyle = palette[idx % palette.length];
    ctx.fill();

    ctx.beginPath();
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.stroke();

    start = end;
  });

  ctx.beginPath();
  ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  ctx.fillStyle = '#111';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.font = '700 18px system-ui';
  ctx.fillText('ÂêàË®à', cx, cy - 10);
  ctx.font = '800 22px system-ui';
  ctx.fillText(`${total}${suffix}`, cx, cy + 18);

  if (legendEl) {
    legendEl.innerHTML = items
      .filter(it => (Number(it[key]) || 0) > 0)
      .map((it, idx) => {
        const v = Number(it[key]) || 0;
        const pct = Math.round((v / total) * 100);
        return `<div class="legend-row">
          <span class="legend-dot" style="background:${palette[idx % palette.length]}"></span>
          <span class="legend-cat">${it.cat}</span>
          <span class="legend-amt">${v}${suffix}</span>
          <span class="legend-pct">${pct}%</span>
        </div>`;
      }).join('');
  }
}

</script>
<script>
/* ===== Level 2 (Module) scaffold v36.0 =====
   ÁõÆÁöÑ: Êó¢Â≠ò„ÅÆË¶ã„ÅüÁõÆ/Ê©üËÉΩ„ÅØÂ§â„Åà„Åö„ÄÅ‰ªäÂæå„ÅÆ‰øÆÊ≠£„Çí„Äå„É¢„Ç∏„É•„Éº„É´Âçò‰Ωç„Äç„ÅßËß¶„Çå„Çã„Çà„ÅÜ„Å´È™®Ê†º„ÇíËøΩÂä†„ÄÇ
   - core: month/storage/ui
   - modules: tab„Åî„Å®„ÅÆonShowÔºà„Çø„ÉñË°®Á§∫ÊôÇ„ÅÆÂÜçÊèèÁîªÔºâ
   - switchTab„Çí„É©„ÉÉ„Éó„Åó„Å¶modules[tabName].onShow„ÇíÂëº„Å∂
*/
(function(){
  'use strict';

  // ---------- core ----------
  const core = {};
  core.month = {
    keyFromDate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      return `${y}-${m}`;
    },
    keyNow(){ return this.keyFromDate(new Date()); },
    addMonths(ym, offset){
      const [y,m] = String(ym).split('-').map(Number);
      const d = new Date(y, (m-1)+offset, 1); // always day=1 to avoid month jump
      return this.keyFromDate(d);
    },
    fmtJP(ym){
      const [y,m] = String(ym).split('-').map(Number);
      return `${y}Âπ¥${m}Êúà`;
    }
  };

  core.storage = {
    safeParse(str, fallback){
      try{
        if(!str) return fallback;
        const v = JSON.parse(str);
        return v ?? fallback;
      }catch(e){
        return fallback;
      }
    },
    get(key, fallback){
      return this.safeParse(localStorage.getItem(key), fallback);
    },
    set(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }
  };

  core.ui = {
    byId(id){ return document.getElementById(id); },
    on(id, ev, fn){
      const el = this.byId(id);
      if(el) el.addEventListener(ev, fn);
    }
  };

  // ---------- app ----------
  const App = window.App = window.App || {};
  App.core = core;

  // Êó¢Â≠ò„ÅÆ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å∏„ÅÆÂèÇÁÖß„Çí„Åæ„Å®„ÇÅ„Å¶„Åä„ÅèÔºà‰ªäÂæå„ÅÆÊï¥ÁêÜ„Å´‰Ωø„Åà„ÇãÔºâ
  App.state = App.state || {};
  App.state.currentMonthKey = core.month.keyNow();

  // ---------- modules (tab per) ----------
  App.modules = App.modules || {};

  function callIfFn(name){
    const fn = window[name];
    if(typeof fn === 'function') fn();
  }

  // NOTE: Êó¢Â≠òÂÆüË£Ö„Å´Âêà„Çè„Åõ„Å¶onShow„Å†„ÅëÂÆöÁæ©ÔºàÊåôÂãï„ÅØÂ§â„Åà„Å™„ÅÑÔºâ
  App.modules.journal = {
    onShow(){ callIfFn('renderCalendar'); }
  };
  App.modules.reportActivity = {
    onShow(){ callIfFn('renderActivityReport'); }
  };
  App.modules.reportMoney = {
    onShow(){ callIfFn('renderMoneyReport'); }
  };
  App.modules.goals = {
    onShow(){
      // goalsÁ≥ª„ÅØÂ≠òÂú®„Åô„Çå„Å∞Âëº„Å∂ÔºàÁâàÂ∑Æ„Åå„ÅÇ„Å£„Å¶„ÇÇËêΩ„Å°„Å™„ÅÑ„Çà„ÅÜ„Å´Ôºâ
      if(typeof window.updateGoalsMonthDisplay === 'function') window.updateGoalsMonthDisplay();
      if(typeof window.renderGoals === 'function') window.renderGoals();
      if(typeof window.renderGoalsProgress === 'function') window.renderGoalsProgress();
    }
  };
  App.modules.activity = { onShow(){} };
  App.modules.money = { onShow(){} };

  // ---------- switchTab wrapper ----------
  const originalSwitchTab = window.switchTab;
  if(typeof originalSwitchTab === 'function'){
    window.switchTab = function(tabName){
      // ÂÖÉ„ÅÆÊåôÂãï
      originalSwitchTab(tabName);

      // „É¢„Ç∏„É•„Éº„É´„ÅÆonShow
      try{
        const mod = App.modules[tabName];
        if(mod && typeof mod.onShow === 'function') mod.onShow();
      }catch(e){
        console.warn('[App.modules] onShow error:', e);
      }
    };
  }

  // ---------- future: centralized init hook ----------
  document.addEventListener('DOMContentLoaded', ()=>{
    // Ëµ∑ÂãïÁõ¥Âæå„Å´„ÄÅ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„Éñ„Åå„ÅÇ„Çå„Å∞„Åù„ÅÆonShow„ÇíÂëº„Å∂
    const activeTab = document.querySelector('.tab-content.active');
    if(activeTab && activeTab.id && App.modules[activeTab.id]?.onShow){
      try{ App.modules[activeTab.id].onShow(); }catch(e){}
    }
  });
})();

function renderDonutChart(canvasId, legendId, items, key, suffix) {
  const canvas = document.getElementById(canvasId);
  const legendEl = document.getElementById(legendId);
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const total = items.reduce((s, i) => s + (Number(i[key]) || 0), 0);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!total) {
    if (legendEl) legendEl.innerHTML = '';
    return;
  }

  const palette = ['#4F46E5','#16A34A','#F59E0B','#0EA5E9','#EF4444','#A855F7','#64748B','#22C55E','#E11D48','#F97316'];
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const rOuter = 140;
  const rInner = 88;

  let start = -Math.PI / 2;
  items.forEach((it, idx) => {
    const v = Number(it[key]) || 0;
    if (v <= 0) return;
    const angle = (v / total) * Math.PI * 2;
    const end = start + angle;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.closePath();
    ctx.fillStyle = palette[idx % palette.length];
    ctx.fill();

    ctx.beginPath();
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.stroke();

    start = end;
  });

  ctx.beginPath();
  ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  ctx.fillStyle = '#111';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.font = '700 18px system-ui';
  ctx.fillText('ÂêàË®à', cx, cy - 10);
  ctx.font = '800 22px system-ui';
  ctx.fillText(`${total}${suffix}`, cx, cy + 18);

  if (legendEl) {
    legendEl.innerHTML = items
      .filter(it => (Number(it[key]) || 0) > 0)
      .map((it, idx) => {
        const v = Number(it[key]) || 0;
        const pct = Math.round((v / total) * 100);
        return `<div class="legend-row">
          <span class="legend-dot" style="background:${palette[idx % palette.length]}"></span>
          <span class="legend-cat">${it.cat}</span>
          <span class="legend-amt">${v}${suffix}</span>
          <span class="legend-pct">${pct}%</span>
        </div>`;
      }).join('');
  }
}

</script>
<script>
/* ===== v36.1 Goals Module (Phase 1) =====
   - ÁõÆÊ®ô„Å†„Åë„Çí App.modules.goals „Å´ÈõÜÁ¥ÑÔºàÂÜÖÈÉ®ÂÆüË£Ö„Çí„Åì„Åì„Å∏Ôºâ
   - Êó¢Â≠ò„ÅÆHTML/Ë¶ã„ÅüÁõÆ/‰øùÂ≠ò„Ç≠„Éº(monthlyGoals)„ÅØÁ∂≠ÊåÅ
   - ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„ÄÅÂΩìÈù¢„ÅØ window.addGoal Á≠â„ÅÆ„Ç∞„É≠„Éº„Éê„É´„ÇíËñÑ„ÅÑ„É©„ÉÉ„Éë„Éº„Å®„Åó„Å¶ÊÆã„Åô
*/
(function(){
  'use strict';

  const App = window.App = window.App || {};
  App.core = App.core || {};
  const core = App.core;

  // core.month „ÅåÁÑ°„ÅÑÂ†¥Âêà„ÅØÊúÄÂ∞èÂÆüË£ÖÔºà‰øùÈô∫Ôºâ
  core.month = core.month || {
    keyFromDate(d){
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,'0');
      return `${y}-${m}`;
    },
    keyNow(){ return this.keyFromDate(new Date()); },
    addMonths(ym, offset){
      const [y,m]=String(ym).split('-').map(Number);
      const d=new Date(y,(m-1)+offset,1);
      return this.keyFromDate(d);
    },
    fmtJP(ym){
      const [y,m]=String(ym).split('-').map(Number);
      return `${y}Âπ¥${m}Êúà`;
    }
  };

  core.storage = core.storage || {
    safeParse(str, fallback){
      try{ if(!str) return fallback; const v=JSON.parse(str); return v ?? fallback; }catch(e){ return fallback; }
    },
    get(key, fallback){ return this.safeParse(localStorage.getItem(key), fallback); },
    set(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
  };

  core.ui = core.ui || {
    byId(id){ return document.getElementById(id); }
  };

  App.state = App.state || {};
  App.state.goals = App.state.goals || {};

  const STORAGE_KEY = 'monthlyGoals';

  function ensureState(){
    if(!App.state.goals.currentMonth) App.state.goals.currentMonth = core.month.keyNow();
    if(!App.state.goals.selectedMonth) App.state.goals.selectedMonth = App.state.goals.currentMonth;
  }

  function loadGoals(){
    const v = core.storage.get(STORAGE_KEY, []);
    return Array.isArray(v) ? v : [];
  }
  function saveGoals(goals){
    core.storage.set(STORAGE_KEY, goals);
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#39;");
  }

  function setStatus(msg, isError){
    const el = core.ui.byId('goalStatus');
    if(!el) return;
    el.textContent = msg || '';
    el.style.color = isError ? '#b00020' : '#666';
    if(msg){
      setTimeout(()=>{ if(el.textContent === msg) el.textContent=''; }, 2400);
    }
  }

  const GoalsModule = {
    init(){
      ensureState();

      // Êó¢Â≠ò„ÅÆUIË¶ÅÁ¥†„Åå„ÅÇ„ÇãÂ†¥Âêà„Å†„Åë„Éê„Ç§„É≥„ÉâÔºàÂ£ä„Çå„Å´„Åè„ÅèÔºâ
      const prev = core.ui.byId('prevMonthBtn');
      const next = core.ui.byId('nextMonthBtn');
      const addBtn = core.ui.byId('addGoalBtn');
      const input = core.ui.byId('goalInput');

      if(prev && !prev.dataset.bound){
        prev.addEventListener('click', ()=>GoalsModule.changeMonth(-1));
        prev.dataset.bound = '1';
      }
      if(next && !next.dataset.bound){
        next.addEventListener('click', ()=>GoalsModule.changeMonth(1));
        next.dataset.bound = '1';
      }
      if(addBtn && !addBtn.dataset.bound){
        addBtn.addEventListener('click', ()=>GoalsModule.addGoal());
        addBtn.dataset.bound = '1';
      }
      if(input && !input.dataset.bound){
        input.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter'){
            e.preventDefault();
            GoalsModule.addGoal();
          }
        });
        input.dataset.bound = '1';
      }

      GoalsModule.updateMonthDisplay();
      GoalsModule.render();
    },

    onShow(){
      ensureState();
      GoalsModule.updateMonthDisplay();
      GoalsModule.render();
    },

    getSelectedMonth(){
      ensureState();
      return App.state.goals.selectedMonth;
    },

    updateMonthDisplay(){
      ensureState();
      const ym = App.state.goals.selectedMonth;
      const cur = App.state.goals.currentMonth;

      const display = core.ui.byId('currentGoalsMonth');
      if(display) display.textContent = core.month.fmtJP(ym);

      const title = core.ui.byId('goalsListTitle');
      if(title){
        title.textContent = (ym === cur) ? '‰ªäÊúà„ÅÆÁõÆÊ®ô„É™„Çπ„Éà' : `${core.month.fmtJP(ym)}„ÅÆÁõÆÊ®ô„É™„Çπ„Éà`;
      }
    },

    changeMonth(offset){
      ensureState();
      App.state.goals.selectedMonth = core.month.addMonths(App.state.goals.selectedMonth, offset);
      GoalsModule.updateMonthDisplay();
      GoalsModule.render();
    },

    addGoal(){
      ensureState();
      const input = core.ui.byId('goalInput');
      const sel = core.ui.byId('goalCategory');

      const text = (input?.value || '').trim();
      const category = sel?.value || '„Åù„ÅÆ‰ªñ';

      if(!text){
        setStatus('‚ùå ÁõÆÊ®ô„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', true);
        return;
      }

      const goals = loadGoals();
      goals.unshift({
        id: Date.now(),
        text,
        category,
        month: App.state.goals.selectedMonth, // ‚Üê Ë°®Á§∫‰∏≠„ÅÆÊúà„Å´ËøΩÂä†ÔºàÈáçË¶ÅÔºâ
        createdAt: new Date().toISOString(),
        completed: false,
        currentLevel: 0,
        progress: []
      });

      saveGoals(goals);
      if(input) input.value = '';
      setStatus('‚úì ÁõÆÊ®ô„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', false);
      GoalsModule.render();
    },

    toggleComplete(goalId){
      const goals = loadGoals();
      const g = goals.find(x => x && x.id === goalId);
      if(!g) return;
      g.completed = !g.completed;
      saveGoals(goals);
      GoalsModule.render();
    },

    deleteGoal(goalId){
      if(!confirm('„Åì„ÅÆÁõÆÊ®ô„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
      const goals = loadGoals().filter(g => g && g.id !== goalId);
      saveGoals(goals);
      GoalsModule.render();
    },

    addProgress(goalId){
      const goals = loadGoals();
      const g = goals.find(x => x && x.id === goalId);
      if(!g) return;

      const levelEl = core.ui.byId(`level-${goalId}`);
      const commentEl = core.ui.byId(`comment-${goalId}`);
      const level = parseInt(levelEl?.value ?? '0', 10);
      const comment = (commentEl?.value || '').trim();

      if(Number.isNaN(level) || level < 0 || level > 10){
        alert('„É¨„Éô„É´„ÅØ0„Äú10„ÅßÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }
      if(!comment){
        alert('„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }

      if(!Array.isArray(g.progress)) g.progress = [];
      g.progress.unshift({
        date: new Date().toISOString().slice(0,10),
        level,
        comment,
        timestamp: new Date().toISOString()
      });
      g.currentLevel = level;
      if(level === 10) g.completed = true;

      saveGoals(goals);
      if(commentEl) commentEl.value = '';
      setStatus('‚úì ÈÄ≤Êçó„ÇíË®òÈå≤„Åó„Åæ„Åó„Åü', false);
      GoalsModule.render();
    },

    render(){
      ensureState();
      GoalsModule.renderList();
      GoalsModule.renderSummary();
    },

    renderSummary(){
      const container = core.ui.byId('goalsProgress');
      if(!container) return;

      const ym = App.state.goals.selectedMonth;
      const goals = loadGoals().filter(g => g && g.month === ym);

      if(goals.length === 0){
        container.innerHTML = `<div class="empty-state">ÁõÆÊ®ô„ÇíËøΩÂä†„Åô„Çã„Å®ÈõÜË®à„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ</div>`;
        return;
      }

      const total = goals.length;
      const completed = goals.filter(g=>!!g.completed).length;
      const pct = Math.round((completed/total)*100);

      container.innerHTML = `
        <div class="summary-row">
          <div class="summary-chip">‚úÖ ÂÆå‰∫Ü ${completed}/${total}</div>
          <div class="summary-chip">üìà ÈÅîÊàêÁéá ${pct}%</div>
        </div>
        <div class="progress-bar-container" style="margin-top:10px">
          <div class="progress-bar-fill" style="width:${pct}%"></div>
        </div>
      `;
    },

    renderList(){
      const list = core.ui.byId('goalsList');
      if(!list) return;

      const ym = App.state.goals.selectedMonth;
      const goals = loadGoals().filter(g => g && g.month === ym);

      if(goals.length === 0){
        list.innerHTML = `<div class="empty-state">ÁõÆÊ®ô„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ‰∏ä„ÅÆ„Éï„Ç©„Éº„É†„Åã„ÇâËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>`;
        return;
      }

      list.innerHTML = goals.map(goal=>{
        const level = Number(goal.currentLevel ?? 0);
        const pct = Math.max(0, Math.min(10, level)) * 10;
        const completed = !!goal.completed;

        return `
          <div class="goal-item ${completed ? 'completed' : ''}">
            <div class="goal-header">
              <div class="goal-title">${escapeHtml(goal.text || '')}</div>
              <div class="goal-category">${escapeHtml(goal.category || '„Åù„ÅÆ‰ªñ')}</div>
            </div>

            <div class="goal-progress-container">
              <div class="progress-bar-container">
                <div class="progress-bar-fill" style="width:${pct}%"></div>
              </div>
              <div class="progress-text">Lv.${level}/10Ôºà${pct}%Ôºâ</div>
            </div>

            <div class="goal-progress-input">
              <select id="level-${goal.id}" class="progress-level-select">
                ${Array.from({length:11},(_,i)=>`<option value="${i}" ${i===level?'selected':''}>Lv.${i}</option>`).join('')}
              </select>
              <input id="comment-${goal.id}" class="progress-comment-input" placeholder="„Ç≥„É°„É≥„ÉàÔºà‰æãÔºöÂü∫Á§é„Ç≥„Éº„Éâ„ÅÆ‰ΩúÊàêÔºâ" maxlength="120" />
              <button class="btn-primary" onclick="window.addGoalProgress(${goal.id})">Ë®òÈå≤</button>
            </div>

            <div class="goal-actions">
              <button class="btn-secondary" onclick="window.toggleGoalComplete(${goal.id})">‚úÖ ÂÆå‰∫ÜÂàáÊõø</button>
              <button class="btn-secondary" onclick="window.deleteGoal(${goal.id})">üóëÔ∏è ÂâäÈô§</button>
            </div>

            <details class="goal-history">
              <summary>üìö ÈÄ≤ÊçóÂ±•Ê≠¥</summary>
              <div class="goal-history-list">
                ${GoalsModule.renderHistory(goal)}
              </div>
            </details>
          </div>
        `;
      }).join('');
    },

    renderHistory(goal){
      const hist = Array.isArray(goal.progress) ? goal.progress : [];
      if(hist.length === 0){
        return `<div class="history-empty">„Åæ„Å†Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>`;
      }
      return hist.slice(0, 30).map(h=>{
        return `<div class="history-item">
          <div class="history-meta">üìÖ ${escapeHtml(h.date || '')} Ôºè üì∂ Lv.${Number(h.level ?? 0)}</div>
          <div class="history-comment">${escapeHtml(h.comment || '')}</div>
        </div>`;
      }).join('');
    }
  };

  App.modules = App.modules || {};
  App.modules.goals = GoalsModule;

  // ---- thin global wrappers (compat) ----
  window.addGoal = () => GoalsModule.addGoal();
  window.changeGoalsMonth = (offset) => GoalsModule.changeMonth(offset);
  window.updateGoalsMonthDisplay = () => GoalsModule.updateMonthDisplay();
  window.renderGoals = () => GoalsModule.renderList();
  window.renderGoalsProgress = () => GoalsModule.renderSummary();
  window.deleteGoal = (id) => GoalsModule.deleteGoal(id);
  window.toggleGoalComplete = (id) => GoalsModule.toggleComplete(id);
  window.addGoalProgress = (id) => GoalsModule.addProgress(id);

  // Init only once DOM is ready
  document.addEventListener('DOMContentLoaded', ()=>GoalsModule.init());
})();

function renderDonutChart(canvasId, legendId, items, key, suffix) {
  const canvas = document.getElementById(canvasId);
  const legendEl = document.getElementById(legendId);
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const total = items.reduce((s, i) => s + (Number(i[key]) || 0), 0);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!total) {
    if (legendEl) legendEl.innerHTML = '';
    return;
  }

  const palette = ['#4F46E5','#16A34A','#F59E0B','#0EA5E9','#EF4444','#A855F7','#64748B','#22C55E','#E11D48','#F97316'];
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const rOuter = 140;
  const rInner = 88;

  let start = -Math.PI / 2;
  items.forEach((it, idx) => {
    const v = Number(it[key]) || 0;
    if (v <= 0) return;
    const angle = (v / total) * Math.PI * 2;
    const end = start + angle;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.closePath();
    ctx.fillStyle = palette[idx % palette.length];
    ctx.fill();

    ctx.beginPath();
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.stroke();

    start = end;
  });

  ctx.beginPath();
  ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  ctx.fillStyle = '#111';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.font = '700 18px system-ui';
  ctx.fillText('ÂêàË®à', cx, cy - 10);
  ctx.font = '800 22px system-ui';
  ctx.fillText(`${total}${suffix}`, cx, cy + 18);

  if (legendEl) {
    legendEl.innerHTML = items
      .filter(it => (Number(it[key]) || 0) > 0)
      .map((it, idx) => {
        const v = Number(it[key]) || 0;
        const pct = Math.round((v / total) * 100);
        return `<div class="legend-row">
          <span class="legend-dot" style="background:${palette[idx % palette.length]}"></span>
          <span class="legend-cat">${it.cat}</span>
          <span class="legend-amt">${v}${suffix}</span>
          <span class="legend-pct">${pct}%</span>
        </div>`;
      }).join('');
  }
}

</script>
<script>
/* ===== v36.2 Journal Module (Phase 2 - fixed fields, MUST/WANT) ===== */
(function(){
  'use strict';
  const App = window.App = window.App || {};
  App.core = App.core || {};
  const core = App.core;

  core.storage = core.storage || {
    safeParse(str, fallback){ try{ if(!str) return fallback; const v=JSON.parse(str); return v ?? fallback; }catch(e){ return fallback; } },
    get(key, fallback){ return this.safeParse(localStorage.getItem(key), fallback); },
    set(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
  };

  const STORAGE_KEY = 'journalEntriesV2';

  function pad2(n){ return String(n).padStart(2,'0'); }
  function todayKey(){
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function safeEntries(){
    const v = core.storage.get(STORAGE_KEY, {});
    return (v && typeof v === 'object' && !Array.isArray(v)) ? v : {};
  }

  function setStatus(id, msg, isError){
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = msg || '';
    el.style.color = isError ? '#b00020' : '#666';
    if(msg){
      setTimeout(()=>{ if(el.textContent === msg) el.textContent=''; }, 2400);
    }
  }

  function getEl(id){ return document.getElementById(id); }

  function readForm(){
    return {
      events: (getEl('journalV2Events')?.value || '').trim(),
      learnings: (getEl('journalV2Learnings')?.value || '').trim(),
      feelings: (getEl('journalV2Feelings')?.value || '').trim(),
      gratitude: (getEl('journalV2Gratitude')?.value || '').trim(),
      must: (getEl('journalV2Must')?.value || '').trim(),
      want: (getEl('journalV2Want')?.value || '').trim(),
      mood: (getEl('journalV2Mood')?.value || ''),
    };
  }

  function writeForm(entry){
    getEl('journalV2Events').value = entry?.events || '';
    getEl('journalV2Learnings').value = entry?.learnings || '';
    getEl('journalV2Feelings').value = entry?.feelings || '';
    getEl('journalV2Gratitude').value = entry?.gratitude || '';
    getEl('journalV2Must').value = entry?.must || '';
    getEl('journalV2Want').value = entry?.want || '';
    getEl('journalV2Mood').value = entry?.mood || '';
  }

  function saveEntry(dateKey){
    const entries = safeEntries();
    const data = readForm();
    entries[dateKey] = {
      ...data,
      date: dateKey,
      updatedAt: new Date().toISOString()
    };
    core.storage.set(STORAGE_KEY, entries);
    setStatus('journalV2Status', '‚úì ‰øùÂ≠ò„Åó„Åæ„Åó„Åü', false);
  }

  function loadEntry(dateKey){
    const entries = safeEntries();
    return entries[dateKey] || null;
  }

  // ---- Voice ----
  let recognition = null;
  let isListening = false;

  function canUseSpeech(){
    return !!(window.SpeechRecognition || window.webkitSpeechRecognition);
  }

  function appendToTarget(text){
    const target = getEl('journalV2Target')?.value || 'events';
    const map = {
      events: 'journalV2Events',
      learnings: 'journalV2Learnings',
      feelings: 'journalV2Feelings',
      gratitude: 'journalV2Gratitude',
      must: 'journalV2Must',
      want: 'journalV2Want'
    };
    const id = map[target] || 'journalV2Events';
    const el = getEl(id);
    if(!el) return;
    const sep = el.value && !el.value.endsWith('\n') ? '\n' : '';
    el.value = (el.value || '') + sep + text.trim();
  }

  function startVoice(){
    if(isListening) return;
    if(!canUseSpeech()){
      setStatus('journalV2Status', '‚ùå „Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞ÂÖ•Âäõ„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì', true);
      return;
    }
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    recognition.lang = 'ja-JP';
    recognition.interimResults = true;
    recognition.continuous = true;

    const stopBtn = getEl('journalV2StopBtn');
    const voiceBtn = getEl('journalV2VoiceBtn');
    if(stopBtn) stopBtn.disabled = false;
    if(voiceBtn) voiceBtn.disabled = true;

    let finalText = '';
    isListening = true;
    setStatus('journalV2Status', 'üé§ Èü≥Â£∞ÂÖ•Âäõ‰∏≠‚Ä¶ÔºàÂÅúÊ≠¢„ÅßÁ¢∫ÂÆöÔºâ', false);

    recognition.onresult = (event) => {
      let interim = '';
      for(let i = event.resultIndex; i < event.results.length; i++){
        const res = event.results[i];
        const t = res[0].transcript;
        if(res.isFinal) finalText += t;
        else interim += t;
      }
      // ÈÄî‰∏≠Ë°®Á§∫„ÅØ„Çπ„ÉÜ„Éº„Çø„Çπ„Å´„Å†„ÅëÂá∫„ÅôÔºàtextarea„Å´„Ç¥„Éü„ÇíÂ¢ó„ÇÑ„Åï„Å™„ÅÑÔºâ
      if(interim){
        setStatus('journalV2Status', `üé§ Èü≥Â£∞ÂÖ•Âäõ‰∏≠‚Ä¶ ${interim}`, false);
      }
    };

    recognition.onerror = (e) => {
      console.warn('speech error', e);
      stopVoice(true);
      setStatus('journalV2Status', '‚ùå Èü≥Â£∞ÂÖ•Âäõ„Ç®„É©„ÉºÔºà„Éû„Ç§„ÇØË®±ÂèØ/„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÔºâ', true);
    };

    recognition.onend = () => {
      // stopVoice() „Åã„ÇâÂëº„Å∞„Çå„ÅüÂ†¥Âêà„ÇÇÊù•„Çã
      if(isListening){
        // ‰∫àÊúü„Åõ„Å¨ÁµÇ‰∫Ü
        isListening = false;
        const stopBtn2 = getEl('journalV2StopBtn');
        const voiceBtn2 = getEl('journalV2VoiceBtn');
        if(stopBtn2) stopBtn2.disabled = true;
        if(voiceBtn2) voiceBtn2.disabled = false;
      }
      if(finalText.trim()){
        appendToTarget(finalText);
        finalText = '';
        setStatus('journalV2Status', '‚úì Èü≥Â£∞ÂÖ•Âäõ„ÇíÂèçÊò†„Åó„Åæ„Åó„ÅüÔºàÂøÖË¶Å„Å™„Çâ‰øùÂ≠òÔºâ', false);
      }
    };

    recognition.start();
  }

  function stopVoice(fromError){
    if(!recognition) return;
    try{ recognition.stop(); }catch(e){}
    recognition = null;
    isListening = false;
    const stopBtn = getEl('journalV2StopBtn');
    const voiceBtn = getEl('journalV2VoiceBtn');
    if(stopBtn) stopBtn.disabled = true;
    if(voiceBtn) voiceBtn.disabled = false;
    if(!fromError) setStatus('journalV2Status', '‚úì ÂÅúÊ≠¢„Åó„Åæ„Åó„ÅüÔºàÁ¢∫ÂÆö‰∏≠‚Ä¶Ôºâ', false);
  }

  // ---- IO ----
  function openIO(mode){
    const wrap = getEl('journalV2IO');
    const ta = getEl('journalV2IOText');
    if(!wrap || !ta) return;
    wrap.style.display = 'block';
    wrap.dataset.mode = mode;
    setStatus('journalV2IOStatus', '', false);
    if(mode === 'export'){
      ta.value = JSON.stringify(safeEntries(), null, 2);
    }else{
      ta.value = '';
    }
  }
  function closeIO(){
    const wrap = getEl('journalV2IO');
    if(!wrap) return;
    wrap.style.display = 'none';
    wrap.dataset.mode = '';
    setStatus('journalV2IOStatus', '', false);
  }
  function applyImport(){
    const wrap = getEl('journalV2IO');
    const ta = getEl('journalV2IOText');
    if(!wrap || !ta) return;
    if(wrap.dataset.mode !== 'import') return;
    const raw = ta.value.trim();
    if(!raw){
      setStatus('journalV2IOStatus', '‚ùå JSON„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ', true);
      return;
    }
    try{
      const obj = JSON.parse(raw);
      if(!obj || typeof obj !== 'object' || Array.isArray(obj)) throw new Error('object expected');
      core.storage.set(STORAGE_KEY, obj);
      setStatus('journalV2IOStatus', '‚úì Âæ©ÂÖÉ„Åó„Åæ„Åó„Åü', false);
      // reload current date
      const d = getEl('journalV2Date')?.value || todayKey();
      writeForm(loadEntry(d));
    }catch(e){
      console.warn(e);
      setStatus('journalV2IOStatus', '‚ùå JSONÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì', true);
    }
  }
  function clearAll(){
    if(!confirm('„Ç∏„É£„Éº„Éä„É´„Éá„Éº„Çø„ÇíÂÖ®ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
    core.storage.set(STORAGE_KEY, {});
    setStatus('journalV2Status', '‚úì ÂÖ®ÂâäÈô§„Åó„Åæ„Åó„Åü', false);
    writeForm(null);
  }

  const JournalModule = {
    init(){
      const dateInput = getEl('journalV2Date');
      if(dateInput && !dateInput.value) dateInput.value = todayKey();

      getEl('journalV2TodayBtn')?.addEventListener('click', ()=>{
        if(dateInput) dateInput.value = todayKey();
        JournalModule.load();
      });
      getEl('journalV2SaveBtn')?.addEventListener('click', ()=>JournalModule.save());
      dateInput?.addEventListener('change', ()=>JournalModule.load());

      getEl('journalV2VoiceBtn')?.addEventListener('click', startVoice);
      getEl('journalV2StopBtn')?.addEventListener('click', ()=>stopVoice(false));

      getEl('journalV2ExportBtn')?.addEventListener('click', ()=>openIO('export'));
      getEl('journalV2ImportBtn')?.addEventListener('click', ()=>openIO('import'));
      getEl('journalV2CloseIOBtn')?.addEventListener('click', closeIO);
      getEl('journalV2ApplyImportBtn')?.addEventListener('click', applyImport);
      getEl('journalV2ClearBtn')?.addEventListener('click', clearAll);

      // initial load
      JournalModule.load();
    },
    onShow(){
      // when tab shown, refresh from storage (in case edited elsewhere)
      JournalModule.load();
    },
    getDateKey(){
      return getEl('journalV2Date')?.value || todayKey();
    },
    load(){
      const d = JournalModule.getDateKey();
      const entry = loadEntry(d);
      writeForm(entry);
      setStatus('journalV2Status', '', false);
    },
    save(){
      const d = JournalModule.getDateKey();
      saveEntry(d);
    }
  };

  App.modules = App.modules || {};
  App.modules.journal = JournalModule;

  // thin compat wrappers (if old UI calls these, they won't crash)
  window.startJournalVoice = startVoice;
  window.stopJournalVoice = stopVoice;

  document.addEventListener('DOMContentLoaded', ()=>JournalModule.init());
})();

function renderDonutChart(canvasId, legendId, items, key, suffix) {
  const canvas = document.getElementById(canvasId);
  const legendEl = document.getElementById(legendId);
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const total = items.reduce((s, i) => s + (Number(i[key]) || 0), 0);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!total) {
    if (legendEl) legendEl.innerHTML = '';
    return;
  }

  const palette = ['#4F46E5','#16A34A','#F59E0B','#0EA5E9','#EF4444','#A855F7','#64748B','#22C55E','#E11D48','#F97316'];
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const rOuter = 140;
  const rInner = 88;

  let start = -Math.PI / 2;
  items.forEach((it, idx) => {
    const v = Number(it[key]) || 0;
    if (v <= 0) return;
    const angle = (v / total) * Math.PI * 2;
    const end = start + angle;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.closePath();
    ctx.fillStyle = palette[idx % palette.length];
    ctx.fill();

    ctx.beginPath();
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.stroke();

    start = end;
  });

  ctx.beginPath();
  ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  ctx.fillStyle = '#111';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.font = '700 18px system-ui';
  ctx.fillText('ÂêàË®à', cx, cy - 10);
  ctx.font = '800 22px system-ui';
  ctx.fillText(`${total}${suffix}`, cx, cy + 18);

  if (legendEl) {
    legendEl.innerHTML = items
      .filter(it => (Number(it[key]) || 0) > 0)
      .map((it, idx) => {
        const v = Number(it[key]) || 0;
        const pct = Math.round((v / total) * 100);
        return `<div class="legend-row">
          <span class="legend-dot" style="background:${palette[idx % palette.length]}"></span>
          <span class="legend-cat">${it.cat}</span>
          <span class="legend-amt">${v}${suffix}</span>
          <span class="legend-pct">${pct}%</span>
        </div>`;
      }).join('');
  }
}

</script>
<script>
/* ===== v36.3 Dummy AI Summary (UI only) ===== */
(function(){
  function summarize(text){
    if(!text) return '';
    const lines = text.split(/[\n„ÄÇ]/).filter(Boolean);
    return lines.slice(0,3).map(l=>'„Éª'+l.trim()).join('\n');
  }

  function runDummyAI(){
    const ids = [
      'journalV2Events',
      'journalV2Learnings',
      'journalV2Feelings',
      'journalV2Gratitude',
      'journalV2Must',
      'journalV2Want'
    ];
    ids.forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.value = summarize(el.value);
    });
    const st=document.getElementById('journalV2Status');
    if(st) st.textContent='ü§ñ „Éá„É¢Ë¶ÅÁ¥Ñ„ÇíÂèçÊò†„Åó„Åæ„Åó„ÅüÔºàAPIÊú™Êé•Á∂öÔºâ';
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const btn=document.getElementById('journalV2AISummaryBtn');
    if(btn) btn.addEventListener('click', runDummyAI);
  });
})();

function renderDonutChart(canvasId, legendId, items, key, suffix) {
  const canvas = document.getElementById(canvasId);
  const legendEl = document.getElementById(legendId);
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const total = items.reduce((s, i) => s + (Number(i[key]) || 0), 0);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!total) {
    if (legendEl) legendEl.innerHTML = '';
    return;
  }

  const palette = ['#4F46E5','#16A34A','#F59E0B','#0EA5E9','#EF4444','#A855F7','#64748B','#22C55E','#E11D48','#F97316'];
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const rOuter = 140;
  const rInner = 88;

  let start = -Math.PI / 2;
  items.forEach((it, idx) => {
    const v = Number(it[key]) || 0;
    if (v <= 0) return;
    const angle = (v / total) * Math.PI * 2;
    const end = start + angle;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.closePath();
    ctx.fillStyle = palette[idx % palette.length];
    ctx.fill();

    ctx.beginPath();
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.stroke();

    start = end;
  });

  ctx.beginPath();
  ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  ctx.fillStyle = '#111';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.font = '700 18px system-ui';
  ctx.fillText('ÂêàË®à', cx, cy - 10);
  ctx.font = '800 22px system-ui';
  ctx.fillText(`${total}${suffix}`, cx, cy + 18);

  if (legendEl) {
    legendEl.innerHTML = items
      .filter(it => (Number(it[key]) || 0) > 0)
      .map((it, idx) => {
        const v = Number(it[key]) || 0;
        const pct = Math.round((v / total) * 100);
        return `<div class="legend-row">
          <span class="legend-dot" style="background:${palette[idx % palette.length]}"></span>
          <span class="legend-cat">${it.cat}</span>
          <span class="legend-amt">${v}${suffix}</span>
          <span class="legend-pct">${pct}%</span>
        </div>`;
      }).join('');
  }
}

</script>
<script>
/* ===== v37.1 Journal Ultra Simple + Summary Log (Dummy) ===== */
(function(){
  'use strict';
  const App = window.App = window.App || {};
  App.core = App.core || {};
  const core = App.core;

  core.storage = core.storage || {
    safeParse(str, fallback){ try{ if(!str) return fallback; const v=JSON.parse(str); return v ?? fallback; }catch(e){ return fallback; } },
    get(key, fallback){ return this.safeParse(localStorage.getItem(key), fallback); },
    set(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
  };

  const STORAGE_KEY = 'journalEntriesV3';

  function pad2(n){ return String(n).padStart(2,'0'); }
  function todayKey(){
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function setStatus(msg, isError){
    const el = document.getElementById('journalV2Status');
    if(!el) return;
    el.textContent = msg || '';
    el.style.color = isError ? '#b00020' : '#666';
    if(msg){
      setTimeout(()=>{ if(el.textContent === msg) el.textContent=''; }, 2400);
    }
  }

  function entries(){
    const v = core.storage.get(STORAGE_KEY, {});
    return (v && typeof v === 'object' && !Array.isArray(v)) ? v : {};
  }
  function saveEntries(obj){ core.storage.set(STORAGE_KEY, obj); }

  function getDateKey(){
    return document.getElementById('journalV2Date')?.value || todayKey();
  }

  function getRaw(){
    return (document.getElementById('journalV3Raw')?.value || '').trim();
  }
  function setRaw(t){
    const el = document.getElementById('journalV3Raw');
    if(el) el.value = t || '';
  }

  // ---- mood ----
  function setMood(value){
    const cards = document.querySelectorAll('#journalMoodWrap .mood-card');
    cards.forEach(c=>{
      const on = c.getAttribute('data-mood') === value;
      c.classList.toggle('active', on);
      c.setAttribute('aria-checked', on ? 'true' : 'false');
    });
    // remember in a data attr
    const wrap = document.getElementById('journalMoodWrap');
    if(wrap) wrap.setAttribute('data-selected', value || '');
  }
  function getMood(){
    const wrap = document.getElementById('journalMoodWrap');
    return (wrap?.getAttribute('data-selected') || '').trim();
  }


  // ---- speech ----
  let recognition = null;
  let isListening = false;

  function canUseSpeech(){
    return !!(window.SpeechRecognition || window.webkitSpeechRecognition);
  }

  function appendRaw(text){
    const el = document.getElementById('journalV3Raw');
    if(!el) return;
    const sep = el.value && !el.value.endsWith('\n') ? '\n' : '';
    el.value = (el.value || '') + sep + text.trim();
  }

  function startVoice(){
    if(isListening) return;
    if(!canUseSpeech()){
      setStatus('‚ùå „Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞ÂÖ•Âäõ„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì', true);
      return;
    }
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    recognition.lang = 'ja-JP';
    recognition.interimResults = true;
    recognition.continuous = true;

    const stopBtn = document.getElementById('journalV2StopBtn');
    const voiceBtn = document.getElementById('journalV2VoiceBtn');
    if(stopBtn) stopBtn.disabled = false;
    if(voiceBtn) voiceBtn.disabled = true;

    let finalText = '';
    isListening = true;
    setStatus('üé§ Èü≥Â£∞ÂÖ•Âäõ‰∏≠‚Ä¶ÔºàÂÅúÊ≠¢„ÅßÁ¢∫ÂÆöÔºâ', false);

    recognition.onresult = (event) => {
      let interim = '';
      for(let i = event.resultIndex; i < event.results.length; i++){
        const res = event.results[i];
        const t = res[0].transcript;
        if(res.isFinal) finalText += t;
        else interim += t;
      }
      if(interim){
        setStatus(`üé§ Èü≥Â£∞ÂÖ•Âäõ‰∏≠‚Ä¶ ${interim}`, false);
      }
    };

    recognition.onerror = () => {
      stopVoice(true);
      setStatus('‚ùå Èü≥Â£∞ÂÖ•Âäõ„Ç®„É©„ÉºÔºà„Éû„Ç§„ÇØË®±ÂèØ/„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÔºâ', true);
    };

    recognition.onend = () => {
      const stopBtn2 = document.getElementById('journalV2StopBtn');
      const voiceBtn2 = document.getElementById('journalV2VoiceBtn');
      if(stopBtn2) stopBtn2.disabled = true;
      if(voiceBtn2) voiceBtn2.disabled = false;

      isListening = false;

      if(finalText.trim()){
        appendRaw(finalText);
        finalText = '';
        setStatus('‚úì Èü≥Â£∞ÂÖ•Âäõ„ÇíÂèçÊò†„Åó„Åæ„Åó„ÅüÔºàÂøÖË¶Å„Å™„Çâ‰øùÂ≠òÔºâ', false);
      }
    };

    recognition.start();
  }

  function stopVoice(fromError){
    if(!recognition) return;
    try{ recognition.stop(); }catch(e){}
    recognition = null;
    isListening = false;
    const stopBtn = document.getElementById('journalV2StopBtn');
    const voiceBtn = document.getElementById('journalV2VoiceBtn');
    if(stopBtn) stopBtn.disabled = true;
    if(voiceBtn) voiceBtn.disabled = false;
    if(!fromError) setStatus('‚úì ÂÅúÊ≠¢„Åó„Åæ„Åó„ÅüÔºàÁ¢∫ÂÆö‰∏≠‚Ä¶Ôºâ', false);
  }

  // ---- dummy summary ----
  function splitSentences(text){
    return text.split(/[\n„ÄÇÔºÅÔºü]/).map(s=>s.trim()).filter(Boolean);
  }
  function bullets(arr, n){
    if(!arr || arr.length===0) return '‚Äî';
    return arr.slice(0,n).map(s=>'„Éª'+s).join('\n');
  }
  function categorize(text){
    const s = splitSentences(text);
    const events=[], learnings=[], feelings=[], gratitude=[], must=[], want=[];
    s.forEach(line=>{
      const low=line;
      if(/[ÊÑüË¨ù|„ÅÇ„Çä„Åå„Å®„ÅÜ|Âä©„Åã„Å£„Åü|„ÅÇ„Çä„Åå„Åü]/.test(low)) gratitude.push(line);
      if(/[ÂèçÁúÅ|Â≠¶„Å≥|Ê∞ó„Å•|ÂàÜ„Åã„Å£„Åü|ÊÄù„ÅÜ|„Å™„ÅÆ„Åß|„Åπ„Åç|Â§ß„Åç„Åã„Å£„Åü]/.test(low)) learnings.push(line);
      if(/[Â¨â|ÁÑ¶|„É¢„É§|„Å§„Çâ|„Åó„Çì„Å©|‰∏çÂÆâ|Ê•Ω„Åó„ÅÑ|ÊÇ≤„Åó„ÅÑ|„Ç§„É©„Ç§„É©]/.test(low)) feelings.push(line);
      if(/[MUST|ÂøÖ„Åö|„ÇÑ„Çâ„Å™„Åç„ÇÉ|„Åó„Å™„ÅÑ„Å®]/i.test(low)) must.push(line);
      if(/[WANT|„ÇÑ„Çä„Åü„ÅÑ|„Åß„Åç„Åü„Çâ|‰ΩôË£ï]/i.test(low)) want.push(line);
      events.push(line);
    });

    if(must.length===0 || want.length===0){
      s.forEach(line=>{
        if(/ÊòéÊó•/.test(line) || /„ÇÑ„Çã/.test(line) || /‰∫àÂÆö/.test(line)){
          if(/„ÇÑ„Çâ„Å™„Åç„ÇÉ|ÂøÖ„Åö|„Åó„Å™„ÅÑ„Å®/.test(line)) must.push(line);
          else want.push(line);
        }
      });
    }

    return {
      events: bullets(events, 3),
      learnings: bullets(learnings, 3),
      feelings: bullets(feelings, 3),
      gratitude: bullets(gratitude, 2),
      must: bullets(must, 3),
      want: bullets(want, 3),
    };
  }

  function summarize(){
    const d = getDateKey();
    const raw = getRaw();
    if(!raw){
      setStatus('‚ùå „Åæ„Åö„ÄåË©±„Åó„ÅüÂÜÖÂÆπ„Äç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', true);
      return;
    }
    const obj = entries();
    const entry = obj[d] || { date:d };
    entry.raw = raw;
    entry.mood = getMood();
    entry.summary = categorize(raw);
    entry.updatedAt = new Date().toISOString();
    obj[d] = entry;
    saveEntries(obj);
    setStatus('ü§ñ Ë¶ÅÁ¥ÑÔºà„Éá„É¢Ôºâ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ„É≠„Ç∞„ÅßÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô', false);
    renderTodaySummary();
    renderLog();
  }

  // ---- persistence ----
  function load(){
    const d = getDateKey();
    const e = entries()[d];
    setRaw(e?.raw || '');
    setMood(e?.mood || '');
    renderTodaySummary();
  }
  function save(){
    const d = getDateKey();
    const raw = getRaw();
    const obj = entries();
    const entry = obj[d] || { date:d };
    entry.raw = raw;
    entry.mood = getMood();
    entry.updatedAt = new Date().toISOString();
    obj[d] = entry;
    saveEntries(obj);
    setStatus('‚úì ‰øùÂ≠ò„Åó„Åæ„Åó„Åü', false);
    renderTodaySummary();
    renderLog();
  }
  function clearDay(){
    if(!confirm('„Åì„ÅÆÊó•„ÅÆÂÜÖÂÆπ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) return;
    setRaw('');
    setMood('');
    const d = getDateKey();
    const obj = entries();
    obj[d] = { date:d, raw:'', updatedAt:new Date().toISOString() };
    saveEntries(obj);
    setStatus('‚úì „ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', false);
    renderTodaySummary();
    renderLog();
  }

  function esc(s){
    return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  function renderTodaySummary(){
    const d = getDateKey();
    const e = entries()[d];
    const empty = document.getElementById('journalV3TodaySummaryEmpty');
    const body = document.getElementById('journalV3TodaySummaryBody');
    const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.textContent = val || '‚Äî'; };
    if(e && e.summary){
      if(empty) empty.style.display='none';
      if(body) body.style.display='block';
      set('todaySumEvents', e.summary.events);
      set('todaySumLearnings', e.summary.learnings);
      set('todaySumFeelings', e.summary.feelings);
      set('todaySumGratitude', e.summary.gratitude);
      set('todaySumMust', e.summary.must);
      set('todaySumWant', e.summary.want);
    }else{
      if(empty) empty.style.display='block';
      if(body) body.style.display='none';
    }
  }

  function renderLog(){
    const list = document.getElementById('journalV3LogList');
    if(!list) return;

    const obj = entries();
    const keys = Object.keys(obj).sort().reverse();
    const items = keys
      .map(k => ({ k, v: obj[k] }))
      .filter(it => (it.v?.raw && it.v.raw.trim()) || it.v?.summary);

    if(items.length === 0){
      list.innerHTML = '„Åæ„Å†„É≠„Ç∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ';
      return;
    }

    list.innerHTML = items.map(({k,v})=>{
      const snippet = (v.raw || '').trim().slice(0, 120);
      const hasSummary = !!v.summary;
      const sum = v.summary || {};
      const summaryHtml = hasSummary ? `
        <div class="journal-summary-open">
          <div class="small" style="margin:6px 0 8px;color:#666;">Ë¶ÅÁ¥Ñ</div>
          <div class="summary-grid">
            <div class="summary-k">Âá∫Êù•‰∫ã</div><div class="summary-v">${esc(sum.events)}</div>
            <div class="summary-k">Â≠¶„Å≥</div><div class="summary-v">${esc(sum.learnings)}</div>
            <div class="summary-k">ÊÑüÊÉÖ</div><div class="summary-v">${esc(sum.feelings)}</div>
            <div class="summary-k">ÊÑüË¨ù</div><div class="summary-v">${esc(sum.gratitude)}</div>
            <div class="summary-k must">MUST</div><div class="summary-v">${esc(sum.must)}</div>
            <div class="summary-k want">WANT</div><div class="summary-v">${esc(sum.want)}</div>
          </div>
        </div>
      ` : `<div class="small" style="margin-top:8px;color:#666;">Ë¶ÅÁ¥Ñ„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„ÇìÔºà„ÄåË¶ÅÁ¥ÑÔºà„Éá„É¢Ôºâ„Äç„ÇíÊäº„ÅôÔºâ</div>`;

      return `
        <div class="journal-log-item">
          <div class="journal-log-head">
            <div class="journal-log-date">${esc(k)}</div>
            <div class="journal-log-actions">
              <button class="btn-secondary" data-load="${esc(k)}">Èñã„Åè</button>
            </div>
          </div>
          <div class="journal-log-snippet">${esc(snippet)}${snippet.length>=120?'‚Ä¶':''}</div>
          ${summaryHtml}
        </div>
      `;
    }).join('');

    // bind load buttons
    list.querySelectorAll('button[data-load]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const k = btn.getAttribute('data-load');
        const dateInput = document.getElementById('journalV2Date');
        if(dateInput) dateInput.value = k;
        load();
        setStatus('üìÖ Êó•‰ªò„ÇíÂàá„ÇäÊõø„Åà„Åæ„Åó„Åü', false);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const dateInput = document.getElementById('journalV2Date');
    if(dateInput && !dateInput.value) dateInput.value = todayKey();

    document.getElementById('journalV2VoiceBtn')?.addEventListener('click', startVoice);
    document.getElementById('journalV2StopBtn')?.addEventListener('click', ()=>stopVoice(false));
    document.getElementById('journalV2SaveBtn')?.addEventListener('click', save);
    document.getElementById('journalV3SummarizeBtn')?.addEventListener('click', summarize);
    dateInput?.addEventListener('change', ()=>{ load(); renderTodaySummary(); });

    document.getElementById('journalV2TodayBtn')?.addEventListener('click', ()=>{
      if(dateInput) dateInput.value = todayKey();
      load();
    });

    document.getElementById('journalV3ClearBtn')?.addEventListener('click', clearDay);
    document.getElementById('journalAiBigBtn')?.addEventListener('click', ()=>{ document.getElementById('journalV3SummarizeBtn')?.click(); });

    // mood bind
    document.querySelectorAll('#journalMoodWrap .mood-card').forEach(card=>{
      const pick = ()=>{ setMood(card.getAttribute('data-mood')); };
      card.addEventListener('click', pick);
      card.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); pick(); }});
    });

    load();
    renderTodaySummary();
    renderLog();
  });

  window.startJournalVoice = startVoice;
  window.stopJournalVoice = stopVoice;
})();

function renderDonutChart(canvasId, legendId, items, key, suffix) {
  const canvas = document.getElementById(canvasId);
  const legendEl = document.getElementById(legendId);
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const total = items.reduce((s, i) => s + (Number(i[key]) || 0), 0);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!total) {
    if (legendEl) legendEl.innerHTML = '';
    return;
  }

  const palette = ['#4F46E5','#16A34A','#F59E0B','#0EA5E9','#EF4444','#A855F7','#64748B','#22C55E','#E11D48','#F97316'];
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const rOuter = 140;
  const rInner = 88;

  let start = -Math.PI / 2;
  items.forEach((it, idx) => {
    const v = Number(it[key]) || 0;
    if (v <= 0) return;
    const angle = (v / total) * Math.PI * 2;
    const end = start + angle;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.closePath();
    ctx.fillStyle = palette[idx % palette.length];
    ctx.fill();

    ctx.beginPath();
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.stroke();

    start = end;
  });

  ctx.beginPath();
  ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  ctx.fillStyle = '#111';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.font = '700 18px system-ui';
  ctx.fillText('ÂêàË®à', cx, cy - 10);
  ctx.font = '800 22px system-ui';
  ctx.fillText(`${total}${suffix}`, cx, cy + 18);

  if (legendEl) {
    legendEl.innerHTML = items
      .filter(it => (Number(it[key]) || 0) > 0)
      .map((it, idx) => {
        const v = Number(it[key]) || 0;
        const pct = Math.round((v / total) * 100);
        return `<div class="legend-row">
          <span class="legend-dot" style="background:${palette[idx % palette.length]}"></span>
          <span class="legend-cat">${it.cat}</span>
          <span class="legend-amt">${v}${suffix}</span>
          <span class="legend-pct">${pct}%</span>
        </div>`;
      }).join('');
  }
}

</script>

<script>
/* ===== v37.5 Remove legacy journal date block ===== */
(function(){
  function removeLegacyJournalDate(){
    const input = document.getElementById('journalDate');
    if(!input) return;
    // container: label + flex row are inside a styled box div
    const box = input.parentElement && input.parentElement.parentElement;
    if(box && box.remove) box.remove();
  }
  document.addEventListener('DOMContentLoaded', removeLegacyJournalDate);
})();

// ‚úÖ ÁîªÈù¢‰∏ã„Åß„ÇÇÊäº„Åõ„Çã„Äå‰øùÂ≠ò„Äç„Éú„Çø„É≥Ôºà‰∏ä„ÅÆ‰øùÂ≠ò„Éú„Çø„É≥„Å´ÂßîË≠≤Ôºâ
(function(){
  const big = document.getElementById('journalSaveBigBtn');
  const top = document.getElementById('journalV2SaveBtn');
  if(big && top){
    big.addEventListener('click', ()=> top.click());
  }
})();


function renderDonutChart(canvasId, legendId, items, key, suffix) {
  const canvas = document.getElementById(canvasId);
  const legendEl = document.getElementById(legendId);
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const total = items.reduce((s, i) => s + (Number(i[key]) || 0), 0);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!total) {
    if (legendEl) legendEl.innerHTML = '';
    return;
  }

  const palette = ['#4F46E5','#16A34A','#F59E0B','#0EA5E9','#EF4444','#A855F7','#64748B','#22C55E','#E11D48','#F97316'];
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const rOuter = 140;
  const rInner = 88;

  let start = -Math.PI / 2;
  items.forEach((it, idx) => {
    const v = Number(it[key]) || 0;
    if (v <= 0) return;
    const angle = (v / total) * Math.PI * 2;
    const end = start + angle;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.closePath();
    ctx.fillStyle = palette[idx % palette.length];
    ctx.fill();

    ctx.beginPath();
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.stroke();

    start = end;
  });

  ctx.beginPath();
  ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  ctx.fillStyle = '#111';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.font = '700 18px system-ui';
  ctx.fillText('ÂêàË®à', cx, cy - 10);
  ctx.font = '800 22px system-ui';
  ctx.fillText(`${total}${suffix}`, cx, cy + 18);

  if (legendEl) {
    legendEl.innerHTML = items
      .filter(it => (Number(it[key]) || 0) > 0)
      .map((it, idx) => {
        const v = Number(it[key]) || 0;
        const pct = Math.round((v / total) * 100);
        return `<div class="legend-row">
          <span class="legend-dot" style="background:${palette[idx % palette.length]}"></span>
          <span class="legend-cat">${it.cat}</span>
          <span class="legend-amt">${v}${suffix}</span>
          <span class="legend-pct">${pct}%</span>
        </div>`;
      }).join('');
  }
}

</script>

<script>
/* ===== Journal Voice Input: Toggle Button Version (Mobile First) ===== */
(function(){
  'use strict';

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return;

  let recognition = null;
  let isListening = false;
  let shouldRestart = false;

  const btn = document.getElementById('journalV2VoiceBtn');
  const textarea = document.getElementById('journalV3Raw');
  const status = document.getElementById('journalV2Status');

  function setStatus(msg){
    if(status) status.textContent = msg || '';
  }

  function updateButton(){
    if(!btn) return;
    if(isListening){
      btn.textContent = '‚èπ ÂÅúÊ≠¢';
      btn.style.background = '#111';
      btn.style.color = '#fff';
    } else {
      btn.textContent = 'üé§ Èü≥Â£∞ÂÖ•Âäõ';
      btn.style.background = '';
      btn.style.color = '';
    }
  }

  function start(){
    recognition = new SR();
    recognition.lang = 'ja-JP';
    recognition.continuous = true;
    recognition.interimResults = true;

    recognition.onresult = (e)=>{
      let interim = '';
      for(let i=e.resultIndex;i<e.results.length;i++){
        const r = e.results[i];
        if(r.isFinal){
          textarea.value += r[0].transcript;
        } else {
          interim += r[0].transcript;
        }
      }
      if(interim) setStatus('üéô ÂÖ•Âäõ‰∏≠‚Ä¶');
    };

    recognition.onerror = ()=>{};

    recognition.onend = ()=>{
      if(shouldRestart){
        setTimeout(()=>{
          try{ recognition.start(); }catch(e){}
        }, 800);
      } else {
        isListening = false;
        updateButton();
        setStatus('');
      }
    };

    try{ recognition.start(); }catch(e){}
  }

  btn.addEventListener('click', ()=>{
    if(isListening){
      shouldRestart = false;
      recognition && recognition.stop();
    } else {
      isListening = true;
      shouldRestart = true;
      setStatus('üéô Èü≥Â£∞ÂÖ•Âäõ‰∏≠ÔºàÂÅúÊ≠¢„ÅßÁµÇ‰∫ÜÔºâ');
      updateButton();
      start();
    }
  });

})();
</script>

</body>
</html>
                                                                                                                                                                                                                                                                                                                                                                                                                                       